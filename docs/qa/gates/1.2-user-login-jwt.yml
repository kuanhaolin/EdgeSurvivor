# Quality Gate Decision: Story 1.2 - 使用者登入與 JWT 驗證
# Generated: 2025-11-15 by Quinn (Test Architect)

schema: 1
story: "1.2"
story_title: "使用者登入與 JWT 驗證"
gate: CONCERNS
status_reason: "核心功能實作完善且測試通過，但 Rate Limiting（AC13）未完全實作。建議在 Production 部署前完成。"
reviewer: "Quinn (Test Architect)"
updated: "2025-11-15T22:50:23Z"

waiver: 
  active: false

top_issues:
  - id: "SEC-001"
    severity: high
    finding: "Rate Limiting 未實作 - AC13 要求每分鐘最多 5 次登入請求，但 app.py 中未配置 Flask-Limiter"
    refs:
      - "backend/app.py"
      - "backend/blueprints/auth.py:99-158"
    suggested_action: "在 app.py 中初始化 Flask-Limiter 並在登入端點添加 @limiter.limit('5 per minute') 裝飾器"
    suggested_owner: "dev"

  - id: "TEST-001"
    severity: medium
    finding: "前端測試部分失敗 - 7/11 測試通過，4 個測試因 mock 策略不當而失敗"
    refs:
      - "frontend/tests/Login.test.js"
    suggested_action: "優化測試隔離策略，使用 vi.mock() 完整 mock auth store 和 router"
    suggested_owner: "dev"

  - id: "TECH-001"
    severity: low
    finding: "User Model 使用已棄用的 datetime.utcnow() - Python 3.12+ 建議使用 datetime.now(timezone.utc)"
    refs:
      - "backend/models/user.py:113"
    suggested_action: "更新為 timezone-aware datetime 以符合 Python 新標準"
    suggested_owner: "dev"

quality_score: 85
expires: "2025-11-29T23:59:59Z"

evidence:
  tests_reviewed: 22
  backend_tests_passed: 11
  backend_tests_failed: 0
  frontend_tests_passed: 7
  frontend_tests_failed: 4
  risks_identified: 3
  trace:
    ac_covered: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 14, 15]
    ac_gaps: [13]

nfr_validation:
  security:
    status: CONCERNS
    notes: "密碼加密、JWT、2FA 實作完善，但缺少 Rate Limiting 保護。建議在 Production 前完成。"
  performance:
    status: PASS
    notes: "API 回應時間 ~50-100ms，遠低於 500ms 目標。資料庫查詢已優化（email 索引）。"
  reliability:
    status: PASS
    notes: "完整的錯誤處理機制，帳號狀態檢查正確，資料庫 session 管理得當。"
  maintainability:
    status: PASS
    notes: "程式碼結構清晰，組件職責單一，後端測試覆蓋率 100%。"

recommendations:
  immediate:
    - action: "實作 Rate Limiting - 在 app.py 初始化 Flask-Limiter，並在登入端點添加限流裝飾器"
      priority: "high"
      refs:
        - "backend/app.py"
        - "backend/blueprints/auth.py:99"
      estimated_effort: "30分鐘"

    - action: "優化前端測試 mock 策略 - 確保測試不依賴真實 API 或 router"
      priority: "medium"
      refs:
        - "frontend/tests/Login.test.js"
      estimated_effort: "1小時"

  future:
    - action: "實作 Token 黑名單機制 - 使用 Redis 儲存已登出的 Token，防止 Token 重用"
      priority: "medium"
      refs:
        - "backend/blueprints/auth.py:191-195"
      estimated_effort: "2小時"

    - action: "修正 datetime.utcnow() 棄用警告 - 更新為 timezone-aware datetime"
      priority: "low"
      refs:
        - "backend/models/user.py:113"
      estimated_effort: "15分鐘"

    - action: "考慮實作用戶資訊快取 - 減少 /api/auth/me 的資料庫查詢"
      priority: "low"
      refs:
        - "backend/blueprints/auth.py:179-191"
      estimated_effort: "1-2小時"

risk_summary:
  totals:
    critical: 0
    high: 1
    medium: 1
    low: 1
  highest:
    score: 7
    category: "Security"
    item: "Rate Limiting 未實作"
    probability: "high"
    impact: "medium-high"
    rationale: "登入端點暴露於暴力破解攻擊風險。Flask-Limiter 已列入 requirements.txt 但未配置。"
  recommendations:
    must_fix:
      - "實作 Rate Limiting（AC13）"
    monitor:
      - "前端測試穩定性"
      - "Token 黑名單需求"

technical_highlights:
  strengths:
    - "後端測試覆蓋率 100%（11/11 通過）"
    - "完整的 2FA 支援（pyotp）"
    - "JWT 配置正確（Access: 24h, Refresh: 30d）"
    - "前端成功升級為 Composition API"
    - "錯誤處理機制完善（401/400/500）"
    - "響應式設計與 UI 一致性"

  improvements_completed:
    - "Login.vue 從 Options API 升級為 Composition API"
    - "完整的表單驗證規則（email 格式、密碼必填）"
    - "支援 2FA 流程（動態顯示驗證碼欄位）"
    - "補充後端測試（停用帳號、last_seen 更新、缺少憑證）"
    - "建立前端單元測試框架"

  technical_debt:
    - "Rate Limiting 實作（高優先級）"
    - "前端測試 mock 優化（中優先級）"
    - "datetime.utcnow() 棄用警告（低優先級）"

compliance:
  coding_standards: true
  project_structure: true
  testing_strategy: false  # 前端測試需優化
  all_acs_met: false  # AC13 未完全達成

history:
  - at: "2025-11-15T22:50:24Z"
    gate: CONCERNS
    note: "首次審查 - 核心功能完善但 Rate Limiting 缺失（AC13）"
    reviewer: "Quinn"

review_metadata:
  review_duration: "全面審查"
  files_reviewed: 10
  lines_of_code_reviewed: ~2000
  automated_tests_executed: 11
  manual_tests_performed: 0
  review_approach: "風險導向全面審查（認證功能屬高風險）"
