# 3. 技術約束

## 現有技術棧

| 層級 | 技術 | 版本 | 說明 |
|------|------|------|------|
| **前端** | Vue.js | 3.3.8 | 採用 Composition API (`<script setup>`) |
| | Vue Router | 4.2.5 | 單頁應用路由 |
| | Axios | 1.6.2 | HTTP 客戶端 |
| | Socket.IO Client | 4.5.4 | WebSocket 通訊 |
| | Vite | 5.0.0 | 建置工具 |
| | Vitest | 1.0.4 | 測試框架 |
| **後端** | Python | 3.9+ | 主要程式語言 |
| | Flask | 2.3.3 | Web 框架 |
| | Flask-SocketIO | 5.3.5 | WebSocket 支援 |
| | Flask-JWT-Extended | 4.5.3 | JWT 認證 |
| | Flask-CORS | 4.0.0 | 跨域資源共享 |
| | SQLAlchemy | 2.0.23 | ORM 框架 |
| | PyMySQL | 1.1.0 | MySQL 驅動 |
| | Werkzeug | 3.0.1 | 工具庫（密碼雜湊等） |
| **資料庫** | MariaDB | 10.11 | 主資料庫 |
| | SQLite | 3.x | 測試用記憶體資料庫 |
| **部署** | Docker | Latest | 容器化 |
| | Docker Compose | Latest | 多容器編排 |
| | Gunicorn | 21.2.0 | WSGI 伺服器 |
| | Gevent | 23.9.1 | 非同步工作模式 |

## 整合策略

### 資料庫整合
- **保持現有資料模型設計**：7個核心資料表（User, Activity, Match, ChatMessage, Expense, ActivityReview, ActivityDiscussion）
- **維持資料庫連線配置**：`pool_size=20, max_overflow=40, pool_pre_ping=True, pool_recycle=3600`
- **遵循 SQLAlchemy 2.x 語法**：使用 `select()`, `Session.scalar()` 等新 API
- **處理日期欄位遷移**：Activity 同時保留 `date` 和 `start_date`/`end_date` 欄位

### API 整合
- **維持現有 REST API 端點**：9 個 Blueprint 模組（auth, users, activities, matches, chat, discussions, expenses, reviews, upload）
- **保持 JWT 認證流程**：使用 `@jwt_required()` 裝飾器
- **維護 Socket.IO 事件協定**：現有事件名稱和資料格式不變
- **遵循 Flask Blueprint 架構**：保持模組化設計

### 前端整合
- **採用 Vue 3 Composition API**：使用 `<script setup>` 語法
- **維持 Vue Router 路由配置**：現有路由路徑不變
- **使用 Axios + Socket.IO 客戶端**：保持與後端通訊方式
- **保留現有 UI 組件結構**：避免大規模重構

### WebSocket 整合
- **維持 Flask-SocketIO 架構**：保持現有事件處理邏輯
- **JWT Token 驗證**：從 query 參數或 auth 資料中提取 token
- **注意記憶體狀態限制**：線上用戶清單不支援分散式部署（已知技術債務）

### 測試策略
- **保持 pytest 測試框架**：170+ 測試用例
- **使用 SQLite in-memory 資料庫**：測試隔離
- **維護現有測試覆蓋範圍**：包含單元測試和整合測試

## 程式碼組織標準

- **後端模組化**：按 Blueprint 分離（auth, activities, chat 等）
- **前端元件化**：Views（頁面）+ Components（可重用元件）
- **模型定義集中**：`backend/models/` 目錄統一管理
- **工具函數分離**：`backend/utils/` 目錄存放輔助功能
- **測試程式獨立**：`backend/test/` 目錄組織測試用例

## 部署環境適應

- **Docker Compose 編排**：3 個服務（frontend, backend, db）
- **環境變數管理**：使用 `.env` 檔案
- **生產環境優化**：gunicorn + gevent worker
- **容器網路隔離**：`edgesurvivor-network` 專用網路

## 風險評估

| 風險 | 影響 | 可能性 | 緩解措施 |
|------|------|--------|----------|
| Socket.IO 記憶體狀態不支援分散式部署 | 高 | 中 | 優先級 P2 - 改用 Redis 或資料庫儲存 |
| N+1 查詢效能問題 | 中 | 高 | 優先級 P1 - 使用 `joinedload()` 優化查詢 |
| 日期欄位命名不一致（date vs start_date） | 低 | 低 | 已緩解 - 同時保留兩組欄位 |
| 缺乏 API 文件 | 中 | 已發生 | 優先級 P2 - 生成 API 規格文件 |
| 測試覆蓋率未量化 | 低 | 已發生 | 優先級 P3 - 加入 pytest-cov 工具 |

---