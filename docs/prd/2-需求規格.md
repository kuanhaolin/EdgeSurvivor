# 2. 需求規格

基於現有系統的完整分析，以下是 EdgeSurvivor 平台的功能需求、非功能需求和兼容性要求。

## 功能需求

### 用戶認證與管理

- **FR1**: 系統應支援用戶透過 email 和密碼註冊帳號，密碼使用 Werkzeug 進行雜湊加密儲存
- **FR2**: 系統應支援用戶登入並返回 JWT token（access token 和 refresh token）
- **FR3**: 系統應支援雙因素認證（2FA），使用 TOTP 協定（pyotp 實現）
- **FR4**: 系統應支援 JWT token 刷新機制，透過 `/api/auth/refresh` 端點
- **FR5**: 用戶資料應支援隱私等級設定（public/partial/hidden）和社交隱私設定（public/friends_only）
- **FR6**: 用戶個人資料應包含：姓名、地點、簡介、性別、年齡、興趣標籤（JSON 格式）、頭像 URL
- **FR7**: 系統應支援用戶評價統計（rating_count, average_rating）

### 活動管理

- **FR8**: 用戶應能創建活動，包含：標題、描述、類別、日期範圍（start_date, end_date）、時間（start_time, end_time）、地點、集合點、最大參與人數、費用
- **FR9**: 活動應支援難度等級（easy/medium/hard）和參與者條件（性別偏好、年齡範圍）
- **FR10**: 活動創建者應能上傳封面圖和多張活動圖片（JSON 格式儲存 URL）
- **FR11**: 用戶應能查詢活動列表，支援篩選：我創建的活動（type=created）、我參加的活動（type=joined）、所有活動
- **FR12**: 活動創建者應能更新和刪除自己創建的活動
- **FR13**: 用戶應能申請加入活動（透過 `/api/activities/<id>/join`）
- **FR14**: 活動創建者應能審核參與者申請（批准/拒絕），透過 `/api/activities/<id>/participants/<user_id>`
- **FR15**: 活動應支援狀態管理（active/completed/cancelled）
- **FR16**: 系統應保留 `date` 欄位以實現向後兼容，同時支援新的 `start_date/end_date` 欄位

### 旅伴媒合系統

- **FR17**: 用戶應能發起媒合申請，可選擇關聯活動或直接向其他用戶發起（activity_id 可為 NULL）
- **FR18**: 媒合申請應包含申請訊息（message 欄位）
- **FR19**: 媒合記錄應支援狀態流轉：pending  confirmed/rejected/cancelled
- **FR20**: 被申請用戶應能確認或拒絕媒合申請
- **FR21**: 拒絕媒合時應能提供拒絕原因（rejection_reason）
- **FR22**: 系統應記錄媒合的時間戳：申請時間（match_date）、確認時間（confirmed_date）、取消時間（cancel_date）
- **FR23**: 媒合確認後應自動創建聊天室（基於 match_id）

### 即時聊天系統

- **FR24**: 系統應支援基於 Socket.IO 的 WebSocket 即時通訊
- **FR25**: 用戶連線時應在 `auth.token` 參數中傳遞 JWT 進行身分驗證
- **FR26**: 用戶應能加入特定聊天室（基於 match_id）
- **FR27**: 用戶應能發送和接收即時訊息
- **FR28**: 聊天訊息應同時儲存到資料庫（ChatMessage 模型）供歷史查詢
- **FR29**: 系統應支援訊息已讀狀態（is_read 欄位）
- **FR30**: 系統應廣播用戶上線/離線狀態（user_online/user_offline 事件）
- **FR31**: 系統應維護線上用戶清單（當前使用記憶體字典 online_users）

### 活動討論區

- **FR32**: 每個活動應有獨立的討論區（ActivityDiscussion 模型）
- **FR33**: 參與者應能在活動討論區發布和查看討論內容

### 費用分攤管理

- **FR34**: 用戶應能為活動創建費用記錄，包含：金額、描述、類別、代墊者
- **FR35**: 系統應支援三種費用分攤類型：全體分攤（all）、指定部分參與者（selected）、一對一借款（borrow）
- **FR36**: 系統應支援兩種分攤方式：平均分攤（equal）、自訂金額（custom）
- **FR37**: 費用分攤參與者資訊應以 JSON 格式儲存（split_participants）
- **FR38**: 系統應提供費用分攤摘要計算，包含：每人應付金額、代墊統計、結算建議
- **FR39**: 用戶應能更新和刪除自己創建的費用記錄

### 評價系統

- **FR40**: 活動結束後，參與者應能對活動進行評價（ActivityReview 模型）
- **FR41**: 評價應關聯到用戶的評價統計（rating_count, average_rating）

### 文件上傳

- **FR42**: 系統應支援圖片上傳功能（`/api/upload`）
- **FR43**: 上傳的檔案應儲存在本地檔案系統（`backend/uploads/`）
- **FR44**: 系統應返回上傳檔案的存取 URL

---
## 非功能需求

### 效能

- **NFR1**: 系統應使用資料庫連線池（pool_size=20, max_overflow=40）以支援並行存取
- **NFR2**: 生產環境應使用 gevent 非同步模式以提高 WebSocket 連線效能
- **NFR3**: 系統應在生產環境使用 gunicorn + gevent worker 部署
- **NFR4**: API 回應時間應保持在合理範圍內（需注意 N+1 查詢問題）

### 安全性

- **NFR5**: 所有密碼應使用 Werkzeug 進行雜湊加密，不得明文儲存
- **NFR6**: 系統應使用 JWT（Flask-JWT-Extended）進行 API 認證
- **NFR7**: 系統應支援可選的雙因素認證（2FA）增強安全性
- **NFR8**: CORS 應限制為明確允許的來源（localhost:3000, localhost:8080, 生產網域）
- **NFR9**: Socket.IO 連線應透過 JWT token 驗證用戶身分

### 可靠性

- **NFR10**: 資料庫連線應設定 pool_pre_ping=True 以確保連線有效性
- **NFR11**: 資料庫連線應設定 pool_recycle=3600 以防止長時間連線失效
- **NFR12**: 系統應包含 170+ 測試用例覆蓋核心功能
- **NFR13**: 測試應使用獨立的 SQLite in-memory 資料庫避免污染生產資料

### 可維護性

- **NFR14**: 後端應採用 Flask Blueprint 架構實現模組化
- **NFR15**: 前端應採用 Vue 3 Composition API（`<script setup>` 語法）
- **NFR16**: 程式碼應遵循 SQLAlchemy 2.x 語法規範
- **NFR17**: 系統應提供完整的技術文檔（brownfield-architecture.md）

### 可擴展性

- **NFR18**: 系統架構應支援前後端獨立部署
- **NFR19**: Docker Compose 設定應支援容器化部署
- **NFR20**: 注意：當前 Socket.IO 線上用戶清單使用記憶體儲存，不支援水平擴展（已知技術債務）

### 兼容性

- **NFR21**: 前端應支援現代瀏覽器（Chrome, Firefox, Safari, Edge）
- **NFR22**: 系統應支援 WebSocket 協定（Socket.IO）
- **NFR23**: 後端應兼容 Python 3.9+
- **NFR24**: 資料庫應使用 MariaDB 10.11

## 兼容性需求

- **CR1: 資料模型兼容性** - Activity 模型必須同時維護 `date` 和 `start_date` 欄位以支援舊版本資料和新的日期範圍功能
- **CR2: API 端點兼容性** - 所有現有 API 端點必須保持 URL 路徑、請求/回應格式不變，確保前端和整合系統正常運作
- **CR3: JWT Token 兼容性** - 認證機制必須繼續使用 JWT token，token 格式和驗證流程保持一致
- **CR4: Socket.IO 協定兼容性** - WebSocket 通訊必須繼續使用 Socket.IO 協定，事件名稱和資料格式保持不變
- **CR5: 資料庫 Schema 兼容性** - 資料庫表格結構變更必須透過遷移腳本實現，不得破壞現有資料
- **CR6: 環境設定兼容性** - 必須繼續支援透過 `.env` 檔案進行環境設定，環境變數命名保持一致
- **CR7: Docker 部署兼容性** - 必須繼續支援 Docker Compose 部署方式，容器名稱和網路設定保持穩定

---