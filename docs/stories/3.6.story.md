# Story 3.6: 活動相簿

## Status

Draft

## Story

**As a** 活動參與者,
**I want** 上傳照片到活動相簿,
**so that** 我可以與其他參與者分享活動回憶。

## Acceptance Criteria

### 權限控制

1. 只有已加入活動的參與者可以上傳照片

2. 未登入用戶不可上傳照片

3. 未參加活動的用戶不可上傳照片

4. 任何用戶（包括未登入）都可以查看活動相簿

5. 只有照片上傳者和活動組織者可以刪除照片

### 上傳功能

6. 提供「上傳照片」按鈕（僅限參與者可見）

7. 點擊「上傳照片」按鈕後，開啟檔案選擇對話框

8. 支援的圖片格式：JPG, JPEG, PNG, GIF, WEBP

9. 單張照片檔案大小限制：5MB

10. 單次上傳數量限制：最多 10 張

11. 上傳前顯示圖片預覽

12. 上傳過程中顯示進度條

13. 上傳成功後：
    - 顯示成功訊息
    - 自動重新載入相簿
    - 新上傳的照片顯示在最前面

14. 上傳失敗後：
    - 顯示錯誤訊息（例如：「檔案過大」、「格式不支援」）
    - 允許重新上傳

### 相簿瀏覽功能

15. 在活動詳情頁面顯示「活動相簿」區塊

16. 預設顯示最新上傳的 6 張照片縮圖

17. 提供「查看所有照片」按鈕，導航至完整相簿頁面

18. 完整相簿頁面顯示所有照片，使用網格佈局

19. 照片網格應使用響應式設計：
    - 桌面版：4-6 欄
    - 平板版：3-4 欄
    - 手機版：2-3 欄

20. 每張照片縮圖應顯示：
    - 照片圖片
    - 上傳者姓名
    - 上傳時間（相對時間，例如「2 小時前」）

21. 點擊照片縮圖可放大檢視（燈箱效果）

22. 燈箱效果應支援：
    - 左右滑動切換照片
    - 鍵盤方向鍵切換
    - ESC 鍵關閉
    - 顯示目前照片索引（例如「3 / 25」）

### 照片刪除功能

23. 照片上傳者在自己的照片上看到「刪除」按鈕

24. 活動組織者在所有照片上看到「刪除」按鈕

25. 其他用戶不應看到「刪除」按鈕

26. 點擊「刪除」按鈕後，顯示確認對話框：
    - 提示：「確定要刪除這張照片嗎？」
    - 提供「確定」和「取消」按鈕

27. 確認刪除後：
    - 發送刪除請求
    - 成功後顯示成功訊息並移除照片
    - 失敗後顯示錯誤訊息

### 後端 API - 上傳照片

28. API 端點：`POST /api/activities/:activityId/photos`

29. API 應驗證 JWT 認證

30. API 應驗證用戶是否為活動參與者

31. Request 使用 multipart/form-data 格式

32. 支援多檔案上傳（欄位名稱：`photos`）

33. 後端應驗證：
    - 檔案類型（只允許圖片）
    - 檔案大小（單檔 ≤ 5MB）
    - 上傳數量（≤ 10 張）

34. 照片儲存位置：`uploads/activities/:activityId/`

35. 照片檔名應加上時間戳記或 UUID（避免重複）

36. 成功回應（201 Created）：
    ```json
    {
      "message": "照片上傳成功",
      "photos": [
        {
          "photo_id": 1,
          "url": "/uploads/activities/1/photo_1699180800_abc123.jpg",
          "uploaded_by": 10,
          "uploader_name": "john_doe",
          "created_at": "2025-11-05T16:00:00"
        }
      ]
    }
    ```

37. 錯誤回應：
    - 401：`{"error": "請先登入"}`
    - 403：`{"error": "只有活動參與者可以上傳照片"}`
    - 400：`{"error": "檔案大小超過限制（最大 5MB）"}`
    - 400：`{"error": "不支援的檔案格式"}`
    - 400：`{"error": "一次最多上傳 10 張照片"}`

### 後端 API - 獲取活動照片

38. API 端點：`GET /api/activities/:activityId/photos`

39. API 不需要認證（公開）

40. 支援分頁：
    - Query 參數：`page`（預設 1）、`per_page`（預設 20）

41. 照片按上傳時間倒序排列（最新的在前）

42. 成功回應（200 OK）：
    ```json
    {
      "photos": [
        {
          "photo_id": 1,
          "url": "/uploads/activities/1/photo.jpg",
          "uploaded_by": 10,
          "uploader_name": "john_doe",
          "uploader_avatar": "/uploads/avatar10.jpg",
          "created_at": "2025-11-05T16:00:00"
        }
      ],
      "pagination": {
        "page": 1,
        "per_page": 20,
        "total": 50,
        "pages": 3
      }
    }
    ```

### 後端 API - 刪除照片

43. API 端點：`DELETE /api/activities/:activityId/photos/:photoId`

44. API 應驗證 JWT 認證

45. API 應驗證權限：
    - 照片上傳者可以刪除
    - 活動組織者可以刪除

46. 刪除照片時應同時刪除檔案系統中的檔案

47. 成功回應（200 OK）：
    ```json
    {
      "message": "照片已刪除"
    }
    ```

48. 錯誤回應：
    - 401：`{"error": "請先登入"}`
    - 403：`{"error": "沒有權限刪除此照片"}`
    - 404：`{"error": "照片不存在"}`

### 空狀態處理

49. 如果活動沒有照片，顯示空狀態：
    - 圖示或插圖
    - 文字：「目前還沒有照片」
    - 如果是參與者，顯示「成為第一個上傳照片的人！」

50. 空狀態應提供「上傳照片」按鈕（僅限參與者）

### 效能要求

51. 圖片應生成縮圖（例如：300x300）用於網格顯示

52. 使用懶載入（lazy loading）載入照片

53. 上傳照片應支援壓縮（前端或後端）

54. 相簿頁面載入時間需低於 2000ms

## Tasks / Subtasks

> **Brownfield 專案說明**：後端需要新增照片上傳、獲取、刪除 API。前端需要建立完整相簿頁面，並在活動詳情頁面整合照片上傳和預覽功能。

### Phase 1: 後端照片 API 實作

- [ ] **Task 1: 實作照片上傳 API** (AC: 28-37)
  - [ ] 在 `backend/blueprints/activities.py` 新增 `POST /activities/<id>/photos` 端點
  - [ ] 安裝並配置檔案上傳套件（例如：Flask-Uploads 或使用 werkzeug）
  - [ ] 實作 JWT 認證驗證
  - [ ] 實作參與者權限檢查
  - [ ] 實作檔案類型驗證（MIME type 檢查）
  - [ ] 實作檔案大小驗證（≤ 5MB）
  - [ ] 實作上傳數量限制（≤ 10 張）
  - [ ] 建立上傳目錄（`uploads/activities/:activityId/`）
  - [ ] 實作檔案儲存邏輯（加上時間戳記或 UUID）
  - [ ] 實作資料庫記錄建立（ActivityPhoto model）
  - [ ] 實作錯誤處理
  - [ ] 測試 API 端點
  - [ ] 記錄 API 規格

- [ ] **Task 2: 實作獲取照片 API** (AC: 38-42)
  - [ ] 在 `backend/blueprints/activities.py` 新增 `GET /activities/<id>/photos` 端點
  - [ ] 實作分頁邏輯（page, per_page）
  - [ ] 實作照片倒序排列（最新在前）
  - [ ] 包含上傳者資訊（姓名、頭像）
  - [ ] 測試 API 端點

- [ ] **Task 3: 實作刪除照片 API** (AC: 43-48)
  - [ ] 在 `backend/blueprints/activities.py` 新增 `DELETE /activities/<id>/photos/<photo_id>` 端點
  - [ ] 實作 JWT 認證驗證
  - [ ] 實作權限檢查（上傳者或組織者）
  - [ ] 實作資料庫記錄刪除
  - [ ] 實作檔案系統檔案刪除（使用 `os.remove`）
  - [ ] 實作錯誤處理（檔案不存在）
  - [ ] 測試 API 端點

- [ ] **Task 4: 檢查/建立 ActivityPhoto Model** (AC: 34-35)
  - [ ] 檢查 `backend/models/` 是否有 ActivityPhoto model
  - [ ] 如果沒有，建立 model（欄位：photo_id, activity_id, url, uploaded_by, created_at）
  - [ ] 建立與 Activity 和 User 的關聯
  - [ ] 執行資料庫遷移（如需要）

### Phase 2: 前端照片上傳組件

- [ ] **Task 5: 建立 PhotoUploader 組件** (AC: 6-14)
  - [ ] 在 `frontend/src/components/activity/` 建立 `PhotoUploader.vue`
  - [ ] 使用 Vue 3 Composition API 和 `<script setup>` 語法
  - [ ] 實作檔案選擇功能（使用 `el-upload` 或原生 input）
  - [ ] 實作多檔案上傳（最多 10 張）
  - [ ] 實作檔案類型驗證（前端）
  - [ ] 實作檔案大小驗證（前端，≤ 5MB）
  - [ ] 實作圖片預覽
  - [ ] 實作上傳進度條
  - [ ] 實作上傳成功/失敗處理
  - [ ] Emit 'upload-success' 事件通知父組件
  - [ ] 測試組件

### Phase 3: 前端相簿頁面

- [ ] **Task 6: 建立 ActivityPhotos 頁面** (AC: 18-22, 49-50)
  - [ ] 在 `frontend/src/views/` 建立 `ActivityPhotos.vue`
  - [ ] 使用 Vue 3 Composition API 和 `<script setup>` 語法
  - [ ] 實作照片網格佈局（響應式）
  - [ ] 實作照片載入邏輯（呼叫 API）
  - [ ] 實作分頁功能
  - [ ] 實作照片資訊顯示（上傳者、時間）
  - [ ] 實作空狀態顯示
  - [ ] 測試頁面

- [ ] **Task 7: 實作燈箱效果** (AC: 21-22)
  - [ ] 使用 Element Plus 的 `el-image-viewer` 或第三方套件（例如：vue-easy-lightbox）
  - [ ] 實作點擊照片放大
  - [ ] 實作左右切換（滑動、方向鍵）
  - [ ] 實作 ESC 關閉
  - [ ] 顯示照片索引（3 / 25）
  - [ ] 測試燈箱功能

- [ ] **Task 8: 實作照片刪除功能** (AC: 23-27)
  - [ ] 檢查用戶權限（上傳者或組織者）
  - [ ] 顯示/隱藏「刪除」按鈕
  - [ ] 實作刪除確認對話框
  - [ ] 實作刪除 API 呼叫
  - [ ] 刪除成功後更新照片列表
  - [ ] 測試刪除功能

### Phase 4: 整合到活動詳情頁面

- [ ] **Task 9: 更新 ActivityDetail.vue 頁面** (AC: 15-17)
  - [ ] 導入 `PhotoUploader` 組件
  - [ ] 在相簿區塊整合上傳功能
  - [ ] 顯示最新 6 張照片縮圖
  - [ ] 實作「查看所有照片」按鈕（導航至 ActivityPhotos 頁面）
  - [ ] 實作照片上傳成功後重新載入
  - [ ] 測試整合

### Phase 5: API 服務層

- [ ] **Task 10: 更新 activities API 服務** (AC: 28, 38, 43)
  - [ ] 在 `frontend/src/api/activities.js` 新增：
    ```javascript
    export const uploadPhotos = (activityId, formData) => {
      return axios.post(`/api/activities/${activityId}/photos`, formData, {
        headers: { 'Content-Type': 'multipart/form-data' }
      })
    }
    
    export const getActivityPhotos = (activityId, page = 1, perPage = 20) => {
      return axios.get(`/api/activities/${activityId}/photos`, {
        params: { page, per_page: perPage }
      })
    }
    
    export const deletePhoto = (activityId, photoId) => {
      return axios.delete(`/api/activities/${activityId}/photos/${photoId}`)
    }
    ```
  - [ ] 測試 API 函數

### Phase 6: 路由配置

- [ ] **Task 11: 更新路由配置** (AC: 17)
  - [ ] 在 `frontend/src/router/index.js` 新增路由：
    ```javascript
    {
      path: '/activities/:activityId/photos',
      name: 'ActivityPhotos',
      component: () => import('@/views/ActivityPhotos.vue')
    }
    ```
  - [ ] 測試路由導航

### Phase 7: 效能優化

- [ ] **Task 12: 實作效能優化** (AC: 51-54)
  - [ ] 後端實作縮圖生成（使用 Pillow 或 ImageMagick）
  - [ ] 前端實作圖片壓縮（使用 canvas 或第三方套件）
  - [ ] 實作懶載入（`el-image` 的 `lazy` 屬性）
  - [ ] 測試效能

### Phase 8: 測試

- [ ] **Task 13: 前端單元測試** (所有 AC)
  - [ ] 測試 `PhotoUploader.vue` 組件
  - [ ] 測試 `ActivityPhotos.vue` 頁面
  - [ ] 測試照片上傳流程
  - [ ] 測試照片刪除流程
  - [ ] 測試權限控制
  - [ ] 執行測試：`npm run test:unit`
  - [ ] 確認覆蓋率 > 80%

- [ ] **Task 14: 後端測試** (AC: 28-48)
  - [ ] 測試照片上傳 API（成功和失敗情況）
  - [ ] 測試檔案類型驗證
  - [ ] 測試檔案大小驗證
  - [ ] 測試上傳數量限制
  - [ ] 測試參與者權限檢查
  - [ ] 測試獲取照片 API（含分頁）
  - [ ] 測試刪除照片 API（含權限檢查）
  - [ ] 執行測試：`pytest backend/tests/test_activities.py -v`

### Phase 9: 整合測試與驗收

- [ ] **Task 15: 端到端功能驗證** (所有 AC)
  - [ ] 手動測試完整照片上傳流程
  - [ ] 測試照片瀏覽和燈箱效果
  - [ ] 測試照片刪除流程
  - [ ] 測試權限控制
  - [ ] 測試響應式設計
  - [ ] 驗證所有 AC 滿足

## Dev Notes

### Previous Story Insights

**來自 Story 1.1 - 3.5 的經驗**：
- Vue 3 Composition API 是標準開發模式 [Source: architecture/4-組件標準-component-standards.md]
- Element Plus 組件庫已整合，使用 `el-upload`、`el-image`、`el-image-viewer` 等組件 [Source: architecture/2-前端技術棧-frontend-tech-stack.md]
- Day.js 用於相對時間顯示 [Source: architecture/2-前端技術棧-frontend-tech-stack.md]
- Flask 用於檔案上傳處理 [Source: backend 架構]
- Pinia 用於狀態管理（用戶資訊） [Source: architecture/5-狀態管理-state-management.md]
- JWT 認證機制完善 [Source: architecture/6-api-整合-api-integration.md]

### API Specifications

#### 上傳照片 API

**Endpoint**: `POST /api/activities/:activityId/photos`

**Authentication**: Required (JWT Token)

**Path Parameters**:
- `activityId`: 活動 ID（整數）

**Request**:
- Content-Type: `multipart/form-data`
- Body: 
  - `photos`: File[] (最多 10 張)

**Validation Rules**:
- 只有活動參與者可以上傳
- 檔案類型：image/jpeg, image/jpg, image/png, image/gif, image/webp
- 單檔大小：≤ 5MB
- 上傳數量：≤ 10 張

**Response (Success - 201)**:
```json
{
  "message": "照片上傳成功",
  "photos": [
    {
      "photo_id": 1,
      "url": "/uploads/activities/1/photo_1699180800_abc123.jpg",
      "thumbnail_url": "/uploads/activities/1/thumb_photo_1699180800_abc123.jpg",
      "uploaded_by": 10,
      "uploader_name": "john_doe",
      "created_at": "2025-11-05T16:00:00"
    }
  ]
}
```

**Response (Errors)**:
```json
// 401 Unauthorized
{"error": "請先登入"}

// 403 Forbidden
{"error": "只有活動參與者可以上傳照片"}

// 400 Bad Request (檔案過大)
{"error": "檔案大小超過限制（最大 5MB）"}

// 400 Bad Request (格式不支援)
{"error": "不支援的檔案格式"}

// 400 Bad Request (數量超過)
{"error": "一次最多上傳 10 張照片"}
```

#### 獲取活動照片 API

**Endpoint**: `GET /api/activities/:activityId/photos`

**Authentication**: Optional

**Path Parameters**:
- `activityId`: 活動 ID（整數）

**Query Parameters**:
- `page`: 頁碼（預設 1）
- `per_page`: 每頁數量（預設 20）

**Response (Success - 200)**:
```json
{
  "photos": [
    {
      "photo_id": 1,
      "url": "/uploads/activities/1/photo.jpg",
      "thumbnail_url": "/uploads/activities/1/thumb_photo.jpg",
      "uploaded_by": 10,
      "uploader_name": "john_doe",
      "uploader_avatar": "/uploads/avatar10.jpg",
      "created_at": "2025-11-05T16:00:00",
      "can_delete": true
    }
  ],
  "pagination": {
    "page": 1,
    "per_page": 20,
    "total": 50,
    "pages": 3
  }
}
```

#### 刪除照片 API

**Endpoint**: `DELETE /api/activities/:activityId/photos/:photoId`

**Authentication**: Required (JWT Token)

**Path Parameters**:
- `activityId`: 活動 ID（整數）
- `photoId`: 照片 ID（整數）

**Authorization Rules**:
- 照片上傳者可以刪除
- 活動組織者可以刪除

**Response (Success - 200)**:
```json
{
  "message": "照片已刪除"
}
```

**Response (Errors)**:
```json
// 401 Unauthorized
{"error": "請先登入"}

// 403 Forbidden
{"error": "沒有權限刪除此照片"}

// 404 Not Found
{"error": "照片不存在"}
```

### Backend Implementation Guide

**照片上傳實作範例**:

```python
import os
import uuid
from datetime import datetime
from werkzeug.utils import secure_filename
from PIL import Image

ALLOWED_EXTENSIONS = {'jpg', 'jpeg', 'png', 'gif', 'webp'}
MAX_FILE_SIZE = 5 * 1024 * 1024  # 5MB
MAX_UPLOAD_COUNT = 10
UPLOAD_FOLDER = 'uploads/activities'

def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

def create_thumbnail(image_path, thumbnail_path, size=(300, 300)):
    """建立縮圖"""
    try:
        with Image.open(image_path) as img:
            img.thumbnail(size, Image.Resampling.LANCZOS)
            img.save(thumbnail_path, quality=85, optimize=True)
    except Exception as e:
        print(f"Error creating thumbnail: {e}")

@activities_bp.route('/<int:activity_id>/photos', methods=['POST'])
@jwt_required()
def upload_photos(activity_id):
    """上傳活動照片"""
    try:
        current_user_id = get_jwt_identity()
        
        # 檢查活動是否存在
        activity = Activity.query.filter_by(activity_id=activity_id).first()
        if not activity:
            return jsonify({'error': '活動不存在'}), 404
        
        # 檢查是否為參與者
        is_participant = ActivityParticipant.query.filter_by(
            activity_id=activity_id,
            user_id=current_user_id
        ).first()
        
        if not is_participant:
            return jsonify({'error': '只有活動參與者可以上傳照片'}), 403
        
        # 檢查是否有檔案
        if 'photos' not in request.files:
            return jsonify({'error': '沒有選擇檔案'}), 400
        
        files = request.files.getlist('photos')
        
        # 檢查上傳數量
        if len(files) > MAX_UPLOAD_COUNT:
            return jsonify({'error': f'一次最多上傳 {MAX_UPLOAD_COUNT} 張照片'}), 400
        
        # 建立上傳目錄
        activity_folder = os.path.join(UPLOAD_FOLDER, str(activity_id))
        os.makedirs(activity_folder, exist_ok=True)
        
        uploaded_photos = []
        
        for file in files:
            if file.filename == '':
                continue
            
            # 檢查檔案類型
            if not allowed_file(file.filename):
                return jsonify({'error': '不支援的檔案格式'}), 400
            
            # 檢查檔案大小
            file.seek(0, os.SEEK_END)
            file_size = file.tell()
            file.seek(0)
            
            if file_size > MAX_FILE_SIZE:
                return jsonify({'error': '檔案大小超過限制（最大 5MB）'}), 400
            
            # 生成唯一檔名
            timestamp = int(datetime.utcnow().timestamp())
            unique_id = uuid.uuid4().hex[:8]
            ext = file.filename.rsplit('.', 1)[1].lower()
            filename = f'photo_{timestamp}_{unique_id}.{ext}'
            thumb_filename = f'thumb_{filename}'
            
            # 儲存檔案
            filepath = os.path.join(activity_folder, filename)
            thumb_filepath = os.path.join(activity_folder, thumb_filename)
            file.save(filepath)
            
            # 建立縮圖
            create_thumbnail(filepath, thumb_filepath)
            
            # 建立資料庫記錄
            photo = ActivityPhoto(
                activity_id=activity_id,
                url=f'/{filepath}',
                thumbnail_url=f'/{thumb_filepath}',
                uploaded_by=current_user_id
            )
            db.session.add(photo)
            db.session.flush()
            
            uploaded_photos.append({
                'photo_id': photo.photo_id,
                'url': photo.url,
                'thumbnail_url': photo.thumbnail_url,
                'uploaded_by': current_user_id,
                'uploader_name': User.query.get(current_user_id).username,
                'created_at': photo.created_at.isoformat()
            })
        
        db.session.commit()
        
        return jsonify({
            'message': '照片上傳成功',
            'photos': uploaded_photos
        }), 201
        
    except Exception as e:
        db.session.rollback()
        return jsonify({'error': str(e)}), 500

@activities_bp.route('/<int:activity_id>/photos', methods=['GET'])
def get_activity_photos(activity_id):
    """獲取活動照片"""
    try:
        page = request.args.get('page', 1, type=int)
        per_page = request.args.get('per_page', 20, type=int)
        
        # 取得目前用戶 ID（如果已登入）
        current_user_id = None
        try:
            current_user_id = get_jwt_identity()
        except:
            pass
        
        # 查詢活動組織者
        activity = Activity.query.filter_by(activity_id=activity_id).first()
        if not activity:
            return jsonify({'error': '活動不存在'}), 404
        
        # 分頁查詢照片
        pagination = ActivityPhoto.query.filter_by(activity_id=activity_id).order_by(
            ActivityPhoto.created_at.desc()
        ).paginate(page=page, per_page=per_page, error_out=False)
        
        photos = []
        for photo in pagination.items:
            uploader = User.query.get(photo.uploaded_by)
            can_delete = (
                current_user_id == photo.uploaded_by or 
                current_user_id == activity.creator_id
            )
            
            photos.append({
                'photo_id': photo.photo_id,
                'url': photo.url,
                'thumbnail_url': photo.thumbnail_url,
                'uploaded_by': photo.uploaded_by,
                'uploader_name': uploader.username if uploader else None,
                'uploader_avatar': uploader.avatar if uploader else None,
                'created_at': photo.created_at.isoformat(),
                'can_delete': can_delete
            })
        
        return jsonify({
            'photos': photos,
            'pagination': {
                'page': page,
                'per_page': per_page,
                'total': pagination.total,
                'pages': pagination.pages
            }
        }), 200
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@activities_bp.route('/<int:activity_id>/photos/<int:photo_id>', methods=['DELETE'])
@jwt_required()
def delete_photo(activity_id, photo_id):
    """刪除照片"""
    try:
        current_user_id = get_jwt_identity()
        
        # 查詢照片
        photo = ActivityPhoto.query.filter_by(
            photo_id=photo_id,
            activity_id=activity_id
        ).first()
        
        if not photo:
            return jsonify({'error': '照片不存在'}), 404
        
        # 查詢活動組織者
        activity = Activity.query.get(activity_id)
        
        # 檢查權限（上傳者或組織者）
        if current_user_id != photo.uploaded_by and current_user_id != activity.creator_id:
            return jsonify({'error': '沒有權限刪除此照片'}), 403
        
        # 刪除檔案
        try:
            if os.path.exists(photo.url.lstrip('/')):
                os.remove(photo.url.lstrip('/'))
            if os.path.exists(photo.thumbnail_url.lstrip('/')):
                os.remove(photo.thumbnail_url.lstrip('/'))
        except Exception as e:
            print(f"Error deleting files: {e}")
        
        # 刪除資料庫記錄
        db.session.delete(photo)
        db.session.commit()
        
        return jsonify({'message': '照片已刪除'}), 200
        
    except Exception as e:
        db.session.rollback()
        return jsonify({'error': str(e)}), 500
```

**ActivityPhoto Model 範例**:

```python
# backend/models/activity_photo.py

from datetime import datetime
from backend import db

class ActivityPhoto(db.Model):
    __tablename__ = 'activity_photos'
    
    photo_id = db.Column(db.Integer, primary_key=True)
    activity_id = db.Column(db.Integer, db.ForeignKey('activities.activity_id'), nullable=False)
    url = db.Column(db.String(500), nullable=False)
    thumbnail_url = db.Column(db.String(500))
    uploaded_by = db.Column(db.Integer, db.ForeignKey('users.user_id'), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # 關聯
    activity = db.relationship('Activity', backref='photos')
    uploader = db.relationship('User')
```

### Frontend Implementation Guide

**PhotoUploader 組件範例**:

```vue
<script setup>
import { ref } from 'vue'
import { ElMessage } from 'element-plus'
import { uploadPhotos } from '@/api/activities'

const props = defineProps({
  activityId: {
    type: Number,
    required: true
  }
})

const emit = defineEmits(['upload-success'])

const fileList = ref([])
const uploading = ref(false)

const beforeUpload = (file) => {
  // 檢查檔案類型
  const isImage = file.type.startsWith('image/')
  if (!isImage) {
    ElMessage.error('只能上傳圖片檔案')
    return false
  }
  
  // 檢查檔案大小
  const isLt5M = file.size / 1024 / 1024 < 5
  if (!isLt5M) {
    ElMessage.error('圖片大小不能超過 5MB')
    return false
  }
  
  // 檢查數量
  if (fileList.value.length >= 10) {
    ElMessage.error('一次最多上傳 10 張照片')
    return false
  }
  
  return true
}

const handleChange = (file, files) => {
  fileList.value = files
}

const handleRemove = (file, files) => {
  fileList.value = files
}

const handleUpload = async () => {
  if (fileList.value.length === 0) {
    ElMessage.warning('請選擇要上傳的照片')
    return
  }
  
  try {
    uploading.value = true
    
    const formData = new FormData()
    fileList.value.forEach(file => {
      formData.append('photos', file.raw)
    })
    
    await uploadPhotos(props.activityId, formData)
    
    ElMessage.success('照片上傳成功！')
    fileList.value = []
    emit('upload-success')
    
  } catch (error) {
    const errorMsg = error.response?.data?.error || '上傳失敗，請稍後再試'
    ElMessage.error(errorMsg)
  } finally {
    uploading.value = false
  }
}
</script>

<template>
  <div class="photo-uploader">
    <el-upload
      v-model:file-list="fileList"
      :auto-upload="false"
      :before-upload="beforeUpload"
      :on-change="handleChange"
      :on-remove="handleRemove"
      list-type="picture-card"
      accept="image/*"
      multiple
      :limit="10"
    >
      <el-icon><Plus /></el-icon>
    </el-upload>
    
    <div class="upload-actions mt-4">
      <el-button
        type="primary"
        :loading="uploading"
        :disabled="fileList.length === 0"
        @click="handleUpload"
      >
        上傳 {{ fileList.length }} 張照片
      </el-button>
    </div>
  </div>
</template>
```

**ActivityPhotos 頁面範例**:

```vue
<script setup>
import { ref, computed, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { useUserStore } from '@/stores/user'
import { getActivityPhotos, deletePhoto } from '@/api/activities'
import { ElMessage, ElMessageBox } from 'element-plus'
import dayjs from 'dayjs'
import relativeTime from 'dayjs/plugin/relativeTime'
import 'dayjs/locale/zh-tw'

dayjs.extend(relativeTime)
dayjs.locale('zh-tw')

const route = useRoute()
const router = useRouter()
const userStore = useUserStore()

const activityId = computed(() => parseInt(route.params.activityId))
const photos = ref([])
const pagination = ref({ page: 1, per_page: 20, total: 0, pages: 0 })
const loading = ref(false)
const viewerVisible = ref(false)
const viewerIndex = ref(0)

const imageUrls = computed(() => photos.value.map(p => p.url))

const fetchPhotos = async (page = 1) => {
  try {
    loading.value = true
    const { data } = await getActivityPhotos(activityId.value, page, 20)
    photos.value = data.photos
    pagination.value = data.pagination
  } catch (error) {
    ElMessage.error('無法載入照片')
  } finally {
    loading.value = false
  }
}

const handleDelete = async (photo) => {
  try {
    await ElMessageBox.confirm('確定要刪除這張照片嗎？', '確認刪除', {
      confirmButtonText: '確定',
      cancelButtonText: '取消',
      type: 'warning'
    })
    
    await deletePhoto(activityId.value, photo.photo_id)
    ElMessage.success('照片已刪除')
    await fetchPhotos(pagination.value.page)
    
  } catch (error) {
    if (error !== 'cancel') {
      const errorMsg = error.response?.data?.error || '刪除失敗'
      ElMessage.error(errorMsg)
    }
  }
}

const openViewer = (index) => {
  viewerIndex.value = index
  viewerVisible.value = true
}

const formatRelativeTime = (date) => {
  return dayjs(date).fromNow()
}

onMounted(() => {
  fetchPhotos()
})
</script>

<template>
  <div class="activity-photos">
    <h2>活動相簿</h2>
    
    <!-- 載入狀態 -->
    <el-skeleton v-if="loading" :rows="8" animated />
    
    <!-- 空狀態 -->
    <el-empty v-else-if="photos.length === 0" description="目前還沒有照片">
      <el-button type="primary">上傳照片</el-button>
    </el-empty>
    
    <!-- 照片網格 -->
    <div v-else class="photos-grid">
      <div
        v-for="(photo, index) in photos"
        :key="photo.photo_id"
        class="photo-item"
      >
        <el-image
          :src="photo.thumbnail_url"
          fit="cover"
          lazy
          @click="openViewer(index)"
        >
          <template #error>
            <div class="image-error">
              <el-icon><Picture /></el-icon>
            </div>
          </template>
        </el-image>
        
        <div class="photo-info">
          <div class="uploader">
            <el-avatar :src="photo.uploader_avatar" :size="24" />
            <span>{{ photo.uploader_name }}</span>
          </div>
          <div class="time">{{ formatRelativeTime(photo.created_at) }}</div>
        </div>
        
        <el-button
          v-if="photo.can_delete"
          type="danger"
          size="small"
          class="delete-btn"
          @click.stop="handleDelete(photo)"
        >
          刪除
        </el-button>
      </div>
    </div>
    
    <!-- 分頁 -->
    <el-pagination
      v-if="pagination.pages > 1"
      v-model:current-page="pagination.page"
      :page-size="pagination.per_page"
      :total="pagination.total"
      layout="prev, pager, next"
      @current-change="fetchPhotos"
    />
    
    <!-- 燈箱 -->
    <el-image-viewer
      v-if="viewerVisible"
      :url-list="imageUrls"
      :initial-index="viewerIndex"
      @close="viewerVisible = false"
    />
  </div>
</template>

<style scoped>
.photos-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1rem;
}

.photo-item {
  position: relative;
  aspect-ratio: 1;
}

.photo-item .el-image {
  width: 100%;
  height: 100%;
  cursor: pointer;
}

.delete-btn {
  position: absolute;
  top: 8px;
  right: 8px;
}
</style>
```

### File Locations

**Backend** (新建/更新):
- API: `backend/blueprints/activities.py` (新增照片相關端點)
- Model: `backend/models/activity_photo.py` (新建或檢查)
- 測試: `backend/tests/test_activities.py` (新增測試)
- 上傳目錄: `uploads/activities/:activityId/` (自動建立)

**Frontend - New Files**:
- 照片上傳組件: `frontend/src/components/activity/PhotoUploader.vue` (新建)
- 相簿頁面: `frontend/src/views/ActivityPhotos.vue` (新建)

**Frontend - Updated Files**:
- 活動詳情頁面: `frontend/src/views/ActivityDetail.vue` (整合照片上傳)
- 路由: `frontend/src/router/index.js` (新增相簿路由)
- API 函數: `frontend/src/api/activities.js` (新增照片相關函數)
- 測試: `frontend/tests/unit/components/activity/PhotoUploader.spec.js` (新建)

### Testing Requirements

**Unit Testing (Vitest)** [Source: architecture/11-測試策略-testing-requirements.md]:
- 測試 `PhotoUploader.vue` 組件
- 測試檔案類型驗證
- 測試檔案大小驗證
- 測試上傳數量限制
- 測試 `ActivityPhotos.vue` 頁面
- 測試照片刪除功能
- 覆蓋率目標：> 80%

**Backend Testing (pytest)**:
- 測試照片上傳 API（成功和各種失敗情況）
- 測試參與者權限檢查
- 測試檔案類型和大小驗證
- 測試獲取照片 API（含分頁）
- 測試刪除照片 API（含權限檢查）
- 測試檔案系統操作

### Technical Constraints

1. **檔案大小限制：5MB**（前後端都要驗證）
2. **上傳數量限制：10 張**（前後端都要驗證）
3. **支援的格式：JPG, JPEG, PNG, GIF, WEBP**
4. **縮圖尺寸：300x300**（後端生成）
5. **權限控制：只有參與者可上傳，上傳者和組織者可刪除**

### UI/UX 考量

**照片網格建議**:
- 使用 CSS Grid 自動填充
- 響應式斷點：桌面 4-6 欄、平板 3-4 欄、手機 2-3 欄
- 照片比例固定為 1:1（正方形）
- Hover 時顯示上傳者和時間資訊

**上傳 UX**:
- 拖放上傳（drag & drop）
- 圖片預覽
- 進度條顯示
- 多選功能
- 即時驗證（前端）

**燈箱 UX**:
- 滑動切換（手機版）
- 方向鍵切換（桌面版）
- ESC 關閉
- 顯示索引（3 / 25）
- 背景半透明遮罩

## Testing

### Frontend Testing
```bash
npm run test:unit
npm run test:coverage
```

### Backend Testing
```bash
pytest backend/tests/test_activities.py::test_upload_photos -v
pytest backend/tests/test_activities.py::test_get_photos -v
pytest backend/tests/test_activities.py::test_delete_photo -v
```

### Manual Testing Checklist

- [ ] 參與者可以看到「上傳照片」按鈕
- [ ] 非參與者看不到「上傳照片」按鈕
- [ ] 未登入用戶看不到「上傳照片」按鈕
- [ ] 可以選擇多張照片（最多 10 張）
- [ ] 檔案類型驗證正常（只允許圖片）
- [ ] 檔案大小驗證正常（≤ 5MB）
- [ ] 上傳前顯示圖片預覽
- [ ] 上傳過程中顯示進度條
- [ ] 上傳成功後顯示成功訊息並重新載入
- [ ] 上傳失敗後顯示錯誤訊息
- [ ] 相簿區塊顯示最新 6 張照片縮圖
- [ ] 「查看所有照片」按鈕導航至完整相簿頁面
- [ ] 完整相簿頁面顯示所有照片（響應式網格）
- [ ] 照片縮圖顯示上傳者姓名和時間
- [ ] 點擊照片可放大檢視（燈箱效果）
- [ ] 燈箱支援左右切換
- [ ] 燈箱支援方向鍵切換
- [ ] 燈箱支援 ESC 關閉
- [ ] 燈箱顯示照片索引
- [ ] 照片上傳者可以看到自己照片的「刪除」按鈕
- [ ] 活動組織者可以看到所有照片的「刪除」按鈕
- [ ] 其他用戶看不到「刪除」按鈕
- [ ] 刪除照片前顯示確認對話框
- [ ] 刪除成功後移除照片並顯示成功訊息
- [ ] 空狀態正確顯示（無照片時）
- [ ] 分頁功能正常運作
- [ ] 懶載入正常運作
- [ ] 縮圖正常生成和顯示

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*此區塊由開發代理在實作時填寫*

### Agent Model Used

(待開發代理填寫)

### Debug Log References

(待開發代理填寫)

### Completion Notes List

(待開發代理填寫)

### File List

(待開發代理填寫)

## QA Results

*此區塊由 QA 代理審查後更新審查結果*
