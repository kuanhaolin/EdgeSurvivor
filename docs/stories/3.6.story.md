# Story 3.6: 查看媒合統計

## Status
Cancelled

**取消原因：** 此功能目前不需要實作，暫不列入開發計畫。

## Story

**As a** 已登入用戶,
**I want** 查看我的媒合成功率和歷史記錄,
**so that** 我可以了解我的媒合表現

## Acceptance Criteria

1. 顯示媒合總數、成功數、拒絕數
2. 顯示媒合成功率
3. 顯示最近成功媒合的旅伴
4. 顯示基於活動的媒合 vs 直接媒合的比例
5. 可以查看歷史媒合記錄

## Tasks / Subtasks

### Phase 1: 後端 API - 媒合統計端點 (AC: 1, 2, 3, 4, 5)

- [ ] **Task 1.1**: 實作 GET /api/matches/stats 端點 (AC: 1, 2, 3, 4, 5)
  - [ ] 在 ackend/blueprints/matches.py 新增 /stats 路由
  - [ ] 使用 @jwt_required() 裝飾器保護端點
  - [ ] 使用 get_jwt_identity() 取得當前用戶 ID [Source: brownfield-architecture.md#認證 API]
  - [ ] 實作資料庫查詢邏輯統計媒合記錄
  - [ ] 返回 JSON 格式的統計資料

- [ ] **Task 1.2**: 實作媒合統計計算邏輯 (AC: 1, 2, 4)
  - [ ] 查詢 Match 表，篩選 user_a == current_user_id 或 user_b == current_user_id
  - [ ] 統計總媒合數量（所有狀態的媒合記錄）
  - [ ] 統計成功媒合數量（status == 'confirmed'）[Source: brownfield-architecture.md#Match 模型]
  - [ ] 統計拒絕媒合數量（status == 'rejected'）
  - [ ] 計算媒合成功率 = confirmed 數量 / 總申請數量 * 100
  - [ ] 統計基於活動的媒合數量（activity_id IS NOT NULL）
  - [ ] 統計直接媒合數量（activity_id IS NULL）[Source: brownfield-architecture.md#Match 模型]

- [ ] **Task 1.3**: 查詢最近成功媒合的旅伴資訊 (AC: 3)
  - [ ] 查詢 status == 'confirmed' 的 Match 記錄
  - [ ] 使用 order_by(Match.confirmed_date.desc()) 按確認日期排序
  - [ ] 限制返回最近 5-10 筆記錄（使用 .limit(10)）
  - [ ] 使用 joinedload() 預載關聯的 User 資料避免 N+1 查詢 [Source: brownfield-architecture.md#效能瓶頸]
  - [ ] 序列化旅伴資訊（user_id, name, avatar, interests）

- [ ] **Task 1.4**: 構建 API 回應格式 (AC: 1, 2, 3, 4)
  - [ ] 回應包含統計資訊：total_matches, confirmed_matches, rejected_matches, success_rate
  - [ ] 回應包含媒合類型比例：activity_based_count, direct_match_count
  - [ ] 回應包含最近成功媒合列表：recent_confirmed_matches[]
  - [ ] 每個旅伴包含：match_id, confirmed_date, partner (user_id, name, avatar, interests), activity (如有)
  - [ ] 使用 jsonify() 返回 JSON 回應，狀態碼 200

- [ ] **Task 1.5**: 錯誤處理與邊界條件 (AC: 所有)
  - [ ] 處理無媒合記錄的情況（返回 0 統計值）
  - [ ] 處理查詢異常，返回 500 錯誤和錯誤訊息
  - [ ] 確保除法運算時處理總數為 0 的情況（避免除以零）
  - [ ] 新增 try-except 包裝所有資料庫操作

### Phase 2: 前端實作 - 媒合統計頁面 (AC: 1, 2, 3, 4, 5)

- [ ] **Task 2.1**: 建立或擴充 Matches.vue 頁面 - 統計區塊 (AC: 1, 2, 3, 4)
  - [ ] 在 rontend/src/views/Matches.vue 新增統計顯示區塊
  - [ ] 使用 Vue 3 Composition API <script setup> 語法 [Source: brownfield-architecture.md#技術堆疊]
  - [ ] 使用 Element Plus 組件展示統計數據（el-card, el-statistic）
  - [ ] 顯示媒合總數、成功數、拒絕數的數字卡片
  - [ ] 顯示成功率百分比（使用進度條或圓形進度條）
  - [ ] 顯示活動媒合 vs 直接媒合的圓餅圖或比例條

- [ ] **Task 2.2**: 實作 API 呼叫邏輯 (AC: 1, 2, 3, 4, 5)
  - [ ] 建立 loadMatchStats() 函數呼叫 GET /api/matches/stats
  - [ ] 使用 Axios 實例發送請求，自動帶入 JWT Token [Source: brownfield-architecture.md#Axios 攔截器配置]
  - [ ] 在 onMounted() 生命週期鉤子中自動載入統計資料
  - [ ] 將 API 回應資料存入 reactive 變數（如 matchStats）
  - [ ] 處理載入狀態（loading）和錯誤狀態（error）

- [ ] **Task 2.3**: 顯示最近成功媒合的旅伴列表 (AC: 3, 5)
  - [ ] 使用 el-table 或 el-list 組件顯示旅伴列表
  - [ ] 每個旅伴顯示：頭像、姓名、興趣標籤、確認日期
  - [ ] 如果有關聯活動，顯示活動標題
  - [ ] 點擊旅伴可導航至該用戶的個人資料頁或開啟聊天室
  - [ ] 格式化確認日期為本地化格式（使用 dayjs）[Source: brownfield-architecture.md#技術堆疊]

- [ ] **Task 2.4**: 錯誤處理與用戶反饋 (AC: 所有)
  - [ ] API 請求失敗時顯示 Element Plus el-message 錯誤訊息
  - [ ] 無媒合記錄時顯示友善的空狀態訊息（如「您還沒有任何媒合記錄」）
  - [ ] 載入期間顯示 loading 動畫（el-skeleton 或 -loading）
  - [ ] 確保 Token 失效時導向登入頁（Axios 攔截器自動處理）

### Phase 3: 單元測試 (AC: 所有)

- [ ] **Task 3.1**: 後端單元測試 - GET /api/matches/stats (AC: 1, 2, 3, 4, 5)
  - [ ] 在 ackend/test/ 目錄建立 TC_3_6.py 測試檔案 [Source: brownfield-architecture.md#Repository 結構現狀]
  - [ ] 使用 Pytest 框架撰寫測試案例 [Source: brownfield-architecture.md#技術堆疊]
  - [ ] 測試案例：成功取得媒合統計（有媒合記錄）
  - [ ] 測試案例：無媒合記錄時返回零值統計
  - [ ] 測試案例：JWT Token 認證失敗返回 401
  - [ ] 測試案例：成功率計算正確
  - [ ] 測試案例：活動媒合與直接媒合數量統計正確
  - [ ] 測試案例：最近成功媒合列表按日期排序且數量限制正確
  - [ ] 使用 conftest.py 中的 fixtures（client, auth_token）[Source: brownfield-architecture.md#Repository 結構現狀]

- [ ] **Task 3.2**: 前端單元測試 - Matches.vue 統計區塊 (AC: 1, 2, 3, 4)
  - [ ] 在 rontend/tests/ 或 rontend/test/ 目錄建立測試檔案
  - [ ] 使用 Vitest 測試框架 [Source: brownfield-architecture.md#技術堆疊]
  - [ ] 測試案例：統計數據正確顯示
  - [ ] 測試案例：API 失敗時顯示錯誤訊息
  - [ ] 測試案例：空狀態正確顯示
  - [ ] Mock Axios 請求模擬 API 回應

### Phase 4: 整合測試與驗證 (AC: 所有)

- [ ] **Task 4.1**: 手動整合測試 (AC: 1, 2, 3, 4, 5)
  - [ ] 登入系統並導航至媒合頁面
  - [ ] 驗證統計數據區塊正確顯示
  - [ ] 驗證媒合總數、成功數、拒絕數數字正確
  - [ ] 驗證成功率百分比計算正確
  - [ ] 驗證活動媒合與直接媒合比例正確顯示
  - [ ] 驗證最近成功媒合旅伴列表顯示且按日期排序
  - [ ] 測試無媒合記錄的情況（新用戶）
  - [ ] 測試 Token 過期時的錯誤處理

- [ ] **Task 4.2**: 跨瀏覽器測試 (AC: 所有)
  - [ ] 在 Chrome 測試功能正常
  - [ ] 在 Firefox 測試功能正常
  - [ ] 在 Safari/Edge 測試功能正常（如可用）
  - [ ] 確認響應式設計在手機和平板正常顯示

## Dev Notes

### Previous Story Insights
- Story 3.5 為驗證型故事，確認了現有媒合記錄查詢功能正常運作
- 已存在的 API 端點：GET /api/matches/sent（查詢已發送）、GET /api/matches/pending（查詢收到的）、GET /api/matches（查詢已媒合）
- 識別了 N+1 查詢問題，建議使用 joinedload() 預載關聯資料 [Source: Story 3.5 QA Results]

### Data Models
**Match 模型** [Source: brownfield-architecture.md#Match 模型]:
- 主鍵：match_id
- 關聯欄位：ctivity_id（可為 NULL，支援直接媒合）、user_a（申請者）、user_b（被申請者）
- 狀態欄位：status - 'pending', 'confirmed', 'rejected', 'cancelled'
- 時間戳欄位：match_date（申請時間）, confirmed_date（確認時間）, cancel_date（取消時間）
- 其他欄位：message（申請訊息）, 
ejection_reason（拒絕原因）

**User 模型** [Source: brownfield-architecture.md#User 模型]:
- 主鍵：user_id
- 基本資訊：
ame, email, profile_picture (或 vatar), io
- 興趣：interests - JSON 字串格式儲存興趣標籤
- 評價統計：
ating_count, verage_rating

### API Specifications
**新增端點：GET /api/matches/stats** [新實作]:
- **路徑**：/api/matches/stats
- **方法**：GET
- **認證**：需要 JWT Token（@jwt_required() 裝飾器）
- **請求參數**：無（從 JWT Token 取得當前用戶 ID）
- **回應格式** (200 OK):
`json
{
  "total_matches": 15,
  "confirmed_matches": 8,
  "rejected_matches": 3,
  "pending_matches": 2,
  "cancelled_matches": 2,
  "success_rate": 53.33,
  "activity_based_count": 10,
  "direct_match_count": 5,
  "recent_confirmed_matches": [
    {
      "match_id": 12,
      "confirmed_date": "2025-12-15T14:30:00",
      "partner": {
        "user_id": 5,
        "name": "Alice",
        "avatar": "https://...",
        "interests": ["hiking", "travel"]
      },
      "activity": {
        "activity_id": 7,
        "title": "墾丁三日遊"
      }
    }
  ]
}
`
- **錯誤回應**：
  - 401 Unauthorized：Token 無效或未提供
  - 500 Internal Server Error：伺服器錯誤

**資料庫查詢邏輯**:
- 查詢所有與當前用戶相關的媒合記錄：Match.query.filter(db.or_(Match.user_a == current_user_id, Match.user_b == current_user_id)).all()
- 使用 SQLAlchemy 2.x 語法：db.or_() 用於 OR 條件 [Source: brownfield-architecture.md#資料庫連接配置]
- 預載關聯資料：Match.query.options(joinedload(Match.user_a_ref), joinedload(Match.user_b_ref)).filter(...)（避免 N+1 查詢）

### File Locations
- **後端 API 檔案**：ackend/blueprints/matches.py - 新增 @matches_bp.route('/stats', methods=['GET']) 函數 [Source: brownfield-architecture.md#Blueprint 架構]
- **前端頁面**：rontend/src/views/Matches.vue - 擴充現有媒合管理頁面，新增統計顯示區塊
- **測試檔案**：ackend/test/TC_3_6.py - 後端單元測試 [Source: brownfield-architecture.md#Repository 結構現狀]
- **前端測試**：rontend/tests/ 或 rontend/test/ - 前端單元測試

### Testing Requirements
**測試框架與標準** [Source: brownfield-architecture.md#技術堆疊]:
- 後端：Pytest 框架，測試檔案命名 TC_*.py
- 前端：Vitest 框架（Vue 測試工具）
- 測試配置：pytest.ini - 設定覆蓋率要求 --cov-fail-under=70

**測試策略**:
1. **後端單元測試**：
   - 測試 API 端點的認證、權限、回應格式
   - 測試統計計算邏輯的正確性
   - 測試邊界條件（無媒合記錄、除以零等）
   - 使用 conftest.py 中的 fixtures（client, uth_token, 測試資料庫）

2. **前端單元測試**：
   - 測試組件渲染與資料顯示
   - 測試 API 呼叫與錯誤處理
   - Mock Axios 請求

3. **整合測試**：
   - 端到端測試：從前端發起請求到後端返回資料的完整流程
   - 測試不同媒合狀態和數量的顯示

### Technical Constraints
- **JWT Token 管理**：使用 Flask-JWT-Extended，Token 儲存在 localStorage [Source: brownfield-architecture.md#Axios 攔截器配置]
- **CORS 配置**：後端已配置允許前端域名跨域請求 [Source: brownfield-architecture.md#已知限制與注意事項]
- **資料庫連接池**：pool_size=20, max_overflow=40 [Source: brownfield-architecture.md#資料庫連接配置]
- **響應時間要求**：API 回應時間應 < 200ms（一般媒合數量）[Source: Story 3.5 QA Results]

### Project Structure Notes
- **Monorepo 結構**：前後端在同一 repository，分別位於 ackend/ 和 rontend/ 目錄 [Source: brownfield-architecture.md#專案架構模式]
- **Blueprint 架構**：所有媒合相關 API 在 matches_bp Blueprint 中，URL 前綴 /api/matches [Source: brownfield-architecture.md#Blueprint 架構]
- **Vue Router**：前端路由使用 meta.requiresAuth 標記需要認證的頁面 [Source: brownfield-architecture.md#路由結構]

### Implementation Guidelines
1. **後端優先**：先完成 API 端點實作和測試，確保資料正確返回
2. **使用 joinedload**：避免 N+1 查詢問題，預載關聯的 User 資料
3. **錯誤處理**：所有資料庫操作使用 try-except 包裝，返回適當的 HTTP 狀態碼
4. **前端響應式**：確保統計頁面在不同螢幕尺寸下正常顯示
5. **本地化**：日期格式使用 zh-TW locale（前端使用 dayjs）
6. **空狀態設計**：無媒合記錄時顯示友善的空狀態訊息，引導用戶發起媒合

### Testing
**測試檔案位置** [Source: brownfield-architecture.md#Repository 結構現狀]:
- 後端測試：ackend/test/TC_3_6.py
- 前端測試：rontend/tests/ 或 rontend/test/

**測試標準**:
- 使用 Pytest 框架進行後端測試
- 使用 Vitest 進行前端測試
- 測試覆蓋率要求：70% 以上（pytest.ini 配置）
- 測試案例應涵蓋成功路徑、錯誤處理、邊界條件

**測試執行指令** [Source: brownfield-architecture.md#常用指令與腳本]:
`ash
# 後端測試
pytest backend/test/TC_3_6.py

# 前端測試
npm run test

# 測試覆蓋率
pytest --cov=backend --cov-report=html
`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-16 | 1.0 | 初始故事草稿建立 | Bob (Scrum Master) |
| 2025-12-16 | 1.1 | 標記為 Cancelled - 此功能目前不需要實作 | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used
_待開發代理完成_

### Debug Log References
_待開發代理完成_

### Completion Notes List
_待開發代理完成_

### File List
_待開發代理完成_

---

## QA Results
_待 QA 代理完成_
