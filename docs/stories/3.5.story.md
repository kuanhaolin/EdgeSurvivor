# Story 3.5: 活動狀態管理

## Status

Draft

## Story

**As a** 活動組織者,
**I want** 管理活動狀態（開放招募 / 進行中 / 已完成 / 已取消）,
**so that** 我可以控制活動的生命週期並讓參與者了解活動當前狀態。

## Acceptance Criteria

### 狀態定義

1. 系統支援以下四種活動狀態：
   - **recruiting** (開放招募)：活動正在招募參與者
   - **ongoing** (進行中)：活動已開始，正在進行
   - **completed** (已完成)：活動已結束
   - **cancelled** (已取消)：活動已被組織者取消

2. 新建立的活動預設狀態為 **recruiting**

### 權限控制

3. 只有活動組織者可以修改活動狀態

4. 非組織者嘗試修改狀態應返回 403 Forbidden 錯誤

5. 未登入用戶嘗試修改狀態應返回 401 Unauthorized 錯誤

### 狀態轉換規則

6. 從 **recruiting** 可以轉換為：
   - **ongoing**（活動開始）
   - **cancelled**（取消活動）

7. 從 **ongoing** 可以轉換為：
   - **completed**（活動結束）
   - **cancelled**（取消活動）

8. 從 **completed** 不可轉換為其他狀態（終止狀態）

9. 從 **cancelled** 不可轉換為其他狀態（終止狀態）

10. 嘗試非法狀態轉換應返回 400 錯誤並說明原因

### 前端 UI - 組織者視圖

11. 在活動詳情頁面，組織者應看到「管理狀態」按鈕或下拉選單

12. 點擊「管理狀態」後，顯示狀態選擇對話框

13. 狀態選擇對話框應：
    - 顯示目前狀態
    - 列出可轉換的狀態選項（根據轉換規則）
    - 禁用不可轉換的選項

14. 選擇新狀態後，顯示確認對話框：
    - 提示：「確定要將活動狀態改為『進行中』嗎？」
    - 提供「確定」和「取消」按鈕

15. 確認後發送 API 請求並顯示載入狀態

16. 成功後：
    - 顯示成功訊息：「狀態已更新為『進行中』」
    - 更新頁面顯示的狀態標籤
    - 不需重新載入整個頁面

17. 失敗後顯示錯誤訊息（例如：「狀態更新失敗，請稍後再試」）

### 前端 UI - 參與者視圖

18. 非組織者在活動詳情頁面不應看到「管理狀態」按鈕

19. 所有用戶都能看到活動的目前狀態標籤

20. 狀態標籤應使用不同顏色區分：
    - recruiting：綠色
    - ongoing：藍色
    - completed：灰色
    - cancelled：紅色

### 狀態變更的業務邏輯

21. 將狀態改為 **cancelled** 時：
    - 應通知所有參與者（透過系統通知，如已實作）
    - 參與者不可再加入活動

22. 將狀態改為 **ongoing** 時：
    - 參與者不可再加入活動
    - 參與者可以退出活動

23. 將狀態改為 **completed** 時：
    - 參與者不可再加入或退出活動
    - 活動相簿和討論仍可正常使用

24. 狀態變更應記錄時間戳記（`updated_at` 欄位自動更新）

### 後端 API

25. API 端點：`PATCH /api/activities/:activityId/status`

26. Request Body：
    ```json
    {
      "status": "ongoing"
    }
    ```

27. API 應驗證 JWT 認證

28. API 應驗證目前用戶是否為活動組織者

29. API 應驗證狀態轉換是否合法

30. 成功回應（200 OK）：
    ```json
    {
      "message": "活動狀態已更新",
      "activity": {
        "activity_id": 1,
        "status": "ongoing",
        "updated_at": "2025-11-05T15:30:00"
      }
    }
    ```

31. 錯誤回應：
    - 401：`{"error": "請先登入"}`
    - 403：`{"error": "只有組織者可以修改活動狀態"}`
    - 400：`{"error": "無效的狀態轉換：已完成的活動無法變更狀態"}`
    - 404：`{"error": "活動不存在"}`

### 列表頁面整合

32. 在活動列表頁面，狀態為 **cancelled** 的活動應：
    - 顯示「已取消」標籤
    - 可選：標題文字顯示刪除線

33. 在活動列表頁面，狀態為 **completed** 的活動應：
    - 顯示「已完成」標籤
    - 仍可點擊查看詳情

34. 預設篩選條件應只顯示 **recruiting** 和 **ongoing** 的活動

35. 提供「顯示已完成/已取消活動」的篩選選項

### 資料庫層級

36. `status` 欄位應使用資料庫枚舉（ENUM）或檢查約束

37. 確保 `status` 欄位不可為 NULL

38. `updated_at` 欄位應在狀態變更時自動更新

## Tasks / Subtasks

> **Brownfield 專案說明**：Activity Model 已有 `status` 欄位，後端需要新增狀態更新 API。前端需要在活動詳情頁面新增狀態管理 UI（僅組織者可見）。

### Phase 1: 後端 API 實作

- [ ] **Task 1: 實作狀態更新 API** (AC: 25-31, 36-38)
  - [ ] 在 `backend/blueprints/activities.py` 新增 `PATCH /activities/<id>/status` 端點
  - [ ] 實作 JWT 認證驗證
  - [ ] 實作組織者權限檢查
  - [ ] 實作狀態轉換規則驗證（使用狀態機模式或字典映射）
  - [ ] 實作狀態更新邏輯
  - [ ] 確保 `updated_at` 自動更新
  - [ ] 實作錯誤處理（401, 403, 400, 404）
  - [ ] 測試 API 端點
  - [ ] 記錄 API 規格

- [ ] **Task 2: 資料庫層級驗證** (AC: 36-38)
  - [ ] 檢查 `backend/models/activity.py` 中的 `status` 欄位定義
  - [ ] 確認使用 SQLAlchemy Enum 或檢查約束
  - [ ] 確認 `status` 欄位不可為 NULL
  - [ ] 確認 `updated_at` 欄位有 `onupdate` 設定
  - [ ] 測試資料庫約束

### Phase 2: 前端狀態管理組件

- [ ] **Task 3: 建立 StatusManager 組件** (AC: 11-17)
  - [ ] 在 `frontend/src/components/activity/` 建立 `StatusManager.vue`
  - [ ] 使用 Vue 3 Composition API 和 `<script setup>` 語法
  - [ ] 接收 props：`currentStatus`、`activityId`
  - [ ] 實作狀態轉換規則邏輯（根據目前狀態顯示可轉換選項）
  - [ ] 實作狀態選擇對話框（使用 `el-dialog` + `el-select`）
  - [ ] 實作確認對話框（使用 `ElMessageBox.confirm`）
  - [ ] 實作 API 呼叫（呼叫 `updateActivityStatus`）
  - [ ] Emit 'status-updated' 事件通知父組件
  - [ ] 實作成功/失敗訊息顯示
  - [ ] 測試組件

- [ ] **Task 4: 實作狀態文字和顏色映射** (AC: 1, 20)
  - [ ] 建立狀態文字對應（recruiting → 開放招募）
  - [ ] 建立狀態顏色對應（recruiting → success）
  - [ ] 建立狀態轉換規則映射
  - [ ] 測試映射邏輯

### Phase 3: 整合到活動詳情頁面

- [ ] **Task 5: 更新 ActivityDetail.vue 頁面** (AC: 11, 18, 19)
  - [ ] 導入 `StatusManager` 組件
  - [ ] 檢查目前用戶是否為組織者（比對 `creator.user_id` 與 `userStore.userId`）
  - [ ] 僅組織者可見「管理狀態」按鈕
  - [ ] 實作 `handleStatusUpdated` 函數更新頁面狀態
  - [ ] 測試整合

### Phase 4: API 服務層

- [ ] **Task 6: 更新 activities API 服務** (AC: 25)
  - [ ] 在 `frontend/src/api/activities.js` 新增 `updateActivityStatus` 函數：
    ```javascript
    export const updateActivityStatus = (activityId, status) => {
      return axios.patch(`/api/activities/${activityId}/status`, { status })
    }
    ```
  - [ ] 測試 API 函數

### Phase 5: 列表頁面整合

- [ ] **Task 7: 更新活動列表頁面** (AC: 32-35)
  - [ ] 為已取消活動標題添加刪除線樣式（CSS）
  - [ ] 確認狀態標籤正確顯示
  - [ ] 更新預設篩選條件（只顯示 recruiting 和 ongoing）
  - [ ] 新增「顯示已完成/已取消活動」篩選選項
  - [ ] 測試列表頁面

### Phase 6: 業務邏輯實作

- [ ] **Task 8: 實作狀態變更業務邏輯** (AC: 21-24)
  - [ ] 實作 cancelled 狀態的參與限制（前端和後端）
  - [ ] 實作 ongoing 狀態的參與限制
  - [ ] 實作 completed 狀態的參與和退出限制
  - [ ] 測試業務邏輯

### Phase 7: 測試

- [ ] **Task 9: 前端單元測試** (所有 AC)
  - [ ] 測試 `StatusManager.vue` 組件渲染
  - [ ] 測試狀態轉換規則
  - [ ] 測試組織者權限檢查
  - [ ] 測試狀態更新流程
  - [ ] 執行測試：`npm run test:unit`
  - [ ] 確認覆蓋率 > 80%

- [ ] **Task 10: 後端測試** (AC: 25-31)
  - [ ] 測試組織者可以更新狀態
  - [ ] 測試非組織者無法更新狀態（403）
  - [ ] 測試未登入用戶無法更新狀態（401）
  - [ ] 測試狀態轉換規則（合法和非法轉換）
  - [ ] 測試 404 錯誤
  - [ ] 執行測試：`pytest backend/tests/test_activities.py -v`

### Phase 8: 整合測試與驗收

- [ ] **Task 11: 端到端功能驗證** (所有 AC)
  - [ ] 手動測試完整狀態管理流程
  - [ ] 測試所有狀態轉換
  - [ ] 測試權限控制
  - [ ] 測試列表頁面顯示
  - [ ] 驗證所有 AC 滿足

## Dev Notes

### Previous Story Insights

**來自 Story 1.1 - 3.4 的經驗**：
- Vue 3 Composition API 是標準開發模式 [Source: architecture/4-組件標準-component-standards.md]
- Element Plus 組件庫已整合，使用 `el-dialog`、`el-select`、`el-button`、`ElMessageBox` 等組件 [Source: architecture/2-前端技術棧-frontend-tech-stack.md]
- JWT 認證機制完善 [Source: architecture/6-api-整合-api-integration.md]
- Pinia 用於狀態管理（用戶資訊） [Source: architecture/5-狀態管理-state-management.md]
- SQLAlchemy ORM 用於資料庫操作 [Source: backend/models/activity.py]
- Activity Model 已有 `status` 欄位 [Source: backend/models/activity.py]

### API Specifications

#### 更新活動狀態 API

**Endpoint**: `PATCH /api/activities/:activityId/status`

**Authentication**: Required (JWT Token)

**Path Parameters**:
- `activityId`: 活動 ID（整數）

**Request Body**:
```json
{
  "status": "ongoing"
}
```

**Validation Rules**:
- `status` 必須是以下值之一：`recruiting`, `ongoing`, `completed`, `cancelled`
- 只有組織者可以更新狀態
- 狀態轉換必須符合規則

**Response (Success - 200)**:
```json
{
  "message": "活動狀態已更新",
  "activity": {
    "activity_id": 1,
    "status": "ongoing",
    "updated_at": "2025-11-05T15:30:00"
  }
}
```

**Response (Errors)**:
```json
// 401 Unauthorized
{
  "error": "請先登入"
}

// 403 Forbidden
{
  "error": "只有組織者可以修改活動狀態"
}

// 400 Bad Request (無效轉換)
{
  "error": "無效的狀態轉換：已完成的活動無法變更狀態"
}

// 404 Not Found
{
  "error": "活動不存在"
}
```

### Backend Implementation Guide

**狀態轉換規則映射**:

```python
# backend/blueprints/activities.py

# 狀態轉換規則
STATUS_TRANSITIONS = {
    'recruiting': ['ongoing', 'cancelled'],
    'ongoing': ['completed', 'cancelled'],
    'completed': [],  # 終止狀態
    'cancelled': []   # 終止狀態
}

@activities_bp.route('/<int:activity_id>/status', methods=['PATCH'])
@jwt_required()
def update_activity_status(activity_id):
    """更新活動狀態（僅組織者）"""
    try:
        current_user_id = get_jwt_identity()
        data = request.get_json()
        new_status = data.get('status')
        
        # 驗證狀態值
        valid_statuses = ['recruiting', 'ongoing', 'completed', 'cancelled']
        if new_status not in valid_statuses:
            return jsonify({'error': f'無效的狀態值：{new_status}'}), 400
        
        # 查詢活動
        activity = Activity.query.filter_by(activity_id=activity_id).first()
        if not activity:
            return jsonify({'error': '活動不存在'}), 404
        
        # 檢查是否為組織者
        if activity.creator_id != current_user_id:
            return jsonify({'error': '只有組織者可以修改活動狀態'}), 403
        
        # 檢查狀態轉換是否合法
        current_status = activity.status
        allowed_transitions = STATUS_TRANSITIONS.get(current_status, [])
        
        if new_status == current_status:
            return jsonify({'error': f'活動已經是「{new_status}」狀態'}), 400
        
        if new_status not in allowed_transitions:
            status_names = {
                'recruiting': '開放招募',
                'ongoing': '進行中',
                'completed': '已完成',
                'cancelled': '已取消'
            }
            return jsonify({
                'error': f'無效的狀態轉換：{status_names[current_status]}的活動無法變更為{status_names[new_status]}'
            }), 400
        
        # 更新狀態
        activity.status = new_status
        activity.updated_at = datetime.utcnow()
        db.session.commit()
        
        return jsonify({
            'message': '活動狀態已更新',
            'activity': {
                'activity_id': activity.activity_id,
                'status': activity.status,
                'updated_at': activity.updated_at.isoformat()
            }
        }), 200
        
    except Exception as e:
        db.session.rollback()
        return jsonify({'error': str(e)}), 500
```

**Activity Model 檢查**:

```python
# backend/models/activity.py

from sqlalchemy import Enum

class Activity(db.Model):
    __tablename__ = 'activities'
    
    activity_id = db.Column(db.Integer, primary_key=True)
    status = db.Column(
        Enum('recruiting', 'ongoing', 'completed', 'cancelled', name='activity_status'),
        nullable=False,
        default='recruiting'
    )
    updated_at = db.Column(
        db.DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow  # 自動更新
    )
    # ... 其他欄位
```

### Frontend Implementation Guide

**StatusManager 組件範例**:

```vue
<script setup>
import { ref, computed } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { updateActivityStatus } from '@/api/activities'

const props = defineProps({
  currentStatus: {
    type: String,
    required: true
  },
  activityId: {
    type: Number,
    required: true
  }
})

const emit = defineEmits(['status-updated'])

const dialogVisible = ref(false)
const selectedStatus = ref('')
const loading = ref(false)

// 狀態轉換規則
const statusTransitions = {
  recruiting: ['ongoing', 'cancelled'],
  ongoing: ['completed', 'cancelled'],
  completed: [],
  cancelled: []
}

// 狀態文字對應
const statusTexts = {
  recruiting: '開放招募',
  ongoing: '進行中',
  completed: '已完成',
  cancelled: '已取消'
}

// 可轉換的狀態選項
const availableStatuses = computed(() => {
  const allowed = statusTransitions[props.currentStatus] || []
  return allowed.map(status => ({
    value: status,
    label: statusTexts[status]
  }))
})

const openDialog = () => {
  if (availableStatuses.value.length === 0) {
    ElMessage.warning('此狀態無法再變更')
    return
  }
  selectedStatus.value = ''
  dialogVisible.value = true
}

const handleConfirm = async () => {
  if (!selectedStatus.value) {
    ElMessage.warning('請選擇新狀態')
    return
  }
  
  try {
    await ElMessageBox.confirm(
      `確定要將活動狀態改為「${statusTexts[selectedStatus.value]}」嗎？`,
      '確認變更',
      {
        confirmButtonText: '確定',
        cancelButtonText: '取消',
        type: 'warning'
      }
    )
    
    loading.value = true
    await updateActivityStatus(props.activityId, selectedStatus.value)
    
    ElMessage.success(`狀態已更新為「${statusTexts[selectedStatus.value]}」`)
    emit('status-updated', selectedStatus.value)
    dialogVisible.value = false
    
  } catch (error) {
    if (error !== 'cancel') {
      const errorMsg = error.response?.data?.error || '狀態更新失敗，請稍後再試'
      ElMessage.error(errorMsg)
    }
  } finally {
    loading.value = false
  }
}

defineExpose({ openDialog })
</script>

<template>
  <div class="status-manager">
    <el-button type="primary" @click="openDialog">
      管理狀態
    </el-button>
    
    <el-dialog
      v-model="dialogVisible"
      title="變更活動狀態"
      width="400px"
    >
      <div class="mb-4">
        <p class="text-gray-600 mb-2">目前狀態：</p>
        <el-tag>{{ statusTexts[currentStatus] }}</el-tag>
      </div>
      
      <el-select
        v-model="selectedStatus"
        placeholder="請選擇新狀態"
        class="w-full"
      >
        <el-option
          v-for="option in availableStatuses"
          :key="option.value"
          :label="option.label"
          :value="option.value"
        />
      </el-select>
      
      <template #footer>
        <el-button @click="dialogVisible = false">取消</el-button>
        <el-button
          type="primary"
          :loading="loading"
          @click="handleConfirm"
        >
          確定
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>
```

**整合到 ActivityDetail.vue**:

```vue
<script setup>
import StatusManager from '@/components/activity/StatusManager.vue'

// ... 現有程式碼

const isCreator = computed(() => {
  return userStore.userId === activity.value?.creator?.user_id
})

const handleStatusUpdated = (newStatus) => {
  // 更新本地狀態，避免重新載入整個頁面
  if (activity.value) {
    activity.value.status = newStatus
    activity.value.updated_at = new Date().toISOString()
  }
}
</script>

<template>
  <!-- ... 現有內容 -->
  
  <!-- 組織者專用：狀態管理 -->
  <StatusManager
    v-if="isCreator"
    :current-status="activity.status"
    :activity-id="activity.activity_id"
    @status-updated="handleStatusUpdated"
  />
</template>
```

### Status Color Mappings (與 Story 3.2, 3.4 一致)

```javascript
const statusColors = {
  recruiting: 'success',  // 綠色
  ongoing: 'primary',     // 藍色
  completed: 'info',      // 灰色
  cancelled: 'danger'     // 紅色
}

const statusTexts = {
  recruiting: '開放招募',
  ongoing: '進行中',
  completed: '已完成',
  cancelled: '已取消'
}
```

### File Locations

**Backend** (更新):
- API: `backend/blueprints/activities.py` (新增 PATCH 端點)
- Model: `backend/models/activity.py` (檢查 status 欄位定義)
- 測試: `backend/tests/test_activities.py` (新增測試)

**Frontend - New Files**:
- 狀態管理組件: `frontend/src/components/activity/StatusManager.vue` (新建)

**Frontend - Updated Files**:
- 活動詳情頁面: `frontend/src/views/ActivityDetail.vue` (整合 StatusManager)
- 活動列表頁面: `frontend/src/views/Activities.vue` (更新篩選和樣式)
- API 函數: `frontend/src/api/activities.js` (新增 `updateActivityStatus`)
- 測試: `frontend/tests/unit/components/activity/StatusManager.spec.js` (新建)

### Testing Requirements

**Unit Testing (Vitest)** [Source: architecture/11-測試策略-testing-requirements.md]:
- 測試 `StatusManager.vue` 組件渲染
- 測試狀態轉換規則邏輯
- 測試組織者權限檢查
- 測試狀態更新流程
- 測試錯誤處理
- 覆蓋率目標：> 80%

**Backend Testing (pytest)**:
- 測試組織者可以更新狀態
- 測試非組織者被拒絕（403）
- 測試未登入被拒絕（401）
- 測試合法狀態轉換
- 測試非法狀態轉換（400）
- 測試 404 錯誤
- 測試 `updated_at` 自動更新

### Technical Constraints

1. **狀態轉換規則必須在前後端都實作**（前端用於 UI 控制，後端用於安全驗證）
2. **使用資料庫 ENUM 約束**（確保資料完整性）
3. **組織者權限檢查必須在後端執行**（前端隱藏 UI 只是 UX 優化）
4. **狀態變更應記錄時間**（`updated_at` 自動更新）
5. **狀態變更應考慮對參與功能的影響**（cancelled/ongoing/completed 限制參加）

### UI/UX 考量

**狀態管理按鈕位置建議**:
- 桌面版：放在活動標題旁或右側資訊卡片中
- 手機版：放在活動標題下方或底部固定按鈕

**狀態轉換確認訊息**:
- recruiting → ongoing：「確定要開始活動嗎？開始後將無法再招募新成員。」
- recruiting → cancelled：「確定要取消活動嗎？所有參與者將收到通知。」
- ongoing → completed：「確定要結束活動嗎？結束後狀態將無法變更。」
- ongoing → cancelled：「確定要取消活動嗎？活動正在進行中。」

**列表頁面樣式**:
```css
.activity-cancelled .activity-title {
  text-decoration: line-through;
  opacity: 0.6;
}
```

## Testing

### Frontend Testing
```bash
npm run test:unit
npm run test:coverage
```

### Backend Testing
```bash
pytest backend/tests/test_activities.py::test_update_activity_status -v
```

### Manual Testing Checklist

- [ ] 組織者在活動詳情頁面可以看到「管理狀態」按鈕
- [ ] 非組織者在活動詳情頁面看不到「管理狀態」按鈕
- [ ] 點擊「管理狀態」按鈕顯示狀態選擇對話框
- [ ] 狀態選擇對話框顯示目前狀態
- [ ] 狀態選擇對話框只列出可轉換的狀態選項
- [ ] 選擇新狀態後顯示確認對話框
- [ ] 確認後成功更新狀態並顯示成功訊息
- [ ] 狀態更新後頁面顯示的狀態標籤正確更新
- [ ] 狀態更新不需重新載入整個頁面
- [ ] 測試所有合法狀態轉換（recruiting→ongoing, recruiting→cancelled, ongoing→completed, ongoing→cancelled）
- [ ] 測試非法狀態轉換（completed→任何, cancelled→任何）顯示錯誤訊息
- [ ] 測試非組織者嘗試更新狀態（前端不顯示按鈕，後端返回 403）
- [ ] 測試未登入用戶嘗試更新狀態（後端返回 401）
- [ ] 狀態標籤顏色正確（recruiting綠、ongoing藍、completed灰、cancelled紅）
- [ ] 列表頁面已取消活動標題顯示刪除線
- [ ] 列表頁面預設不顯示已完成和已取消活動
- [ ] 列表頁面篩選可以顯示已完成和已取消活動
- [ ] cancelled 狀態的活動不允許新參與者加入
- [ ] ongoing 狀態的活動不允許新參與者加入
- [ ] completed 狀態的活動不允許參與者加入或退出

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*此區塊由開發代理在實作時填寫*

### Agent Model Used

(待開發代理填寫)

### Debug Log References

(待開發代理填寫)

### Completion Notes List

(待開發代理填寫)

### File List

(待開發代理填寫)

## QA Results

*此區塊由 QA 代理審查後更新審查結果*
