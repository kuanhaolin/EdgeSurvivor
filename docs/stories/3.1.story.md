# Story 3.1: 建立活動

## Status

Draft

## Story

**As a** 活動組織者,
**I want** 建立一項新活動，包含標題、日期、地點、描述、類別、人數上限、費用和封面圖,
**so that** 我可以吸引志同道合的旅伴加入我的活動。

## Acceptance Criteria

### 建立活動表單設計

1. 提供「建立活動」入口：
   - 在導航欄或控制台顯示「建立活動」按鈕
   - 點擊後跳轉到 `/activities/create` 路由

2. 建立活動頁面應包含以下表單欄位：
   - **活動標題** (必填)：單行文字輸入，最多 200 字
   - **活動類型** (必填)：下拉選單，選項包括：
     - `adventure` - 冒險探索
     - `culture` - 文化體驗
     - `leisure` - 休閒放鬆
     - `food` - 美食之旅
     - `sports` - 運動健身
     - `other` - 其他
   - **活動日期** (必填)：
     - 開始日期（日期選擇器）
     - 結束日期（日期選擇器，選填）
     - 結束日期必須晚於或等於開始日期
   - **活動地點** (必填)：單行文字輸入，最多 200 字
   - **活動描述** (必填)：多行文字輸入，最少 20 字，最多 2000 字
   - **人數上限** (必填)：數字輸入，最小值 2，最大值 50，預設值 2
   - **預估費用** (選填)：數字輸入，最小值 0，預設值 0，顯示單位「NT$」
   - **集合地點** (選填)：單行文字輸入，最多 255 字
   - **預計時長** (選填)：數字輸入，單位「小時」，最小值 1
   - **難度等級** (選填)：下拉選單，選項：`easy`、`medium`、`hard`
   - **性別偏好** (選填)：下拉選單，選項：`any`（不限）、`male`（男性）、`female`（女性）
   - **年齡限制** (選填)：
     - 最小年齡：數字輸入，最小值 1，最大值 100
     - 最大年齡：數字輸入，最小值 1，最大值 100
     - 最大年齡必須大於最小年齡
   - **特別注意事項** (選填)：多行文字輸入，最多 1000 字
   - **封面圖片** (選填)：圖片上傳器，支援 JPG、PNG、WEBP 格式，最大 16MB

3. 表單驗證規則：
   - 所有必填欄位不能為空
   - 日期欄位：開始日期不能早於今天，結束日期不能早於開始日期
   - 人數上限：2-50 之間的整數
   - 費用：非負數，最多兩位小數
   - 描述：最少 20 字
   - 年齡限制：最大年齡 > 最小年齡（如果兩者都填寫）

### 使用者體驗

4. 表單欄位應使用 Element Plus 的表單組件（`el-form`、`el-input`、`el-select` 等）

5. 必填欄位應標記紅色星號（*）

6. 提供即時表單驗證，錯誤訊息應顯示在欄位下方

7. 提供「提交」和「取消」按鈕：
   - 「提交」按鈕：primary 類型，點擊後驗證表單並提交
   - 「取消」按鈕：default 類型，點擊後返回上一頁

8. 提交時應顯示載入狀態（按鈕 loading 效果）

9. 成功建立後：
   - 顯示成功訊息：「活動已成功建立」
   - 跳轉到該活動的詳情頁（`/activities/{activity_id}`）

10. 建立失敗時：
    - 顯示具體錯誤訊息
    - 保持在建立頁面，保留已填寫的資料

### 後端 API

11. API 端點：`POST /api/activities`

12. 請求 Body 格式（JSON）：
    ```json
    {
      "title": "陽明山登山之旅",
      "type": "adventure",
      "start_date": "2025-11-10",
      "end_date": "2025-11-10",
      "location": "陽明山國家公園",
      "description": "一起去陽明山呼吸新鮮空氣...",
      "max_members": 8,
      "cost": 500.00,
      "meeting_point": "捷運劍潭站 1 號出口",
      "duration_hours": 6,
      "difficulty_level": "medium",
      "gender_preference": "any",
      "age_min": 18,
      "age_max": 50,
      "notes": "請攜帶登山杖和防曬用品"
    }
    ```

13. 成功回應（201 Created）：
    ```json
    {
      "message": "活動創建成功",
      "activity": {
        "activity_id": 123,
        "title": "陽明山登山之旅",
        "status": "recruiting",
        "creator_id": 1,
        "current_participants": 1,
        ...
      }
    }
    ```

14. 錯誤回應（400 Bad Request）：
    ```json
    {
      "error": "title is required"
    }
    ```

### 後端驗證

15. API 應驗證 JWT 認證（使用者必須登入）

16. 驗證必填欄位：`title`、`type`、`location`、`start_date`、`max_members`

17. 驗證日期邏輯：
    - `start_date` 不能早於今天
    - `end_date` 不能早於 `start_date`（如果提供）

18. 驗證數字範圍：
    - `max_members`：2-50
    - `cost`：>= 0
    - `age_min` 和 `age_max`：1-100，且 `age_max` > `age_min`

19. 建立活動時：
    - 自動設定 `creator_id` 為當前登入使用者
    - 自動設定 `status` 為 `recruiting`（開放招募）
    - 自動設定 `created_at` 和 `updated_at` 時間戳
    - 自動將創建者加入參與者列表（`ActivityParticipant` 表），角色為 `creator`，狀態為 `joined`

20. 建立成功後回傳完整的活動資料

### 封面圖上傳（選填功能）

21. 使用 `ImageUploader` 組件上傳封面圖

22. 上傳 API：`POST /api/upload/activity-cover`

23. 支援格式：JPG、PNG、WEBP

24. 檔案大小限制：最大 16MB

25. 上傳成功後，將圖片 URL 儲存到 `cover_image` 欄位

26. 前端應顯示上傳進度和預覽圖

### 效能與安全性

27. API 回應時間需低於 1000ms

28. 防止 SQL Injection（使用 ORM 參數化查詢）

29. 防止 XSS 攻擊（前端輸入清理，後端輸出編碼）

30. 限制單一使用者建立活動的頻率（Rate Limiting）：每分鐘最多 3 次請求

## Tasks / Subtasks

> **Brownfield 專案說明**：後端 Activity Model 和 API 端點已存在，但需要確認是否支援所有必要欄位。前端需要建立完整的建立活動表單頁面。

### Phase 1: 後端檢查與調整

- [ ] **Task 1: 檢查 Activity Model** (AC: 2, 19)
  - [ ] 檢查 `backend/models/activity.py` 是否包含所有必要欄位
  - [ ] 確認欄位：`title`, `category`, `start_date`, `end_date`, `location`, `description`, `max_participants`, `cost`, `meeting_point`, `duration_hours`, `difficulty_level`, `gender_preference`, `age_min`, `age_max`, `notes`, `cover_image`, `status`, `creator_id`, `created_at`, `updated_at`
  - [ ] 如有缺少，添加新欄位並建立資料庫遷移
  - [ ] 確認 `to_dict()` 方法包含所有欄位
  - [ ] 記錄 Model 檢查結果

- [ ] **Task 2: 檢查並更新建立活動 API** (AC: 11-20)
  - [ ] 檢查 `backend/blueprints/activities.py` 中的 `POST /activities` 端點
  - [ ] 確認支援所有欄位的接收和驗證
  - [ ] 實作必填欄位驗證
  - [ ] 實作日期邏輯驗證（start_date >= 今天，end_date >= start_date）
  - [ ] 實作數字範圍驗證（max_members: 2-50, cost >= 0）
  - [ ] 確認創建活動時自動將創建者加入參與者列表
  - [ ] 測試 API 端點
  - [ ] 記錄 API 規格

### Phase 2: 前端頁面開發

- [ ] **Task 3: 建立 CreateActivity 頁面組件** (AC: 1, 2)
  - [ ] 在 `frontend/src/views/` 建立 `CreateActivity.vue`
  - [ ] 使用 Vue 3 Composition API 和 `<script setup>` 語法
  - [ ] 設計頁面佈局（使用 Element Plus 的 `el-form` 和 `el-card`）
  - [ ] 添加頁面標題「建立活動」
  - [ ] 建立表單資料結構（ref）
  - [ ] 測試頁面路由

- [ ] **Task 4: 實作表單欄位** (AC: 2)
  - [ ] 實作「活動標題」欄位（`el-input`，必填，maxlength 200）
  - [ ] 實作「活動類型」欄位（`el-select`，必填，選項映射）
  - [ ] 實作「活動日期」欄位（`el-date-picker`，開始日期必填，結束日期選填）
  - [ ] 實作「活動地點」欄位（`el-input`，必填，maxlength 200）
  - [ ] 實作「活動描述」欄位（`el-input type="textarea"`，必填，minlength 20，maxlength 2000）
  - [ ] 實作「人數上限」欄位（`el-input-number`，必填，min 2，max 50，default 2）
  - [ ] 實作「預估費用」欄位（`el-input-number`，選填，min 0，precision 2）
  - [ ] 實作「集合地點」欄位（`el-input`，選填，maxlength 255）
  - [ ] 實作「預計時長」欄位（`el-input-number`，選填，min 1，單位「小時」）
  - [ ] 實作「難度等級」欄位（`el-select`，選填）
  - [ ] 實作「性別偏好」欄位（`el-select`，選填）
  - [ ] 實作「年齡限制」欄位（兩個 `el-input-number`，選填）
  - [ ] 實作「特別注意事項」欄位（`el-input type="textarea"`，選填，maxlength 1000）
  - [ ] 測試所有欄位的顯示和基本輸入

- [ ] **Task 5: 實作表單驗證** (AC: 3, 6)
  - [ ] 使用 Element Plus 的表單驗證機制（`el-form` 的 `rules`）
  - [ ] 設定必填欄位的驗證規則
  - [ ] 設定日期邏輯驗證（開始日期 >= 今天，結束日期 >= 開始日期）
  - [ ] 設定人數上限驗證（2-50）
  - [ ] 設定費用驗證（>= 0）
  - [ ] 設定描述字數驗證（>= 20 字）
  - [ ] 設定年齡限制驗證（max > min）
  - [ ] 實作自定義驗證器函數
  - [ ] 測試所有驗證規則

- [ ] **Task 6: 實作表單提交邏輯** (AC: 7, 8, 9, 10)
  - [ ] 實作「提交」按鈕點擊處理函數
  - [ ] 在提交前驗證表單（`formRef.value.validate()`）
  - [ ] 顯示載入狀態（按鈕 loading）
  - [ ] 呼叫 API 提交表單資料
  - [ ] 處理成功回應：顯示成功訊息，跳轉到活動詳情頁
  - [ ] 處理錯誤回應：顯示錯誤訊息，保留表單資料
  - [ ] 實作「取消」按鈕：返回上一頁或跳轉到活動列表
  - [ ] 測試提交流程

### Phase 3: 前端 API 服務層

- [ ] **Task 7: 更新 activities API 服務** (AC: 11)
  - [ ] 檢查 `frontend/src/api/activities.js` 中的 `createActivity` 函數
  - [ ] 確認函數簽名正確：`createActivity(data)`
  - [ ] 確認請求方法為 `POST /api/activities`
  - [ ] 確認請求 Body 格式正確
  - [ ] 測試 API 函數

### Phase 4: 封面圖上傳（選填功能）

- [ ] **Task 8: 整合圖片上傳組件** (AC: 2, 21-26)
  - [ ] 確認 `ImageUploader` 組件存在於 `frontend/src/components/`
  - [ ] 在建立活動表單中添加封面圖上傳區域
  - [ ] 綁定上傳的圖片 URL 到表單資料的 `cover_image` 欄位
  - [ ] 實作上傳進度顯示
  - [ ] 實作圖片預覽
  - [ ] 測試圖片上傳功能

### Phase 5: 路由配置

- [ ] **Task 9: 添加建立活動路由** (AC: 1)
  - [ ] 在 `frontend/src/router/index.js` 添加路由定義
  - [ ] 路徑：`/activities/create`
  - [ ] 組件：`CreateActivity.vue`
  - [ ] 設定路由守衛：需要登入才能訪問
  - [ ] 設定頁面標題 meta 資訊
  - [ ] 測試路由跳轉

- [ ] **Task 10: 添加建立活動入口** (AC: 1)
  - [ ] 在導航欄或控制台添加「建立活動」按鈕
  - [ ] 按鈕點擊後跳轉到 `/activities/create`
  - [ ] 測試入口連結

### Phase 6: 測試

- [ ] **Task 11: 前端單元測試** (AC: 所有)
  - [ ] 測試 `CreateActivity.vue` 組件渲染
  - [ ] 測試表單欄位綁定
  - [ ] 測試表單驗證規則
  - [ ] 測試提交邏輯（Mock API）
  - [ ] 執行測試：`npm run test:unit`
  - [ ] 確認覆蓋率 > 80%

- [ ] **Task 12: 後端測試** (AC: 15-20)
  - [ ] 測試建立活動 API（成功案例）
  - [ ] 測試必填欄位驗證
  - [ ] 測試日期邏輯驗證
  - [ ] 測試數字範圍驗證
  - [ ] 測試 JWT 認證
  - [ ] 測試創建者自動加入參與者列表
  - [ ] 執行測試：`pytest backend/tests/test_activities.py -v`

### Phase 7: 整合測試與驗收

- [ ] **Task 13: 端到端功能驗證** (所有 AC)
  - [ ] 手動測試建立活動完整流程
  - [ ] 測試所有表單欄位的輸入和驗證
  - [ ] 測試成功建立後跳轉到活動詳情頁
  - [ ] 測試錯誤處理
  - [ ] 測試封面圖上傳（如果實作）
  - [ ] 驗證所有 AC 滿足

## Dev Notes

### Previous Story Insights

**來自 Story 1.1 - 2.6 的經驗**：
- Vue 3 Composition API 是標準開發模式 [Source: architecture/4-組件標準-component-standards.md]
- Element Plus 組件庫已整合，使用 `el-form`、`el-input`、`el-select` 等組件 [Source: architecture/2-前端技術棧-frontend-tech-stack.md]
- Pinia Auth Store 用於管理認證狀態 [Source: architecture/5-狀態管理-state-management.md]
- JWT 認證機制完善，使用 `@jwt_required()` 裝飾器 [Source: architecture/6-api-整合-api-integration.md]
- Axios 攔截器已配置，自動添加 JWT Token 和錯誤處理 [Source: architecture/6-api-整合-api-integration.md]
- 確認對話框使用 `ElMessageBox.confirm()` [Source: stories/2.5.story.md]
- Day.js 用於日期時間處理 [Source: architecture/2-前端技術棧-frontend-tech-stack.md]
- 表單驗證使用 Element Plus 的內建驗證機制 [Source: architecture/4-組件標準-component-standards.md]

### Data Models

**Activity Model - 完整欄位定義**

[Source: backend/models/activity.py]

```python
class Activity(db.Model):
    __tablename__ = 'activities'
    
    # 主鍵
    activity_id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    
    # 基本資訊
    title = db.Column(db.String(200), nullable=False)
    category = db.Column(db.String(50))  # adventure, culture, leisure, food, sports, other
    date = db.Column(db.Date, nullable=False)  # 舊欄位，向後兼容
    start_date = db.Column(db.Date)  # 活動開始日期
    end_date = db.Column(db.Date)  # 活動結束日期
    location = db.Column(db.String(200), nullable=False)
    description = db.Column(db.Text)
    max_participants = db.Column(db.Integer, default=2)
    cost = db.Column(Numeric(10, 2), default=0.00)
    status = db.Column(db.String(20), default='active')  # active, completed, cancelled
    creator_id = db.Column(db.Integer, db.ForeignKey('users.user_id'), nullable=False)
    
    # 額外屬性
    meeting_point = db.Column(db.String(255))  # 集合地點
    duration_hours = db.Column(db.Integer)  # 預計時長（小時）
    difficulty_level = db.Column(db.String(20))  # easy, medium, hard
    gender_preference = db.Column(db.String(20))  # any, male, female
    age_min = db.Column(db.Integer)
    age_max = db.Column(db.Integer)
    notes = db.Column(db.Text)  # 特別注意事項
    
    # 圖片相關
    cover_image = db.Column(db.String(500))  # 封面圖片 URL
    images = db.Column(db.Text)  # 活動照片 URLs (JSON 格式)
    
    # 時間戳
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

**ActivityParticipant Model - 參與者關聯**

```python
# 創建活動時自動將創建者加入參與者列表
creator_participant = ActivityParticipant(
    activity_id=activity.activity_id,
    user_id=current_user_id,
    status='joined',
    role='creator'
)
```

### API Specifications

#### 建立活動

**Endpoint**: `POST /api/activities`

**Authentication**: Required (JWT Token)

**Request Body**:
```json
{
  "title": "陽明山登山之旅",
  "type": "adventure",
  "start_date": "2025-11-10",
  "end_date": "2025-11-10",
  "location": "陽明山國家公園",
  "description": "一起去陽明山呼吸新鮮空氣，享受大自然的美好。活動包含登山、野餐和攝影。",
  "max_members": 8,
  "cost": 500.00,
  "meeting_point": "捷運劍潭站 1 號出口",
  "duration_hours": 6,
  "difficulty_level": "medium",
  "gender_preference": "any",
  "age_min": 18,
  "age_max": 50,
  "notes": "請攜帶登山杖、防曬用品和足夠的飲用水"
}
```

**Response (Success - 201)**:
```json
{
  "message": "活動創建成功",
  "activity": {
    "activity_id": 123,
    "title": "陽明山登山之旅",
    "category": "adventure",
    "start_date": "2025-11-10",
    "end_date": "2025-11-10",
    "location": "陽明山國家公園",
    "status": "recruiting",
    "creator_id": 1,
    "current_participants": 1,
    "max_participants": 8,
    "cost": 500.00,
    "created_at": "2025-11-05T12:00:00Z",
    ...
  }
}
```

**Response (Error - 400)**:
```json
{
  "error": "title is required"
}
```

**Response (Error - 401)**:
```json
{
  "error": "未授權，請先登入"
}
```

### File Locations

**Backend** (已存在，需檢查):
- Model: `backend/models/activity.py` (檢查欄位完整性)
- API: `backend/blueprints/activities.py` (檢查 POST /activities 端點)
- 測試: `backend/tests/test_activities.py` (新增測試)

**Frontend - New Files**:
- 建立活動頁面: `frontend/src/views/CreateActivity.vue` (新建)

**Frontend - Updated Files**:
- API 函數: `frontend/src/api/activities.js` (檢查 createActivity 函數)
- 路由: `frontend/src/router/index.js` (添加 /activities/create 路由)
- 導航欄/控制台: 添加「建立活動」按鈕入口
- 測試: `frontend/tests/unit/views/CreateActivity.spec.js` (新建)

### Testing Requirements

**Unit Testing (Vitest)** [Source: architecture/11-測試策略-testing-requirements.md]:
- 測試 `CreateActivity.vue` 組件渲染
- 測試表單欄位綁定和驗證
- 測試提交邏輯（Mock API）
- 測試日期驗證邏輯
- 測試數字範圍驗證
- 覆蓋率目標：> 80%

**Backend Testing (pytest)**:
- 測試建立活動 API 成功案例
- 測試必填欄位驗證
- 測試日期邏輯驗證
- 測試數字範圍驗證
- 測試 JWT 認證
- 測試創建者自動加入參與者列表

**測試執行命令**:
```bash
# 前端單元測試
npm run test:unit

# 前端測試覆蓋率
npm run test:coverage

# 後端測試
pytest backend/tests/test_activities.py -v

# E2E 測試（選填）
npm run test:e2e
```

### Technical Constraints

1. **表單驗證必須在前後端都執行**（前端提供即時反饋，後端確保資料完整性）
2. **日期不能早於今天**（防止建立過期活動）
3. **創建者自動成為參與者**（確保資料一致性）
4. **使用 ORM 參數化查詢**（防止 SQL Injection）
5. **JWT Token 必須有效**（確保只有登入使用者可以建立活動）

### UI/UX 考量

**表單欄位映射**（前端 vs 後端）:
- 前端 `type` → 後端 `category`
- 前端 `max_members` → 後端 `max_participants`
- 前端 `start_date` → 後端 `start_date` 和 `date`（向後兼容）

**活動類型選項**:
```javascript
const activityTypes = [
  { value: 'adventure', label: '冒險探索' },
  { value: 'culture', label: '文化體驗' },
  { value: 'leisure', label: '休閒放鬆' },
  { value: 'food', label: '美食之旅' },
  { value: 'sports', label: '運動健身' },
  { value: 'other', label: '其他' }
]
```

**難度等級選項**:
```javascript
const difficultyLevels = [
  { value: 'easy', label: '簡單' },
  { value: 'medium', label: '中等' },
  { value: 'hard', label: '困難' }
]
```

**性別偏好選項**:
```javascript
const genderPreferences = [
  { value: 'any', label: '不限' },
  { value: 'male', label: '限男性' },
  { value: 'female', label: '限女性' }
]
```

**表單佈局建議**:
- 使用 `el-form` 的 `label-width` 統一標籤寬度
- 使用 `el-col` 和 `el-row` 實現響應式佈局
- 桌面：兩欄佈局，手機：單欄佈局
- 使用 `el-card` 包裝表單區塊

## Testing

### Frontend Testing
```bash
npm run test:unit
npm run test:coverage
```

### Backend Testing
```bash
pytest backend/tests/test_activities.py -v -k create
```

### Manual Testing Checklist

- [ ] 訪問 `/activities/create` 頁面正常顯示
- [ ] 所有表單欄位正確渲染
- [ ] 必填欄位顯示紅色星號
- [ ] 表單驗證正確（必填、日期邏輯、數字範圍）
- [ ] 提交成功後跳轉到活動詳情頁
- [ ] 提交失敗時顯示錯誤訊息並保留表單資料
- [ ] 取消按鈕正常返回
- [ ] 日期選擇器限制過去日期
- [ ] 結束日期不能早於開始日期
- [ ] 人數上限限制在 2-50 之間
- [ ] 費用只能輸入非負數
- [ ] 描述至少 20 字驗證
- [ ] 年齡限制邏輯正確（最大 > 最小）
- [ ] 封面圖上傳功能正常（如果實作）
- [ ] 創建者自動成為參與者
- [ ] 響應式設計在手機和桌面都正常

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*此區塊由開發代理在實作時填寫*

### Agent Model Used

(待開發代理填寫)

### Debug Log References

(待開發代理填寫)

### Completion Notes List

(待開發代理填寫)

### File List

(待開發代理填寫)

## QA Results

*此區塊由 QA 代理審查後更新審查結果*
