# Story 3.3: 搜尋與篩選活動

## Status

Draft

## Story

**As a** 用戶,
**I want** 根據地點、日期、性別、年齡、類型來搜尋和篩選活動,
**so that** 我可以快速找到符合我需求的活動。

## Acceptance Criteria

### 篩選器設計

1. 在活動列表頁面上方提供篩選器區域

2. 篩選器應包含以下欄位：
   - **關鍵字搜尋**：文字輸入框，可搜尋活動標題和描述
   - **活動類型**：下拉選單，選項包括：
     - 全部
     - 冒險探索 (adventure)
     - 文化體驗 (culture)
     - 休閒放鬆 (leisure)
     - 美食之旅 (food)
     - 運動健身 (sports)
     - 其他 (other)
   - **活動狀態**：下拉選單，選項包括：
     - 全部
     - 開放招募 (recruiting)
     - 進行中 (ongoing)
     - 已完成 (completed)
     - 已取消 (cancelled)
   - **活動日期**：日期範圍選擇器（開始日期 - 結束日期）
   - **活動地點**：文字輸入框
   - **性別偏好**：下拉選單，選項：全部、男性、女性、不限
   - **年齡範圍**：滑桿（slider），範圍 18-80 歲

3. 篩選器應可摺疊/展開：
   - 預設展開狀態
   - 提供「展開篩選」/「收合篩選」按鈕

4. 提供「重置」按鈕清除所有篩選條件

5. 提供「搜尋」按鈕套用篩選條件

### 篩選邏輯

6. 關鍵字搜尋應同時搜尋活動標題和描述（不區分大小寫）

7. 活動類型篩選應支援單選

8. 活動狀態篩選應支援單選

9. 日期篩選應篩選開始日期在指定範圍內的活動

10. 地點篩選應模糊匹配（包含關鍵字即可）

11. 性別偏好篩選：
    - 選擇「全部」：顯示所有活動
    - 選擇「男性」：只顯示性別偏好為「男性」或「不限」的活動
    - 選擇「女性」：只顯示性別偏好為「女性」或「不限」的活動
    - 選擇「不限」：只顯示性別偏好為「不限」的活動

12. 年齡範圍篩選：
    - 顯示活動的年齡限制與所選範圍有交集的活動
    - 例如：選擇 25-35 歲，應顯示年齡限制為 20-40 或 30-50 的活動

13. 多個篩選條件應為 AND 邏輯（同時滿足所有條件）

### 使用者體驗

14. 輸入篩選條件時，應即時顯示符合條件的活動數量（例如：「找到 12 個活動」）

15. 點擊「搜尋」按鈕後：
    - 發送 API 請求
    - 顯示載入狀態
    - 更新活動列表
    - 捲動到活動列表頂部

16. 點擊「重置」按鈕後：
    - 清除所有篩選條件
    - 重新載入所有活動
    - 關鍵字輸入框清空
    - 下拉選單恢復為「全部」
    - 日期選擇器清空
    - 年齡滑桿恢復為預設範圍（18-80）

17. 篩選條件應保存在 URL 查詢參數中，以便分享或收藏

18. 頁面載入時應從 URL 讀取篩選條件並自動套用

19. 如果沒有符合條件的活動：
    - 顯示空狀態：「沒有找到符合條件的活動」
    - 提示文字：「請嘗試調整篩選條件」
    - 提供「重置篩選」按鈕

### 後端 API

20. API 端點：`GET /api/activities`

21. 支援以下查詢參數：
    - `search`: 關鍵字搜尋
    - `category`: 活動類型
    - `status`: 活動狀態
    - `date_from`: 開始日期（YYYY-MM-DD）
    - `date_to`: 結束日期（YYYY-MM-DD）
    - `location`: 地點關鍵字
    - `gender`: 性別偏好
    - `age_min`: 最小年齡
    - `age_max`: 最大年齡
    - `page`: 頁碼
    - `per_page`: 每頁數量

22. 成功回應（200 OK）：
    ```json
    {
      "activities": [...],
      "pagination": {
        "page": 1,
        "per_page": 12,
        "total": 25,
        "pages": 3
      },
      "filters": {
        "search": "登山",
        "category": "adventure",
        "status": "recruiting"
      }
    }
    ```

23. 如果沒有符合條件的活動，返回空陣列：
    ```json
    {
      "activities": [],
      "pagination": {
        "page": 1,
        "per_page": 12,
        "total": 0,
        "pages": 0
      }
    }
    ```

### 後端驗證與邏輯

24. API 應驗證 JWT 認證

25. 後端應實作以下篩選邏輯：
    - 關鍵字搜尋：使用 SQL `LIKE` 或 `ILIKE` 查詢標題和描述
    - 活動類型：精確匹配 `category` 欄位
    - 活動狀態：精確匹配 `status` 欄位
    - 日期範圍：`start_date BETWEEN date_from AND date_to`
    - 地點：使用 `LIKE` 模糊匹配 `location` 欄位
    - 性別偏好：根據邏輯篩選 `gender_preference` 欄位
    - 年齡範圍：檢查活動的年齡限制與所選範圍是否有交集

26. 篩選條件應可組合（支援多個條件同時存在）

27. 無效的查詢參數應被忽略（不返回錯誤）

28. 日期格式應驗證（YYYY-MM-DD），無效日期返回 400 錯誤

### 效能要求

29. API 回應時間需低於 1000ms（即使套用多個篩選條件）

30. 前端應使用防抖（debounce）技術，避免輸入時頻繁發送請求

31. 後端應對常用查詢建立資料庫索引（例如：`category`、`status`、`start_date`）

### 響應式設計

32. 篩選器在手機版應：
    - 預設收合
    - 使用全螢幕對話框或抽屜展開
    - 提供「套用」和「取消」按鈕

33. 篩選器在桌面版應：
    - 顯示在頁面上方
    - 使用多欄佈局（2-3 欄）

## Tasks / Subtasks

> **Brownfield 專案說明**：後端 API 端點 `GET /api/activities` 已存在，需要擴展支援搜尋和篩選查詢參數。前端需要建立篩選器組件並整合到活動列表頁面。

### Phase 1: 後端擴展

- [ ] **Task 1: 擴展活動列表 API 支援篩選** (AC: 20-28)
  - [ ] 檢查 `backend/blueprints/activities.py` 中的 `GET /activities` 端點
  - [ ] 新增查詢參數處理：`search`、`category`、`status`、`date_from`、`date_to`、`location`、`gender`、`age_min`、`age_max`
  - [ ] 實作關鍵字搜尋邏輯（使用 SQLAlchemy `ilike` 查詢標題和描述）
  - [ ] 實作活動類型篩選（精確匹配 `category`）
  - [ ] 實作活動狀態篩選（精確匹配 `status`）
  - [ ] 實作日期範圍篩選（`start_date BETWEEN date_from AND date_to`）
  - [ ] 實作地點篩選（模糊匹配 `location`）
  - [ ] 實作性別偏好篩選邏輯
  - [ ] 實作年齡範圍篩選（檢查交集）
  - [ ] 實作多條件組合邏輯
  - [ ] 實作日期格式驗證
  - [ ] 在回應中包含套用的篩選條件（`filters` 物件）
  - [ ] 測試 API 端點
  - [ ] 記錄 API 規格

- [ ] **Task 2: 資料庫索引優化** (AC: 31)
  - [ ] 為 `category` 欄位建立索引
  - [ ] 為 `status` 欄位建立索引
  - [ ] 為 `start_date` 欄位建立索引
  - [ ] 測試查詢效能
  - [ ] 記錄索引變更

### Phase 2: 前端篩選器組件

- [ ] **Task 3: 建立 ActivityFilters 組件** (AC: 1, 2, 3, 4, 5)
  - [ ] 在 `frontend/src/components/activity/` 建立 `ActivityFilters.vue`
  - [ ] 使用 Vue 3 Composition API 和 `<script setup>` 語法
  - [ ] 實作篩選器佈局（使用 `el-form`）
  - [ ] 實作關鍵字搜尋輸入框（`el-input`）
  - [ ] 實作活動類型下拉選單（`el-select`）
  - [ ] 實作活動狀態下拉選單（`el-select`）
  - [ ] 實作日期範圍選擇器（`el-date-picker` type="daterange"）
  - [ ] 實作地點輸入框（`el-input`）
  - [ ] 實作性別偏好下拉選單（`el-select`）
  - [ ] 實作年齡範圍滑桿（`el-slider` range）
  - [ ] 實作「搜尋」按鈕
  - [ ] 實作「重置」按鈕
  - [ ] 實作展開/收合功能（使用 `el-collapse` 或自定義）
  - [ ] 測試組件渲染

- [ ] **Task 4: 實作篩選器邏輯** (AC: 6-13, 14-16)
  - [ ] 建立響應式篩選條件物件（ref）
  - [ ] 實作「搜尋」按鈕點擊處理函數
  - [ ] 實作「重置」按鈕點擊處理函數
  - [ ] Emit 'filter-change' 事件傳遞篩選條件
  - [ ] 實作符合條件活動數量顯示（如有 API 支援）
  - [ ] 測試篩選邏輯

### Phase 3: 整合到活動列表頁面

- [ ] **Task 5: 更新 Activities.vue 頁面** (AC: 17, 18)
  - [ ] 導入 `ActivityFilters` 組件
  - [ ] 將篩選器放置在活動列表上方
  - [ ] 實作 `handleFilterChange` 函數處理篩選條件變更
  - [ ] 根據篩選條件呼叫 API
  - [ ] 實作 URL 查詢參數同步（使用 Vue Router）
  - [ ] 頁面載入時從 URL 讀取篩選條件
  - [ ] 將 URL 參數傳遞給篩選器組件（初始化篩選條件）
  - [ ] 測試整合後的功能

- [ ] **Task 6: 實作空狀態處理** (AC: 19)
  - [ ] 檢測篩選後活動數量為 0 的情況
  - [ ] 顯示特定的空狀態提示
  - [ ] 提供「重置篩選」按鈕
  - [ ] 測試空狀態顯示

### Phase 4: 前端 API 服務層

- [ ] **Task 7: 更新 activities API 服務** (AC: 20)
  - [ ] 確認 `frontend/src/api/activities.js` 中的 `getActivities` 函數
  - [ ] 確認函數支援所有篩選參數
  - [ ] 測試 API 函數

### Phase 5: 響應式設計

- [ ] **Task 8: 實作篩選器響應式設計** (AC: 32, 33)
  - [ ] 實作桌面版佈局（多欄）
  - [ ] 實作手機版佈局（使用 `el-drawer` 或 `el-dialog`）
  - [ ] 手機版預設收合，點擊按鈕展開
  - [ ] 測試不同螢幕尺寸下的顯示

### Phase 6: 效能優化

- [ ] **Task 9: 實作防抖功能** (AC: 30)
  - [ ] 為關鍵字搜尋輸入添加防抖（300ms）
  - [ ] 為地點輸入添加防抖（300ms）
  - [ ] 使用 lodash 的 `debounce` 或自行實作
  - [ ] 測試防抖效果

### Phase 7: 測試

- [ ] **Task 10: 前端單元測試** (AC: 所有)
  - [ ] 測試 `ActivityFilters.vue` 組件渲染
  - [ ] 測試篩選條件變更
  - [ ] 測試重置功能
  - [ ] 測試 URL 同步
  - [ ] 測試空狀態處理
  - [ ] 執行測試：`npm run test:unit`
  - [ ] 確認覆蓋率 > 80%

- [ ] **Task 11: 後端測試** (AC: 24-28)
  - [ ] 測試關鍵字搜尋
  - [ ] 測試活動類型篩選
  - [ ] 測試活動狀態篩選
  - [ ] 測試日期範圍篩選
  - [ ] 測試地點篩選
  - [ ] 測試性別偏好篩選
  - [ ] 測試年齡範圍篩選
  - [ ] 測試多條件組合
  - [ ] 測試日期格式驗證
  - [ ] 執行測試：`pytest backend/tests/test_activities.py -v`

### Phase 8: 整合測試與驗收

- [ ] **Task 12: 端到端功能驗證** (所有 AC)
  - [ ] 手動測試所有篩選條件
  - [ ] 測試多條件組合
  - [ ] 測試重置功能
  - [ ] 測試 URL 同步和分享
  - [ ] 測試空狀態顯示
  - [ ] 測試響應式設計
  - [ ] 測試防抖功能
  - [ ] 驗證所有 AC 滿足

## Dev Notes

### Previous Story Insights

**來自 Story 1.1 - 3.2 的經驗**：
- Vue 3 Composition API 是標準開發模式 [Source: architecture/4-組件標準-component-standards.md]
- Element Plus 組件庫已整合，使用 `el-form`、`el-select`、`el-date-picker`、`el-slider`、`el-drawer` 等組件 [Source: architecture/2-前端技術棧-frontend-tech-stack.md]
- Vue Router 用於 URL 查詢參數管理 [Source: architecture/7-路由配置-routing.md]
- JWT 認證機制完善 [Source: architecture/6-api-整合-api-integration.md]
- SQLAlchemy ORM 用於資料庫查詢 [Source: backend/models/activity.py]
- Day.js 用於日期處理 [Source: architecture/2-前端技術棧-frontend-tech-stack.md]

### API Specifications

#### 擴展的活動列表 API

**Endpoint**: `GET /api/activities`

**Authentication**: Required (JWT Token)

**Query Parameters**:
- `search`: 關鍵字搜尋（標題和描述）
- `category`: 活動類型（adventure, culture, leisure, food, sports, other）
- `status`: 活動狀態（recruiting, ongoing, completed, cancelled）
- `date_from`: 開始日期（YYYY-MM-DD）
- `date_to`: 結束日期（YYYY-MM-DD）
- `location`: 地點關鍵字
- `gender`: 性別偏好（any, male, female）
- `age_min`: 最小年齡（18-80）
- `age_max`: 最大年齡（18-80）
- `page`: 頁碼（預設 1）
- `per_page`: 每頁數量（預設 12）

**Request Example**:
```
GET /api/activities?search=登山&category=adventure&status=recruiting&date_from=2025-11-10&date_to=2025-12-31&location=陽明山&page=1&per_page=12
```

**Response (Success - 200)**:
```json
{
  "activities": [
    {
      "activity_id": 1,
      "title": "陽明山登山之旅",
      "category": "adventure",
      "status": "recruiting",
      ...
    }
  ],
  "pagination": {
    "page": 1,
    "per_page": 12,
    "total": 25,
    "pages": 3
  },
  "filters": {
    "search": "登山",
    "category": "adventure",
    "status": "recruiting",
    "date_from": "2025-11-10",
    "date_to": "2025-12-31",
    "location": "陽明山"
  }
}
```

### Backend Implementation Guide

**SQLAlchemy 查詢範例**:

```python
from sqlalchemy import and_, or_

@activities_bp.route('', methods=['GET'])
@jwt_required()
def get_activities():
    """獲取活動列表（支援篩選）"""
    try:
        # 取得查詢參數
        search = request.args.get('search')
        category = request.args.get('category')
        status = request.args.get('status')
        date_from = request.args.get('date_from')
        date_to = request.args.get('date_to')
        location = request.args.get('location')
        gender = request.args.get('gender')
        age_min = request.args.get('age_min', type=int)
        age_max = request.args.get('age_max', type=int)
        page = request.args.get('page', 1, type=int)
        per_page = request.args.get('per_page', 12, type=int)
        
        # 建立基礎查詢
        query = Activity.query
        
        # 關鍵字搜尋
        if search:
            search_pattern = f'%{search}%'
            query = query.filter(
                or_(
                    Activity.title.ilike(search_pattern),
                    Activity.description.ilike(search_pattern)
                )
            )
        
        # 活動類型篩選
        if category:
            query = query.filter(Activity.category == category)
        
        # 活動狀態篩選
        if status:
            query = query.filter(Activity.status == status)
        
        # 日期範圍篩選
        if date_from:
            query = query.filter(Activity.start_date >= date_from)
        if date_to:
            query = query.filter(Activity.start_date <= date_to)
        
        # 地點篩選
        if location:
            query = query.filter(Activity.location.ilike(f'%{location}%'))
        
        # 性別偏好篩選
        if gender and gender != 'any':
            query = query.filter(
                or_(
                    Activity.gender_preference == gender,
                    Activity.gender_preference == 'any'
                )
            )
        
        # 年齡範圍篩選
        if age_min and age_max:
            query = query.filter(
                or_(
                    Activity.age_min == None,
                    Activity.age_max == None,
                    and_(
                        Activity.age_min <= age_max,
                        Activity.age_max >= age_min
                    )
                )
            )
        
        # 分頁
        pagination = query.paginate(page=page, per_page=per_page, error_out=False)
        
        # 組裝回應
        activities = [a.to_dict(include_creator_info=True) for a in pagination.items]
        
        return jsonify({
            'activities': activities,
            'pagination': {
                'page': page,
                'per_page': per_page,
                'total': pagination.total,
                'pages': pagination.pages
            },
            'filters': {
                'search': search,
                'category': category,
                'status': status,
                'date_from': date_from,
                'date_to': date_to,
                'location': location,
                'gender': gender,
                'age_min': age_min,
                'age_max': age_max
            }
        }), 200
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500
```

### Frontend Implementation Guide

**URL 查詢參數同步**:

```javascript
import { useRouter, useRoute } from 'vue-router'
import { ref, watch, onMounted } from 'vue'

const router = useRouter()
const route = useRoute()

const filters = ref({
  search: '',
  category: '',
  status: '',
  dateRange: [],
  location: '',
  gender: '',
  ageRange: [18, 80]
})

// 從 URL 讀取篩選條件
const loadFiltersFromURL = () => {
  filters.value = {
    search: route.query.search || '',
    category: route.query.category || '',
    status: route.query.status || '',
    dateRange: route.query.date_from && route.query.date_to 
      ? [route.query.date_from, route.query.date_to] 
      : [],
    location: route.query.location || '',
    gender: route.query.gender || '',
    ageRange: [
      parseInt(route.query.age_min) || 18,
      parseInt(route.query.age_max) || 80
    ]
  }
}

// 更新 URL 查詢參數
const updateURL = () => {
  const query = {}
  if (filters.value.search) query.search = filters.value.search
  if (filters.value.category) query.category = filters.value.category
  if (filters.value.status) query.status = filters.value.status
  if (filters.value.dateRange.length === 2) {
    query.date_from = filters.value.dateRange[0]
    query.date_to = filters.value.dateRange[1]
  }
  if (filters.value.location) query.location = filters.value.location
  if (filters.value.gender) query.gender = filters.value.gender
  if (filters.value.ageRange[0] !== 18) query.age_min = filters.value.ageRange[0]
  if (filters.value.ageRange[1] !== 80) query.age_max = filters.value.ageRange[1]
  
  router.push({ query })
}

onMounted(() => {
  loadFiltersFromURL()
  fetchActivities()
})
```

**防抖實作**:

```javascript
import { debounce } from 'lodash-es'

const debouncedSearch = debounce((value) => {
  filters.value.search = value
  handleFilterChange()
}, 300)

const handleSearchInput = (value) => {
  debouncedSearch(value)
}
```

### File Locations

**Backend** (更新):
- API: `backend/blueprints/activities.py` (擴展篩選邏輯)
- Model: `backend/models/activity.py` (檢查索引)
- 測試: `backend/tests/test_activities.py` (新增測試)

**Frontend - New Files**:
- 篩選器組件: `frontend/src/components/activity/ActivityFilters.vue` (新建)

**Frontend - Updated Files**:
- 活動列表頁面: `frontend/src/views/Activities.vue` (整合篩選器)
- API 函數: `frontend/src/api/activities.js` (確認支援篩選參數)
- 測試: `frontend/tests/unit/components/activity/ActivityFilters.spec.js` (新建)

### Testing Requirements

**Unit Testing (Vitest)** [Source: architecture/11-測試策略-testing-requirements.md]:
- 測試 `ActivityFilters.vue` 組件渲染
- 測試篩選條件變更
- 測試重置功能
- 測試 URL 同步
- 測試防抖功能
- 覆蓋率目標：> 80%

**Backend Testing (pytest)**:
- 測試每個篩選條件
- 測試多條件組合
- 測試日期格式驗證
- 測試性別和年齡邏輯

### Technical Constraints

1. **防抖延遲設定為 300ms**（避免頻繁請求）
2. **URL 查詢參數必須同步**（支援分享和收藏）
3. **資料庫索引**（category, status, start_date）
4. **日期格式驗證**（YYYY-MM-DD）
5. **多條件 AND 邏輯**（同時滿足所有條件）

### UI/UX 考量

**篩選器佈局建議**:
```vue
<el-form :model="filters" label-position="top">
  <el-row :gutter="20">
    <el-col :span="24">
      <el-input 
        v-model="filters.search" 
        placeholder="搜尋活動標題或描述"
        clearable
      />
    </el-col>
    <el-col :xs="24" :sm="12" :md="8">
      <el-select v-model="filters.category" placeholder="活動類型">
        <el-option label="全部" value="" />
        <el-option label="冒險探索" value="adventure" />
        <!-- 更多選項 -->
      </el-select>
    </el-col>
    <!-- 更多篩選欄位 -->
  </el-row>
</el-form>
```

## Testing

### Frontend Testing
```bash
npm run test:unit
npm run test:coverage
```

### Backend Testing
```bash
pytest backend/tests/test_activities.py -v -k filter
```

### Manual Testing Checklist

- [ ] 關鍵字搜尋正常運作
- [ ] 活動類型篩選正確
- [ ] 活動狀態篩選正確
- [ ] 日期範圍篩選正確
- [ ] 地點篩選正常（模糊匹配）
- [ ] 性別偏好篩選邏輯正確
- [ ] 年齡範圍篩選邏輯正確（交集檢查）
- [ ] 多條件組合正常運作
- [ ] 重置按鈕清除所有篩選
- [ ] URL 查詢參數正確同步
- [ ] 頁面載入時從 URL 讀取篩選條件
- [ ] 空狀態正確顯示（無符合活動時）
- [ ] 防抖功能正常（輸入不會立即觸發請求）
- [ ] 手機版篩選器使用抽屜或對話框
- [ ] 桌面版篩選器多欄佈局
- [ ] 篩選後活動數量顯示正確

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*此區塊由開發代理在實作時填寫*

### Agent Model Used

(待開發代理填寫)

### Debug Log References

(待開發代理填寫)

### Completion Notes List

(待開發代理填寫)

### File List

(待開發代理填寫)

## QA Results

*此區塊由 QA 代理審查後更新審查結果*
