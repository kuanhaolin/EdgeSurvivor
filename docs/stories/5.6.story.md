# Story 5.6: 費用幣別支援

> **⏸️ 開發狀態：已暫緩**  
> 此功能暫時不開發，平台目前保持穩定狀態。待後續需求評估後再行開發。

## Status
Draft - On Hold

## Story

**As a** 國際旅行者,
**I want** 以不同幣別記錄費用,
**so that** 我在不同國家旅行時，可以用當地幣別準確記錄支出

## Acceptance Criteria

1. 可以選擇費用幣別（TWD, USD, EUR, JPY 等）
2. 系統應顯示幣別符號
3. 統計數據應依幣別分組
4. 未來可考慮匯率轉換功能

## Tasks / Subtasks

### Phase 1: 後端費用幣別支援 (AC: 1, 3)

- [ ] **Task 1.1**: 更新 Expense 資料模型支援 currency 欄位 (AC: 1)
  - [ ] 檢查 `backend/models/expense.py` 是否已有 `currency` 欄位
  - [ ] 如果沒有，添加 `currency = db.Column(db.String(10), default='TWD')` 欄位
  - [ ] 確保 `to_dict()` 方法包含 currency 欄位
  - [ ] 驗證 currency 欄位在 API 回應中正確返回

- [ ] **Task 1.2**: 創建資料庫遷移腳本添加 currency 欄位 (AC: 1)
  - [ ] 創建 `backend/migrations/add_currency_to_expenses.py` 遷移腳本
  - [ ] 使用 SQLAlchemy `text()` 執行 `ALTER TABLE expenses ADD COLUMN currency VARCHAR(10) DEFAULT 'TWD'` 語句
  - [ ] 添加遷移回滾邏輯（可選）
  - [ ] 測試遷移腳本執行成功
  - [ ] 驗證現有費用記錄自動設定 'TWD' 預設值

- [ ] **Task 1.3**: 更新費用創建 API 支援 currency 參數 (AC: 1)
  - [ ] 修改 `backend/blueprints/expenses.py` 的 `create_expense()` 函數
  - [ ] 從請求 JSON 中提取 `currency` 參數
  - [ ] 驗證 currency 值在允許清單中 ['TWD', 'USD', 'EUR', 'JPY', 'CNY', 'GBP', 'AUD', 'KRW', 'THB', 'SGD']
  - [ ] 如果 currency 無效，返回 400 錯誤
  - [ ] 將 currency 值儲存到 Expense 物件
  - [ ] 確保 API 回應包含 currency 欄位

- [ ] **Task 1.4**: 更新費用修改 API 支援 currency 更新 (AC: 1)
  - [ ] 修改 `backend/blueprints/expenses.py` 的更新費用端點
  - [ ] 允許修改 currency 欄位
  - [ ] 驗證 currency 值有效性
  - [ ] 更新資料庫記錄

- [ ] **Task 1.5**: 更新費用查詢 API 回應包含 currency (AC: 1, 3)
  - [ ] 驗證 `GET /api/expenses/activity/<activity_id>` 端點回應包含 currency
  - [ ] 驗證 `GET /api/expenses/user/<user_id>` 端點回應包含 currency
  - [ ] 確保費用統計 API 依幣別分組（如果存在）

- [ ] **Task 1.6**: 測試後端費用幣別功能 (AC: 1, 3)
  - [ ] 創建測試檔案 `backend/test/TC_5_6_currency_support.py`
  - [ ] 測試：創建費用時指定 currency（TWD, USD, EUR 等）
  - [ ] 測試：未指定 currency 時預設為 TWD
  - [ ] 測試：指定無效 currency 返回 400 錯誤
  - [ ] 測試：查詢費用時 currency 正確返回
  - [ ] 測試：修改費用 currency 成功
  - [ ] 測試：費用統計依幣別分組（如實作統計分組功能）

### Phase 2: 前端費用幣別選擇 (AC: 1, 2)

- [ ] **Task 2.1**: 添加幣別選擇器到費用表單 (AC: 1, 2)
  - [ ] 在 `frontend/src/components/ExpenseManager.vue` 的費用表單中添加幣別選擇器
  - [ ] 使用 `el-select` 組件，選項包含 TWD, USD, EUR, JPY, CNY, GBP, AUD, KRW, THB, SGD
  - [ ] 為每個幣別顯示對應符號和名稱（例如：TWD - 新台幣 NT$）
  - [ ] 預設選擇 TWD
  - [ ] 綁定 v-model 到 `expenseForm.currency`

- [ ] **Task 2.2**: 創建幣別輔助工具函數 (AC: 2)
  - [ ] 創建 `frontend/src/utils/currencyHelper.js` 工具檔案
  - [ ] 定義 `getCurrencySymbol(currency)` 函數返回幣別符號（TWD→'NT$', USD→'$', EUR→'€' 等）
  - [ ] 定義 `getCurrencyName(currency)` 函數返回幣別中文名稱
  - [ ] 定義 `formatCurrency(amount, currency)` 函數格式化金額顯示
  - [ ] 導出幣別選項清單 `CURRENCY_OPTIONS`

- [ ] **Task 2.3**: 更新費用清單顯示幣別符號 (AC: 2)
  - [ ] 修改 `frontend/src/components/ExpenseManager.vue` 的費用清單表格
  - [ ] 在金額欄位使用 `getCurrencySymbol()` 顯示幣別符號
  - [ ] 格式化金額顯示（例如：NT$ 1,000 或 $ 50.00）
  - [ ] 確保不同幣別使用對應符號

- [ ] **Task 2.4**: 更新費用統計顯示依幣別分組 (AC: 3)
  - [ ] 檢查是否存在費用統計組件
  - [ ] 修改統計顯示邏輯，依幣別分組顯示
  - [ ] 顯示格式：「總支出：NT$ 5,000 / $ 100 / € 50」
  - [ ] 或使用表格/列表分別顯示各幣別統計

- [ ] **Task 2.5**: 測試前端幣別功能 (AC: 1, 2, 3)
  - [ ] 手動測試：創建費用時選擇不同幣別
  - [ ] 手動測試：費用清單顯示正確幣別符號
  - [ ] 手動測試：編輯費用時可修改幣別
  - [ ] 手動測試：統計數據依幣別分組顯示
  - [ ] 驗證表單驗證正確（必填、格式）

### Phase 3: 資料庫更新與部署 (AC: 1)

- [ ] **Task 3.1**: 執行資料庫遷移 (AC: 1)
  - [ ] 在開發環境執行遷移腳本：`python backend/migrations/add_currency_to_expenses.py`
  - [ ] 驗證 expenses 表格已添加 currency 欄位
  - [ ] 驗證現有記錄 currency 欄位值為 'TWD'
  - [ ] 更新 `db/init-complete.sql` 包含 currency 欄位定義

- [ ] **Task 3.2**: 更新資料庫初始化腳本 (AC: 1)
  - [ ] 修改 `db/init-complete.sql` 的 CREATE TABLE expenses 語句
  - [ ] 添加 `currency VARCHAR(10) DEFAULT 'TWD'` 欄位
  - [ ] 驗證新資料庫初始化正確包含 currency 欄位

## Dev Notes

### Previous Story Insights

**從 Story 5.5 (刪除費用記錄) 的經驗**:
- Expense 模型已支援多種欄位（split_type, split_method, split_participants, borrower_id）
- API 端點已實作完整的權限驗證（創建者/代墊人檢查）
- 測試策略使用 SQLite in-memory 資料庫
- 前端使用 ExpenseManager.vue 組件統一管理費用功能
- 所有費用相關測試放在 `backend/test/TC_5_*.py`

**技術決策參考**：
- 遵循現有的資料庫遷移模式（參考 `backend/migrations/add_expense_split_type.py`）
- API 端點驗證邏輯與現有費用端點保持一致
- 前端表單元件使用 Element Plus 組件（el-select, el-form）

### Data Models

**Expense 模型當前欄位** [Source: backend/models/expense.py]:
```python
class Expense(db.Model):
    __tablename__ = 'expenses'
    
    expense_id = db.Column(db.Integer, primary_key=True)
    activity_id = db.Column(db.Integer, db.ForeignKey('activities.activity_id'))
    payer_id = db.Column(db.Integer, db.ForeignKey('users.user_id'))
    amount = db.Column(Numeric(10, 2), nullable=False)
    description = db.Column(db.Text)
    expense_date = db.Column(db.Date, default=datetime.utcnow)
    category = db.Column(db.String(50))
    split_type = db.Column(db.String(20), default='all')
    is_split = db.Column(db.Boolean, default=True)
    split_method = db.Column(db.String(20), default='equal')
    split_participants = db.Column(db.Text)
    borrower_id = db.Column(db.Integer, db.ForeignKey('users.user_id'))
    participants = db.Column(db.Text)  # 向後兼容
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # 關聯
    activity = db.relationship('Activity', backref='expenses')
    payer = db.relationship('User', foreign_keys=[payer_id])
    borrower = db.relationship('User', foreign_keys=[borrower_id])
```

**需要添加的欄位**:
```python
currency = db.Column(db.String(10), default='TWD')  # 幣別代碼
```

**to_dict() 方法需更新** [Source: backend/models/expense.py#L39-60]:
- 確保 `to_dict()` 方法包含 'currency' 欄位在回應資料中

### API Specifications

**費用創建端點** [Source: backend/blueprints/expenses.py]:
- **端點**: `POST /api/activities/<activity_id>/expenses`
- **認證**: `@jwt_required()`
- **請求 JSON 新增參數**:
  - `currency` (string, 可選): 幣別代碼，預設 'TWD'
- **驗證規則**:
  - currency 必須在允許清單中: ['TWD', 'USD', 'EUR', 'JPY', 'CNY', 'GBP', 'AUD', 'KRW', 'THB', 'SGD']
  - 無效 currency 返回 400: `{'error': '不支援的幣別'}`
- **回應格式**:
  - 成功 (201): `{'message': '費用記錄已創建', 'expense': {..., 'currency': 'USD', ...}}`

**費用查詢端點** [Source: backend/blueprints/expenses.py]:
- **端點**: `GET /api/expenses/activity/<activity_id>`
- **回應**: 所有費用記錄包含 currency 欄位

**費用修改端點** [Source: backend/blueprints/expenses.py]:
- **端點**: `PUT /api/expenses/<expense_id>`
- **新增可修改欄位**: currency

### Frontend Component Specifications

**主要組件**: `frontend/src/components/ExpenseManager.vue` [Source: frontend/src/components/ExpenseManager.vue]
- 使用 Vue 3 Composition API (`<script setup>` 語法)
- 使用 Element Plus UI 組件庫

**費用表單新增欄位**:
```vue
<el-form-item label="幣別" prop="currency">
  <el-select v-model="expenseForm.currency" placeholder="請選擇幣別">
    <el-option
      v-for="option in currencyOptions"
      :key="option.value"
      :label="option.label"
      :value="option.value"
    />
  </el-select>
</el-form-item>
```

**幣別選項定義**:
```javascript
const currencyOptions = [
  { value: 'TWD', label: 'TWD - 新台幣 (NT$)' },
  { value: 'USD', label: 'USD - 美元 ($)' },
  { value: 'EUR', label: 'EUR - 歐元 (€)' },
  { value: 'JPY', label: 'JPY - 日圓 (¥)' },
  { value: 'CNY', label: 'CNY - 人民幣 (¥)' },
  { value: 'GBP', label: 'GBP - 英鎊 (£)' },
  { value: 'AUD', label: 'AUD - 澳幣 (A$)' },
  { value: 'KRW', label: 'KRW - 韓元 (₩)' },
  { value: 'THB', label: 'THB - 泰銖 (฿)' },
  { value: 'SGD', label: 'SGD - 新幣 (S$)' }
]
```

**幣別符號映射**:
```javascript
const currencySymbols = {
  TWD: 'NT$',
  USD: '$',
  EUR: '€',
  JPY: '¥',
  CNY: '¥',
  GBP: '£',
  AUD: 'A$',
  KRW: '₩',
  THB: '฿',
  SGD: 'S$'
}
```

**金額顯示格式**:
```vue
<template #default="scope">
  <strong style="color: #f56c6c;">
    {{ getCurrencySymbol(scope.row.currency) }} {{ scope.row.amount }}
  </strong>
</template>
```

### File Locations

**後端檔案** [Source: docs/brownfield-architecture.md#Repository 結構現狀]:
- 資料模型: `backend/models/expense.py`
- API Blueprint: `backend/blueprints/expenses.py`
- 遷移腳本: `backend/migrations/add_currency_to_expenses.py` (需新建)
- 測試檔案: `backend/test/TC_5_6_currency_support.py` (需新建)

**前端檔案** [Source: docs/brownfield-architecture.md#Repository 結構現狀]:
- 費用管理組件: `frontend/src/components/ExpenseManager.vue`
- 幣別工具: `frontend/src/utils/currencyHelper.js` (需新建)

**資料庫檔案**:
- 初始化腳本: `db/init-complete.sql` (需更新)

### Database Migration Pattern

**遷移腳本模式** [Source: backend/migrations/add_expense_split_type.py]:
```python
"""
添加費用幣別欄位
執行方式：python backend/migrations/add_currency_to_expenses.py
"""
import sys
import os

sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from models import db
from app import app
from sqlalchemy import text

def migrate():
    """執行遷移"""
    with app.app_context():
        try:
            # 檢查欄位是否已存在
            result = db.session.execute(text("""
                SELECT column_name 
                FROM information_schema.columns 
                WHERE table_name='expenses' AND column_name='currency'
            """))
            
            if result.fetchone():
                print("currency 欄位已存在，跳過遷移")
                return
            
            # 添加新欄位
            db.session.execute(text("""
                ALTER TABLE expenses 
                ADD COLUMN currency VARCHAR(10) DEFAULT 'TWD'
            """))
            
            db.session.commit()
            print("遷移成功：已添加 currency 欄位")
            
        except Exception as e:
            db.session.rollback()
            print(f"遷移失敗：{str(e)}")
            raise

if __name__ == '__main__':
    migrate()
```

### Testing

**測試框架與標準** [Source: pytest.ini, docs/stories/5.1.story.md#Testing]:
- 後端: Pytest 框架
- 測試檔案命名: `TC_5_6_*.py`
- 測試資料庫: SQLite in-memory
- 測試覆蓋率要求: ≥70%

**測試配置** [Source: pytest.ini]:
```ini
[pytest]
testpaths = backend/test
python_files = TC_*.py
addopts = --verbose --cov=backend --cov-report=html --cov-fail-under=70
```

**測試檔案結構** [Source: backend/test/TC_5_2_1.py]:
```python
"""
TC_5_6_currency_support: 費用幣別支援測試
"""
import pytest
from flask_jwt_extended import create_access_token
from models.user import User
from models.activity import Activity
from models.expense import Expense

@pytest.fixture
def setup_data(client, test_app):
    """準備測試資料"""
    with test_app.app_context():
        # 創建測試用戶
        user = User(name='Test User', email='test@test.com', password_hash='hash')
        db.session.add(user)
        
        # 創建測試活動
        activity = Activity(title='Test', creator_id=user.user_id)
        db.session.add(activity)
        db.session.commit()
        
        return user.user_id, activity.activity_id

def test_create_expense_with_currency(client, test_app, setup_data):
    """測試創建費用時指定幣別"""
    # 測試邏輯...
```

**測試案例需求** (Based on ACs):
1. 創建費用時指定 currency（TWD, USD, EUR, JPY 等）成功
2. 未指定 currency 時預設為 'TWD'
3. 指定無效 currency 返回 400 錯誤
4. 查詢費用清單時 currency 正確返回
5. 修改費用 currency 成功
6. 驗證 to_dict() 包含 currency 欄位

### Technical Constraints

**SQLAlchemy 版本** [Source: docs/架構文檔完成.md#識別的約束條件]:
- 使用 SQLAlchemy 2.x 語法
- 資料庫操作必須使用 `db.session`
- 錯誤處理必須包含 try/except 和 rollback

**資料庫兼容性** [Source: docs/架構文檔完成.md#識別的約束條件]:
- 生產環境: MariaDB 10.11
- 測試環境: SQLite in-memory
- 注意: SQLite 和 MariaDB 的 VARCHAR 行為可能有差異

**向後兼容性**:
- 現有費用記錄必須自動設定 currency = 'TWD'
- API 回應格式保持一致（只添加 currency 欄位）
- 前端必須處理舊記錄沒有 currency 的情況（fallback to 'TWD'）

**CORS 配置** [Source: docs/架構文檔完成.md#識別的約束條件]:
- 已在 Flask 應用中配置 CORS
- 前端可直接跨域請求

### Security Considerations

**輸入驗證**:
- currency 必須在白名單中，防止 SQL 注入
- 使用 Python `in` 運算子驗證：`currency in ALLOWED_CURRENCIES`

**權限驗證**:
- 修改費用時必須驗證用戶是代墊人或活動創建者
- 使用 JWT token 驗證用戶身份

### Performance Considerations

**資料庫索引**:
- currency 欄位不需要額外索引（非查詢條件）
- 現有的 activity_id 和 payer_id 索引已足夠

**前端優化**:
- 幣別選項清單使用 const 定義，避免重複創建
- 幣別符號映射使用物件 key-value，O(1) 查詢時間

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-16 | 1.0 | 初始故事草稿創建 | Bob (Scrum Master) |
| 2025-12-16 | 1.1 | 標記為暫緩開發狀態 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_待開發代理填寫_

### Debug Log References
_待開發代理填寫_

### Completion Notes List
_待開發代理填寫_

### File List
_待開發代理填寫_

## QA Results

_待 QA 代理填寫_
