# Story 2.6: 活動狀態管理

## Status

Draft

## Story

**As a** 活動創建者,
**I want** 管理我的活動狀態（開放招募/進行中/已完成/已取消）,
**so that** 參與者可以清楚了解活動的當前階段，並根據狀態進行相應的操作。

## Acceptance Criteria

### 狀態定義與流轉

1. 活動支援以下狀態：
   - \ecruiting\ (開放招募) - 預設狀態，活動正在招募參與者
   - \ongoing\ (進行中) - 活動已開始執行
   - \completed\ (已完成) - 活動已結束
   - \cancelled\ (已取消) - 活動被創建者取消

2. 狀態流轉規則：
   - 新建活動預設為 \ecruiting\
   - \ecruiting\  \ongoing\ (創建者手動變更)
   - \ecruiting\  \cancelled\ (創建者取消活動)
   - \ongoing\  \completed\ (創建者標記完成)
   - \ongoing\  \cancelled\ (創建者取消活動)
   -  \completed\ 和 \cancelled\ 為終態，不可再變更

### 狀態管理 UI（創建者視角）

3. 活動詳情頁顯示當前狀態標籤（使用不同顏色）：
   - \ecruiting\: 綠色（success）
   - \ongoing\: 藍色（primary）
   - \completed\: 灰色（info）
   - \cancelled\: 紅色（danger）

4. 只有創建者可以看到「狀態管理」按鈕

5. 點擊「狀態管理」按鈕後，顯示狀態選擇下拉選單（Dropdown）

6. 下拉選單只顯示可變更的狀態選項：
   - 當前為 \ecruiting\: 可選擇「進行中」或「取消活動」
   - 當前為 \ongoing\: 可選擇「已完成」或「取消活動」
   - 當前為 \completed\ 或 \cancelled\: 不顯示狀態管理按鈕

7. 選擇變更狀態時，顯示確認對話框

8. 取消活動時，需要提供取消原因（必填，至少 10 字）

9. 確認變更後：
   - 發送 API 請求：\PUT /api/activities/{activity_id}/status\ with \{ status, cancellation_reason? }\
   - 顯示載入狀態
   - 成功後更新頁面狀態標籤
   - 顯示成功訊息（例如：「活動狀態已更新為進行中」）

### 狀態對功能的影響

10. \ecruiting\ 狀態：
    - 允許新使用者申請加入
    - 創建者可以批准/拒絕申請
    - 顯示「申請加入」按鈕（非參與者）

11. \ongoing\ 狀態：
    - 不允許新使用者申請加入
    - 「申請加入」按鈕變更為「活動進行中」（禁用）
    - 參與者可以使用討論串
    - 參與者可以新增費用記錄

12. \completed\ 狀態：
    - 不允許新申請
    - 參與者可以查看但不能新增討論
    - 顯示「活動已完成」標籤
    - 啟用評價功能（參與者可以互相評價）
    - 費用記錄變為唯讀

13. \cancelled\ 狀態：
    - 顯示取消原因
    - 所有互動功能禁用
    - 顯示「活動已取消」標籤和原因

### 活動列表顯示

14. 活動卡片顯示狀態標籤（使用對應顏色）

15. 預設只顯示 \ecruiting\ 狀態的活動

16. 提供狀態篩選器：
    - 全部
    - 開放招募
    - 進行中
    - 已完成
    - 已取消

### 後端驗證

17. API 應驗證 JWT 認證

18. 狀態變更時驗證：
    - 只有創建者可以變更狀態
    - 狀態流轉符合規則（不能從終態變更）
    - 取消活動時必須提供原因（至少 10 字）

19. 變更狀態後記錄時間戳：
    - \started_at\: 變更為 \ongoing\ 的時間
    - \completed_at\: 變更為 \completed\ 的時間
    - \cancelled_at\: 變更為 \cancelled\ 的時間

20. 狀態變更後發送通知給所有參與者（可選功能）

### 使用者體驗

21. 狀態標籤應清晰且顯眼

22. 狀態變更操作應有明確的確認對話框

23. 錯誤訊息應具體且友善（例如：「無法變更狀態：活動已完成」）

24. 成功訊息應包含新狀態（例如：「活動狀態已更新為進行中」）

### 效能與安全性

25. API 回應時間需低於 1000ms

26. 只有創建者可以變更活動狀態

27. 防止惡意或錯誤的狀態變更

## Tasks / Subtasks

> ** Brownfield 專案說明**：後端 Activity Model 已有 \status\ 欄位，但目前僅支援 \ctive\, \completed\, \cancelled\。需要擴展為支援 \ecruiting\, \ongoing\, \completed\, \cancelled\，並新增時間戳欄位。前端需要實作狀態管理 UI 和狀態篩選功能。

### Phase 1: 後端 Model 更新

- [ ] **Task 1: 更新 Activity Model 狀態欄位** (AC: 1, 19)
  - [ ]  檢查 \ackend/models/activity.py\ 的 \status\ 欄位
  - [ ]  如果需要，更新狀態值定義：
    - 從 \ctive\ 更名為 \ecruiting\（或保留 \ctive\ 作為 \ecruiting\ 的別名）
    - 新增 \ongoing\ 狀態
    - 保留 \completed\ 和 \cancelled\
  - [ ]  新增時間戳欄位：
    \\\\\\\\\python
    started_at = db.Column(db.DateTime)  # 開始時間（ongoing）
    completed_at = db.Column(db.DateTime)  # 完成時間
    cancelled_at = db.Column(db.DateTime)  # 取消時間
    cancellation_reason = db.Column(db.Text)  # 取消原因
    \\\\\\\\\
  - [ ]  新增狀態變更方法：
    \\\\\\\\\python
    def update_status(self, new_status, cancellation_reason=None):
        \"\"\"更新活動狀態\"\"\"
        # 驗證狀態流轉
        valid_transitions = {
            'recruiting': ['ongoing', 'cancelled'],
            'ongoing': ['completed', 'cancelled'],
            'completed': [],  # 終態
            'cancelled': []   # 終態
        }
        
        if new_status not in valid_transitions.get(self.status, []):
            raise ValueError(f'無法從 {self.status} 變更為 {new_status}')
        
        if new_status == 'cancelled' and not cancellation_reason:
            raise ValueError('取消活動必須提供原因')
        
        self.status = new_status
        
        if new_status == 'ongoing':
            self.started_at = datetime.utcnow()
        elif new_status == 'completed':
            self.completed_at = datetime.utcnow()
        elif new_status == 'cancelled':
            self.cancelled_at = datetime.utcnow()
            self.cancellation_reason = cancellation_reason
        
        db.session.commit()
    \\\\\\\\\
  - [ ]  更新 \	o_dict()\ 方法包含新欄位
  - [ ]  記錄 Model 變更

- [ ] **Task 2: 資料庫遷移** (AC: 1, 19)
  - [ ]  建立資料庫遷移腳本
  - [ ]  新增欄位：\started_at\, \completed_at\, \cancelled_at\, \cancellation_reason\
  - [ ]  更新現有資料：將 \ctive\ 狀態更新為 \ecruiting\（如果需要）
  - [ ]  測試遷移腳本
  - [ ]  記錄遷移步驟

### Phase 2: 後端 API 實作

- [ ] **Task 3: 實作狀態變更 API** (AC: 9, 17, 18, 20)
  - [ ]  在 \ackend/blueprints/activities.py\ 新增端點：
    \\\\\\\\\python
    @activities_bp.route('/<int:activity_id>/status', methods=['PUT'])
    @jwt_required()
    def update_activity_status(activity_id):
        \"\"\"更新活動狀態\"\"\"
        try:
            current_user_id = int(get_jwt_identity())
            data = request.get_json()
            
            activity = Activity.query.get(activity_id)
            if not activity:
                return jsonify({'error': '找不到活動'}), 404
            
            # 權限檢查：只有創建者可以變更狀態
            if activity.creator_id != current_user_id:
                return jsonify({'error': '只有活動創建者可以變更狀態'}), 403
            
            new_status = data.get('status')
            cancellation_reason = data.get('cancellation_reason')
            
            # 驗證取消原因
            if new_status == 'cancelled':
                if not cancellation_reason or len(cancellation_reason) < 10:
                    return jsonify({'error': '取消活動必須提供原因（至少 10 字）'}), 400
            
            # 變更狀態
            activity.update_status(new_status, cancellation_reason)
            
            return jsonify({
                'message': f'活動狀態已更新為{get_status_text(new_status)}',
                'activity': activity.to_dict()
            }), 200
            
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            db.session.rollback()
            return jsonify({'error': str(e)}), 500
    
    def get_status_text(status):
        status_map = {
            'recruiting': '開放招募',
            'ongoing': '進行中',
            'completed': '已完成',
            'cancelled': '已取消'
        }
        return status_map.get(status, status)
    \\\\\\\\\
  - [ ]  測試 API 端點
  - [ ]  記錄 API 規格

- [ ] **Task 4: 更新活動列表 API** (AC: 15, 16)
  - [ ]  在 \GET /api/activities\ 新增狀態篩選參數
  - [ ]  預設只返回 \ecruiting\ 狀態的活動
  - [ ]  支援 \status\ 查詢參數（all, recruiting, ongoing, completed, cancelled）
  - [ ]  測試篩選功能
  - [ ]  記錄 API 變更

### Phase 3: 前端 API 服務層

- [ ] **Task 5: 新增狀態管理 API 函數** (AC: 9)
  - [ ]  在 \rontend/src/api/activities.js\ 添加函數：
    \\\\\\\\\javascript
    /**
     * 更新活動狀態
     * @param {number} activityId - 活動 ID
     * @param {Object} data - 狀態資料 { status: string, cancellation_reason?: string }
     * @returns {Promise}
     */
    export const updateActivityStatus = (activityId, data) => {
      return axios.put(\\\/activities/\\\/status\\\, data)
    }
    \\\\\\\\\
  - [ ]  更新 \getActivities\ 函數支援狀態篩選
  - [ ]  測試 API 函數

### Phase 4: 前端組件 - 狀態管理

- [ ] **Task 6: 建立狀態管理組件** (AC: 4, 5, 6, 7, 8, 9)
  - [ ]  在 \rontend/src/components/activity/\ 建立 \ActivityStatusManager.vue\
  - [ ]  實作組件（包含狀態下拉選單、確認對話框、取消原因輸入）
  - [ ]  實作狀態流轉邏輯
  - [ ]  測試狀態變更流程
  - [ ]  記錄組件規格

- [ ] **Task 7: 建立狀態標籤組件** (AC: 3, 14, 21)
  - [ ]  在 \rontend/src/components/activity/\ 建立 \ActivityStatusBadge.vue\
  - [ ]  實作不同狀態的顏色樣式
  - [ ]  支援顯示取消原因
  - [ ]  測試標籤顯示

### Phase 5: 整合到活動詳情頁

- [ ] **Task 8: 更新 ActivityDetail.vue** (AC: 3, 4, 10, 11, 12, 13)
  - [ ]  導入 \ActivityStatusManager\ 和 \ActivityStatusBadge\ 組件
  - [ ]  顯示當前狀態標籤
  - [ ]  創建者顯示狀態管理按鈕
  - [ ]  根據狀態禁用/啟用相關功能（申請加入、討論、費用等）
  - [ ]  顯示取消原因（如果已取消）
  - [ ]  測試整合後的功能

### Phase 6: 更新活動列表頁

- [ ] **Task 9: 更新 ActivityList.vue** (AC: 14, 15, 16)
  - [ ]  在活動卡片上顯示狀態標籤
  - [ ]  新增狀態篩選器（Tabs 或 Select）
  - [ ]  實作篩選邏輯
  - [ ]  預設只顯示 \ecruiting\ 狀態的活動
  - [ ]  測試篩選功能

### Phase 7: 測試

- [ ] **Task 10: 前端單元測試** (AC: 所有)
  - [ ]  測試 \ActivityStatusManager.vue\
  - [ ]  測試 \ActivityStatusBadge.vue\
  - [ ]  測試狀態流轉邏輯
  - [ ]  測試取消原因驗證
  - [ ]  執行測試：\
pm run test:unit\
  - [ ]  確認覆蓋率 > 80%

- [ ] **Task 11: 後端測試** (AC: 17, 18, 27)
  - [ ]  測試狀態變更 API
  - [ ]  測試權限驗證
  - [ ]  測試狀態流轉規則
  - [ ]  測試取消原因驗證
  - [ ]  測試終態不可變更
  - [ ]  執行測試：\pytest backend/tests/test_activities.py -v\

### Phase 8: 整合測試與驗收

- [ ] **Task 12: 端到端功能驗證** (所有 AC)
  - [ ]  手動測試所有狀態變更流程
  - [ ]  驗證狀態對功能的影響
  - [ ]  測試活動列表篩選
  - [ ]  驗證所有 AC 滿足

## Dev Notes

### Previous Story Insights

**來自 Story 1.1 - 2.5 的經驗**：
-  Vue 3 Composition API 是標準開發模式
-  Element Plus 組件庫已整合
-  Pinia Auth Store 用於管理認證狀態
-  JWT 認證機制完善
-  確認對話框使用 \ElMessageBox.confirm()\ 和 \ElMessageBox.prompt()\
-  Day.js 用於日期時間處理
-  響應式設計模式已確立

### Data Models

**Activity Model - 狀態相關欄位**

現有欄位：
\\\\\\\\\python
status = db.Column(db.String(20), default='active')
\\\\\\\\\

需要新增的欄位：
\\\\\\\\\python
started_at = db.Column(db.DateTime)  # 開始時間
completed_at = db.Column(db.DateTime)  # 完成時間
cancelled_at = db.Column(db.DateTime)  # 取消時間
cancellation_reason = db.Column(db.Text)  # 取消原因
\\\\\\\\\

**狀態定義**：
- \ecruiting\ (開放招募) - 預設狀態
- \ongoing\ (進行中)
- \completed\ (已完成) - 終態
- \cancelled\ (已取消) - 終態

**狀態流轉規則**：
- \ecruiting\  [\ongoing\, \cancelled\]
- \ongoing\  [\completed\, \cancelled\]
- \completed\  [] (終態)
- \cancelled\  [] (終態)

### API Specifications

#### 更新活動狀態

**Endpoint**: \PUT /api/activities/<activity_id>/status\

**Authentication**: Required (JWT Token)

**Permission**: 只有活動創建者

**Request Body**:
\\\\\\\\\json
{
  \"status\": \"ongoing\",
  \"cancellation_reason\": \"天氣不佳，活動取消\" // 僅在 status=cancelled 時必填
}
\\\\\\\\\

**Response (Success - 200)**:
\\\\\\\\\json
{
  \"message\": \"活動狀態已更新為進行中\",
  \"activity\": {
    \"activity_id\": 1,
    \"status\": \"ongoing\",
    \"started_at\": \"2025-11-05T10:00:00Z\",
    ...
  }
}
\\\\\\\\\

**Response (Error - 400)**:
\\\\\\\\\json
{
  \"error\": \"無法從 completed 變更為 ongoing\"
}
// 或
{
  \"error\": \"取消活動必須提供原因（至少 10 字）\"
}
\\\\\\\\\

**Response (Error - 403)**:
\\\\\\\\\json
{
  \"error\": \"只有活動創建者可以變更狀態\"
}
\\\\\\\\\

### File Locations

**Backend**:
- Model: \ackend/models/activity.py\ (更新)
- API: \ackend/blueprints/activities.py\ (更新)
- 測試: \ackend/tests/test_activities.py\ (更新)

**Frontend - New Files**:
- 狀態管理組件: \rontend/src/components/activity/ActivityStatusManager.vue\ (新建)
- 狀態標籤組件: \rontend/src/components/activity/ActivityStatusBadge.vue\ (新建)

**Frontend - Updated Files**:
- API 函數: \rontend/src/api/activities.js\ (更新)
- 活動詳情頁: \rontend/src/views/ActivityDetail.vue\ (更新)
- 活動列表頁: \rontend/src/views/ActivityList.vue\ (更新)
- 測試: \rontend/tests/unit/components/activity/\ (新增測試檔案)

### Testing Requirements

**Unit Testing (Vitest)**:
- 測試狀態管理組件
- 測試狀態標籤顯示
- 測試狀態流轉邏輯
- 測試取消原因驗證

**Backend Testing (pytest)**:
- 測試狀態變更 API
- 測試權限驗證
- 測試狀態流轉規則
- 測試終態保護

### Technical Constraints

1. **狀態流轉規則必須嚴格執行**
2. **終態（completed, cancelled）不可變更**
3. **取消活動必須提供原因**
4. **只有創建者可以變更狀態**
5. **狀態變更後自動記錄時間戳**

### UI/UX 考量

**狀態顏色映射**：
- \ecruiting\: \	ype=\"success\"\ (綠色)
- \ongoing\: \	ype=\"primary\"\ (藍色)
- \completed\: \	ype=\"info\"\ (灰色)
- \cancelled\: \	ype=\"danger\"\ (紅色)

**狀態對功能影響**：
- \ecruiting\: 所有功能正常
- \ongoing\: 禁用申請加入
- \completed\: 禁用申請、討論（唯讀）、啟用評價
- \cancelled\: 所有互動功能禁用

## Testing

### Frontend Testing
\\\\\\\\\ash
npm run test:unit
\\\\\\\\\

### Backend Testing
\\\\\\\\\ash
pytest backend/tests/test_activities.py -v -k status
\\\\\\\\\

### Manual Testing Checklist

- [ ] 創建者可以將 recruiting 變更為 ongoing
- [ ] 創建者可以將 recruiting 變更為 cancelled
- [ ] 創建者可以將 ongoing 變更為 completed
- [ ] 創建者可以將 ongoing 變更為 cancelled
- [ ] 無法從 completed 變更為其他狀態
- [ ] 無法從 cancelled 變更為其他狀態
- [ ] 取消活動時必須提供原因（至少 10 字）
- [ ] 非創建者無法變更狀態（403 錯誤）
- [ ] ongoing 狀態下無法申請加入
- [ ] completed 狀態下啟用評價功能
- [ ] cancelled 狀態下顯示取消原因
- [ ] 活動列表預設只顯示 recruiting 狀態
- [ ] 狀態篩選器正常運作

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-05 | 1.0 | Initial story creation | GitHub Copilot |

## Dev Agent Record

*此區塊由開發代理在實作時填寫*

### Agent Model Used

(待開發代理填寫)

### Debug Log References

(待開發代理填寫)

### Completion Notes List

(待開發代理填寫)

### File List

(待開發代理填寫)

## QA Results

*此區塊由 QA 代理審查後更新審查結果*
