# Story 1.6: 兩步驟驗證 (2FA)

## Status

Draft

## Story

**As a** 注重安全的使用者,
**I want** 能選用兩步驟驗證 (2FA) 來增強帳號安全,
**so that** 即使密碼洩露，我的帳號仍然受到保護。

## Acceptance Criteria

### 啟用兩步驟驗證

1. 使用者可以在帳號設定頁面找到「兩步驟驗證」選項
2. 點擊「啟用兩步驟驗證」後，顯示設定流程對話框
3. 系統應生成 QR Code 供使用者掃描（使用 TOTP 協定）
4. 顯示備用密鑰（純文字格式），供無法掃描 QR Code 的使用者使用
5. 使用者需使用驗證器 App（如 Google Authenticator、Authy）掃描 QR Code
6. 使用者需輸入驗證器 App 生成的 6 位數驗證碼以確認啟用
7. 驗證碼正確後，顯示「兩步驟驗證已啟用」訊息
8. 系統應生成並顯示 10 組備用驗證碼（8 位數），供緊急使用
9. 使用者應下載或複製備用驗證碼並妥善保存

### 登入時使用兩步驟驗證

10. 已啟用 2FA 的使用者在登入時，輸入帳號密碼後，需要額外輸入驗證碼
11. 顯示「請輸入驗證碼」頁面，包含 6 位數驗證碼輸入框
12. 使用者可選擇使用驗證器 App 生成的驗證碼或備用驗證碼
13. 驗證碼正確後，完成登入流程，發放 JWT Token
14. 驗證碼錯誤時，顯示錯誤訊息「驗證碼錯誤，請重試」
15. 驗證碼輸入錯誤超過 5 次後，帳號暫時鎖定 15 分鐘

### 備用驗證碼使用

16. 使用者可以使用備用驗證碼代替驗證器 App 生成的驗證碼
17. 每個備用驗證碼只能使用一次
18. 使用備用驗證碼後，該驗證碼應標記為已使用
19. 當備用驗證碼只剩 3 個時，顯示警告訊息提示使用者重新生成

### 管理兩步驟驗證

20. 使用者可以在帳號設定頁面查看 2FA 啟用狀態
21. 使用者可以停用兩步驟驗證（需要輸入密碼確認）
22. 停用 2FA 後，所有備用驗證碼失效
23. 使用者可以重新生成備用驗證碼（需要輸入當前驗證碼確認）
24. 重新生成備用驗證碼後，舊的備用驗證碼全部失效

### 安全性要求

25. QR Code 和備用密鑰應包含使用者識別資訊和平台名稱
26. 備用驗證碼應使用加密方式儲存在資料庫
27. 驗證碼驗證應有時間窗口限制（TOTP 標準：30 秒）
28. 驗證碼驗證應允許前後各 1 個時間窗口的驗證碼（容錯 ±30 秒）
29. 所有 2FA 相關操作應記錄在安全日誌中

### 使用者體驗

30. 提供清楚的 2FA 設定指南和常見問題解答
31. 支援多種驗證器 App（Google Authenticator、Authy、Microsoft Authenticator 等）
32. 備用驗證碼應可下載為文字檔案或列印
33. 登入頁面提供「使用備用驗證碼」連結
34. 響應式設計，適配手機與平板

### 錯誤處理

35. 網路錯誤時顯示友善的錯誤訊息
36. QR Code 生成失敗時提供備用密鑰作為替代方案
37. 認證失效時自動跳轉至登入頁

## Tasks / Subtasks

[詳細任務列表省略以節省空間]

## Dev Notes

### Technical Implementation

**TOTP (Time-based One-Time Password) 實作**:
- 使用 `pyotp` 套件
- 時間窗口：30 秒
- 驗證碼長度：6 位數
- 容錯窗口：±1（前後各 30 秒）

## Testing

### Backend Testing
```bash
pytest backend/tests/test_2fa.py -v
```

### Frontend Testing
```bash
npm run test:unit
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-25 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*此區塊由開發代理在實作時填寫*

## QA Results

*此區塊由 QA 代理審查後更新審查結果*
