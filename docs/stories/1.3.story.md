# Story 1.3: Google OAuth2 ç¬¬ä¸‰æ–¹ç™»å…¥

## Status

Draft

## Story

**As a** æ–°è¨ªå®¢æˆ–å·²è¨»å†Šä½¿ç”¨è€…,
**I want** é€éæˆ‘çš„ Google å¸³è™Ÿå¿«é€Ÿç™»å…¥æˆ–è¨»å†Š,
**so that** æˆ‘å¯ä»¥ç¯€çœå¡«å¯«è³‡æ–™çš„æ™‚é–“ä¸¦å¿«é€Ÿé–‹å§‹ä½¿ç”¨å¹³å°ã€‚

## Acceptance Criteria

1. ç™»å…¥é é¢é¡¯ç¤ºã€Œä½¿ç”¨ Google ç™»å…¥ã€æŒ‰éˆ•
2. é»æ“ŠæŒ‰éˆ•å¾Œé–‹å•Ÿ Google OAuth2 æˆæ¬Šæµç¨‹
3. ä½¿ç”¨è€…æˆæ¬ŠæˆåŠŸå¾Œï¼Œç³»çµ±å–å¾— Google ID Token
4. ç³»çµ±é©—è­‰ Google ID Token çš„æœ‰æ•ˆæ€§
5. å¦‚æœ Email å·²å­˜åœ¨æ–¼ç³»çµ±ï¼Œç›´æ¥ç™»å…¥è©²å¸³è™Ÿ
6. å¦‚æœ Email ä¸å­˜åœ¨ï¼Œè‡ªå‹•å»ºç«‹æ–°ä½¿ç”¨è€…å¸³è™Ÿ
7. æ–°å»ºç«‹çš„å¸³è™Ÿè‡ªå‹•è¨­å®š `is_verified=True` (Google å·²é©—è­‰)
8. æ–°å»ºç«‹çš„å¸³è™Ÿä½¿ç”¨éš¨æ©Ÿç”Ÿæˆçš„å®‰å…¨å¯†ç¢¼ (ä½¿ç”¨è€…ä¸æœƒä½¿ç”¨)
9. ç™»å…¥æˆåŠŸå¾Œè¿”å› JWT Access Token
10. ç™»å…¥æˆåŠŸå¾Œè‡ªå‹•è·³è½‰è‡³ /dashboard
11. Token å„²å­˜è‡³ localStorage
12. Google ç™»å…¥å¤±æ•—é¡¯ç¤ºæ˜ç¢ºçš„éŒ¯èª¤è¨Šæ¯
13. æ•´åˆ Google é ­åƒåœ–ç‰‡è‡³ç”¨æˆ¶è³‡æ–™ (profile_picture)
14. API å›æ‡‰æ™‚é–“éœ€ä½æ–¼ 1000ms (è€ƒæ…®ç¬¬ä¸‰æ–¹ API å»¶é²)
15. Google ç™»å…¥ä¸å— Rate Limiting å½±éŸ¿ (ç”± Google æ§åˆ¶)

## Tasks / Subtasks

> **ğŸ”§ Brownfield å°ˆæ¡ˆèªªæ˜**ï¼šå¾Œç«¯å·²æœ‰åŸºç¤çš„ Google ç™»å…¥ API (`/api/auth/google-login`)ã€‚æœ¬ Story è‘—é‡æ–¼**é©—è­‰å¾Œç«¯å¯¦ä½œ**ã€**æ•´åˆå‰ç«¯ Google OAuth æµç¨‹**ï¼Œä»¥åŠ**å®Œå–„ä½¿ç”¨è€…é«”é©—**ã€‚

### Phase 1: Google OAuth é…ç½®èˆ‡è¨­å®š

- [ ] **Task 1: å–å¾— Google OAuth2 æ†‘è­‰** (AC: 2, 3)
  - [ ] è¨ªå• Google Cloud Console (https://console.cloud.google.com)
  - [ ] å»ºç«‹æ–°å°ˆæ¡ˆæˆ–é¸æ“‡ç¾æœ‰å°ˆæ¡ˆ
  - [ ] å•Ÿç”¨ Google+ API æˆ– Google Identity Services
  - [ ] å»ºç«‹ OAuth 2.0 ç”¨æˆ¶ç«¯ ID (Web æ‡‰ç”¨ç¨‹å¼)
  - [ ] è¨­å®šæˆæ¬Šçš„ JavaScript ä¾†æºï¼š`http://localhost:8080`
  - [ ] è¨­å®šæˆæ¬Šçš„é‡æ–°å°å‘ URIï¼š`http://localhost:8080` (ä¸éœ€è¦ callback URL for implicit flow)
  - [ ] è¤‡è£½ Client ID
  - [ ] ğŸ“ å°‡ Client ID å„²å­˜è‡³ `frontend/.env.development` ä½œç‚º `VITE_GOOGLE_CLIENT_ID`

- [ ] **Task 2: é©—è­‰å¾Œç«¯ Google ç™»å…¥ API** (AC: 3, 4, 5, 6, 7, 8, 9, 13)
  - [ ] âœ… ç¢ºèª `backend/blueprints/auth.py` ä¸­çš„ `google_login()` ç«¯é»å­˜åœ¨
  - [ ] âœ… é©—è­‰ç«¯é»è·¯å¾‘ç‚º `POST /api/auth/google-login`
  - [ ] âœ… æª¢æŸ¥è«‹æ±‚ body åŒ…å« `token` æ¬„ä½ (Google ID Token)
  - [ ] âœ… é©—è­‰ä½¿ç”¨ Google tokeninfo ç«¯é»é©—è­‰ ID Token
  - [ ] âœ… ç¢ºèªå¾ tokeninfo å›æ‡‰ä¸­æå– email, name, picture
  - [ ] âœ… é©—è­‰æŸ¥è©¢ç”¨æˆ¶é‚è¼¯ï¼š`User.query.filter_by(email=email).first()`
  - [ ] âœ… ç¢ºèªæ–°ç”¨æˆ¶å»ºç«‹é‚è¼¯ï¼š
    - è¨­å®š `is_verified=True`
    - è¨­å®š `is_active=True`
    - å„²å­˜ `profile_picture` ç‚º Google é ­åƒ URL
    - ä½¿ç”¨ `secrets.token_urlsafe(32)` ç”Ÿæˆéš¨æ©Ÿå¯†ç¢¼
  - [ ] âœ… ç¢ºèª JWT Access Token ç”Ÿæˆï¼š`create_access_token(identity=str(user.user_id))`
  - [ ] âš ï¸ æª¢æŸ¥æ˜¯å¦éœ€è¦ Refresh Token (ç›®å‰å¾Œç«¯æœªè¿”å›)
  - [ ] ğŸ“ è¨˜éŒ„ä»»ä½•èˆ‡è¦æ ¼ä¸ç¬¦çš„åœ°æ–¹

### Phase 2: å‰ç«¯ Google OAuth æ•´åˆ

- [ ] **Task 3: å®‰è£ Google Identity Services SDK** (AC: 2, 3)
  - [ ] åœ¨ `frontend/index.html` çš„ `<head>` ä¸­æ·»åŠ  Google Identity Services SDK:
    ```html
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    ```
  - [ ] é©—è­‰ SDK æ­£ç¢ºè¼‰å…¥

- [ ] **Task 4: å»ºç«‹ Google OAuth Composable** (AC: 2, 3, 4, 12)
  - [ ] åœ¨ `frontend/src/composables/` å»ºç«‹ `useGoogleAuth.js`
  - [ ] å¯¦ä½œ `initGoogleAuth()` å‡½æ•¸ï¼š
    - åˆå§‹åŒ– Google Identity Services
    - é…ç½® client_id å¾ç’°å¢ƒè®Šæ•¸è®€å–
    - è¨­å®š callback å‡½æ•¸è™•ç†æˆæ¬Šå›æ‡‰
  - [ ] å¯¦ä½œ `handleGoogleLogin()` å‡½æ•¸ï¼š
    - è§¸ç™¼ Google One Tap æˆ–å½ˆå‡ºå¼ç™»å…¥
    - è™•ç†æˆåŠŸ/å¤±æ•—å›èª¿
    - å–å¾— ID Token (credential)
  - [ ] å¯¦ä½œéŒ¯èª¤è™•ç†é‚è¼¯
  - [ ] Export composable å‡½æ•¸

- [ ] **Task 5: æ“´å±• Auth API æœå‹™** (AC: 3, 4)
  - [ ] åœ¨ `frontend/src/api/auth.js` æ·»åŠ  `googleLogin(token)` å‡½æ•¸
  - [ ] å‡½æ•¸æ‡‰èª¿ç”¨ `POST /api/auth/google-login`
  - [ ] è«‹æ±‚ body åŒ…å« `{ token: <google_id_token> }`
  - [ ] è¿”å› Promise with response data

- [ ] **Task 6: æ›´æ–° Auth Store** (AC: 9, 10, 11)
  - [ ] åœ¨ `frontend/src/stores/auth.js` æ·»åŠ  `googleLogin(token)` action
  - [ ] Action æ‡‰èª¿ç”¨ `api/auth.js` çš„ `googleLogin(token)`
  - [ ] æˆåŠŸå¾Œå„²å­˜ `access_token` åˆ° localStorage
  - [ ] æˆåŠŸå¾Œå„²å­˜ç”¨æˆ¶è³‡æ–™åˆ° store çš„ `user` state
  - [ ] æˆåŠŸå¾Œè·³è½‰è‡³ `/dashboard`
  - [ ] éŒ¯èª¤è™•ç†ï¼šé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ä¸¦è¨˜éŒ„éŒ¯èª¤

- [ ] **Task 7: å‡ç´š Login.vue çµ„ä»¶** (AC: 1, 2, 10, 12)
  - [ ] åœ¨ `frontend/src/views/auth/Login.vue` æ·»åŠ ã€Œä½¿ç”¨ Google ç™»å…¥ã€æŒ‰éˆ•
  - [ ] æŒ‰éˆ•è¨­è¨ˆï¼š
    - ä½¿ç”¨ Google å®˜æ–¹å“ç‰ŒæŒ‡å— (ç™½åº•ã€Google åœ–ç¤ºã€ã€ŒSign in with Googleã€æ–‡å­—)
    - ä½ç½®ï¼šåœ¨ç™»å…¥è¡¨å–®ä¸‹æ–¹ï¼Œä½œç‚ºæ›¿ä»£ç™»å…¥æ–¹å¼
    - æ¨£å¼èˆ‡ä¸»è¦ç™»å…¥æŒ‰éˆ•ä¸€è‡´ä½†æœ‰è¦–è¦ºå€åˆ†
  - [ ] åŒ¯å…¥ `useGoogleAuth` composable
  - [ ] åœ¨ `onMounted` ä¸­èª¿ç”¨ `initGoogleAuth()`
  - [ ] æŒ‰éˆ•é»æ“Šäº‹ä»¶èª¿ç”¨ `handleGoogleLogin()`
  - [ ] è™•ç† Google ç™»å…¥çš„ loading ç‹€æ…‹
  - [ ] æ·»åŠ åˆ†éš”ç·šï¼šã€Œæˆ–ä½¿ç”¨ Email ç™»å…¥ã€

- [ ] **Task 8: å‡ç´š Register.vue çµ„ä»¶** (AC: 1, 2, 10, 12)
  - [ ] åœ¨ `frontend/src/views/auth/Register.vue` æ·»åŠ ã€Œä½¿ç”¨ Google è¨»å†Šã€æŒ‰éˆ•
  - [ ] è¤‡ç”¨ç›¸åŒçš„ Google OAuth é‚è¼¯
  - [ ] æŒ‰éˆ•æ–‡å­—ï¼šã€Œä½¿ç”¨ Google è¨»å†Šã€
  - [ ] æ·»åŠ èªªæ˜æ–‡å­—ï¼šã€Œä½¿ç”¨ Google è¨»å†Šå³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘å€‘çš„æœå‹™æ¢æ¬¾ã€
  - [ ] æˆåŠŸå¾ŒåŒæ¨£è·³è½‰è‡³ `/dashboard`

### Phase 3: UI/UX å„ªåŒ–

- [ ] **Task 9: Google ç™»å…¥æŒ‰éˆ•è¨­è¨ˆ** (AC: 1)
  - [ ] éµå¾ª Google å“ç‰ŒæŒ‡å—ï¼šhttps://developers.google.com/identity/branding-guidelines
  - [ ] ä½¿ç”¨æ­£ç¢ºçš„ Google Logo SVG
  - [ ] æŒ‰éˆ•æ–‡å­—ï¼šã€Œä½¿ç”¨ Google ç™»å…¥ã€(ç¹é«”ä¸­æ–‡) æˆ– ã€ŒSign in with Googleã€
  - [ ] æŒ‰éˆ•é¡è‰²ï¼šç™½åº• + Google å››è‰² Logo
  - [ ] Hover æ•ˆæœï¼šæ·¡ç°è‰²èƒŒæ™¯
  - [ ] æŒ‰éˆ•å°ºå¯¸ï¼šèˆ‡ä¸»è¦ç™»å…¥æŒ‰éˆ•ä¸€è‡´
  - [ ] éŸ¿æ‡‰å¼è¨­è¨ˆï¼šæ‰‹æ©Ÿç‰ˆå…¨å¯¬

- [ ] **Task 10: éŒ¯èª¤è™•ç†èˆ‡ä½¿ç”¨è€…åé¥‹** (AC: 12)
  - [ ] è™•ç†å„ç¨®éŒ¯èª¤æƒ…å¢ƒï¼š
    - Google å½ˆçª—è¢«å°é–ï¼šæç¤ºä½¿ç”¨è€…å…è¨±å½ˆçª—
    - ä½¿ç”¨è€…å–æ¶ˆæˆæ¬Šï¼šä¸é¡¯ç¤ºéŒ¯èª¤ï¼Œéœé»˜è™•ç†
    - Token é©—è­‰å¤±æ•—ï¼šã€ŒGoogle ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€
    - ç¶²è·¯éŒ¯èª¤ï¼šã€Œç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯è¨­å®šã€
    - ä¼ºæœå™¨éŒ¯èª¤ï¼šã€Œä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€
  - [ ] æ‰€æœ‰éŒ¯èª¤ä½¿ç”¨ Element Plus ElMessage é¡¯ç¤º
  - [ ] æˆåŠŸç™»å…¥é¡¯ç¤ºï¼šã€Œç™»å…¥æˆåŠŸï¼ã€

- [ ] **Task 11: Google One Tap è‡ªå‹•ç™»å…¥ (å¯é¸åŠŸèƒ½)** 
  - [ ] åœ¨ Dashboard æˆ–é¦–é å¯¦ä½œ Google One Tap
  - [ ] åƒ…åœ¨æœªç™»å…¥ç‹€æ…‹é¡¯ç¤º
  - [ ] ä½¿ç”¨è€…å¯é¸æ“‡ã€Œä¸å†é¡¯ç¤ºã€
  - [ ] é…ç½® One Tap è¨­å®šï¼š
    - `auto_select`: false (ä¸è‡ªå‹•é¸æ“‡å¸³è™Ÿ)
    - `cancel_on_tap_outside`: true (é»æ“Šå¤–éƒ¨é—œé–‰)

### Phase 4: æ¸¬è©¦èˆ‡é©—è­‰

- [ ] **Task 12: å¾Œç«¯æ¸¬è©¦è£œå……** (AC: 3, 4, 5, 6, 7, 8, 9, 13)
  - [ ] åœ¨ `backend/tests/test_auth.py` æ·»åŠ  Google ç™»å…¥æ¸¬è©¦
  - [ ] æ¸¬è©¦æ¡ˆä¾‹ï¼š
    - [ ] æ¸¬è©¦æœ‰æ•ˆçš„ Google Token (Mock Google API)
    - [ ] æ¸¬è©¦ç„¡æ•ˆçš„ Google Token (æ‡‰è¿”å› 401)
    - [ ] æ¸¬è©¦ç¼ºå°‘ Token (æ‡‰è¿”å› 400)
    - [ ] æ¸¬è©¦æ–°ç”¨æˆ¶å»ºç«‹ (Email ä¸å­˜åœ¨)
    - [ ] æ¸¬è©¦ç¾æœ‰ç”¨æˆ¶ç™»å…¥ (Email å·²å­˜åœ¨)
    - [ ] é©—è­‰æ–°ç”¨æˆ¶ `is_verified=True`
    - [ ] é©—è­‰é ­åƒæ­£ç¢ºå„²å­˜
    - [ ] é©—è­‰ JWT Token æ­£ç¢ºç”Ÿæˆ
  - [ ] ä½¿ç”¨ `pytest-mock` æˆ– `unittest.mock` Mock Google tokeninfo API
  - [ ] ğŸ§ª åŸ·è¡Œæ¸¬è©¦ï¼š`pytest backend/tests/test_auth.py -v -k google`

- [ ] **Task 13: å‰ç«¯æ¸¬è©¦å»ºç«‹** (AC: 1, 2, 10, 12)
  - [ ] åœ¨ `frontend/tests/unit/views/` å»ºç«‹ `Login.spec.js` (å¦‚ä¸å­˜åœ¨)
  - [ ] æ·»åŠ  Google ç™»å…¥ç›¸é—œæ¸¬è©¦ï¼š
    - [ ] æ¸¬è©¦ Google ç™»å…¥æŒ‰éˆ•æ­£ç¢ºæ¸²æŸ“
    - [ ] æ¸¬è©¦é»æ“ŠæŒ‰éˆ•è§¸ç™¼ `handleGoogleLogin()`
    - [ ] Mock `useGoogleAuth` composable
    - [ ] æ¸¬è©¦æˆåŠŸç™»å…¥å¾Œè·³è½‰è‡³ /dashboard
    - [ ] æ¸¬è©¦å¤±æ•—æ™‚é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
  - [ ] åœ¨ `frontend/tests/unit/composables/` å»ºç«‹ `useGoogleAuth.spec.js`
  - [ ] æ¸¬è©¦ composable é‚è¼¯ï¼š
    - [ ] æ¸¬è©¦ `initGoogleAuth()` æ­£ç¢ºåˆå§‹åŒ–
    - [ ] æ¸¬è©¦ `handleGoogleLogin()` èª¿ç”¨ Google API
    - [ ] Mock Google Identity Services
  - [ ] ğŸ§ª åŸ·è¡Œæ¸¬è©¦ï¼š`npm run test:unit`

### Phase 5: æ•´åˆæ¸¬è©¦

- [ ] **Task 14: ç«¯åˆ°ç«¯åŠŸèƒ½é©—è­‰** (æ‰€æœ‰ AC)
  - [ ] ğŸ§ª æ‰‹å‹•æ¸¬è©¦æ¸…å–®ï¼š
    - [ ] **æ¸¬è©¦ 1**: Google ç™»å…¥æˆåŠŸ (æ–°ç”¨æˆ¶)
      - è¨ªå• http://localhost:8080/login
      - é»æ“Šã€Œä½¿ç”¨ Google ç™»å…¥ã€æŒ‰éˆ•
      - é¸æ“‡ Google å¸³è™Ÿä¸¦æˆæ¬Š
      - é©—è­‰ï¼šè‡ªå‹•å»ºç«‹æ–°å¸³è™Ÿä¸¦è·³è½‰è‡³ /dashboard
      - é©—è­‰ï¼šlocalStorage åŒ…å« access_token
      - é©—è­‰ï¼šç”¨æˆ¶è³‡æ–™åŒ…å« Google é ­åƒ
      - é©—è­‰ï¼š`is_verified=True`
    - [ ] **æ¸¬è©¦ 2**: Google ç™»å…¥æˆåŠŸ (ç¾æœ‰ç”¨æˆ¶)
      - ä½¿ç”¨å·²è¨»å†Šçš„ Google Email
      - é»æ“Šã€Œä½¿ç”¨ Google ç™»å…¥ã€
      - é©—è­‰ï¼šç›´æ¥ç™»å…¥ç¾æœ‰å¸³è™Ÿ
      - é©—è­‰ï¼šç”¨æˆ¶è³‡æ–™æœªè¢«è¦†è“‹ (é™¤äº†é ­åƒå¯èƒ½æ›´æ–°)
    - [ ] **æ¸¬è©¦ 3**: Google æˆæ¬Šå–æ¶ˆ
      - é»æ“Šã€Œä½¿ç”¨ Google ç™»å…¥ã€
      - åœ¨ Google æˆæ¬Šé é¢é»æ“Šã€Œå–æ¶ˆã€
      - é©—è­‰ï¼šå›åˆ°ç™»å…¥é é¢ï¼Œç„¡éŒ¯èª¤è¨Šæ¯ (éœé»˜è™•ç†)
    - [ ] **æ¸¬è©¦ 4**: ç¶²è·¯éŒ¯èª¤è™•ç†
      - æ¨¡æ“¬ç¶²è·¯ä¸­æ–·
      - é»æ“Šã€Œä½¿ç”¨ Google ç™»å…¥ã€
      - é©—è­‰ï¼šé¡¯ç¤ºã€Œç¶²è·¯é€£ç·šå¤±æ•—ã€éŒ¯èª¤è¨Šæ¯
    - [ ] **æ¸¬è©¦ 5**: å¾è¨»å†Šé ä½¿ç”¨ Google è¨»å†Š
      - è¨ªå• /register
      - é»æ“Šã€Œä½¿ç”¨ Google è¨»å†Šã€
      - é©—è­‰ï¼šæˆåŠŸå»ºç«‹å¸³è™Ÿä¸¦è·³è½‰
    - [ ] **æ¸¬è©¦ 6**: è·¨ç€è¦½å™¨æ¸¬è©¦
      - åœ¨ Chromeã€Firefoxã€Edge æ¸¬è©¦ Google ç™»å…¥
      - é©—è­‰ï¼šæ‰€æœ‰ç€è¦½å™¨æ­£å¸¸é‹ä½œ
    - [ ] **æ¸¬è©¦ 7**: æ‰‹æ©ŸéŸ¿æ‡‰å¼æ¸¬è©¦
      - åœ¨æ‰‹æ©Ÿæ¨¡å¼æ¸¬è©¦ Google ç™»å…¥æŒ‰éˆ•
      - é©—è­‰ï¼šæŒ‰éˆ•æ­£ç¢ºé¡¯ç¤ºä¸”å¯é»æ“Š
  - [ ] ğŸ“Š é©—è­‰ API å›æ‡‰æ™‚é–“ < 1000ms (åŒ…å« Google API å»¶é²)
  - [ ] ğŸ“ è¨˜éŒ„æ‰€æœ‰æ¸¬è©¦çµæœ

### åœ–ä¾‹èªªæ˜
- âœ… **å·²å­˜åœ¨ä¸”æ­£ç¢º** - é©—è­‰é€šéå³å¯
- âš ï¸ **éœ€è¦æª¢æŸ¥** - å¯èƒ½éœ€è¦èª¿æ•´
- â• **éœ€è¦æ–°å¢** - ç¼ºå¤±çš„åŠŸèƒ½
- ğŸ”„ **éœ€è¦é‡æ§‹** - éœ€è¦æ”¹é€²ç¾æœ‰å¯¦ä½œ
- ğŸ“ **è¨˜éŒ„** - æ–‡ä»¶åŒ–ç™¼ç¾
- ğŸ§ª **æ¸¬è©¦** - åŸ·è¡Œæ¸¬è©¦
- ğŸ“Š **é©—è­‰** - ç¢ºèªç¬¦åˆéœ€æ±‚

## Dev Notes

### Previous Story Insights

**ä¾†è‡ª Story 1.1 å’Œ 1.2 çš„ç¶“é©—**ï¼š
- âœ… å¾Œç«¯ Auth Blueprint æ¶æ§‹å®Œå–„ï¼Œæ˜“æ–¼æ“´å±•æ–°çš„èªè­‰æ–¹å¼
- âœ… å‰ç«¯ Auth Store ä½¿ç”¨ localStorage å„²å­˜ Tokenï¼Œæ¨¡å¼å·²å»ºç«‹
- âœ… è·¯ç”±å®ˆè¡›æ­£ç¢ºè™•ç†èªè­‰ç‹€æ…‹
- âœ… Element Plus çµ„ä»¶åº«æä¾›è‰¯å¥½çš„ UI çµ„ä»¶
- âœ… Composition API æ˜¯æ¨™æº–åšæ³•
- âœ… éŒ¯èª¤è™•ç†æ¨¡å¼ï¼šå¾Œç«¯è¿”å›éŒ¯èª¤è¨Šæ¯ï¼Œå‰ç«¯é¡¯ç¤º ElMessage
- âš ï¸ Story 1.2 å¾Œç«¯æœªè¿”å› Refresh Tokenï¼ŒGoogle ç™»å…¥å¯èƒ½ä¹Ÿéœ€è¦è£œå……

**Brownfield å°ˆæ¡ˆèƒŒæ™¯**ï¼š
- Google ç™»å…¥å¾Œç«¯ API å·²å­˜åœ¨æ–¼ `backend/blueprints/auth.py`
- éœ€è¦é©—è­‰ç¾æœ‰å¯¦ä½œä¸¦æ•´åˆå‰ç«¯æµç¨‹
- ä¸»è¦å·¥ä½œæ˜¯å‰ç«¯ Google OAuth SDK æ•´åˆå’Œ UI å¯¦ä½œ

### Data Models

**User Model** [Source: backend/models/user.py]
- **Table**: `users`
- **Primary Key**: `user_id` (Integer, Auto-increment)
- **Google ç™»å…¥ç›¸é—œæ¬„ä½**:
  - `email` (String(120), UNIQUE, NOT NULL) - ç”¨æ–¼è­˜åˆ¥ Google å¸³è™Ÿ
  - `name` (String(100), NOT NULL) - å¾ Google ç²å–
  - `profile_picture` (String(255), NULLABLE) - Google é ­åƒ URL
  - `password_hash` (String(255), NOT NULL) - Google ç™»å…¥æ™‚è¨­ç‚ºéš¨æ©Ÿå€¼
  - `is_verified` (Boolean, DEFAULT False) - Google ç™»å…¥æ™‚è¨­ç‚º True
  - `is_active` (Boolean, DEFAULT True) - å¸³è™Ÿç‹€æ…‹
  - `created_at` (DateTime) - å¸³è™Ÿå»ºç«‹æ™‚é–“

- **Methods**:
  - `set_password(password)` - ç”¨æ–¼è¨­å®šéš¨æ©Ÿå¯†ç¢¼
  - `to_dict(include_private=False)` - è½‰æ›ç‚ºå­—å…¸æ ¼å¼

### API Specifications

**Endpoint**: `POST /api/auth/google-login` [Source: backend/blueprints/auth.py:233-289]

**Request Headers**:
```
Content-Type: application/json
```

**Request Body**:
```json
{
  "token": "eyJhbGciOiJSUzI1NiIsImtpZCI6IjY4..."  // Google ID Token
}
```

**Response (Success - 200)** - æ–°ç”¨æˆ¶æˆ–ç¾æœ‰ç”¨æˆ¶:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "user_id": 1,
    "name": "å¼µä¸‰",
    "email": "user@gmail.com",
    "profile_picture": "https://lh3.googleusercontent.com/a/..."
  }
}
```

**Response (Error - 400)**:
```json
{
  "msg": "Missing Google token"
}
// æˆ–
{
  "msg": "Google account missing email"
}
```

**Response (Error - 401)**:
```json
{
  "msg": "Invalid Google token"
}
// æˆ–
{
  "msg": "Token verification failed"
}
```

**Google Token é©—è­‰æµç¨‹**:
1. å¾Œç«¯æ¥æ”¶ Google ID Token
2. èª¿ç”¨ Google tokeninfo ç«¯é»ï¼š`https://oauth2.googleapis.com/tokeninfo?id_token={token}`
3. é©—è­‰å›æ‡‰ç‹€æ…‹ç¢¼ (200 = æœ‰æ•ˆ)
4. å¾å›æ‡‰ä¸­æå–ï¼š`email`, `name`, `picture`
5. æŸ¥è©¢ç”¨æˆ¶æ˜¯å¦å­˜åœ¨
6. ä¸å­˜åœ¨å‰‡å»ºç«‹æ–°ç”¨æˆ¶ï¼Œå­˜åœ¨å‰‡ç›´æ¥ç™»å…¥
7. è¿”å› JWT Token

**âš ï¸ æ³¨æ„äº‹é …**:
- ç›®å‰å¾Œç«¯æœªè¿”å› `refresh_token`ï¼Œå¯èƒ½éœ€è¦è£œå……
- å¾Œç«¯æœªè¿”å›å®Œæ•´çš„ user ç‰©ä»¶ (ç¼ºå°‘å…¶ä»–æ¬„ä½å¦‚ age, location ç­‰)
- å¯èƒ½éœ€è¦åœ¨å¾Œç«¯æ”¹é€²å›æ‡‰æ ¼å¼ä»¥èˆ‡ Story 1.2 ä¸€è‡´

### Component Specifications

**useGoogleAuth Composable** [æ–°å»ºç«‹]

- **Location**: `frontend/src/composables/useGoogleAuth.js`
- **Type**: Vue 3 Composable (Composition API)

**å»ºè­°çµæ§‹**:
```javascript
// frontend/src/composables/useGoogleAuth.js
import { ref } from 'vue'
import { useAuthStore } from '@/stores/auth'
import { ElMessage } from 'element-plus'

export function useGoogleAuth() {
  const authStore = useAuthStore()
  const loading = ref(false)
  
  /**
   * åˆå§‹åŒ– Google Identity Services
   */
  const initGoogleAuth = () => {
    if (!window.google) {
      console.error('Google Identity Services SDK not loaded')
      return
    }
    
    window.google.accounts.id.initialize({
      client_id: import.meta.env.VITE_GOOGLE_CLIENT_ID,
      callback: handleCredentialResponse,
      auto_select: false,
      cancel_on_tap_outside: true
    })
  }
  
  /**
   * è™•ç† Google æˆæ¬Šå›æ‡‰
   * @param {Object} response - Google credential response
   */
  const handleCredentialResponse = async (response) => {
    try {
      loading.value = true
      const credential = response.credential // Google ID Token
      
      // èª¿ç”¨ Auth Store çš„ googleLogin action
      await authStore.googleLogin(credential)
      
      ElMessage.success('ç™»å…¥æˆåŠŸï¼')
    } catch (error) {
      console.error('Google login error:', error)
      ElMessage.error('Google ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦')
    } finally {
      loading.value = false
    }
  }
  
  /**
   * è§¸ç™¼ Google ç™»å…¥
   */
  const handleGoogleLogin = () => {
    if (!window.google) {
      ElMessage.error('Google ç™»å…¥æœå‹™å°šæœªè¼‰å…¥')
      return
    }
    
    // ä½¿ç”¨ Google One Tap æˆ–å½ˆå‡ºå¼ç™»å…¥
    window.google.accounts.id.prompt()
  }
  
  /**
   * æ¸²æŸ“ Google ç™»å…¥æŒ‰éˆ•
   * @param {HTMLElement} element - è¦æ¸²æŸ“æŒ‰éˆ•çš„å®¹å™¨å…ƒç´ 
   */
  const renderGoogleButton = (element) => {
    if (!window.google || !element) return
    
    window.google.accounts.id.renderButton(
      element,
      {
        theme: 'outline',
        size: 'large',
        text: 'signin_with',
        locale: 'zh_TW'
      }
    )
  }
  
  return {
    loading,
    initGoogleAuth,
    handleGoogleLogin,
    renderGoogleButton
  }
}
```

**Login.vue æ•´åˆç¯„ä¾‹**:
```vue
<template>
  <div class="login-page">
    <div class="login-container">
      <el-card class="login-card">
        <template #header>
          <h2>ç™»å…¥ EdgeSurvivor</h2>
          <p>æ­¡è¿å›ä¾†ï¼è«‹ç™»å…¥æ‚¨çš„å¸³è™Ÿ</p>
        </template>
        
        <!-- Google ç™»å…¥æŒ‰éˆ• -->
        <div class="google-login-section">
          <el-button 
            class="google-login-btn" 
            size="large"
            @click="handleGoogleLogin"
            :loading="googleLoading"
          >
            <img src="@/assets/icons/google.svg" alt="Google" class="google-icon" />
            ä½¿ç”¨ Google ç™»å…¥
          </el-button>
        </div>
        
        <!-- åˆ†éš”ç·š -->
        <el-divider>æˆ–ä½¿ç”¨ Email ç™»å…¥</el-divider>
        
        <!-- åŸæœ‰çš„ Email ç™»å…¥è¡¨å–® -->
        <el-form ref="formRef" :model="formData" :rules="rules">
          <!-- ... è¡¨å–®å…§å®¹ ... -->
        </el-form>
        
        <div class="register-prompt">
          é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ
          <router-link to="/register">ç«‹å³è¨»å†Š</router-link>
        </div>
      </el-card>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { useAuthStore } from '@/stores/auth'
import { useGoogleAuth } from '@/composables/useGoogleAuth'
import { ElMessage } from 'element-plus'

const authStore = useAuthStore()
const { loading: googleLoading, initGoogleAuth, handleGoogleLogin } = useGoogleAuth()

// ... åŸæœ‰çš„ç™»å…¥é‚è¼¯ ...

onMounted(() => {
  // åˆå§‹åŒ– Google Auth
  initGoogleAuth()
})
</script>

<style lang="scss" scoped>
.google-login-section {
  margin-bottom: var(--spacing-lg);
}

.google-login-btn {
  width: 100%;
  background: white;
  color: #3c4043;
  border: 1px solid #dadce0;
  font-weight: 500;
  
  &:hover {
    background: #f8f9fa;
    border-color: #dadce0;
  }
  
  .google-icon {
    width: 18px;
    height: 18px;
    margin-right: var(--spacing-sm);
  }
}

.el-divider {
  margin: var(--spacing-lg) 0;
  color: var(--color-text-secondary);
}
</style>
```

### File Locations

Based on [Source: architecture/3-å°ˆæ¡ˆçµæ§‹-project-structure.md]:

**Frontend**:
- Google Auth Composable: `frontend/src/composables/useGoogleAuth.js` (æ–°å»º)
- èªè­‰ API æœå‹™: `frontend/src/api/auth.js` (æ“´å±•)
- èªè­‰ Store: `frontend/src/stores/auth.js` (æ“´å±•)
- ç™»å…¥é é¢: `frontend/src/views/auth/Login.vue` (ä¿®æ”¹)
- è¨»å†Šé é¢: `frontend/src/views/auth/Register.vue` (ä¿®æ”¹)
- Google Logo åœ–ç¤º: `frontend/src/assets/icons/google.svg` (æ–°å»º)
- ç’°å¢ƒè®Šæ•¸: `frontend/.env.development` (æ·»åŠ  VITE_GOOGLE_CLIENT_ID)
- HTML æ¨¡æ¿: `frontend/index.html` (æ·»åŠ  Google SDK)
- å‰ç«¯æ¸¬è©¦: `frontend/tests/unit/composables/useGoogleAuth.spec.js` (æ–°å»º)
- å‰ç«¯æ¸¬è©¦: `frontend/tests/unit/views/Login.spec.js` (æ“´å±•)

**Backend**:
- èªè­‰ Blueprint: `backend/blueprints/auth.py` (å·²å­˜åœ¨ google_login)
- User Model: `backend/models/user.py`
- å¾Œç«¯æ¸¬è©¦: `backend/tests/test_auth.py` (æ“´å±•)

**é…ç½®æ–‡ä»¶**:
- éœ€è¦åœ¨ Google Cloud Console å»ºç«‹ OAuth 2.0 æ†‘è­‰
- Client ID å„²å­˜åœ¨å‰ç«¯ç’°å¢ƒè®Šæ•¸

### Testing Requirements

Based on [Source: architecture/11-æ¸¬è©¦ç­–ç•¥-testing-requirements.md]:

**Unit Testing (Vitest)**:
- **Location**: `frontend/tests/unit/composables/useGoogleAuth.spec.js`
- **Framework**: Vitest + @vue/test-utils
- **Test Cases**:
  1. `initGoogleAuth()` æ­£ç¢ºåˆå§‹åŒ– Google Identity Services
  2. `handleGoogleLogin()` èª¿ç”¨ Google prompt
  3. `handleCredentialResponse()` è™•ç†æˆåŠŸæˆæ¬Š
  4. `handleCredentialResponse()` è™•ç†å¤±æ•—æˆæ¬Š
  5. Google SDK æœªè¼‰å…¥æ™‚çš„éŒ¯èª¤è™•ç†
  6. Loading ç‹€æ…‹æ­£ç¢ºåˆ‡æ›

- **Location**: `frontend/tests/unit/views/Login.spec.js` (æ“´å±•)
- **Test Cases**:
  1. Google ç™»å…¥æŒ‰éˆ•æ­£ç¢ºæ¸²æŸ“
  2. é»æ“ŠæŒ‰éˆ•è§¸ç™¼ `handleGoogleLogin()`
  3. Google ç™»å…¥æˆåŠŸå¾Œè·³è½‰è‡³ /dashboard
  4. Google ç™»å…¥å¤±æ•—é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯

**Backend Testing (pytest)**:
- **Location**: `backend/tests/test_auth.py`
- **Framework**: pytest + pytest-flask + pytest-mock
- **Test Cases**:
  1. æœ‰æ•ˆ Google Token ç™»å…¥ (Mock Google API)
  2. ç„¡æ•ˆ Google Token è¿”å› 401
  3. ç¼ºå°‘ Token è¿”å› 400
  4. æ–°ç”¨æˆ¶å»ºç«‹ (Email ä¸å­˜åœ¨)
  5. ç¾æœ‰ç”¨æˆ¶ç™»å…¥ (Email å·²å­˜åœ¨)
  6. é©—è­‰ `is_verified=True`
  7. é©—è­‰é ­åƒæ­£ç¢ºå„²å­˜
  8. é©—è­‰ JWT Token ç”Ÿæˆ

**Running Tests**:
```bash
# Frontend
npm run test:unit

# Backend (Google ç™»å…¥æ¸¬è©¦)
pytest backend/tests/test_auth.py -v -k google
```

**Mock ç­–ç•¥**:
- å‰ç«¯ï¼šMock `window.google.accounts.id` API
- å¾Œç«¯ï¼šMock `requests.get()` å° Google tokeninfo çš„èª¿ç”¨

### Technical Constraints

[Source: architecture/2-å‰ç«¯æŠ€è¡“æ£§-frontend-tech-stack.md + PRD]

1. **Framework Versions**:
   - Vue.js 3.3.8+
   - Element Plus 2.4.2+
   - Pinia 2.1.7+
   - Flask-JWT-Extended (backend)

2. **Third-Party SDKs**:
   - Google Identity Services (GSI)
   - SDK URL: `https://accounts.google.com/gsi/client`
   - æ–‡ä»¶: https://developers.google.com/identity/gsi/web

3. **Security Requirements**:
   - Google ID Token å¿…é ˆåœ¨å¾Œç«¯é©—è­‰ (ä¸ä¿¡ä»»å‰ç«¯)
   - ä½¿ç”¨ Google tokeninfo ç«¯é»é©—è­‰ Token
   - æ–°å»ºç”¨æˆ¶å¿…é ˆç”Ÿæˆå®‰å…¨éš¨æ©Ÿå¯†ç¢¼
   - JWT Token Identity ä½¿ç”¨å­—ä¸²æ ¼å¼çš„ user_id

4. **Performance Requirements** [NFR1]:
   - API å›æ‡‰æ™‚é–“ < 1000ms (åŒ…å« Google API å»¶é²)
   - å‰ç«¯æ‡‰é¡¯ç¤º loading ç‹€æ…‹

5. **Browser Support** [NFR3]:
   - Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
   - Google Identity Services æ”¯æ´æ‰€æœ‰ç¾ä»£ç€è¦½å™¨

6. **Google å“ç‰ŒæŒ‡å—**:
   - å¿…é ˆéµå¾ª Google å“ç‰ŒæŒ‡å—
   - æ–‡ä»¶: https://developers.google.com/identity/branding-guidelines
   - æŒ‰éˆ•é¡è‰²ã€Logoã€æ–‡å­—å¿…é ˆç¬¦åˆè¦ç¯„

### Project Structure Notes

[Source: architecture/3-å°ˆæ¡ˆçµæ§‹-project-structure.md]

**æ–°å¢ç›®éŒ„/æª”æ¡ˆ**:
- âœ… `frontend/src/composables/` - å­˜æ”¾å¯é‡ç”¨é‚è¼¯ (useGoogleAuth)
- âœ… `frontend/src/assets/icons/` - å­˜æ”¾ SVG åœ–ç¤º (Google Logo)
- âœ… `frontend/.env.development` - ç’°å¢ƒè®Šæ•¸é…ç½®

**ä¿®æ”¹æª”æ¡ˆ**:
- âœ… `frontend/src/api/auth.js` - æ·»åŠ  googleLogin å‡½æ•¸
- âœ… `frontend/src/stores/auth.js` - æ·»åŠ  googleLogin action
- âœ… `frontend/src/views/auth/Login.vue` - æ•´åˆ Google ç™»å…¥æŒ‰éˆ•
- âœ… `frontend/src/views/auth/Register.vue` - æ•´åˆ Google è¨»å†ŠæŒ‰éˆ•
- âœ… `frontend/index.html` - æ·»åŠ  Google SDK script

**ç„¡çµæ§‹è¡çª**ï¼šæ‰€æœ‰æ–°å¢æª”æ¡ˆç¬¦åˆç¾æœ‰å°ˆæ¡ˆçµæ§‹ã€‚

### Additional Notes

**Google OAuth 2.0 æµç¨‹**:
1. ç”¨æˆ¶é»æ“Šã€Œä½¿ç”¨ Google ç™»å…¥ã€
2. è§¸ç™¼ Google Identity Services (One Tap æˆ–å½ˆçª—)
3. ç”¨æˆ¶é¸æ“‡ Google å¸³è™Ÿä¸¦æˆæ¬Š
4. Google è¿”å› ID Token (JWT æ ¼å¼) çµ¦å‰ç«¯
5. å‰ç«¯å°‡ ID Token ç™¼é€è‡³å¾Œç«¯ `/api/auth/google-login`
6. å¾Œç«¯é©—è­‰ ID Token æœ‰æ•ˆæ€§
7. å¾Œç«¯å»ºç«‹æˆ–ç™»å…¥ç”¨æˆ¶
8. å¾Œç«¯è¿”å› JWT Access Token
9. å‰ç«¯å„²å­˜ Token ä¸¦è·³è½‰è‡³ /dashboard

**Google ID Token å…§å®¹** (decoded):
```json
{
  "iss": "https://accounts.google.com",
  "sub": "110169484474386276334",
  "azp": "1234567890.apps.googleusercontent.com",
  "aud": "1234567890.apps.googleusercontent.com",
  "iat": 1234567890,
  "exp": 1234567890,
  "email": "user@gmail.com",
  "email_verified": true,
  "name": "å¼µä¸‰",
  "picture": "https://lh3.googleusercontent.com/a/...",
  "given_name": "ä¸‰",
  "family_name": "å¼µ",
  "locale": "zh-TW"
}
```

**ç’°å¢ƒè®Šæ•¸é…ç½®**:
```bash
# frontend/.env.development
VITE_API_BASE_URL=http://localhost:5000/api
VITE_GOOGLE_CLIENT_ID=your-google-client-id.apps.googleusercontent.com
```

**Google Cloud Console è¨­å®šæ­¥é©Ÿ**:
1. è¨ªå• https://console.cloud.google.com
2. å»ºç«‹å°ˆæ¡ˆæˆ–é¸æ“‡ç¾æœ‰å°ˆæ¡ˆ
3. å•Ÿç”¨ã€ŒGoogle+ APIã€æˆ–ã€ŒGoogle Identity Servicesã€
4. å°èˆªè‡³ã€ŒAPI å’Œæœå‹™ã€>ã€Œæ†‘è­‰ã€
5. å»ºç«‹ã€ŒOAuth 2.0 ç”¨æˆ¶ç«¯ IDã€
6. æ‡‰ç”¨ç¨‹å¼é¡å‹ï¼šã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€
7. æˆæ¬Šçš„ JavaScript ä¾†æºï¼š`http://localhost:8080`
8. å„²å­˜ä¸¦è¤‡è£½ Client ID

**æœªä¾†å¯èƒ½éœ€è¦çš„å¢å¼·**:
1. **Refresh Token**: è£œå……å¾Œç«¯è¿”å› Refresh Token
2. **å¸³è™Ÿç¶å®š**: å…è¨±ç¾æœ‰å¸³è™Ÿç¶å®š Google å¸³è™Ÿ
3. **å…¶ä»–ç¤¾äº¤ç™»å…¥**: Facebook, Line, Apple
4. **One Tap è‡ªå‹•ç™»å…¥**: åœ¨é¦–é å¯¦ä½œ Google One Tap

**åƒè€ƒè³‡æº**:
- Google Identity Services: https://developers.google.com/identity/gsi/web
- Google å“ç‰ŒæŒ‡å—: https://developers.google.com/identity/branding-guidelines
- Google OAuth 2.0: https://developers.google.com/identity/protocols/oauth2

## Testing

### Frontend Testing
```bash
# åŸ·è¡Œå–®å…ƒæ¸¬è©¦
npm run test:unit

# åŸ·è¡Œå¸¶è¦†è“‹ç‡çš„æ¸¬è©¦
npm run test:coverage

# UI æ¸¬è©¦æ¨¡å¼
npm run test:ui
```

### Backend Testing
```bash
# åŸ·è¡Œ Google ç™»å…¥ç›¸é—œæ¸¬è©¦
pytest backend/tests/test_auth.py -v -k google

# åŸ·è¡Œæ‰€æœ‰èªè­‰æ¸¬è©¦
pytest backend/tests/test_auth.py -v

# å¸¶è¦†è“‹ç‡å ±å‘Š
pytest backend/tests/test_auth.py --cov=backend/blueprints/auth --cov-report=html
```

### Manual Testing Checklist

- [ ] åœ¨ Chrome æ¸¬è©¦ Google ç™»å…¥
- [ ] åœ¨ Firefox æ¸¬è©¦ Google ç™»å…¥
- [ ] åœ¨ Edge æ¸¬è©¦ Google ç™»å…¥
- [ ] åœ¨æ‰‹æ©Ÿæ¨¡å¼æ¸¬è©¦ Google ç™»å…¥
- [ ] æ¸¬è©¦æ–°ç”¨æˆ¶è¨»å†Šæµç¨‹
- [ ] æ¸¬è©¦ç¾æœ‰ç”¨æˆ¶ç™»å…¥æµç¨‹
- [ ] æ¸¬è©¦å–æ¶ˆæˆæ¬Šæƒ…å¢ƒ
- [ ] æ¸¬è©¦ç¶²è·¯éŒ¯èª¤è™•ç†
- [ ] é©—è­‰é ­åƒæ­£ç¢ºé¡¯ç¤º
- [ ] é©—è­‰ Token æ­£ç¢ºå„²å­˜

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*æ­¤å€å¡Šç”±é–‹ç™¼ä»£ç†åœ¨å¯¦ä½œæ™‚å¡«å¯«*

### Agent Model Used

(å¾…é–‹ç™¼ä»£ç†å¡«å¯«)

### Debug Log References

(å¾…é–‹ç™¼ä»£ç†å¡«å¯«)

### Completion Notes List

(å¾…é–‹ç™¼ä»£ç†å¡«å¯«)

### File List

(å¾…é–‹ç™¼ä»£ç†å¡«å¯«)

## QA Results

*æ­¤å€å¡Šç”± QA ä»£ç†å¯©æŸ¥å¾Œæ›´æ–°å¯©æŸ¥çµæœ*
