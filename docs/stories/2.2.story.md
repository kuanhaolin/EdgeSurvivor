# Story 2.2: é ­åƒä¸Šå‚³

## Status

Draft

## Story

**As a** ä½¿ç”¨è€…,
**I want** ä¸Šå‚³ä¸€å¼µå€‹äººé ­åƒ,
**so that** å…¶ä»–ç”¨æˆ¶å¯ä»¥é€éæˆ‘çš„é ­åƒæ›´å®¹æ˜“è­˜åˆ¥æˆ‘ï¼Œæå‡ç¤¾äº¤äº’å‹•çš„ä¿¡ä»»åº¦ã€‚

## Acceptance Criteria

### é ­åƒä¸Šå‚³åŠŸèƒ½

1. ä½¿ç”¨è€…å¯ä»¥åœ¨å€‹äººè³‡æ–™é é¢å­˜å–ã€Œä¸Šå‚³é ­åƒã€åŠŸèƒ½
2. æä¾›åœ–ç‰‡é¸æ“‡å™¨ï¼Œæ”¯æ´ä»¥ä¸‹æ ¼å¼ï¼š
   - JPG / JPEG
   - PNG
   - GIF
   - WEBP
3. æª”æ¡ˆå¤§å°é™åˆ¶ç‚º 2MB
4. ä¸Šå‚³å‰æ‡‰é¡¯ç¤ºåœ–ç‰‡é è¦½
5. é è¦½åœ–ç‰‡æ‡‰ä»¥åœ“å½¢é¡¯ç¤ºï¼ˆç¬¦åˆé ­åƒæ¨£å¼ï¼‰

### åœ–ç‰‡é©—è­‰

6. é¸æ“‡æª”æ¡ˆå¾Œæ‡‰é©—è­‰ï¼š
   - æª”æ¡ˆæ ¼å¼æ˜¯å¦æ”¯æ´
   - æª”æ¡ˆå¤§å°æ˜¯å¦åœ¨é™åˆ¶å…§
7. é©—è­‰å¤±æ•—æ™‚é¡¯ç¤ºå…·é«”éŒ¯èª¤è¨Šæ¯
8. åªå…è¨±é¸æ“‡åœ–ç‰‡é¡å‹çš„æª”æ¡ˆ

### ä¸Šå‚³æµç¨‹

9. é»æ“Šã€Œä¸Šå‚³ã€æŒ‰éˆ•è§¸ç™¼ä¸Šå‚³
10. ä¸Šå‚³éç¨‹ä¸­é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
11. ä¸Šå‚³æˆåŠŸå¾Œï¼š
    - é¡¯ç¤ºæˆåŠŸè¨Šæ¯ã€Œé ­åƒæ›´æ–°æˆåŠŸï¼ã€
    - è‡ªå‹•æ›´æ–°é é¢ä¸Šçš„é ­åƒé¡¯ç¤º
    - æ›´æ–°å°èˆªæ¬„ä¸­çš„é ­åƒ
12. ä¸Šå‚³å¤±æ•—æ™‚ï¼š
    - é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    - ä¿ç•™åŸæœ‰é ­åƒ
    - å…è¨±é‡æ–°ä¸Šå‚³

### é ­åƒé¡¯ç¤º

13. é ­åƒæ‡‰åœ¨ä»¥ä¸‹ä½ç½®é¡¯ç¤ºï¼š
    - å€‹äººè³‡æ–™é é¢
    - å°èˆªæ¬„ç”¨æˆ¶é¸å–®
    - æ´»å‹•åƒèˆ‡è€…åˆ—è¡¨
    - èŠå¤©è¨Šæ¯æ°£æ³¡æ—
14. æœªä¸Šå‚³é ­åƒæ™‚ï¼Œé¡¯ç¤ºé è¨­é ­åƒï¼ˆä½¿ç”¨è€…å§“åé¦–å­—æ¯ï¼‰
15. é ­åƒåœ–ç‰‡æ‡‰ä½¿ç”¨ CDN æˆ–å„ªåŒ–çš„éœæ…‹è³‡æºæœå‹™

### ä½¿ç”¨è€…é«”é©—

16. æ”¯æ´æ‹–æ”¾ä¸Šå‚³ï¼ˆDrag & Dropï¼‰
17. æ”¯æ´é»æ“Šé¸æ“‡æª”æ¡ˆ
18. åœ–ç‰‡é è¦½æ‡‰æ”¯æ´ç¸®æ”¾èˆ‡è£åˆ‡ï¼ˆå¯é¸åŠŸèƒ½ï¼‰
19. ä¸Šå‚³å¾Œæ‡‰æ¸…é™¤æª”æ¡ˆé¸æ“‡å™¨ç‹€æ…‹

### å®‰å…¨æ€§èˆ‡æ•ˆèƒ½

20. ä¸Šå‚³éœ€è¦ JWT èªè­‰
21. æª”æ¡ˆåç¨±æ‡‰ä½¿ç”¨ UUID åŠ æ™‚é–“æˆ³ï¼Œé¿å…è¡çª
22. åœ–ç‰‡æ‡‰å„²å­˜è‡³å¾Œç«¯ `uploads/` ç›®éŒ„
23. API å›æ‡‰æ™‚é–“éœ€ä½æ–¼ 2000ms
24. èªè­‰å¤±æ•ˆæ™‚è‡ªå‹•è·³è½‰è‡³ç™»å…¥é 

## Tasks / Subtasks

> **ğŸ”§ Brownfield å°ˆæ¡ˆèªªæ˜**ï¼šå¾Œç«¯å·²å¯¦ä½œåœ–ç‰‡ä¸Šå‚³ API (`POST /api/upload/image`)ã€‚æœ¬ Story è‘—é‡æ–¼**å»ºç«‹å‰ç«¯é ­åƒä¸Šå‚³çµ„ä»¶**ã€**æ•´åˆç¾æœ‰ä¸Šå‚³ API**ï¼Œä»¥åŠ**æ›´æ–°å€‹äººè³‡æ–™ API ä»¥å„²å­˜é ­åƒ URL**ã€‚

### Phase 1: å¾Œç«¯ API é©—è­‰èˆ‡æ“´å±•

- [ ] **Task 1: é©—è­‰åœ–ç‰‡ä¸Šå‚³ API** (AC: 2, 3, 9, 20, 21, 22, 23)
  - [ ] âœ… ç¢ºèª `backend/blueprints/upload.py` ä¸­çš„ `upload_image()` ç«¯é»å­˜åœ¨
  - [ ] âœ… é©—è­‰ç«¯é»è·¯å¾‘ç‚º `POST /api/upload/image`
  - [ ] âœ… æª¢æŸ¥éœ€è¦ JWT èªè­‰ (`@jwt_required()`)
  - [ ] âœ… ç¢ºèªæ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼šPNG, JPG, JPEG, GIF, WEBP
  - [ ] âœ… ç¢ºèªæª”æ¡ˆå¤§å°é™åˆ¶ç‚º 2MB
  - [ ] âœ… ç¢ºèªæª”æ¡ˆå‘½åç­–ç•¥ï¼š`{user_id}_{uuid}_{timestamp}.{ext}`
  - [ ] âœ… ç¢ºèªå›æ‡‰æ ¼å¼åŒ…å«ï¼š
    ```json
    {
      "message": "ä¸Šå‚³æˆåŠŸ",
      "url": "/uploads/{filename}",
      "filename": "{filename}"
    }
    ```
  - [ ] âœ… æ¸¬è©¦ API å›æ‡‰æ™‚é–“ < 2000ms
  - [ ] ğŸ“ è¨˜éŒ„ä»»ä½•èˆ‡è¦æ ¼ä¸ç¬¦çš„åœ°æ–¹

- [ ] **Task 2: æ“´å±•ç”¨æˆ¶è³‡æ–™æ¨¡å‹èˆ‡ API** (AC: 11, 12, 13)
  - [ ] âš ï¸ æª¢æŸ¥ `backend/models/user.py` æ˜¯å¦æœ‰ `avatar` æ¬„ä½
  - [ ] â• è‹¥ç¼ºå¤±ï¼Œæ·»åŠ  `avatar` æ¬„ä½ (String(500), nullable=True)
  - [ ] âš ï¸ æª¢æŸ¥ `backend/blueprints/users.py` ä¸­çš„ `update_profile()` ç«¯é»
  - [ ] â• ç¢ºèªç«¯é»æ”¯æ´æ›´æ–° `avatar` æ¬„ä½
  - [ ] â• ç¢ºèª GET `/api/users/profile` å›æ‡‰åŒ…å« `avatar` URL
  - [ ] ğŸ§ª æ¸¬è©¦æ›´æ–°é ­åƒ URL åŠŸèƒ½

### Phase 2: å‰ç«¯ä¸Šå‚³çµ„ä»¶å»ºç«‹

- [ ] **Task 3: å»ºç«‹ AvatarUploader çµ„ä»¶** (AC: 1, 2, 4, 5, 16, 17)
  - [ ] â• åœ¨ `frontend/src/components/` å»ºç«‹ `AvatarUploader.vue`
  - [ ] â• ä½¿ç”¨ Element Plus `<el-upload>` çµ„ä»¶
  - [ ] â• è¨­è¨ˆçµ„ä»¶çµæ§‹ï¼š
    - åœ“å½¢é ­åƒé è¦½å€
    - ä¸Šå‚³è§¸ç™¼æŒ‰éˆ•
    - æ‹–æ”¾ä¸Šå‚³å€åŸŸ
  - [ ] â• å¯¦ä½œæª”æ¡ˆé¸æ“‡åŠŸèƒ½ï¼ˆé»æ“Šä¸Šå‚³ï¼‰
  - [ ] â• å¯¦ä½œæ‹–æ”¾ä¸Šå‚³åŠŸèƒ½ï¼ˆDrag & Dropï¼‰
  - [ ] â• é…ç½® `accept="image/jpeg,image/png,image/gif,image/webp"`
  - [ ] â• è¨­å®š `limit="1"` é™åˆ¶å–®æ¬¡ä¸Šå‚³ä¸€å¼µåœ–ç‰‡

- [ ] **Task 4: å¯¦ä½œåœ–ç‰‡é è¦½åŠŸèƒ½** (AC: 4, 5)
  - [ ] â• ä½¿ç”¨ `FileReader` API è®€å–é¸æ“‡çš„åœ–ç‰‡
  - [ ] â• å¯¦ä½œ `handlePreview()` å‡½æ•¸é¡¯ç¤ºåœ–ç‰‡é è¦½
  - [ ] â• é è¦½åœ–ç‰‡ä½¿ç”¨åœ“å½¢æ¨£å¼ï¼ˆ`border-radius: 50%`ï¼‰
  - [ ] â• æ”¯æ´é è¦½å°ºå¯¸ï¼šå»ºè­° 150x150px
  - [ ] â• æä¾›ã€Œå–æ¶ˆã€é¸é …æ¸…é™¤é è¦½

- [ ] **Task 5: å¯¦ä½œæª”æ¡ˆé©—è­‰** (AC: 2, 3, 6, 7, 8)
  - [ ] â• å¯¦ä½œ `beforeUpload()` hook é€²è¡Œé©—è­‰
  - [ ] â• é©—è­‰æª”æ¡ˆæ ¼å¼ï¼š
    ```javascript
    const validFormats = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']
    if (!validFormats.includes(file.type)) {
      ElMessage.error('åªæ”¯æ´ JPG, PNG, GIF, WEBP æ ¼å¼')
      return false
    }
    ```
  - [ ] â• é©—è­‰æª”æ¡ˆå¤§å°ï¼š
    ```javascript
    const isLt2M = file.size / 1024 / 1024 < 2
    if (!isLt2M) {
      ElMessage.error('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 2MB')
      return false
    }
    ```
  - [ ] â• é©—è­‰é€šéå¾Œé¡¯ç¤ºé è¦½

### Phase 3: API æœå‹™æ•´åˆ

- [ ] **Task 6: æ“´å±• Upload API æœå‹™** (AC: 9, 10, 11, 12)
  - [ ] â• åœ¨ `frontend/src/api/upload.js` å»ºç«‹æˆ–ç¢ºèªæª”æ¡ˆ
  - [ ] â• å¯¦ä½œ `uploadAvatar()` å‡½æ•¸ï¼š
    ```javascript
    export const uploadAvatar = (file) => {
      const formData = new FormData()
      formData.append('image', file)
      
      return axios.post('/upload/image', formData, {
        headers: {
          'Content-Type': 'multipart/form-data'
        }
      })
    }
    ```
  - [ ] â• è™•ç†ä¸Šå‚³é€²åº¦ï¼ˆä½¿ç”¨ `onUploadProgress`ï¼‰
  - [ ] â• è¿”å› Promise with response data

- [ ] **Task 7: æ“´å±• Users API æœå‹™** (AC: 11, 13)
  - [ ] â• åœ¨ `frontend/src/api/users.js` ç¢ºèªæˆ–æ·»åŠ  `updateProfile()` å‡½æ•¸
  - [ ] â• ç¢ºèªå‡½æ•¸æ”¯æ´æ›´æ–° `avatar` æ¬„ä½ï¼š
    ```javascript
    export const updateProfile = (profileData) => {
      return axios.put('/users/profile', profileData)
    }
    ```
  - [ ] â• ç¢ºèª `getProfile()` å‡½æ•¸å›å‚³åŒ…å« `avatar` æ¬„ä½

- [ ] **Task 8: å¯¦ä½œä¸Šå‚³é‚è¼¯** (AC: 9, 10, 11, 12, 19, 24)
  - [ ] â• å»ºç«‹ `handleUpload()` å‡½æ•¸
  - [ ] â• ä½¿ç”¨ `uploadAvatar()` API ä¸Šå‚³åœ–ç‰‡
  - [ ] â• å¯¦ä½œè¼‰å…¥ç‹€æ…‹ç®¡ç†ï¼ˆ`uploading` refï¼‰
  - [ ] â• ä¸Šå‚³æˆåŠŸå¾Œï¼š
    - å–å¾—åœ–ç‰‡ URL
    - èª¿ç”¨ `updateProfile({ avatar: url })` æ›´æ–°ç”¨æˆ¶è³‡æ–™
    - é¡¯ç¤ºæˆåŠŸè¨Šæ¯ï¼ˆ`ElMessage.success()`ï¼‰
    - æ›´æ–° Auth Store ä¸­çš„ç”¨æˆ¶é ­åƒ
    - æ¸…é™¤æª”æ¡ˆé¸æ“‡å™¨ç‹€æ…‹
  - [ ] â• ä¸Šå‚³å¤±æ•—æ™‚ï¼š
    - æ•ç²éŒ¯èª¤
    - é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼ˆ`ElMessage.error()`ï¼‰
    - ä¿ç•™åŸé ­åƒ
  - [ ] â• è™•ç†èªè­‰å¤±æ•ˆï¼ˆ401ï¼‰ï¼šè‡ªå‹•è·³è½‰è‡³ç™»å…¥é 

### Phase 4: ç‹€æ…‹ç®¡ç†æ•´åˆ

- [ ] **Task 9: æ›´æ–° Auth Store** (AC: 11, 13)
  - [ ] â• åœ¨ `frontend/src/stores/auth.js` ç¢ºèªç”¨æˆ¶è³‡æ–™çµæ§‹åŒ…å« `avatar`
  - [ ] â• æ·»åŠ  `updateAvatar()` actionï¼š
    ```javascript
    updateAvatar(avatarUrl) {
      if (this.user) {
        this.user.avatar = avatarUrl
      }
    }
    ```
  - [ ] â• ç¢ºèª `fetchProfile()` action æœƒè¼‰å…¥é ­åƒè³‡æ–™
  - [ ] â• æ·»åŠ  `avatarUrl` computed propertyï¼š
    ```javascript
    avatarUrl() {
      return this.user?.avatar || null
    }
    ```

### Phase 5: UI æ•´åˆèˆ‡é¡¯ç¤º

- [ ] **Task 10: æ•´åˆåˆ°å€‹äººè³‡æ–™é é¢** (AC: 1, 13)
  - [ ] â• åœ¨ `frontend/src/views/Profile.vue` æˆ– `ProfileEdit.vue` å¼•å…¥ `AvatarUploader` çµ„ä»¶
  - [ ] â• æ·»åŠ é ­åƒä¸Šå‚³å€å¡Š
  - [ ] â• é¡¯ç¤ºç•¶å‰é ­åƒï¼ˆå¾ Auth Store å–å¾—ï¼‰
  - [ ] â• æˆåŠŸä¸Šå‚³å¾Œè‡ªå‹•æ›´æ–°é ­åƒé¡¯ç¤º

- [ ] **Task 11: æ›´æ–°å°èˆªæ¬„é ­åƒ** (AC: 13)
  - [ ] âš ï¸ æª¢æŸ¥ `frontend/src/components/layout/NavBar.vue`
  - [ ] â• ä½¿ç”¨ Auth Store çš„ `avatarUrl` é¡¯ç¤ºé ­åƒ
  - [ ] â• å¯¦ä½œé ­åƒçµ„ä»¶ï¼š
    ```vue
    <el-avatar 
      :src="authStore.avatarUrl" 
      :size="40"
      v-if="authStore.avatarUrl"
    />
    <el-avatar v-else :size="40">
      {{ authStore.user?.name?.charAt(0) }}
    </el-avatar>
    ```
  - [ ] â• é ­åƒä¸Šå‚³æˆåŠŸå¾Œè‡ªå‹•æ›´æ–°å°èˆªæ¬„é ­åƒ

- [ ] **Task 12: å»ºç«‹ Avatar é€šç”¨çµ„ä»¶** (AC: 13, 14)
  - [ ] â• åœ¨ `frontend/src/components/common/` å»ºç«‹ `UserAvatar.vue`
  - [ ] â• çµ„ä»¶æ¥å— propsï¼š`avatar`, `name`, `size`
  - [ ] â• å¯¦ä½œé‚è¼¯ï¼š
    - è‹¥æœ‰ `avatar`ï¼Œé¡¯ç¤ºåœ–ç‰‡
    - è‹¥ç„¡ `avatar`ï¼Œé¡¯ç¤ºå§“åé¦–å­—æ¯ä½œç‚ºé è¨­é ­åƒ
  - [ ] â• æ”¯æ´ä¸åŒå°ºå¯¸ï¼šsmall (32px), medium (40px), large (64px)
  - [ ] â• åœ¨ä»¥ä¸‹ä½ç½®ä½¿ç”¨æ­¤çµ„ä»¶ï¼š
    - å€‹äººè³‡æ–™é é¢
    - å°èˆªæ¬„
    - æ´»å‹•åƒèˆ‡è€…åˆ—è¡¨ï¼ˆæœªä¾†ï¼‰
    - èŠå¤©è¨Šæ¯æ°£æ³¡ï¼ˆæœªä¾†ï¼‰

### Phase 6: æ¨£å¼èˆ‡ UX å„ªåŒ–

- [ ] **Task 13: å¯¦ä½œçµ„ä»¶æ¨£å¼** (AC: 5, 16, 17)
  - [ ] â• è¨­è¨ˆåœ“å½¢é ­åƒé è¦½æ¨£å¼
  - [ ] â• å¯¦ä½œæ‹–æ”¾å€åŸŸè¦–è¦ºæç¤ºï¼š
    - æ‹–æ”¾æ™‚é¡¯ç¤ºè™›ç·šé‚Šæ¡†
    - Hover æ™‚æ”¹è®Šé¡è‰²
  - [ ] â• æ·»åŠ ä¸Šå‚³æŒ‰éˆ•æ¨£å¼
  - [ ] â• å¯¦ä½œè¼‰å…¥ç‹€æ…‹å‹•ç•«ï¼ˆæ—‹è½‰åœ–ç¤ºï¼‰
  - [ ] â• ç¢ºä¿éŸ¿æ‡‰å¼è¨­è¨ˆï¼ˆæ‰‹æ©Ÿã€å¹³æ¿ã€æ¡Œé¢ï¼‰

- [ ] **Task 14: åœ–ç‰‡è£åˆ‡åŠŸèƒ½ï¼ˆå¯é¸ï¼‰** (AC: 18)
  - [ ] âš ï¸ è©•ä¼°æ˜¯å¦éœ€è¦åœ–ç‰‡è£åˆ‡åŠŸèƒ½
  - [ ] â• è‹¥éœ€è¦ï¼Œæ•´åˆ `vue-cropper` æˆ–é¡ä¼¼å¥—ä»¶
  - [ ] â• å¯¦ä½œè£åˆ‡ä»‹é¢ï¼š
    - åœ“å½¢è£åˆ‡æ¡†
    - ç¸®æ”¾æ§åˆ¶
    - æ—‹è½‰æ§åˆ¶
  - [ ] â• è£åˆ‡å¾Œä¸Šå‚³è‡³å¾Œç«¯

### Phase 7: æ¸¬è©¦èˆ‡é©—è­‰

- [ ] **Task 15: å‰ç«¯æ¸¬è©¦å»ºç«‹** (AC: 2, 3, 6, 7, 9, 11)
  - [ ] â• åœ¨ `frontend/tests/unit/components/` å»ºç«‹ `AvatarUploader.spec.js`
  - [ ] â• å¯¦ä½œæ¸¬è©¦æ¡ˆä¾‹ï¼š
    - [ ] æ¸¬è©¦çµ„ä»¶æ­£ç¢ºæ¸²æŸ“
    - [ ] æ¸¬è©¦æª”æ¡ˆé¸æ“‡åŠŸèƒ½
    - [ ] æ¸¬è©¦æª”æ¡ˆæ ¼å¼é©—è­‰
    - [ ] æ¸¬è©¦æª”æ¡ˆå¤§å°é©—è­‰
    - [ ] æ¸¬è©¦åœ–ç‰‡é è¦½é¡¯ç¤º
    - [ ] æ¸¬è©¦ä¸Šå‚³æˆåŠŸæµç¨‹ï¼ˆMock APIï¼‰
    - [ ] æ¸¬è©¦ä¸Šå‚³å¤±æ•—è™•ç†
    - [ ] æ¸¬è©¦æ‹–æ”¾ä¸Šå‚³åŠŸèƒ½
  - [ ] â• Mock `uploadAvatar` å’Œ `updateProfile` API
  - [ ] ğŸ§ª åŸ·è¡Œæ¸¬è©¦ï¼š`npm run test:unit`
  - [ ] ğŸ“Š ç¢ºèªè¦†è“‹ç‡ > 80%

- [ ] **Task 16: å¾Œç«¯æ¸¬è©¦è£œå……** (AC: 2, 3, 20, 21, 22)
  - [ ] âœ… ç¢ºèª `backend/tests/` ä¸­æ˜¯å¦æœ‰ä¸Šå‚³æ¸¬è©¦
  - [ ] â• è‹¥ç¼ºå¤±ï¼Œåœ¨ `backend/tests/test_upload.py` æ·»åŠ æ¸¬è©¦æ¡ˆä¾‹ï¼š
    - [ ] æ¸¬è©¦æˆåŠŸä¸Šå‚³åœ–ç‰‡
    - [ ] æ¸¬è©¦ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼ˆæ‡‰è¿”å› 400ï¼‰
    - [ ] æ¸¬è©¦è¶…éå¤§å°é™åˆ¶ï¼ˆæ‡‰è¿”å› 400ï¼‰
    - [ ] æ¸¬è©¦æœªèªè­‰è«‹æ±‚ï¼ˆæ‡‰è¿”å› 401ï¼‰
    - [ ] æ¸¬è©¦æª”æ¡ˆå‘½åç­–ç•¥
    - [ ] æ¸¬è©¦æª”æ¡ˆå„²å­˜è·¯å¾‘
  - [ ] ğŸ§ª åŸ·è¡Œæ¸¬è©¦ï¼š`pytest backend/tests/test_upload.py -v`
  - [ ] ğŸ“Š ç¢ºèªæ‰€æœ‰æ¸¬è©¦é€šé

### Phase 8: æ•´åˆæ¸¬è©¦

- [ ] **Task 17: ç«¯åˆ°ç«¯åŠŸèƒ½é©—è­‰** (æ‰€æœ‰ AC)
  - [ ] ğŸ§ª æ‰‹å‹•æ¸¬è©¦æ¸…å–®ï¼š
    - [ ] **æ¸¬è©¦ 1**: è¨ªå•å€‹äººè³‡æ–™é é¢
      - ç™»å…¥å¸³è™Ÿ
      - è¨ªå•å€‹äººè³‡æ–™é é¢
      - é©—è­‰ï¼šé¡¯ç¤ºé ­åƒä¸Šå‚³å€åŸŸ
      - é©—è­‰ï¼šé¡¯ç¤ºç•¶å‰é ­åƒæˆ–é è¨­é ­åƒ
    - [ ] **æ¸¬è©¦ 2**: æª”æ¡ˆé¸æ“‡èˆ‡é è¦½
      - é»æ“Šã€Œä¸Šå‚³é ­åƒã€æŒ‰éˆ•
      - é¸æ“‡åœ–ç‰‡æª”æ¡ˆ
      - é©—è­‰ï¼šé¡¯ç¤ºåœ–ç‰‡é è¦½ï¼ˆåœ“å½¢ï¼‰
      - é©—è­‰ï¼šé è¦½åœ–ç‰‡æ­£ç¢ºé¡¯ç¤º
    - [ ] **æ¸¬è©¦ 3**: æª”æ¡ˆé©—è­‰
      - å˜—è©¦ä¸Šå‚³ä¸æ”¯æ´çš„æ ¼å¼ï¼ˆä¾‹å¦‚ PDFï¼‰
      - é©—è­‰ï¼šé¡¯ç¤ºæ ¼å¼éŒ¯èª¤è¨Šæ¯
      - å˜—è©¦ä¸Šå‚³è¶…é 2MB çš„åœ–ç‰‡
      - é©—è­‰ï¼šé¡¯ç¤ºå¤§å°é™åˆ¶éŒ¯èª¤è¨Šæ¯
    - [ ] **æ¸¬è©¦ 4**: æˆåŠŸä¸Šå‚³é ­åƒ
      - é¸æ“‡æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆï¼ˆ< 2MB, JPG/PNGï¼‰
      - é»æ“Šã€Œä¸Šå‚³ã€æŒ‰éˆ•
      - é©—è­‰ï¼šé¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      - é©—è­‰ï¼šä¸Šå‚³æˆåŠŸè¨Šæ¯å‡ºç¾
      - é©—è­‰ï¼šå€‹äººè³‡æ–™é é¢é ­åƒæ›´æ–°
      - é©—è­‰ï¼šå°èˆªæ¬„é ­åƒæ›´æ–°
    - [ ] **æ¸¬è©¦ 5**: æ‹–æ”¾ä¸Šå‚³
      - å°‡åœ–ç‰‡æ‹–æ”¾è‡³ä¸Šå‚³å€åŸŸ
      - é©—è­‰ï¼šé¡¯ç¤ºåœ–ç‰‡é è¦½
      - é©—è­‰ï¼šå¯ä»¥æˆåŠŸä¸Šå‚³
    - [ ] **æ¸¬è©¦ 6**: éŒ¯èª¤è™•ç†
      - æ¨¡æ“¬ç¶²è·¯éŒ¯èª¤ï¼ˆé—œé–‰å¾Œç«¯ï¼‰
      - å˜—è©¦ä¸Šå‚³é ­åƒ
      - é©—è­‰ï¼šé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
      - é©—è­‰ï¼šä¿ç•™åŸé ­åƒ
    - [ ] **æ¸¬è©¦ 7**: èªè­‰ä¿è­·
      - ç™»å‡ºç‹€æ…‹å˜—è©¦ä¸Šå‚³é ­åƒ
      - é©—è­‰ï¼šè‡ªå‹•è·³è½‰è‡³ç™»å…¥é æˆ–é¡¯ç¤ºéŒ¯èª¤
    - [ ] **æ¸¬è©¦ 8**: é è¨­é ­åƒé¡¯ç¤º
      - ä½¿ç”¨æœªä¸Šå‚³é ­åƒçš„å¸³è™Ÿç™»å…¥
      - é©—è­‰ï¼šå°èˆªæ¬„é¡¯ç¤ºå§“åé¦–å­—æ¯
      - é©—è­‰ï¼šå€‹äººè³‡æ–™é é¡¯ç¤ºå§“åé¦–å­—æ¯
    - [ ] **æ¸¬è©¦ 9**: å¤šä½ç½®é ­åƒåŒæ­¥
      - ä¸Šå‚³æ–°é ­åƒ
      - é©—è­‰ï¼šæ‰€æœ‰ä½ç½®çš„é ­åƒåŒæ­¥æ›´æ–°
        - å€‹äººè³‡æ–™é é¢
        - å°èˆªæ¬„ç”¨æˆ¶é¸å–®
    - [ ] **æ¸¬è©¦ 10**: æ•ˆèƒ½æ¸¬è©¦
      - ä½¿ç”¨ DevTools Network é¢æ¿
      - é©—è­‰ï¼šAPI å›æ‡‰æ™‚é–“ < 2000ms
      - é©—è­‰ï¼šä¸Šå‚³æµç¨‹é †æš¢
  - [ ] ğŸ“Š é©—è­‰æ‰€æœ‰ AC æ»¿è¶³
  - [ ] ğŸ“ è¨˜éŒ„æ‰€æœ‰æ¸¬è©¦çµæœ

### åœ–ä¾‹èªªæ˜
- âœ… **å·²å­˜åœ¨ä¸”æ­£ç¢º** - é©—è­‰é€šéå³å¯
- âš ï¸ **éœ€è¦æª¢æŸ¥** - å¯èƒ½éœ€è¦èª¿æ•´
- â• **éœ€è¦æ–°å¢** - ç¼ºå¤±çš„åŠŸèƒ½
- ğŸ”„ **éœ€è¦é‡æ§‹** - éœ€è¦æ”¹é€²ç¾æœ‰å¯¦ä½œ
- ğŸ“ **è¨˜éŒ„** - æ–‡ä»¶åŒ–ç™¼ç¾
- ğŸ§ª **æ¸¬è©¦** - åŸ·è¡Œæ¸¬è©¦
- ğŸ“Š **é©—è­‰** - ç¢ºèªç¬¦åˆéœ€æ±‚

## Dev Notes

### Previous Story Insights

**ä¾†è‡ª Story 1.1 - 1.6 çš„ç¶“é©—**ï¼š
- âœ… Vue 3 Composition API æ˜¯æ¨™æº–é–‹ç™¼æ¨¡å¼
- âœ… Element Plus çµ„ä»¶åº«å·²æ•´åˆä¸”é‹ä½œè‰¯å¥½
- âœ… Pinia Auth Store å·²å»ºç«‹ï¼Œç”¨æ–¼ç®¡ç†èªè­‰ç‹€æ…‹
- âœ… JWT èªè­‰æ©Ÿåˆ¶å®Œå–„ï¼ˆ`@jwt_required()` è£é£¾å™¨ï¼‰
- âœ… Axios æ””æˆªå™¨å·²é…ç½®ï¼Œè™•ç†èªè­‰å’ŒéŒ¯èª¤
- âœ… è·¯ç”±å®ˆè¡›æ©Ÿåˆ¶å·²å»ºç«‹ï¼ˆ`requiresAuth` metaï¼‰
- âœ… éŸ¿æ‡‰å¼è¨­è¨ˆæ¨¡å¼å·²ç¢ºç«‹
- âœ… éŒ¯èª¤è™•ç†æ¨¡å¼ï¼šå¾Œç«¯è¿”å›å…·é«”éŒ¯èª¤ï¼Œå‰ç«¯é¡¯ç¤ºå‹å–„è¨Šæ¯

**Brownfield å°ˆæ¡ˆèƒŒæ™¯**ï¼š
- å¾Œç«¯åœ–ç‰‡ä¸Šå‚³ API å·²å®Œæ•´å¯¦ä½œï¼ˆ`POST /api/upload/image`ï¼‰
- ä¸»è¦å·¥ä½œæ˜¯**å»ºç«‹å‰ç«¯é ­åƒä¸Šå‚³çµ„ä»¶**å’Œ**æ•´åˆç¾æœ‰ä¸Šå‚³ API**
- éœ€è¦**æ“´å±•ç”¨æˆ¶è³‡æ–™æ¨¡å‹**ä»¥å„²å­˜é ­åƒ URL
- éœ€è¦å»ºç«‹**é€šç”¨ Avatar çµ„ä»¶**ä¾›å¤šè™•ä½¿ç”¨

### Data Models

**User Model** [Source: backend/models/user.py]
- **Table**: `users`
- **Primary Key**: `user_id` (Integer, Auto-increment)
- **åŸºæœ¬æ¬„ä½**:
  - `email` (String(120), UNIQUE, NOT NULL) - é›»å­éƒµä»¶
  - `password_hash` (String(255), NOT NULL) - åŠ å¯†å¯†ç¢¼
  - `name` (String(100), NOT NULL) - å§“å
  - `bio` (Text) - å€‹äººç°¡ä»‹
  - `gender` (String(10)) - æ€§åˆ¥
  - `age` (Integer) - å¹´é½¡
  - `interests` (Text) - èˆˆè¶£ï¼ˆJSON æ ¼å¼ï¼‰
- **é ­åƒæ¬„ä½** (éœ€ç¢ºèªæˆ–æ·»åŠ ):
  - `avatar` (String(500), nullable=True) - é ­åƒåœ–ç‰‡ URL
- **ç¤¾ç¾¤é€£çµæ¬„ä½**:
  - `instagram` (String(100)) - Instagram å¸³è™Ÿ
  - `facebook` (String(100)) - Facebook å¸³è™Ÿ
  - `line_id` (String(100)) - Line ID
  - `social_links_public` (Boolean, DEFAULT False) - ç¤¾ç¾¤é€£çµæ˜¯å¦å…¬é–‹
- **è‡ªå‹•æ¬„ä½**:
  - `created_at` (DateTime, DEFAULT CURRENT_TIMESTAMP)
  - `updated_at` (DateTime, AUTO UPDATE)

### API Specifications

**Endpoint 1**: `POST /api/upload/image` [Source: backend/blueprints/upload.py:24-68]

**Authentication**: Required (JWT Token)

**Request Headers**:
```
Authorization: Bearer <JWT_TOKEN>
Content-Type: multipart/form-data
```

**Request Body** (FormData):
```
image: <File> (åœ–ç‰‡æª”æ¡ˆ)
```

**File Constraints**:
- **Allowed Formats**: PNG, JPG, JPEG, GIF, WEBP
- **Max Size**: 2MB (2 * 1024 * 1024 bytes)
- **File Naming**: `{user_id}_{uuid}_{timestamp}.{ext}`
- **Storage Path**: `uploads/` directory

**Response (Success - 200)**:
```json
{
  "message": "ä¸Šå‚³æˆåŠŸ",
  "url": "/uploads/1_a1b2c3d4_20251105143000.jpg",
  "filename": "1_a1b2c3d4_20251105143000.jpg"
}
```

**Response (Error - 400)**:
```json
{
  "error": "æ²’æœ‰é¸æ“‡æ–‡ä»¶"
}
// æˆ–
{
  "error": "ä¸æ”¯æŒçš„æ–‡ä»¶é¡å‹ï¼Œåªå…è¨± PNGã€JPGã€JPEGã€GIFã€WEBP"
}
// æˆ–
{
  "error": "æ–‡ä»¶å¤§å°è¶…éé™åˆ¶ï¼ˆæœ€å¤§ 2MBï¼‰"
}
```

**Response (Error - 401)**:
```json
{
  "msg": "Missing Authorization Header"
}
```

**Response (Error - 500)**:
```json
{
  "error": "ä¸Šå‚³å¤±æ•—"
}
```

**å¾Œç«¯é‚è¼¯é‡é»** [Source: backend/blueprints/upload.py]:
1. **å®‰å…¨æ€§**:
   - ä½¿ç”¨ `secure_filename()` è™•ç†æª”æ¡ˆåç¨±
   - ç”Ÿæˆå”¯ä¸€æª”æ¡ˆåé¿å…è¡çªï¼š`{user_id}_{uuid}_{timestamp}.{ext}`
   - é©—è­‰æª”æ¡ˆé¡å‹å’Œå¤§å°
2. **æª”æ¡ˆè™•ç†**:
   - ä½¿ç”¨ `file.seek()` æª¢æŸ¥æª”æ¡ˆå¤§å°
   - å„²å­˜è‡³ `uploads/` ç›®éŒ„
   - è¿”å›ç›¸å°è·¯å¾‘ URL

---

**Endpoint 2**: `PUT /api/users/profile` [Source: backend/blueprints/users.py - éœ€ç¢ºèª]

**Authentication**: Required (JWT Token)

**Request Headers**:
```
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json
```

**Request Body**:
```json
{
  "name": "John Doe",
  "bio": "Travel enthusiast",
  "gender": "male",
  "age": 28,
  "interests": ["hiking", "photography"],
  "avatar": "/uploads/1_a1b2c3d4_20251105143000.jpg"  // æ–°å¢æ¬„ä½
}
```

**Response (Success - 200)**:
```json
{
  "message": "å€‹äººè³‡æ–™æ›´æ–°æˆåŠŸ",
  "user": {
    "user_id": 1,
    "email": "john@example.com",
    "name": "John Doe",
    "bio": "Travel enthusiast",
    "avatar": "/uploads/1_a1b2c3d4_20251105143000.jpg",
    // ...å…¶ä»–æ¬„ä½
  }
}
```

**Response (Error - 401)**:
```json
{
  "msg": "Missing Authorization Header"
}
```

---

**Endpoint 3**: `GET /api/users/profile` [Source: backend/blueprints/users.py - éœ€ç¢ºèª]

**Authentication**: Required (JWT Token)

**Response (Success - 200)**:
```json
{
  "user_id": 1,
  "email": "john@example.com",
  "name": "John Doe",
  "bio": "Travel enthusiast",
  "avatar": "/uploads/1_a1b2c3d4_20251105143000.jpg",  // ç¢ºèªåŒ…å«æ­¤æ¬„ä½
  "gender": "male",
  "age": 28,
  "interests": ["hiking", "photography"],
  "created_at": "2025-11-01T10:00:00"
}
```

### Component Specifications

**AvatarUploader.vue Component** [æ–°å»ºç«‹]

- **Location**: `frontend/src/components/AvatarUploader.vue`
- **Type**: Reusable Component (Vue 3 SFC with Composition API)
- **Purpose**: æä¾›é ­åƒä¸Šå‚³åŠŸèƒ½ï¼ŒåŒ…å«é è¦½ã€é©—è­‰å’Œä¸Šå‚³é‚è¼¯

**å»ºè­°çµæ§‹**:
```vue
<template>
  <div class="avatar-uploader">
    <!-- ç•¶å‰é ­åƒé¡¯ç¤º -->
    <div class="avatar-preview">
      <el-avatar 
        :src="currentAvatar || previewUrl" 
        :size="120"
        v-if="currentAvatar || previewUrl"
      >
        <template #error>
          <el-icon><Picture /></el-icon>
        </template>
      </el-avatar>
      <el-avatar v-else :size="120">
        {{ userName?.charAt(0) || 'U' }}
      </el-avatar>
    </div>

    <!-- ä¸Šå‚³æ§ä»¶ -->
    <el-upload
      ref="uploadRef"
      class="avatar-upload"
      :action="uploadUrl"
      :headers="uploadHeaders"
      :show-file-list="false"
      :before-upload="beforeUpload"
      :on-success="handleSuccess"
      :on-error="handleError"
      :on-progress="handleProgress"
      accept="image/jpeg,image/png,image/gif,image/webp"
      drag
    >
      <el-button type="primary" :loading="uploading">
        <el-icon><Upload /></el-icon>
        {{ uploading ? 'ä¸Šå‚³ä¸­...' : 'ä¸Šå‚³é ­åƒ' }}
      </el-button>
      <template #tip>
        <div class="el-upload__tip">
          æ”¯æ´ JPGã€PNGã€GIFã€WEBP æ ¼å¼ï¼Œæª”æ¡ˆå¤§å°ä¸è¶…é 2MB
        </div>
      </template>
    </el-upload>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue'
import { ElMessage } from 'element-plus'
import { Upload, Picture } from '@element-plus/icons-vue'
import { uploadAvatar } from '@/api/upload'
import { updateProfile } from '@/api/users'
import { useAuthStore } from '@/stores/auth'

// Props
const props = defineProps({
  currentAvatar: {
    type: String,
    default: ''
  },
  userName: {
    type: String,
    default: ''
  }
})

// Emits
const emit = defineEmits(['upload-success'])

// Store
const authStore = useAuthStore()

// Refs
const uploadRef = ref(null)
const uploading = ref(false)
const previewUrl = ref('')

// Computed
const uploadUrl = computed(() => '/api/upload/image')
const uploadHeaders = computed(() => ({
  Authorization: `Bearer ${authStore.token}`
}))

// Methods
const beforeUpload = (file) => {
  // é©—è­‰æª”æ¡ˆé¡å‹
  const validFormats = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']
  if (!validFormats.includes(file.type)) {
    ElMessage.error('åªæ”¯æ´ JPGã€PNGã€GIFã€WEBP æ ¼å¼')
    return false
  }

  // é©—è­‰æª”æ¡ˆå¤§å°
  const isLt2M = file.size / 1024 / 1024 < 2
  if (!isLt2M) {
    ElMessage.error('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 2MB')
    return false
  }

  // ç”Ÿæˆé è¦½
  const reader = new FileReader()
  reader.onload = (e) => {
    previewUrl.value = e.target.result
  }
  reader.readAsDataURL(file)

  uploading.value = true
  return true
}

const handleSuccess = async (response) => {
  try {
    // æ›´æ–°å€‹äººè³‡æ–™çš„é ­åƒæ¬„ä½
    await updateProfile({ avatar: response.url })
    
    // æ›´æ–° Store
    authStore.updateAvatar(response.url)
    
    // æˆåŠŸè¨Šæ¯
    ElMessage.success('é ­åƒæ›´æ–°æˆåŠŸï¼')
    
    // æ¸…é™¤é è¦½
    previewUrl.value = ''
    
    // ç™¼é€äº‹ä»¶
    emit('upload-success', response.url)
    
  } catch (error) {
    console.error('æ›´æ–°é ­åƒå¤±æ•—:', error)
    ElMessage.error('æ›´æ–°é ­åƒå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦')
  } finally {
    uploading.value = false
  }
}

const handleError = (error) => {
  console.error('ä¸Šå‚³å¤±æ•—:', error)
  ElMessage.error('ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦')
  uploading.value = false
  previewUrl.value = ''
}

const handleProgress = () => {
  uploading.value = true
}
</script>

<style lang="scss" scoped>
.avatar-uploader {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-lg);
}

.avatar-preview {
  .el-avatar {
    border: 2px solid var(--el-border-color);
    font-size: var(--font-size-xxl);
    font-weight: var(--font-weight-bold);
  }
}

.avatar-upload {
  :deep(.el-upload-dragger) {
    padding: var(--spacing-md);
    border-radius: var(--border-radius-md);
  }

  .el-upload__tip {
    margin-top: var(--spacing-sm);
    font-size: var(--font-size-small);
    color: var(--el-text-color-secondary);
    text-align: center;
  }
}
</style>
```

---

**UserAvatar.vue Component** [æ–°å»ºç«‹]

- **Location**: `frontend/src/components/common/UserAvatar.vue`
- **Type**: Reusable Component (é€šç”¨é ­åƒé¡¯ç¤ºçµ„ä»¶)
- **Purpose**: åœ¨å„è™•çµ±ä¸€é¡¯ç¤ºç”¨æˆ¶é ­åƒï¼ˆæœ‰é ­åƒæ™‚é¡¯ç¤ºåœ–ç‰‡ï¼Œç„¡é ­åƒæ™‚é¡¯ç¤ºé¦–å­—æ¯ï¼‰

**å»ºè­°çµæ§‹**:
```vue
<template>
  <el-avatar 
    :src="avatar" 
    :size="avatarSize"
    v-if="avatar"
  >
    <template #error>
      <el-avatar :size="avatarSize">
        {{ initials }}
      </el-avatar>
    </template>
  </el-avatar>
  <el-avatar v-else :size="avatarSize">
    {{ initials }}
  </el-avatar>
</template>

<script setup>
import { computed } from 'vue'

// Props
const props = defineProps({
  avatar: {
    type: String,
    default: ''
  },
  name: {
    type: String,
    default: ''
  },
  size: {
    type: String,
    default: 'medium', // small, medium, large
    validator: (value) => ['small', 'medium', 'large'].includes(value)
  }
})

// Computed
const avatarSize = computed(() => {
  const sizeMap = {
    small: 32,
    medium: 40,
    large: 64
  }
  return sizeMap[props.size]
})

const initials = computed(() => {
  if (!props.name) return 'U'
  return props.name.charAt(0).toUpperCase()
})
</script>
```

### File Locations

Based on [Source: architecture/3-å°ˆæ¡ˆçµæ§‹-project-structure.md]:

**Frontend**:
- é ­åƒä¸Šå‚³çµ„ä»¶: `frontend/src/components/AvatarUploader.vue` (æ–°å»º)
- é€šç”¨é ­åƒçµ„ä»¶: `frontend/src/components/common/UserAvatar.vue` (æ–°å»º)
- Upload API æœå‹™: `frontend/src/api/upload.js` (æ–°å»ºæˆ–ç¢ºèª)
- Users API æœå‹™: `frontend/src/api/users.js` (æ“´å±• - ç¢ºèª updateProfile)
- å€‹äººè³‡æ–™é é¢: `frontend/src/views/Profile.vue` æˆ– `ProfileEdit.vue` (æ•´åˆ AvatarUploader)
- å°èˆªæ¬„çµ„ä»¶: `frontend/src/components/layout/NavBar.vue` (æ•´åˆ UserAvatar)
- Auth Store: `frontend/src/stores/auth.js` (æ·»åŠ  updateAvatar action)
- å‰ç«¯æ¸¬è©¦: `frontend/tests/unit/components/AvatarUploader.spec.js` (æ–°å»º)

**Backend**:
- ä¸Šå‚³ç«¯é»: `backend/blueprints/upload.py` (å·²å­˜åœ¨ upload_image)
- User Model: `backend/models/user.py` (ç¢ºèªæˆ–æ·»åŠ  avatar æ¬„ä½)
- Users Blueprint: `backend/blueprints/users.py` (ç¢ºèª update_profile æ”¯æ´ avatar)
- å¾Œç«¯æ¸¬è©¦: `backend/tests/test_upload.py` (æ–°å»ºæˆ–ç¢ºèª)

### Testing Requirements

Based on [Source: architecture/11-æ¸¬è©¦ç­–ç•¥-testing-requirements.md]:

**Unit Testing (Vitest)**:
- **Location**: `frontend/tests/unit/components/AvatarUploader.spec.js`
- **Framework**: Vitest + @vue/test-utils + Element Plus
- **Coverage Target**: 80%+
- **Test Cases**:
  1. çµ„ä»¶æ­£ç¢ºæ¸²æŸ“
  2. é¡¯ç¤ºç•¶å‰é ­åƒæˆ–é è¨­é ­åƒ
  3. æª”æ¡ˆé¸æ“‡åŠŸèƒ½
  4. æª”æ¡ˆæ ¼å¼é©—è­‰ï¼ˆåªå…è¨±åœ–ç‰‡ï¼‰
  5. æª”æ¡ˆå¤§å°é©—è­‰ï¼ˆæœ€å¤š 2MBï¼‰
  6. åœ–ç‰‡é è¦½åŠŸèƒ½
  7. ä¸Šå‚³æˆåŠŸæµç¨‹ï¼ˆMock APIï¼‰
  8. ä¸Šå‚³å¤±æ•—è™•ç†
  9. é ­åƒæ›´æ–°å¾Œçš„ Store æ›´æ–°
  10. æ‹–æ”¾ä¸Šå‚³åŠŸèƒ½

**Backend Testing (pytest)**:
- **Location**: `backend/tests/test_upload.py`
- **Framework**: pytest + pytest-flask
- **Test Cases**:
  1. æ¸¬è©¦æˆåŠŸä¸Šå‚³åœ–ç‰‡
  2. æ¸¬è©¦ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼è¿”å› 400
  3. æ¸¬è©¦è¶…éå¤§å°é™åˆ¶è¿”å› 400
  4. æ¸¬è©¦æœªèªè­‰è«‹æ±‚è¿”å› 401
  5. æ¸¬è©¦æª”æ¡ˆå‘½åç­–ç•¥æ­£ç¢º
  6. æ¸¬è©¦æª”æ¡ˆå„²å­˜è·¯å¾‘æ­£ç¢º

**Running Tests**:
```bash
# Frontend
npm run test:unit

# Backend
pytest backend/tests/test_upload.py -v
```

### Technical Constraints

[Source: architecture/2-å‰ç«¯æŠ€è¡“æ£§-frontend-tech-stack.md]

1. **Framework Versions**:
   - Vue.js 3.3.8+
   - Element Plus 2.4.2+
   - Axios 1.6.0+ (HTTP è«‹æ±‚)

2. **Performance Requirements**:
   - API å›æ‡‰æ™‚é–“ < 2000ms
   - åœ–ç‰‡ä¸Šå‚³æµç¨‹éœ€æµæš¢

3. **UI/UX Requirements**:
   - éŸ¿æ‡‰å¼è¨­è¨ˆï¼šæ¡Œé¢ã€å¹³æ¿ã€æ‰‹æ©Ÿ
   - ä½¿ç”¨ Element Plus Upload çµ„ä»¶
   - éŒ¯èª¤è¨Šæ¯æ‡‰æ¸…æ™°ä¸”å…·é«”
   - æä¾›æ‹–æ”¾ä¸Šå‚³åŠŸèƒ½

4. **Browser Support**:
   - Chrome 90+, Firefox 88+, Safari 14+, Edge 90+

5. **Authentication**:
   - æ‰€æœ‰ API éœ€ JWT èªè­‰

6. **File Handling**:
   - Max file size: 2MB
   - Allowed formats: JPG, PNG, GIF, WEBP
   - File naming: UUID + timestamp

### Project Structure Notes

[Source: architecture/3-å°ˆæ¡ˆçµæ§‹-project-structure.md]

**æ–°å¢ç›®éŒ„/æª”æ¡ˆ**:
- âœ… `frontend/src/components/AvatarUploader.vue` - é ­åƒä¸Šå‚³çµ„ä»¶ï¼ˆæ–°å»ºï¼‰
- âœ… `frontend/src/components/common/UserAvatar.vue` - é€šç”¨é ­åƒçµ„ä»¶ï¼ˆæ–°å»ºï¼‰
- âœ… `frontend/src/api/upload.js` - ä¸Šå‚³ API æœå‹™ï¼ˆæ–°å»ºæˆ–ç¢ºèªï¼‰
- âœ… `frontend/tests/unit/components/AvatarUploader.spec.js` - å–®å…ƒæ¸¬è©¦ï¼ˆæ–°å»ºï¼‰
- âœ… `backend/tests/test_upload.py` - å¾Œç«¯æ¸¬è©¦ï¼ˆæ–°å»ºæˆ–ç¢ºèªï¼‰

**ä¿®æ”¹æª”æ¡ˆ**:
- âœ… `frontend/src/api/users.js` - ç¢ºèª updateProfile æ”¯æ´ avatar
- âœ… `frontend/src/stores/auth.js` - æ·»åŠ  updateAvatar action
- âœ… `frontend/src/views/Profile.vue` æˆ– `ProfileEdit.vue` - æ•´åˆ AvatarUploader
- âœ… `frontend/src/components/layout/NavBar.vue` - æ•´åˆ UserAvatar
- âœ… `backend/models/user.py` - ç¢ºèªæˆ–æ·»åŠ  avatar æ¬„ä½
- âœ… `backend/blueprints/users.py` - ç¢ºèª update_profile æ”¯æ´ avatar

**ç„¡çµæ§‹è¡çª**ï¼šæ‰€æœ‰æ–°å¢æª”æ¡ˆç¬¦åˆç¾æœ‰å°ˆæ¡ˆçµæ§‹ã€‚

### Additional Notes

**åœ–ç‰‡è™•ç†æœ€ä½³å¯¦è¸**ï¼š
1. å‰ç«¯ä½¿ç”¨ `FileReader` API ç”Ÿæˆé è¦½
2. ä¸Šå‚³ä½¿ç”¨ `FormData` æ ¼å¼
3. Element Plus Upload çµ„ä»¶æä¾›æ‹–æ”¾ã€é€²åº¦ã€éŒ¯èª¤è™•ç†ç­‰åŠŸèƒ½
4. å¾Œç«¯ä½¿ç”¨ UUID + timestamp ç¢ºä¿æª”æ¡ˆåç¨±å”¯ä¸€æ€§

**é ­åƒé¡¯ç¤ºç­–ç•¥**ï¼š
1. å»ºç«‹é€šç”¨ `UserAvatar.vue` çµ„ä»¶ä¾›å„è™•ä½¿ç”¨
2. æœ‰é ­åƒæ™‚é¡¯ç¤ºåœ–ç‰‡ï¼Œç„¡é ­åƒæ™‚é¡¯ç¤ºå§“åé¦–å­—æ¯
3. æ”¯æ´ä¸åŒå°ºå¯¸ï¼šsmall (32px), medium (40px), large (64px)
4. ä½¿ç”¨ Element Plus Avatar çµ„ä»¶æä¾›ä¸€è‡´çš„æ¨£å¼

**ç‹€æ…‹ç®¡ç†**ï¼š
1. Auth Store å„²å­˜ç•¶å‰ç”¨æˆ¶çš„é ­åƒ URL
2. ä¸Šå‚³æˆåŠŸå¾Œèª¿ç”¨ `updateAvatar()` action æ›´æ–° Store
3. æ‰€æœ‰ä½¿ç”¨é ­åƒçš„çµ„ä»¶å¾ Store è®€å–ï¼Œç¢ºä¿å³æ™‚åŒæ­¥

**å¯é¸åŠŸèƒ½ï¼ˆæœªä¾†æ”¹é€²ï¼‰**ï¼š
1. åœ–ç‰‡è£åˆ‡åŠŸèƒ½ï¼ˆä½¿ç”¨ `vue-cropper` å¥—ä»¶ï¼‰
2. åœ–ç‰‡å£“ç¸®ï¼ˆå‰ç«¯å£“ç¸®å¾Œå†ä¸Šå‚³ï¼‰
3. CDN æ•´åˆï¼ˆç”Ÿç”¢ç’°å¢ƒä½¿ç”¨ CDN æœå‹™ï¼‰

**å¾ŒçºŒ Story é—œè¯**ï¼š
- Story 2.1 å°‡å¯¦ä½œç·¨è¼¯å€‹äººè³‡æ–™åŠŸèƒ½ï¼ˆå§“åã€Bioã€æ€§åˆ¥ã€å¹´é½¡ã€èˆˆè¶£ï¼‰
- Story 2.3 å°‡å¯¦ä½œç¤¾ç¾¤é€£çµåŠŸèƒ½ï¼ˆInstagram, Facebook, Lineï¼‰
- Story 2.4 å°‡å¯¦ä½œå€‹äººå„€è¡¨æ¿ï¼ˆæ´»å‹•æ•¸ã€åª’åˆæ•¸ã€å¹³å‡è©•åƒ¹ï¼‰

## Testing

### Frontend Testing
```bash
# åŸ·è¡Œå–®å…ƒæ¸¬è©¦
npm run test:unit

# åŸ·è¡Œå¸¶è¦†è“‹ç‡çš„æ¸¬è©¦
npm run test:coverage

# UI æ¸¬è©¦æ¨¡å¼
npm run test:ui
```

### Backend Testing
```bash
# åŸ·è¡Œä¸Šå‚³ API æ¸¬è©¦
pytest backend/tests/test_upload.py -v

# åŸ·è¡Œç”¨æˆ¶ç›¸é—œæ¸¬è©¦
pytest backend/tests/test_users.py -v

# å¸¶è¦†è“‹ç‡å ±å‘Š
pytest backend/tests/ --cov=backend/blueprints --cov-report=html
```

### Manual Testing Checklist

- [ ] è¨ªå•å€‹äººè³‡æ–™é é¢ï¼ˆéœ€ç™»å…¥ï¼‰
- [ ] é¡¯ç¤ºé ­åƒä¸Šå‚³å€åŸŸ
- [ ] é»æ“Šé¸æ“‡åœ–ç‰‡æª”æ¡ˆ
- [ ] æ‹–æ”¾åœ–ç‰‡è‡³ä¸Šå‚³å€åŸŸ
- [ ] åœ–ç‰‡é è¦½æ­£ç¢ºé¡¯ç¤ºï¼ˆåœ“å½¢ï¼‰
- [ ] æª”æ¡ˆæ ¼å¼é©—è­‰ï¼ˆåªå…è¨±åœ–ç‰‡ï¼‰
- [ ] æª”æ¡ˆå¤§å°é©—è­‰ï¼ˆæœ€å¤š 2MBï¼‰
- [ ] æˆåŠŸä¸Šå‚³é ­åƒ
- [ ] å€‹äººè³‡æ–™é é¢é ­åƒæ›´æ–°
- [ ] å°èˆªæ¬„é ­åƒæ›´æ–°
- [ ] æœªä¸Šå‚³é ­åƒæ™‚é¡¯ç¤ºå§“åé¦–å­—æ¯
- [ ] ä¸Šå‚³å¤±æ•—æ™‚é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
- [ ] ç¶²è·¯éŒ¯èª¤è™•ç†
- [ ] èªè­‰ä¿è­·ï¼ˆæœªç™»å…¥ç„¡æ³•ä¸Šå‚³ï¼‰
- [ ] éŸ¿æ‡‰å¼è¨­è¨ˆï¼ˆæ¡Œé¢/æ‰‹æ©Ÿæ¨¡å¼ï¼‰
- [ ] API å›æ‡‰æ™‚é–“ < 2000ms

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*æ­¤å€å¡Šç”±é–‹ç™¼ä»£ç†åœ¨å¯¦ä½œæ™‚å¡«å¯«*

### Agent Model Used

(å¾…é–‹ç™¼ä»£ç†å¡«å¯«)

### Debug Log References

(å¾…é–‹ç™¼ä»£ç†å¡«å¯«)

### Completion Notes List

(å¾…é–‹ç™¼ä»£ç†å¡«å¯«)

### File List

(å¾…é–‹ç™¼ä»£ç†å¡«å¯«)

## QA Results

*æ­¤å€å¡Šç”± QA ä»£ç†å¯©æŸ¥å¾Œæ›´æ–°å¯©æŸ¥çµæœ*
