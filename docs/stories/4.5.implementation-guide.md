# Story 4.5 å¯¦ä½œæŒ‡å— - ç³»çµ±è¨Šæ¯åŠŸèƒ½

å®Œæˆå‰©é¤˜ 10% çš„å¿«é€ŸæŒ‡å—

---

## ğŸ¯ ç›®æ¨™

å¯¦ä½œ**ç³»çµ±è¨Šæ¯åŠŸèƒ½**,è®“åª’åˆæˆåŠŸæ™‚è‡ªå‹•ç™¼é€ç³»çµ±è¨Šæ¯

---

## ğŸ“‹ å¯¦ä½œæ­¥é©Ÿ

### Step 1: å¾Œç«¯ - åª’åˆç¢ºèªæ™‚å»ºç«‹ç³»çµ±è¨Šæ¯

**æª”æ¡ˆ**: `backend/blueprints/matches.py`

æ‰¾åˆ°åª’åˆç¢ºèªçš„é‚è¼¯ (ç•¶ status å¾ 'pending' è®Šç‚º 'accepted'),æ·»åŠ ç³»çµ±è¨Šæ¯:

```python
from models.chat_message import ChatMessage
from datetime import datetime

# åœ¨åª’åˆç¢ºèªé‚è¼¯ä¸­ (ä¾‹å¦‚ PUT /api/matches/{match_id}/accept)
@matches_bp.route('/<int:match_id>/accept', methods=['PUT'])
@jwt_required()
def accept_match(match_id):
    # ... ç¾æœ‰çš„åª’åˆç¢ºèªé‚è¼¯ ...
    
    match.status = 'accepted'
    match.matched_date = datetime.utcnow()
    
    # ğŸ†• å»ºç«‹ç³»çµ±è¨Šæ¯
    system_message = ChatMessage(
        match_id=match_id,
        sender_id=None,  # ç³»çµ±è¨Šæ¯,æ²’æœ‰ç™¼é€è€…
        receiver_id=match.user_a,  # æ¥æ”¶è€…å¯ä»¥æ˜¯ä»»ä¸€æ–¹,æˆ–å…©æ¢è¨Šæ¯çµ¦é›™æ–¹
        content='ğŸ‰ æ­å–œ!ä½ å€‘å·²æˆåŠŸåª’åˆ,ç¾åœ¨å¯ä»¥é–‹å§‹èŠå¤©äº†!',
        message_type='system',
        status='read'  # ç³»çµ±è¨Šæ¯é è¨­å·²è®€
    )
    db.session.add(system_message)
    
    # å¦‚æœè¦çµ¦é›™æ–¹éƒ½ç™¼é€,å†å»ºç«‹ä¸€æ¢
    system_message_2 = ChatMessage(
        match_id=match_id,
        sender_id=None,
        receiver_id=match.user_b,
        content='ğŸ‰ æ­å–œ!ä½ å€‘å·²æˆåŠŸåª’åˆ,ç¾åœ¨å¯ä»¥é–‹å§‹èŠå¤©äº†!',
        message_type='system',
        status='read'
    )
    db.session.add(system_message_2)
    
    db.session.commit()
    
    # ğŸ†• é€é Socket.IO å»£æ’­ç³»çµ±è¨Šæ¯åˆ°èŠå¤©å®¤
    from socketio_events import socketio
    room = f'chat_{match_id}'
    socketio.emit('new_message', {
        'message_id': system_message.message_id,
        'match_id': match_id,
        'sender_id': None,
        'content': system_message.content,
        'message_type': 'system',
        'timestamp': system_message.timestamp.isoformat() + 'Z',
        'status': 'read'
    }, room=room)
    
    # ... è¿”å›æˆåŠŸéŸ¿æ‡‰ ...
```

---

### Step 2: å‰ç«¯ - ç³»çµ±è¨Šæ¯é¡¯ç¤ºæ¨£å¼

**æª”æ¡ˆ**: `frontend/src/views/Chat.vue`

#### 2.1 ä¿®æ”¹è¨Šæ¯é¡¯ç¤ºæ¨¡æ¿

æ‰¾åˆ°è¨Šæ¯åˆ—è¡¨çš„éƒ¨åˆ†,æ·»åŠ ç³»çµ±è¨Šæ¯åˆ¤æ–·:

```vue
<template>
  <!-- åœ¨è¨Šæ¯åˆ—è¡¨ä¸­ -->
  <el-scrollbar ref="messageScrollbar" height="calc(100vh - 400px)" class="message-list">
    <div
      v-for="message in messages"
      :key="message.id"
      :class="['message-item', { 'is-mine': message.isMine, 'is-system': message.type === 'system' }]"
    >
      <!-- ğŸ†• ç³»çµ±è¨Šæ¯ç‰¹æ®Šé¡¯ç¤º -->
      <div v-if="message.type === 'system'" class="system-message">
        <div class="system-message-content">
          {{ message.content }}
        </div>
        <div class="system-message-time">{{ message.time }}</div>
      </div>
      
      <!-- ä¸€èˆ¬è¨Šæ¯ (åŸæœ‰é‚è¼¯) -->
      <template v-else>
        <el-avatar v-if="!message.isMine" :size="35" :src="selectedChat.avatar" />
        <div class="message-content">
          <div v-if="message.type === 'text'" class="message-bubble">
            {{ message.content }}
          </div>
          <!-- ... å…¶ä»–è¨Šæ¯é¡å‹ ... -->
        </div>
      </template>
    </div>
  </el-scrollbar>
</template>
```

#### 2.2 æ·»åŠ  CSS æ¨£å¼

åœ¨ `<style scoped>` ä¸­æ·»åŠ :

```css
/* ç³»çµ±è¨Šæ¯æ¨£å¼ */
.message-item.is-system {
  display: flex;
  justify-content: center;
  margin: 20px 0;
}

.system-message {
  text-align: center;
  max-width: 80%;
}

.system-message-content {
  display: inline-block;
  background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
  color: #666;
  padding: 10px 20px;
  border-radius: 16px;
  font-size: 13px;
  line-height: 1.5;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  position: relative;
}

.system-message-content::before {
  content: '';
  position: absolute;
  left: 50%;
  top: -6px;
  transform: translateX(-50%);
  width: 40px;
  height: 2px;
  background: #d0d0d0;
  border-radius: 2px;
}

.system-message-time {
  color: #999;
  font-size: 11px;
  margin-top: 5px;
}
```

---

### Step 3: æ¸¬è©¦é©—è­‰

#### 3.1 æ›´æ–°æ¸¬è©¦æª”æ¡ˆ

**æª”æ¡ˆ**: `backend/test/TC_4_5.py`

ç§»é™¤ `@pytest.mark.skip` æ¨™è¨˜:

```python
class TestSystemMessages:
    """æ¸¬è©¦ç³»çµ±è¨Šæ¯åŠŸèƒ½"""
    
    # ğŸ†• ç§»é™¤ skip æ¨™è¨˜
    def test_match_success_system_message(self, client, test_app):
        """æ¸¬è©¦åª’åˆæˆåŠŸæ™‚è‡ªå‹•ç”Ÿæˆç³»çµ±è¨Šæ¯ (AC: 7)"""
        with test_app.app_context():
            # ... æ¸¬è©¦é‚è¼¯ ...
```

#### 3.2 åŸ·è¡Œæ¸¬è©¦

```bash
cd c:\EdgeSurvivor
python -m pytest backend/test/TC_4_5.py::TestSystemMessages -v
```

**é æœŸçµæœ**: âœ… PASSED

---

### Step 4: æ‰‹å‹•æ¸¬è©¦

1. **å»ºç«‹å…©å€‹æ¸¬è©¦ç”¨æˆ¶** (å¦‚æœé‚„æ²’æœ‰)
2. **ç™¼èµ·åª’åˆç”³è«‹**
3. **ç¢ºèªåª’åˆ** â†’ æ‡‰è©²çœ‹åˆ°ç³»çµ±è¨Šæ¯
4. **é€²å…¥èŠå¤©å®¤** â†’ ç³»çµ±è¨Šæ¯æ‡‰è©²å±…ä¸­é¡¯ç¤º,ç°è‰²èƒŒæ™¯

**æª¢æŸ¥é …ç›®**:
- [ ] åª’åˆç¢ºèªå¾Œç³»çµ±è¨Šæ¯è‡ªå‹•ç”Ÿæˆ
- [ ] ç³»çµ±è¨Šæ¯åœ¨èŠå¤©å®¤ä¸­æ­£ç¢ºé¡¯ç¤º
- [ ] ç³»çµ±è¨Šæ¯æ¨£å¼èˆ‡ä¸€èˆ¬è¨Šæ¯ä¸åŒ (å±…ä¸­ã€ç°è‰²)
- [ ] ç³»çµ±è¨Šæ¯ä¸é¡¯ç¤ºé ­åƒ
- [ ] ç³»çµ±è¨Šæ¯ä¸é¡¯ç¤ºç™¼é€è€…åç¨±

---

## ğŸ” æ³¨æ„äº‹é …

### 1. ChatMessage æ¨¡å‹æ¬„ä½ç¢ºèª

ç¢ºèª `sender_id` å…è¨± NULL:

```python
# backend/models/chat_message.py
sender_id = db.Column(db.Integer, db.ForeignKey('users.user_id'), nullable=True)  # â† ç¢ºèªç‚º True
```

å¦‚æœä¸å…è¨± NULL,å¯ä»¥:
- ä¿®æ”¹æ¨¡å‹ä¸¦åŸ·è¡Œé·ç§»
- æˆ–ä½¿ç”¨ä¸€å€‹ç³»çµ±ç”¨æˆ¶ ID (å¦‚ user_id=0 æˆ– user_id=999999)

### 2. Socket.IO å»£æ’­

ç³»çµ±è¨Šæ¯ä¹Ÿéœ€è¦é€é Socket.IO å»£æ’­,è®“åœ¨ç·šç”¨æˆ¶å³æ™‚çœ‹åˆ°ã€‚

ç¢ºä¿åœ¨å»ºç«‹ç³»çµ±è¨Šæ¯å¾Œå‘¼å«:

```python
socketio.emit('new_message', {...}, room=f'chat_{match_id}')
```

### 3. å‰ç«¯è¨Šæ¯é¡å‹è™•ç†

ç¢ºä¿ loadMessages æ™‚æ­£ç¢ºè™•ç† system é¡å‹:

```javascript
messages.value = response.data.messages.map(msg => ({
  id: msg.message_id,
  type: msg.message_type || 'text',  // â† ç¢ºä¿æœ‰ type
  content: msg.content,
  time: formatTime(msg.created_at),
  isMine: msg.sender_id === currentUserId  // system è¨Šæ¯ sender_id ç‚º null
}))
```

---

## ğŸ“Š å®Œæˆæª¢æŸ¥æ¸…å–®

å¯¦ä½œå®Œæˆå¾Œ,ç¢ºèªä»¥ä¸‹é …ç›®:

### å¾Œç«¯
- [ ] åª’åˆç¢ºèªæ™‚å»ºç«‹ç³»çµ±è¨Šæ¯
- [ ] ç³»çµ±è¨Šæ¯ message_type='system'
- [ ] sender_id=None (æˆ–ç³»çµ±ç”¨æˆ¶ ID)
- [ ] é€é Socket.IO å»£æ’­ç³»çµ±è¨Šæ¯
- [ ] æ¸¬è©¦é€šé: `test_match_success_system_message`

### å‰ç«¯
- [ ] è­˜åˆ¥ message.type === 'system'
- [ ] ç³»çµ±è¨Šæ¯ä½¿ç”¨ç‰¹æ®Šæ¨£å¼
- [ ] å±…ä¸­é¡¯ç¤º
- [ ] ä¸é¡¯ç¤ºé ­åƒå’Œç™¼é€è€…
- [ ] ç°è‰²èƒŒæ™¯æˆ–ç‰¹æ®Šé¡è‰²

### æ¸¬è©¦
- [ ] è‡ªå‹•åŒ–æ¸¬è©¦é€šé (5/5)
- [ ] æ‰‹å‹•æ¸¬è©¦åª’åˆæµç¨‹
- [ ] ç³»çµ±è¨Šæ¯æ­£ç¢ºé¡¯ç¤º

---

## ğŸ‰ å®Œæˆå¾Œ

å°‡ Story 4.5 ç‹€æ…‹æ›´æ–°ç‚º **Done**:

```markdown
## Status
Done

## å¯¦ä½œå®Œæˆåº¦
100% âœ…

- âœ… å³æ™‚è¨Šæ¯æ¥æ”¶èˆ‡é¡¯ç¤º
- âœ… æœªè®€è¨ˆæ•¸ç³»çµ±
- âœ… å·²è®€æ¨™è¨˜èˆ‡å›åŸ·
- âœ… æ‡‰ç”¨å…§é€šçŸ¥
- âœ… è‡ªå‹•æ»¾å‹•
- âœ… ç³»çµ±è¨Šæ¯åŠŸèƒ½
```

---

**é è¨ˆå·¥ä½œæ™‚é–“**: 2-3 å°æ™‚  
**é›£åº¦**: â­â­â˜†â˜†â˜† (ä¸­ç­‰åæ˜“)  
**å»ºè­°**: å…ˆå¯¦ä½œå¾Œç«¯,æ¸¬è©¦ API,å†å¯¦ä½œå‰ç«¯æ¨£å¼
