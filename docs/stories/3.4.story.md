# Story 3.4: 查看活動詳情

## Status

Draft

## Story

**As a** 用戶,
**I want** 點擊活動並查看其詳細頁面，包含所有資訊、目前的參與者、討論串、費用和相簿,
**so that** 我可以深入了解活動內容並決定是否參加。

## Acceptance Criteria

### 頁面路由與導航

1. 從活動列表點擊活動卡片應導航至活動詳情頁面

2. 活動詳情頁面路由格式：`/activities/:activityId`

3. 如果活動不存在，應顯示 404 錯誤頁面並提示「活動不存在」

4. 提供「返回列表」按鈕，導航回活動列表頁面

5. 頁面應支援瀏覽器的「上一頁」和「下一頁」功能

### 活動基本資訊區塊

6. 顯示活動標題（粗體、大字號）

7. 顯示活動狀態標籤：
   - 開放招募（recruiting）- 綠色
   - 進行中（ongoing）- 藍色
   - 已完成（completed）- 灰色
   - 已取消（cancelled）- 紅色

8. 顯示活動類型標籤（使用與列表頁一致的顏色）

9. 顯示活動封面圖片：
   - 如果有封面圖，顯示完整寬度
   - 如果無封面圖，顯示預設圖片或佔位符

10. 顯示活動描述（支援換行和基本格式）

### 活動詳細資訊區塊

11. 顯示活動組織者資訊：
    - 顯示姓名和頭像
    - 點擊可導航至組織者個人資料頁面（如已實作）

12. 顯示活動日期時間：
    - 開始時間（格式：YYYY年MM月DD日 HH:mm）
    - 結束時間（格式：YYYY年MM月DD日 HH:mm）
    - 或顯示「待定」如果日期未確定

13. 顯示活動地點：
    - 地點名稱
    - 如有地址，顯示完整地址

14. 顯示人數資訊：
    - 目前參與人數 / 人數上限
    - 例如：「5 / 10 人」
    - 如果已滿，顯示「已額滿」標籤

15. 顯示費用資訊：
    - 如果免費，顯示「免費」
    - 如果有費用，顯示金額（例如：「NT$ 500」）

16. 顯示性別和年齡限制：
    - 性別偏好：「不限」、「男性」、「女性」
    - 年齡範圍：「18-35 歲」或「不限」

### 參與者列表區塊

17. 顯示「參與者」標題及目前人數

18. 顯示參與者清單：
    - 每位參與者的頭像和姓名
    - 使用頭像網格或列表呈現
    - 最多顯示前 10 位，超過的顯示「+N 位」

19. 組織者在參與者列表中應有特殊標記（例如：「組織者」標籤）

20. 點擊參與者頭像可導航至其個人資料頁面（如已實作）

### 討論串區塊

21. 顯示「討論」標題及討論數量

22. 如果有討論，顯示最新的 5 則討論：
    - 顯示發言者姓名和頭像
    - 顯示發言時間（使用相對時間，例如「2 小時前」）
    - 顯示發言內容（最多顯示 2 行，超過顯示「...」）

23. 提供「查看所有討論」按鈕，展開完整討論串

24. 如果沒有討論，顯示「目前還沒有討論」提示

25. 如果用戶已登入且已加入活動，提供「發表討論」輸入框

### 費用明細區塊

26. 如果活動有費用，顯示費用明細區塊

27. 費用明細應包含：
    - 費用項目名稱
    - 費用金額

28. 如果有多筆費用，顯示總計金額

29. 如果活動免費，不顯示此區塊

### 活動相簿區塊

30. 顯示「活動相簿」標題及照片數量

31. 如果有照片，顯示照片網格（最多顯示 6 張縮圖）

32. 點擊照片可放大檢視（使用燈箱效果）

33. 提供「查看所有照片」按鈕，導航至完整相簿頁面

34. 如果沒有照片，顯示「目前還沒有照片」提示

35. 如果用戶已登入且已加入活動，提供「上傳照片」按鈕

### 參加/退出功能

36. 如果用戶未登入，顯示「登入後參加」按鈕，點擊導航至登入頁面

37. 如果用戶已登入但未參加：
    - 顯示「我要參加」按鈕
    - 點擊後發送參加請求
    - 成功後更新參與者列表並顯示成功訊息

38. 如果用戶已參加：
    - 顯示「已參加」狀態
    - 提供「退出活動」按鈕

39. 如果活動已額滿，「我要參加」按鈕應禁用並顯示「已額滿」

40. 如果活動狀態為「已完成」或「已取消」，不顯示參加按鈕

### 後端 API

41. API 端點：`GET /api/activities/:activityId`

42. API 應驗證 JWT 認證（可選：未登入也能查看，但功能受限）

43. 成功回應（200 OK）：
    ```json
    {
      "activity": {
        "activity_id": 1,
        "title": "陽明山登山之旅",
        "description": "探索陽明山的美麗風景...",
        "category": "adventure",
        "status": "recruiting",
        "start_date": "2025-11-15T09:00:00",
        "end_date": "2025-11-15T17:00:00",
        "location": "陽明山國家公園",
        "max_participants": 10,
        "current_participants": 5,
        "cost": 500,
        "gender_preference": "any",
        "age_min": 18,
        "age_max": 45,
        "cover_image": "/uploads/activity1.jpg",
        "creator": {
          "user_id": 10,
          "username": "john_doe",
          "avatar": "/uploads/avatar10.jpg"
        },
        "participants": [
          {
            "user_id": 10,
            "username": "john_doe",
            "avatar": "/uploads/avatar10.jpg",
            "is_creator": true
          },
          ...
        ],
        "discussions": [
          {
            "discussion_id": 1,
            "user": {
              "user_id": 11,
              "username": "jane_smith",
              "avatar": "/uploads/avatar11.jpg"
            },
            "content": "這個活動看起來很有趣！",
            "created_at": "2025-11-05T14:30:00"
          }
        ],
        "expenses": [
          {
            "expense_id": 1,
            "description": "交通費",
            "amount": 200
          },
          {
            "expense_id": 2,
            "description": "餐費",
            "amount": 300
          }
        ],
        "photos": [
          {
            "photo_id": 1,
            "url": "/uploads/photo1.jpg",
            "uploaded_by": 10,
            "created_at": "2025-11-05T10:00:00"
          }
        ],
        "user_is_participant": true
      }
    }
    ```

44. 如果活動不存在，返回 404 錯誤：
    ```json
    {
      "error": "活動不存在"
    }
    ```

45. API 回應應包含：
    - 完整的活動資訊
    - 組織者資料
    - 參與者列表
    - 最新討論（最多 5 則）
    - 費用明細
    - 照片（最多 6 張）
    - 目前用戶是否已參加（`user_is_participant`）

### 效能要求

46. 頁面載入時間需低於 1500ms

47. 圖片應使用懶載入（lazy loading）

48. 後端應使用 JOIN 查詢減少資料庫請求次數

### 響應式設計

49. 手機版應：
    - 單欄佈局
    - 參與者頭像縮小
    - 照片網格調整為 2-3 欄

50. 桌面版應：
    - 左側主要內容，右側資訊卡片（組織者、參與者等）
    - 照片網格 3-4 欄

## Tasks / Subtasks

> **Brownfield 專案說明**：後端 API 端點 `GET /api/activities/:id` 已存在，但需要擴展以包含參與者、討論、費用和照片資料。前端需要建立完整的活動詳情頁面。

### Phase 1: 後端 API 擴展

- [ ] **Task 1: 擴展活動詳情 API** (AC: 41-45, 48)
  - [ ] 檢查 `backend/blueprints/activities.py` 中的 `GET /activities/<id>` 端點
  - [ ] 使用 SQLAlchemy JOIN 查詢載入關聯資料：
    - 組織者資料（User）
    - 參與者列表（ActivityParticipant + User）
    - 討論串（ActivityDiscussion + User，最新 5 則）
    - 費用明細（Expense）
    - 照片（ActivityPhoto，最新 6 張）
  - [ ] 實作 `user_is_participant` 邏輯（檢查目前用戶是否在參與者列表中）
  - [ ] 新增 404 錯誤處理（活動不存在）
  - [ ] 優化查詢效能（使用 `joinedload` 或 `selectinload`）
  - [ ] 測試 API 端點
  - [ ] 記錄 API 規格

### Phase 2: 前端頁面骨架

- [ ] **Task 2: 建立 ActivityDetail 頁面組件** (AC: 1-5)
  - [ ] 在 `frontend/src/views/` 建立 `ActivityDetail.vue`
  - [ ] 使用 Vue 3 Composition API 和 `<script setup>` 語法
  - [ ] 實作路由參數讀取（`useRoute` 取得 `activityId`）
  - [ ] 實作頁面載入邏輯（呼叫 API 獲取活動詳情）
  - [ ] 實作 404 錯誤處理（活動不存在）
  - [ ] 實作「返回列表」按鈕
  - [ ] 測試基本路由功能

- [ ] **Task 3: 更新路由配置** (AC: 2)
  - [ ] 在 `frontend/src/router/index.js` 新增路由：
    ```javascript
    {
      path: '/activities/:activityId',
      name: 'ActivityDetail',
      component: () => import('@/views/ActivityDetail.vue')
    }
    ```
  - [ ] 測試路由導航

### Phase 3: 活動基本資訊區塊

- [ ] **Task 4: 實作活動基本資訊區塊** (AC: 6-10)
  - [ ] 顯示活動標題
  - [ ] 顯示活動狀態標籤（使用 `el-tag`，與 Story 3.2 一致的顏色）
  - [ ] 顯示活動類型標籤
  - [ ] 顯示活動封面圖片（使用 `el-image`，支援預覽和錯誤處理）
  - [ ] 顯示活動描述（保留換行格式）
  - [ ] 測試區塊渲染

### Phase 4: 活動詳細資訊區塊

- [ ] **Task 5: 實作活動詳細資訊區塊** (AC: 11-16)
  - [ ] 實作組織者資訊卡片（顯示姓名、頭像）
  - [ ] 實作日期時間顯示（使用 Day.js 格式化）
  - [ ] 實作地點顯示
  - [ ] 實作人數資訊（目前 / 上限，顯示「已額滿」標籤）
  - [ ] 實作費用資訊（免費或金額）
  - [ ] 實作性別和年齡限制顯示
  - [ ] 測試區塊渲染

### Phase 5: 參與者列表區塊

- [ ] **Task 6: 實作參與者列表區塊** (AC: 17-20)
  - [ ] 顯示參與者標題和人數
  - [ ] 實作參與者頭像網格（使用 `el-avatar`）
  - [ ] 限制顯示前 10 位，超過顯示「+N 位」
  - [ ] 標記組織者（顯示「組織者」標籤）
  - [ ] 測試參與者顯示

### Phase 6: 討論串區塊

- [ ] **Task 7: 實作討論串區塊** (AC: 21-25)
  - [ ] 顯示討論標題和數量
  - [ ] 實作討論列表（顯示最新 5 則）
  - [ ] 實作相對時間顯示（使用 Day.js `fromNow`）
  - [ ] 實作「查看所有討論」按鈕（展開/收合）
  - [ ] 實作空狀態提示
  - [ ] 實作「發表討論」輸入框（僅限已參加者）
  - [ ] 測試討論區塊

### Phase 7: 費用明細與相簿區塊

- [ ] **Task 8: 實作費用明細區塊** (AC: 26-29)
  - [ ] 顯示費用明細列表
  - [ ] 計算並顯示總計金額
  - [ ] 免費活動不顯示此區塊
  - [ ] 測試費用顯示

- [ ] **Task 9: 實作活動相簿區塊** (AC: 30-35)
  - [ ] 顯示相簿標題和照片數量
  - [ ] 實作照片網格（最多 6 張縮圖）
  - [ ] 實作照片燈箱效果（使用 `el-image-viewer` 或第三方套件）
  - [ ] 實作「查看所有照片」按鈕
  - [ ] 實作空狀態提示
  - [ ] 實作「上傳照片」按鈕（僅限已參加者）
  - [ ] 測試相簿區塊

### Phase 8: 參加/退出功能

- [ ] **Task 10: 實作參加/退出功能** (AC: 36-40)
  - [ ] 檢查用戶登入狀態（使用 Pinia store）
  - [ ] 實作「登入後參加」按鈕（導航至登入頁面）
  - [ ] 實作「我要參加」按鈕（呼叫 POST /api/activities/:id/join）
  - [ ] 實作「退出活動」按鈕（呼叫 DELETE /api/activities/:id/leave）
  - [ ] 實作按鈕狀態邏輯（已額滿、已完成、已取消時禁用）
  - [ ] 實作成功/失敗提示訊息
  - [ ] 測試參加/退出功能

### Phase 9: API 服務層

- [ ] **Task 11: 更新 activities API 服務** (AC: 41)
  - [ ] 確認 `frontend/src/api/activities.js` 中的 `getActivityDetail` 函數
  - [ ] 如果不存在，建立函數：
    ```javascript
    export const getActivityDetail = (activityId) => {
      return axios.get(`/api/activities/${activityId}`)
    }
    ```
  - [ ] 測試 API 函數

### Phase 10: 響應式設計

- [ ] **Task 12: 實作響應式佈局** (AC: 49, 50)
  - [ ] 實作桌面版佈局（左主內容 + 右側資訊卡片）
  - [ ] 實作手機版佈局（單欄）
  - [ ] 調整參與者頭像大小（手機版較小）
  - [ ] 調整照片網格（桌面 3-4 欄，手機 2-3 欄）
  - [ ] 測試不同螢幕尺寸

### Phase 11: 效能優化

- [ ] **Task 13: 實作效能優化** (AC: 46, 47)
  - [ ] 為封面圖和照片實作懶載入（`el-image` 的 `lazy` 屬性）
  - [ ] 優化圖片載入（使用縮圖）
  - [ ] 測試頁面載入效能

### Phase 12: 測試

- [ ] **Task 14: 前端單元測試** (所有 AC)
  - [ ] 測試 `ActivityDetail.vue` 組件渲染
  - [ ] 測試 404 錯誤處理
  - [ ] 測試參加/退出功能
  - [ ] 測試響應式佈局
  - [ ] 執行測試：`npm run test:unit`
  - [ ] 確認覆蓋率 > 80%

- [ ] **Task 15: 後端測試** (AC: 41-45)
  - [ ] 測試活動詳情 API
  - [ ] 測試關聯資料載入（參與者、討論、費用、照片）
  - [ ] 測試 `user_is_participant` 邏輯
  - [ ] 測試 404 錯誤處理
  - [ ] 執行測試：`pytest backend/tests/test_activities.py -v`

### Phase 13: 整合測試與驗收

- [ ] **Task 16: 端到端功能驗證** (所有 AC)
  - [ ] 手動測試完整頁面流程
  - [ ] 測試從列表導航至詳情
  - [ ] 測試所有區塊顯示
  - [ ] 測試參加/退出功能
  - [ ] 測試響應式設計
  - [ ] 驗證所有 AC 滿足

## Dev Notes

### Previous Story Insights

**來自 Story 1.1 - 3.3 的經驗**：
- Vue 3 Composition API 是標準開發模式 [Source: architecture/4-組件標準-component-standards.md]
- Element Plus 組件庫已整合，使用 `el-image`、`el-tag`、`el-avatar`、`el-button` 等組件 [Source: architecture/2-前端技術棧-frontend-tech-stack.md]
- Day.js 用於日期格式化和相對時間顯示 [Source: architecture/2-前端技術棧-frontend-tech-stack.md]
- Vue Router 用於頁面導航 [Source: architecture/7-路由配置-routing.md]
- Pinia 用於狀態管理（用戶登入狀態） [Source: architecture/5-狀態管理-state-management.md]
- JWT 認證機制完善 [Source: architecture/6-api-整合-api-integration.md]
- SQLAlchemy ORM 用於資料庫查詢和關聯載入 [Source: backend/models/activity.py]

### API Specifications

#### 活動詳情 API

**Endpoint**: `GET /api/activities/:activityId`

**Authentication**: Optional (未登入可查看，但 `user_is_participant` 為 false)

**Path Parameters**:
- `activityId`: 活動 ID（整數）

**Response (Success - 200)**:
```json
{
  "activity": {
    "activity_id": 1,
    "title": "陽明山登山之旅",
    "description": "探索陽明山的美麗風景，享受大自然的洗禮。",
    "category": "adventure",
    "status": "recruiting",
    "start_date": "2025-11-15T09:00:00",
    "end_date": "2025-11-15T17:00:00",
    "location": "陽明山國家公園",
    "max_participants": 10,
    "current_participants": 5,
    "cost": 500,
    "gender_preference": "any",
    "age_min": 18,
    "age_max": 45,
    "cover_image": "/uploads/activity1.jpg",
    "created_at": "2025-11-01T10:00:00",
    "updated_at": "2025-11-05T14:00:00",
    "creator": {
      "user_id": 10,
      "username": "john_doe",
      "avatar": "/uploads/avatar10.jpg"
    },
    "participants": [
      {
        "user_id": 10,
        "username": "john_doe",
        "avatar": "/uploads/avatar10.jpg",
        "is_creator": true
      },
      {
        "user_id": 11,
        "username": "jane_smith",
        "avatar": "/uploads/avatar11.jpg",
        "is_creator": false
      }
    ],
    "discussions": [
      {
        "discussion_id": 1,
        "user": {
          "user_id": 11,
          "username": "jane_smith",
          "avatar": "/uploads/avatar11.jpg"
        },
        "content": "這個活動看起來很有趣！期待參加。",
        "created_at": "2025-11-05T14:30:00"
      }
    ],
    "expenses": [
      {
        "expense_id": 1,
        "description": "交通費",
        "amount": 200
      },
      {
        "expense_id": 2,
        "description": "餐費",
        "amount": 300
      }
    ],
    "photos": [
      {
        "photo_id": 1,
        "url": "/uploads/photo1.jpg",
        "uploaded_by": 10,
        "uploader_name": "john_doe",
        "created_at": "2025-11-05T10:00:00"
      }
    ],
    "user_is_participant": true
  }
}
```

**Response (Error - 404)**:
```json
{
  "error": "活動不存在"
}
```

### Backend Implementation Guide

**SQLAlchemy 查詢範例（優化版）**:

```python
from sqlalchemy.orm import joinedload, selectinload

@activities_bp.route('/<int:activity_id>', methods=['GET'])
def get_activity_detail(activity_id):
    """獲取活動詳情（包含所有關聯資料）"""
    try:
        # 取得目前用戶 ID（如果已登入）
        current_user_id = None
        try:
            current_user_id = get_jwt_identity()
        except:
            pass
        
        # 使用 joinedload 優化查詢
        activity = Activity.query.options(
            joinedload(Activity.creator),
            selectinload(Activity.participants).joinedload(ActivityParticipant.user),
            selectinload(Activity.discussions).joinedload(ActivityDiscussion.user).limit(5),
            selectinload(Activity.expenses),
            selectinload(Activity.photos).limit(6)
        ).filter_by(activity_id=activity_id).first()
        
        if not activity:
            return jsonify({'error': '活動不存在'}), 404
        
        # 檢查目前用戶是否已參加
        user_is_participant = False
        if current_user_id:
            user_is_participant = any(
                p.user_id == current_user_id for p in activity.participants
            )
        
        # 組裝回應
        activity_data = activity.to_dict(include_creator_info=True)
        
        # 新增參與者列表
        activity_data['participants'] = [
            {
                'user_id': p.user.user_id,
                'username': p.user.username,
                'avatar': p.user.avatar,
                'is_creator': p.user_id == activity.creator_id
            }
            for p in activity.participants
        ]
        
        # 新增討論串（最新 5 則）
        activity_data['discussions'] = [
            {
                'discussion_id': d.discussion_id,
                'user': {
                    'user_id': d.user.user_id,
                    'username': d.user.username,
                    'avatar': d.user.avatar
                },
                'content': d.content,
                'created_at': d.created_at.isoformat()
            }
            for d in sorted(activity.discussions, key=lambda x: x.created_at, reverse=True)[:5]
        ]
        
        # 新增費用明細
        activity_data['expenses'] = [
            {
                'expense_id': e.expense_id,
                'description': e.description,
                'amount': e.amount
            }
            for e in activity.expenses
        ]
        
        # 新增照片（最新 6 張）
        activity_data['photos'] = [
            {
                'photo_id': p.photo_id,
                'url': p.url,
                'uploaded_by': p.uploaded_by,
                'uploader_name': p.uploader.username if p.uploader else None,
                'created_at': p.created_at.isoformat()
            }
            for p in sorted(activity.photos, key=lambda x: x.created_at, reverse=True)[:6]
        ]
        
        # 新增用戶參與狀態
        activity_data['user_is_participant'] = user_is_participant
        
        return jsonify({'activity': activity_data}), 200
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500
```

### Frontend Implementation Guide

**Vue 組件結構範例**:

```vue
<script setup>
import { ref, computed, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { useUserStore } from '@/stores/user'
import { getActivityDetail, joinActivity, leaveActivity } from '@/api/activities'
import dayjs from 'dayjs'
import relativeTime from 'dayjs/plugin/relativeTime'
import 'dayjs/locale/zh-tw'

dayjs.extend(relativeTime)
dayjs.locale('zh-tw')

const route = useRoute()
const router = useRouter()
const userStore = useUserStore()

const activity = ref(null)
const loading = ref(true)
const notFound = ref(false)

const activityId = computed(() => route.params.activityId)
const isLoggedIn = computed(() => userStore.isLoggedIn)
const isParticipant = computed(() => activity.value?.user_is_participant || false)
const isFull = computed(() => 
  activity.value?.current_participants >= activity.value?.max_participants
)
const canJoin = computed(() => 
  isLoggedIn.value && 
  !isParticipant.value && 
  !isFull.value && 
  activity.value?.status === 'recruiting'
)

const fetchActivityDetail = async () => {
  try {
    loading.value = true
    const { data } = await getActivityDetail(activityId.value)
    activity.value = data.activity
    notFound.value = false
  } catch (error) {
    if (error.response?.status === 404) {
      notFound.value = true
    }
    ElMessage.error('無法載入活動詳情')
  } finally {
    loading.value = false
  }
}

const handleJoin = async () => {
  try {
    await joinActivity(activityId.value)
    ElMessage.success('成功加入活動！')
    await fetchActivityDetail()
  } catch (error) {
    ElMessage.error('加入活動失敗')
  }
}

const handleLeave = async () => {
  try {
    await ElMessageBox.confirm('確定要退出活動嗎？', '提示', {
      confirmButtonText: '確定',
      cancelButtonText: '取消',
      type: 'warning'
    })
    await leaveActivity(activityId.value)
    ElMessage.success('已退出活動')
    await fetchActivityDetail()
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('退出活動失敗')
    }
  }
}

const goBack = () => {
  router.push('/activities')
}

const formatDate = (date) => {
  return dayjs(date).format('YYYY年MM月DD日 HH:mm')
}

const formatRelativeTime = (date) => {
  return dayjs(date).fromNow()
}

onMounted(() => {
  fetchActivityDetail()
})
</script>

<template>
  <div class="activity-detail">
    <!-- 載入狀態 -->
    <el-skeleton v-if="loading" :rows="10" animated />
    
    <!-- 404 錯誤 -->
    <el-empty v-else-if="notFound" description="活動不存在">
      <el-button @click="goBack">返回列表</el-button>
    </el-empty>
    
    <!-- 活動詳情 -->
    <div v-else class="detail-container">
      <!-- 返回按鈕 -->
      <el-button @click="goBack" icon="ArrowLeft" class="mb-4">
        返回列表
      </el-button>
      
      <!-- 活動封面 -->
      <el-image 
        :src="activity.cover_image" 
        fit="cover"
        class="cover-image"
        lazy
      >
        <template #error>
          <div class="image-placeholder">
            <el-icon><Picture /></el-icon>
          </div>
        </template>
      </el-image>
      
      <el-row :gutter="20" class="mt-4">
        <!-- 左側主內容 -->
        <el-col :xs="24" :lg="16">
          <!-- 標題和標籤 -->
          <h1 class="activity-title">{{ activity.title }}</h1>
          <div class="tags mb-4">
            <el-tag :type="statusTagType">{{ statusText }}</el-tag>
            <el-tag :color="categoryColor">{{ categoryText }}</el-tag>
            <el-tag v-if="isFull" type="danger">已額滿</el-tag>
          </div>
          
          <!-- 描述 -->
          <p class="activity-description">{{ activity.description }}</p>
          
          <!-- 討論串區塊 -->
          <div class="section discussions">
            <h3>討論 ({{ activity.discussions?.length || 0 }})</h3>
            <!-- 討論內容實作 -->
          </div>
          
          <!-- 活動相簿 -->
          <div class="section photos">
            <h3>活動相簿 ({{ activity.photos?.length || 0 }})</h3>
            <!-- 照片網格實作 -->
          </div>
        </el-col>
        
        <!-- 右側資訊卡片 -->
        <el-col :xs="24" :lg="8">
          <!-- 組織者資訊 -->
          <el-card class="info-card mb-4">
            <h4>組織者</h4>
            <!-- 組織者資訊實作 -->
          </el-card>
          
          <!-- 活動詳細資訊 -->
          <el-card class="info-card mb-4">
            <h4>活動資訊</h4>
            <!-- 日期、地點、人數、費用實作 -->
          </el-card>
          
          <!-- 參與者 -->
          <el-card class="info-card mb-4">
            <h4>參與者 ({{ activity.current_participants }})</h4>
            <!-- 參與者列表實作 -->
          </el-card>
          
          <!-- 參加按鈕 -->
          <el-button 
            v-if="canJoin"
            type="primary" 
            size="large" 
            @click="handleJoin"
            class="w-full"
          >
            我要參加
          </el-button>
          <el-button 
            v-else-if="isParticipant"
            type="info" 
            size="large" 
            disabled
            class="w-full mb-2"
          >
            已參加
          </el-button>
          <el-button 
            v-if="isParticipant"
            size="large" 
            @click="handleLeave"
            class="w-full"
          >
            退出活動
          </el-button>
        </el-col>
      </el-row>
    </div>
  </div>
</template>
```

### Color Mappings (與 Story 3.2 一致)

**活動狀態顏色**:
```javascript
const statusColors = {
  recruiting: 'success',  // 綠色
  ongoing: 'primary',     // 藍色
  completed: 'info',      // 灰色
  cancelled: 'danger'     // 紅色
}
```

**活動類型顏色**:
```javascript
const categoryColors = {
  adventure: '#67C23A',   // 綠色
  culture: '#E6A23C',     // 橙色
  leisure: '#409EFF',     // 藍色
  food: '#F56C6C',        // 紅色
  sports: '#909399',      // 灰色
  other: '#909399'        // 灰色
}
```

### File Locations

**Backend** (更新):
- API: `backend/blueprints/activities.py` (擴展詳情端點)
- Models: 檢查 `backend/models/activity.py`, `activity_participant.py`, `activity_discussion.py`, `expense.py`
- 測試: `backend/tests/test_activities.py` (新增測試)

**Frontend - New Files**:
- 活動詳情頁面: `frontend/src/views/ActivityDetail.vue` (新建)

**Frontend - Updated Files**:
- 路由: `frontend/src/router/index.js` (新增路由)
- API 函數: `frontend/src/api/activities.js` (新增 `getActivityDetail`, `joinActivity`, `leaveActivity`)
- 測試: `frontend/tests/unit/views/ActivityDetail.spec.js` (新建)

### Testing Requirements

**Unit Testing (Vitest)** [Source: architecture/11-測試策略-testing-requirements.md]:
- 測試 `ActivityDetail.vue` 組件渲染
- 測試 404 錯誤處理
- 測試參加/退出功能
- 測試按鈕狀態邏輯
- 測試響應式佈局
- 覆蓋率目標：> 80%

**Backend Testing (pytest)**:
- 測試活動詳情 API
- 測試關聯資料載入（JOIN 查詢）
- 測試 `user_is_participant` 邏輯
- 測試 404 錯誤
- 測試效能（查詢次數）

### Technical Constraints

1. **使用 SQLAlchemy `joinedload` 和 `selectinload` 優化查詢**（避免 N+1 問題）
2. **圖片懶載入**（使用 `el-image` 的 `lazy` 屬性）
3. **討論和照片數量限制**（討論 5 則，照片 6 張）
4. **響應式佈局**（桌面版左右分欄，手機版單欄）
5. **日期格式化統一使用 Day.js**

### UI/UX 考量

**頁面佈局建議**:
- 桌面版：左側主要內容（描述、討論、相簿），右側資訊卡片（組織者、參與者、參加按鈕）
- 手機版：單欄垂直排列，資訊卡片在主內容下方
- 封面圖片：全寬度顯示，高度固定（例如 400px）
- 參與者頭像：使用網格或橫向滾動顯示
- 照片網格：使用 `el-image` 組件，支援點擊預覽

**狀態文字對應**:
```javascript
const statusTexts = {
  recruiting: '開放招募',
  ongoing: '進行中',
  completed: '已完成',
  cancelled: '已取消'
}

const categoryTexts = {
  adventure: '冒險探索',
  culture: '文化體驗',
  leisure: '休閒放鬆',
  food: '美食之旅',
  sports: '運動健身',
  other: '其他'
}
```

## Testing

### Frontend Testing
```bash
npm run test:unit
npm run test:coverage
```

### Backend Testing
```bash
pytest backend/tests/test_activities.py::test_get_activity_detail -v
```

### Manual Testing Checklist

- [ ] 從活動列表點擊活動可正確導航至詳情頁面
- [ ] 活動不存在時顯示 404 錯誤頁面
- [ ] 「返回列表」按鈕正常運作
- [ ] 活動標題和標籤正確顯示
- [ ] 活動封面圖片正確載入（有圖和無圖情況）
- [ ] 活動描述正確顯示（保留換行）
- [ ] 組織者資訊正確顯示
- [ ] 日期時間格式正確（YYYY年MM月DD日 HH:mm）
- [ ] 地點資訊正確顯示
- [ ] 人數資訊正確（目前/上限）
- [ ] 費用資訊正確（免費或金額）
- [ ] 性別和年齡限制正確顯示
- [ ] 參與者列表正確顯示（包含組織者標記）
- [ ] 討論串正確顯示（最新 5 則）
- [ ] 相對時間正確顯示（「2 小時前」）
- [ ] 費用明細正確顯示（如有費用）
- [ ] 活動相簿正確顯示（最多 6 張）
- [ ] 照片燈箱效果正常運作
- [ ] 未登入時顯示「登入後參加」按鈕
- [ ] 已登入未參加時顯示「我要參加」按鈕
- [ ] 已參加時顯示「已參加」和「退出活動」按鈕
- [ ] 活動已額滿時「我要參加」按鈕禁用
- [ ] 活動已完成或已取消時不顯示參加按鈕
- [ ] 參加活動功能正常運作
- [ ] 退出活動功能正常運作（含確認對話框）
- [ ] 手機版佈局正確（單欄）
- [ ] 桌面版佈局正確（左右分欄）
- [ ] 圖片懶載入正常運作

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*此區塊由開發代理在實作時填寫*

### Agent Model Used

(待開發代理填寫)

### Debug Log References

(待開發代理填寫)

### Completion Notes List

(待開發代理填寫)

### File List

(待開發代理填寫)

## QA Results

*此區塊由 QA 代理審查後更新審查結果*
