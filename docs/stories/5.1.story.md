# Story 5.1: 建立與管理媒合申請

## Status

Draft

## Story

**As a** 使用者,
**I want** 對特定使用者發出媒合申請，並能管理我發出和收到的申請狀態（待確認/已接受/已拒絕等）,
**so that** 我可以主動尋找潛在的旅伴。

## Acceptance Criteria

### 媒合申請發送

1. 使用者可以在其他使用者的個人資料頁面看到「發送媒合申請」按鈕
2. 點擊按鈕後彈出確認對話框，可選填申請訊息（最多 500 字）
3. 發送申請時應顯示載入狀態
4. 成功發送後顯示成功訊息：「媒合申請已發送」
5. 已發送過申請的使用者，按鈕應顯示為「已發送申請」並禁用
6. 已媒合成功的使用者，按鈕應顯示為「已媒合」並禁用
7. 不能對自己發送媒合申請

### 媒合管理頁面

8. 提供媒合管理頁面（/matches），包含三個分頁：
   - **待處理**：收到的待確認申請
   - **已發送**：我發送的申請及其狀態
   - **已媒合**：雙方確認的媒合列表

9. 每個分頁應顯示對應的媒合列表
10. 每個媒合項目應顯示：
    - 對方使用者的頭像、名稱
    - 媒合建立時間
    - 申請訊息（如有）
    - 當前狀態（pending, accepted, rejected）
    - 相關活動資訊（如果是通過活動發起的）

### 待處理申請審核

11. 在「待處理」分頁，每個申請應提供「接受」和「拒絕」按鈕
12. 點擊「接受」後：
    - 顯示確認對話框
    - 確認後更新狀態為 ccepted
    - 顯示成功訊息：「已接受媒合申請」
    - 自動開啟私人聊天室（如已實作）
13. 點擊「拒絕」後：
    - 顯示確認對話框，可選填拒絕原因
    - 確認後更新狀態為 
ejected
    - 顯示訊息：「已拒絕該申請」

### 已發送申請管理

14. 在「已發送」分頁，顯示我發送的所有申請
15. 顯示每個申請的狀態：
    - pending：等待對方回應
    - ccepted：對方已接受
    - 
ejected：對方已拒絕
16. pending 狀態的申請應提供「取消申請」按鈕
17. 點擊「取消申請」後更新狀態為 cancelled

### 已媒合列表

18. 在「已媒合」分頁，顯示所有 ccepted 狀態的媒合
19. 每個媒合項目應提供「查看資料」按鈕，跳轉到對方個人資料頁
20. 每個媒合項目應提供「發送訊息」按鈕，開啟私人聊天室（如已實作）

### 後端 API

21. **發送媒合申請** - POST /api/matches
    - Request Body: { "responder_id": 2, "message": "希望能成為旅伴！", "activity_id": 123 }
    - Response (201): { "message": "媒合申請已發送", "match": {...} }

22. **獲取待處理申請** - GET /api/matches/pending
    - Response (200): { "matches": [{...}] }

23. **獲取已發送申請** - GET /api/matches/sent
    - Response (200): { "matches": [{...}] }

24. **獲取已媒合列表** - GET /api/matches?status=accepted
    - Response (200): { "matches": [{...}] }

25. **接受媒合申請** - POST /api/matches/{match_id}/accept
    - Response (200): { "message": "媒合申請已接受", "match": {...} }

26. **拒絕媒合申請** - POST /api/matches/{match_id}/reject
    - Request Body: { "reason": "行程不合適" }
    - Response (200): { "message": "媒合申請已拒絕" }

27. **取消媒合申請** - POST /api/matches/{match_id}/cancel
    - Response (200): { "message": "媒合申請已取消" }

### 效能與體驗

28. API 回應時間需低於 500ms
29. 頁面載入時顯示骨架屏（Skeleton）
30. 操作成功/失敗時顯示友善的訊息提示
31. 空狀態時顯示引導訊息（例如：「還沒有待處理的申請」）

### 安全性

32. 所有 API 需要 JWT 認證
33. 只能管理與自己相關的媒合申請
34. 防止重複發送媒合申請給同一使用者


## Tasks / Subtasks

> ** Brownfield 專案說明**：後端 Match Model 和基礎 API 已實作，前端需建立完整的媒合管理頁面和互動流程。

### Phase 1: 後端 API 驗證與補充

- [ ] **Task 1: 驗證 Match Model** (AC: 10, 33, 34)
  - [ ]  確認 ackend/models/match.py 存在
  - [ ]  驗證欄位：match_id, ctivity_id, user_a, user_b, status, match_date, confirmed_date, message, 
ejection_reason
  - [ ]  檢查 	o_dict() 方法
  - [ ]  檢查狀態管理方法：confirm(), 
eject(), cancel()
  - [ ]  檢查輔助方法：get_other_user(), is_participant()
  - [ ]  記錄 Model 結構

- [ ] **Task 2: 驗證媒合 API 端點** (AC: 21-27)
  - [ ]  驗證 POST /api/matches - 發送媒合申請
  - [ ]  驗證 GET /api/matches/pending - 獲取待處理申請
  - [ ]  驗證 GET /api/matches/sent - 獲取已發送申請  
  - [ ]  驗證 GET /api/matches?status=accepted - 獲取已媒合列表
  - [ ]  檢查 POST /api/matches/{match_id}/accept - 接受申請（可能需新增）
  - [ ]  檢查 POST /api/matches/{match_id}/reject - 拒絕申請（可能需新增）
  - [ ]  檢查 POST /api/matches/{match_id}/cancel - 取消申請（可能需新增）
  - [ ]  記錄現有 API 和缺失功能

- [ ] **Task 3: 補充缺失的 API 端點** (AC: 25-27, 如需要)
  - [ ]  實作 ccept_match() 端點（如不存在）
    - 驗證 match_id 存在
    - 驗證當前使用者是 user_b
    - 更新狀態為 'accepted'
    - 設定 confirmed_date
    - 回傳更新後的 match
  - [ ]  實作 
eject_match() 端點（如不存在）
    - 驗證 match_id 存在
    - 驗證當前使用者是 user_b
    - 接收 rejection_reason
    - 更新狀態為 'rejected'
    - 回傳結果
  - [ ]  實作 cancel_match() 端點（如不存在）
    - 驗證 match_id 存在
    - 驗證當前使用者是 user_a 且狀態為 pending
    - 更新狀態為 'cancelled'
    - 回傳結果
  - [ ]  測試新增的端點

### Phase 2: 前端頁面建立

- [ ] **Task 4: 建立 Matches 頁面** (AC: 8, 9)
  - [ ]  建立 rontend/src/views/Matches.vue
  - [ ]  使用 Composition API 架構
  - [ ]  設計頁面佈局：
    - 頁面標題「媒合管理」
    - 三個分頁：待處理、已發送、已媒合
  - [ ]  使用 Element Plus Tabs 組件
  - [ ]  實作分頁切換邏輯
  - [ ]  添加響應式設計

- [ ] **Task 5: 實作待處理分頁** (AC: 11-13, 22)
  - [ ]  建立待處理列表組件或區塊
  - [ ]  呼叫 GET /api/matches/pending 獲取資料
  - [ ]  顯示每個申請的資訊：
    - 申請者頭像和名稱
    - 申請時間
    - 申請訊息
    - 相關活動（如有）
  - [ ]  實作「接受」按鈕及確認對話框
  - [ ]  實作「拒絕」按鈕及確認對話框（可選填拒絕原因）
  - [ ]  實作接受/拒絕後的 UI 更新
  - [ ]  顯示空狀態（無待處理申請時）

- [ ] **Task 6: 實作已發送分頁** (AC: 14-17, 23)
  - [ ]  建立已發送列表組件或區塊
  - [ ]  呼叫 GET /api/matches/sent 獲取資料
  - [ ]  顯示每個申請的資訊和狀態
  - [ ]  根據狀態顯示不同的標籤樣式：
    - pending: warning 標籤
    - accepted: success 標籤
    - rejected: danger 標籤
  - [ ]  實作「取消申請」按鈕（僅 pending 狀態）
  - [ ]  實作取消確認對話框
  - [ ]  顯示空狀態

- [ ] **Task 7: 實作已媒合分頁** (AC: 18-20, 24)
  - [ ]  建立已媒合列表組件或區塊
  - [ ]  呼叫 GET /api/matches?status=accepted 獲取資料
  - [ ]  顯示每個媒合的資訊
  - [ ]  實作「查看資料」按鈕，跳轉到對方個人資料頁
  - [ ]  實作「發送訊息」按鈕（如聊天功能已實作）
  - [ ]  顯示空狀態

### Phase 3: 個人資料頁面整合

- [ ] **Task 8: 在個人資料頁添加媒合按鈕** (AC: 1-7, 21)
  - [ ]  檢查 rontend/src/views/Profile.vue 或 ProfileDetail.vue
  - [ ]  添加「發送媒合申請」按鈕
  - [ ]  實作按鈕顯示邏輯：
    - 不是自己：顯示「發送媒合申請」
    - 已發送：顯示「已發送申請」並禁用
    - 已媒合：顯示「已媒合」並禁用
    - 是自己：不顯示按鈕
  - [ ]  實作點擊彈出確認對話框
  - [ ]  對話框包含訊息輸入框（最多 500 字）
  - [ ]  實作發送媒合申請邏輯
  - [ ]  處理成功/失敗回應

### Phase 4: API 服務層

- [ ] **Task 9: 建立或擴展 matches API 服務** (AC: 21-27)
  - [ ]  檢查 rontend/src/api/matches.js 是否存在
  - [ ]  實作 sendMatchRequest(data) - POST /api/matches
  - [ ]  實作 getPendingMatches() - GET /api/matches/pending
  - [ ]  實作 getSentMatches() - GET /api/matches/sent
  - [ ]  實作 getAcceptedMatches() - GET /api/matches?status=accepted
  - [ ]  實作 cceptMatch(matchId) - POST /api/matches/{id}/accept
  - [ ]  實作 
ejectMatch(matchId, reason) - POST /api/matches/{id}/reject
  - [ ]  實作 cancelMatch(matchId) - POST /api/matches/{id}/cancel
  - [ ]  所有函數返回 Promise

### Phase 5: UI/UX 優化

- [ ] **Task 10: 實作載入和空狀態** (AC: 29, 31)
  - [ ]  使用 Element Plus Skeleton 組件
  - [ ]  為每個分頁實作 Skeleton 載入狀態
  - [ ]  實作空狀態組件（EmptyState）
  - [ ]  為每個分頁設計空狀態訊息：
    - 待處理：「還沒有待處理的申請」
    - 已發送：「還沒有發送過申請」
    - 已媒合：「還沒有媒合成功的旅伴」
  - [ ]  添加淡入動畫

- [ ] **Task 11: 實作訊息提示** (AC: 30)
  - [ ]  使用 Element Plus Message 組件
  - [ ]  實作成功訊息提示
  - [ ]  實作錯誤訊息提示
  - [ ]  實作警告訊息提示
  - [ ]  設定合適的顯示時長

- [ ] **Task 12: 實作確認對話框** (AC: 2, 12, 13, 16, 17)
  - [ ]  使用 Element Plus MessageBox 組件
  - [ ]  實作發送媒合確認對話框（含訊息輸入）
  - [ ]  實作接受媒合確認對話框
  - [ ]  實作拒絕媒合確認對話框（含原因輸入）
  - [ ]  實作取消申請確認對話框
  - [ ]  處理使用者取消操作

### Phase 6: 路由配置

- [ ] **Task 13: 路由配置** (AC: 8)
  - [ ]  在 rontend/src/router/index.js 添加媒合頁面路由
  - [ ]  路由配置：
    - Path: /matches
    - Component: Matches.vue
    - Meta: { requiresAuth: true, title: '媒合管理' }
  - [ ]  添加路由守衛（需登入）
  - [ ]  測試路由導航

- [ ] **Task 14: 導航連結整合** (AC: 8)
  - [ ]  在導航欄添加「媒合」連結
  - [ ]  確認從其他頁面可跳轉至媒合頁面
  - [ ]  驗證導航功能正常

### Phase 7: 測試

- [ ] **Task 15: 前端測試** (AC: 所有)
  - [ ]  建立 rontend/tests/unit/views/Matches.spec.js
  - [ ]  測試頁面正確渲染
  - [ ]  測試分頁切換
  - [ ]  測試媒合列表顯示
  - [ ]  測試按鈕點擊事件
  - [ ]  測試 API 調用（Mock）
  - [ ]  測試載入狀態
  - [ ]  測試空狀態
  - [ ]  測試錯誤處理
  - [ ]  執行測試：
pm run test:unit
  - [ ]  確認覆蓋率 > 80%

- [ ] **Task 16: 後端測試補充** (AC: 21-27, 32-34)
  - [ ]  在 ackend/tests/test_matches.py 補充測試
  - [ ]  測試發送媒合申請成功
  - [ ]  測試重複發送媒合申請（應失敗）
  - [ ]  測試對自己發送申請（應失敗）
  - [ ]  測試獲取待處理申請
  - [ ]  測試獲取已發送申請
  - [ ]  測試獲取已媒合列表
  - [ ]  測試接受媒合申請
  - [ ]  測試拒絕媒合申請
  - [ ]  測試取消媒合申請
  - [ ]  測試未認證請求（應返回 401）
  - [ ]  測試權限檢查（只能管理自己的申請）
  - [ ]  執行測試：pytest backend/tests/test_matches.py -v
  - [ ]  確認所有測試通過

### Phase 8: 整合測試

- [ ] **Task 17: 端到端功能驗證** (所有 AC)
  - [ ]  **測試 1**: 發送媒合申請流程
    - 登入帳號 A
    - 訪問其他使用者（帳號 B）的個人資料頁
    - 點擊「發送媒合申請」
    - 填寫申請訊息
    - 驗證：申請成功發送
    - 驗證：按鈕變為「已發送申請」並禁用
  - [ ]  **測試 2**: 待處理申請審核
    - 登入帳號 B
    - 訪問媒合頁面 /matches
    - 切換到「待處理」分頁
    - 驗證：顯示來自帳號 A 的申請
    - 點擊「接受」
    - 驗證：申請狀態更新為 accepted
    - 驗證：顯示成功訊息
  - [ ]  **測試 3**: 已發送申請查看
    - 登入帳號 A
    - 訪問媒合頁面
    - 切換到「已發送」分頁
    - 驗證：顯示發送給帳號 B 的申請
    - 驗證：狀態顯示為 accepted
  - [ ]  **測試 4**: 已媒合列表
    - 任一帳號登入
    - 訪問媒合頁面
    - 切換到「已媒合」分頁
    - 驗證：顯示雙方媒合記錄
    - 點擊「查看資料」
    - 驗證：跳轉到對方個人資料頁
  - [ ]  **測試 5**: 拒絕媒合申請
    - 建立新的媒合申請
    - 接收方登入
    - 點擊「拒絕」
    - 填寫拒絕原因
    - 驗證：申請狀態更新為 rejected
  - [ ]  **測試 6**: 取消媒合申請
    - 發送方登入
    - 發送新的媒合申請
    - 在「已發送」分頁找到該申請
    - 點擊「取消申請」
    - 驗證：申請狀態更新為 cancelled
  - [ ]  **測試 7**: 防重複發送
    - 嘗試向同一使用者再次發送申請
    - 驗證：顯示錯誤訊息
  - [ ]  **測試 8**: 空狀態顯示
    - 使用無任何媒合的測試帳號
    - 訪問三個分頁
    - 驗證：每個分頁都顯示空狀態訊息
  - [ ]  **測試 9**: 載入狀態
    - 訪問媒合頁面
    - 驗證：顯示 Skeleton 載入狀態
    - 驗證：資料載入後切換至實際內容
  - [ ]  **測試 10**: 響應式設計
    - 在桌面、平板、手機模式測試
    - 驗證：所有佈局正確顯示
    - 驗證：按鈕和操作可正常使用
  - [ ]  驗證所有 AC 滿足
  - [ ]  記錄所有測試結果

### 圖例說明
-  **已存在且正確** - 驗證通過即可
-  **需要檢查** - 可能需要調整
-  **需要新增** - 缺失的功能
-  **需要重構** - 需要改進現有實作
-  **記錄** - 文件化發現
-  **測試** - 執行測試
-  **驗證** - 確認符合需求


## Dev Notes

### Previous Story Insights

**來自 Epic 3 的經驗**：
-  Vue 3 Composition API 是標準開發模式
-  Element Plus 組件庫完整且運作良好
-  Pinia Store 用於狀態管理
-  JWT 認證機制完善
-  Axios 攔截器處理認證和錯誤
-  路由守衛機制已建立
-  響應式設計模式已確立
-  Socket.IO 用於即時通訊功能
-  Day.js 用於日期格式化

**Brownfield 專案背景**：
- 後端 Match Model 已完整實作
- 基礎媒合 API 端點可能已存在
- 主要工作是**建立前端媒合管理頁面**和**完善 API 端點**
- 需要設計優質的使用者體驗（載入狀態、確認對話框、空狀態）

### Data Models

**Match Model** [Source: backend/models/match.py]
- **Table**: matches
- **Primary Key**: match_id (Integer, Auto-increment)
- **欄位**:
  - match_id (Integer, PK) - 媒合 ID
  - user_a (Integer, FK to users, NOT NULL) - 發起媒合的使用者
  - user_b (Integer, FK to users, NOT NULL) - 被邀請的使用者
  - ctivity_id (Integer, FK to activities, NULLABLE) - 相關活動（可選）
  - status (String(50), DEFAULT 'pending') - 媒合狀態
    - 'pending': 等待 user_b 回應
    - 'accepted': user_b 已接受，媒合成功
    - 'rejected': user_b 已拒絕
    - 'cancelled': user_a 取消申請
  - message (Text, NULLABLE) - user_a 的申請訊息
  - 
ejection_reason (Text, NULLABLE) - user_b 的拒絕原因
  - match_date (DateTime, DEFAULT now()) - 申請建立時間
  - confirmed_date (DateTime, NULLABLE) - 媒合確認時間（接受時設定）
  - created_at (DateTime) - 記錄建立時間

**關聯**:
- user_a_rel: relationship to User (發起者)
- user_b_rel: relationship to User (被邀請者)
- ctivity: relationship to Activity (相關活動)

**方法**:
- 	o_dict(): 轉換為字典格式
- confirm(): 確認媒合（設定 status='accepted', confirmed_date=now）
- 
eject(reason=None): 拒絕媒合（設定 status='rejected', rejection_reason）
- cancel(): 取消媒合（設定 status='cancelled'）
- get_other_user(user_id): 獲取對方使用者 ID
- is_participant(user_id): 檢查使用者是否為參與者

**User Model** [Source: backend/models/user.py]
- **Table**: users
- **Primary Key**: user_id (Integer, Auto-increment)
- **相關欄位**:
  - user_id, 
ame, email, vatar_url
  - 
ating_count, verage_rating
  - interests (JSON) - 興趣標籤陣列

### API Specifications

**Endpoint 1**: POST /api/matches [Source: backend/blueprints/matches.py]

**Authentication**: Required (JWT Token)

**Purpose**: 發送媒合申請

**Request Headers**:
`
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json
`

**Request Body**:
`json
{
  "responder_id": 2,
  "message": "希望能成為旅伴！",
  "activity_id": 123
}
`

**Validation**:
- 
esponder_id 必須存在且為有效使用者 ID
- 
esponder_id 不能等於當前使用者 ID（不能對自己發送）
- 不能重複發送給同一使用者（檢查是否已有 pending 或 accepted 狀態的媒合）
- message 最多 500 字
- ctivity_id 如提供，必須為有效活動 ID

**Response (Success - 201)**:
`json
{
  "message": "媒合申請已發送",
  "match": {
    "match_id": 456,
    "user_a": 1,
    "user_b": 2,
    "status": "pending",
    "message": "希望能成為旅伴！",
    "activity_id": 123,
    "match_date": "2025-11-25T10:30:00",
    "created_at": "2025-11-25T10:30:00"
  }
}
`

**Response (Error - 400)**:
`json
{
  "error": "不能對自己發送媒合申請"
}
// 或
{
  "error": "已經有待處理或已接受的媒合申請"
}
// 或
{
  "error": "申請訊息過長（最多 500 字）"
}
`

**Response (Error - 404)**:
`json
{
  "error": "使用者不存在"
}
`

---

**Endpoint 2**: GET /api/matches/pending [Source: backend/blueprints/matches.py]

**Authentication**: Required (JWT Token)

**Purpose**: 獲取當前使用者收到的待處理媒合申請

**Request Headers**:
`
Authorization: Bearer <JWT_TOKEN>
`

**Query Parameters**: None

**Response (Success - 200)**:
`json
{
  "matches": [
    {
      "match_id": 456,
      "user_a": 1,
      "user_b": 2,
      "status": "pending",
      "message": "希望能成為旅伴！",
      "activity_id": 123,
      "match_date": "2025-11-25T10:30:00",
      "requester": {
        "user_id": 1,
        "name": "張小明",
        "avatar_url": "https://...",
        "average_rating": 4.5,
        "rating_count": 10
      },
      "activity": {
        "activity_id": 123,
        "title": "台北一日遊",
        "start_date": "2025-12-01"
      }
    }
  ]
}
`

**查詢邏輯**:
- 查詢條件: user_b = current_user_id AND status = 'pending'
- 排序: 按 match_date 降序（最新的在前）
- 包含 user_a 的基本資料和相關活動資訊

---

**Endpoint 3**: GET /api/matches/sent [Source: backend/blueprints/matches.py]

**Authentication**: Required (JWT Token)

**Purpose**: 獲取當前使用者發送的媒合申請

**Request Headers**:
`
Authorization: Bearer <JWT_TOKEN>
`

**Response (Success - 200)**:
`json
{
  "matches": [
    {
      "match_id": 456,
      "user_a": 1,
      "user_b": 2,
      "status": "pending",
      "message": "希望能成為旅伴！",
      "match_date": "2025-11-25T10:30:00",
      "confirmed_date": null,
      "responder": {
        "user_id": 2,
        "name": "李小華",
        "avatar_url": "https://...",
        "average_rating": 4.8,
        "rating_count": 15
      },
      "activity": {
        "activity_id": 123,
        "title": "台北一日遊",
        "start_date": "2025-12-01"
      }
    }
  ]
}
`

**查詢邏輯**:
- 查詢條件: user_a = current_user_id
- 包含所有狀態（pending, accepted, rejected, cancelled）
- 排序: 按 match_date 降序
- 包含 user_b 的基本資料和相關活動資訊

---

**Endpoint 4**: GET /api/matches?status=accepted [Source: backend/blueprints/matches.py]

**Authentication**: Required (JWT Token)

**Purpose**: 獲取已媒合成功的列表

**Request Headers**:
`
Authorization: Bearer <JWT_TOKEN>
`

**Query Parameters**:
- status (string, optional): 篩選媒合狀態，預設返回所有狀態

**Response (Success - 200)**:
`json
{
  "matches": [
    {
      "match_id": 456,
      "user_a": 1,
      "user_b": 2,
      "status": "accepted",
      "match_date": "2025-11-25T10:30:00",
      "confirmed_date": "2025-11-25T12:00:00",
      "matched_user": {
        "user_id": 2,
        "name": "李小華",
        "avatar_url": "https://...",
        "average_rating": 4.8,
        "rating_count": 15
      },
      "activity": {
        "activity_id": 123,
        "title": "台北一日遊"
      }
    }
  ]
}
`

**查詢邏輯**:
- 查詢條件: (user_a = current_user_id OR user_b = current_user_id) AND status = 'accepted'
- 排序: 按 confirmed_date 降序
- matched_user 為對方使用者資料

---

**Endpoint 5**: POST /api/matches/{match_id}/accept [可能需新增]

**Authentication**: Required (JWT Token)

**Purpose**: 接受媒合申請

**Request Headers**:
`
Authorization: Bearer <JWT_TOKEN>
`

**URL Parameters**:
- match_id (integer): 媒合 ID

**Request Body**: Empty or {}

**Validation**:
- match_id 必須存在
- 當前使用者必須是 user_b（被邀請者）
- 媒合狀態必須是 'pending'

**Response (Success - 200)**:
`json
{
  "message": "已接受媒合申請",
  "match": {
    "match_id": 456,
    "status": "accepted",
    "confirmed_date": "2025-11-25T12:00:00",
    "chat_room_id": 789
  }
}
`

**Response (Error - 403)**:
`json
{
  "error": "無權限操作此媒合申請"
}
`

**Response (Error - 400)**:
`json
{
  "error": "媒合申請狀態不正確"
}
`

---

**Endpoint 6**: POST /api/matches/{match_id}/reject [可能需新增]

**Authentication**: Required (JWT Token)

**Purpose**: 拒絕媒合申請

**Request Headers**:
`
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json
`

**URL Parameters**:
- match_id (integer): 媒合 ID

**Request Body**:
`json
{
  "reason": "行程不合適"
}
`

**Validation**:
- match_id 必須存在
- 當前使用者必須是 user_b
- 媒合狀態必須是 'pending'
- 
eason 可選，最多 500 字

**Response (Success - 200)**:
`json
{
  "message": "已拒絕媒合申請",
  "match": {
    "match_id": 456,
    "status": "rejected",
    "rejection_reason": "行程不合適"
  }
}
`

---

**Endpoint 7**: POST /api/matches/{match_id}/cancel [可能需新增]

**Authentication**: Required (JWT Token)

**Purpose**: 取消媒合申請

**Request Headers**:
`
Authorization: Bearer <JWT_TOKEN>
`

**URL Parameters**:
- match_id (integer): 媒合 ID

**Request Body**: Empty or {}

**Validation**:
- match_id 必須存在
- 當前使用者必須是 user_a（發起者）
- 媒合狀態必須是 'pending'

**Response (Success - 200)**:
`json
{
  "message": "已取消媒合申請",
  "match": {
    "match_id": 456,
    "status": "cancelled"
  }
}
`

**Response (Error - 403)**:
`json
{
  "error": "無權限操作此媒合申請"
}
`

### Component Specifications

**Matches.vue Component** [需新建]

- **Location**: rontend/src/views/Matches.vue
- **Type**: Page Component (Vue 3 SFC with Composition API)
- **Purpose**: 媒合管理頁面，包含三個分頁

**建議結構**:
`ue
<template>
  <div class="matches-page">
    <div class="matches-container">
      <h1>媒合管理</h1>
      
      <el-tabs v-model="activeTab" @tab-change="handleTabChange">
        <!-- 待處理分頁 -->
        <el-tab-pane label="待處理" name="pending">
          <div v-if="loading.pending" class="matches-list">
            <el-skeleton v-for="i in 3" :key="i" animated>
              <template #template>
                <el-skeleton-item variant="rect" style="height: 150px; margin-bottom: 16px" />
              </template>
            </el-skeleton>
          </div>
          
          <el-empty v-else-if="pendingMatches.length === 0" description="還沒有待處理的申請" />
          
          <div v-else class="matches-list">
            <div v-for="match in pendingMatches" :key="match.match_id" class="match-card">
              <div class="match-header">
                <el-avatar :src="match.requester.avatar_url" :size="60">
                  {{ match.requester.name.charAt(0) }}
                </el-avatar>
                <div class="match-info">
                  <h3>{{ match.requester.name }}</h3>
                  <div class="match-meta">
                    <span>
                      <el-icon><Calendar /></el-icon>
                      {{ formatDate(match.match_date) }}
                    </span>
                    <span v-if="match.requester.average_rating">
                      <el-icon><Star /></el-icon>
                      {{ match.requester.average_rating.toFixed(1) }} ({{ match.requester.rating_count }})
                    </span>
                  </div>
                </div>
              </div>
              
              <div v-if="match.message" class="match-message">
                <p>{{ match.message }}</p>
              </div>
              
              <div v-if="match.activity" class="match-activity">
                <el-tag type="info" size="small">
                  相關活動：{{ match.activity.title }}
                </el-tag>
              </div>
              
              <div class="match-actions">
                <el-button type="success" @click="handleAccept(match)">
                  接受
                </el-button>
                <el-button type="danger" @click="handleReject(match)">
                  拒絕
                </el-button>
              </div>
            </div>
          </div>
        </el-tab-pane>
        
        <!-- 已發送分頁 -->
        <el-tab-pane label="已發送" name="sent">
          <div v-if="loading.sent" class="matches-list">
            <el-skeleton v-for="i in 3" :key="i" animated>
              <template #template>
                <el-skeleton-item variant="rect" style="height: 150px; margin-bottom: 16px" />
              </template>
            </el-skeleton>
          </div>
          
          <el-empty v-else-if="sentMatches.length === 0" description="還沒有發送過申請" />
          
          <div v-else class="matches-list">
            <div v-for="match in sentMatches" :key="match.match_id" class="match-card">
              <div class="match-header">
                <el-avatar :src="match.responder.avatar_url" :size="60">
                  {{ match.responder.name.charAt(0) }}
                </el-avatar>
                <div class="match-info">
                  <h3>{{ match.responder.name }}</h3>
                  <div class="match-meta">
                    <span>
                      <el-icon><Calendar /></el-icon>
                      {{ formatDate(match.match_date) }}
                    </span>
                    <el-tag :type="getStatusTagType(match.status)" size="small">
                      {{ getStatusText(match.status) }}
                    </el-tag>
                  </div>
                </div>
              </div>
              
              <div v-if="match.message" class="match-message">
                <p>{{ match.message }}</p>
              </div>
              
              <div class="match-actions">
                <el-button 
                  v-if="match.status === 'pending'" 
                  type="warning" 
                  @click="handleCancel(match)"
                >
                  取消申請
                </el-button>
                <el-button 
                  v-else-if="match.status === 'accepted'" 
                  type="primary" 
                  @click="router.push(/users/)"
                >
                  查看資料
                </el-button>
              </div>
            </div>
          </div>
        </el-tab-pane>
        
        <!-- 已媒合分頁 -->
        <el-tab-pane label="已媒合" name="accepted">
          <div v-if="loading.accepted" class="matches-list">
            <el-skeleton v-for="i in 3" :key="i" animated>
              <template #template>
                <el-skeleton-item variant="rect" style="height: 150px; margin-bottom: 16px" />
              </template>
            </el-skeleton>
          </div>
          
          <el-empty v-else-if="acceptedMatches.length === 0" description="還沒有媒合成功的旅伴" />
          
          <div v-else class="matches-list">
            <div v-for="match in acceptedMatches" :key="match.match_id" class="match-card">
              <div class="match-header">
                <el-avatar :src="match.matched_user.avatar_url" :size="60">
                  {{ match.matched_user.name.charAt(0) }}
                </el-avatar>
                <div class="match-info">
                  <h3>{{ match.matched_user.name }}</h3>
                  <div class="match-meta">
                    <span>
                      <el-icon><SuccessFilled /></el-icon>
                      媒合於 {{ formatDate(match.confirmed_date) }}
                    </span>
                    <span v-if="match.matched_user.average_rating">
                      <el-icon><Star /></el-icon>
                      {{ match.matched_user.average_rating.toFixed(1) }}
                    </span>
                  </div>
                </div>
              </div>
              
              <div class="match-actions">
                <el-button 
                  type="primary" 
                  @click="router.push(/users/)"
                >
                  查看資料
                </el-button>
                <el-button 
                  type="success" 
                  @click="handleSendMessage(match)"
                >
                  發送訊息
                </el-button>
              </div>
            </div>
          </div>
        </el-tab-pane>
      </el-tabs>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'
import { 
  Calendar, Star, SuccessFilled 
} from '@element-plus/icons-vue'
import dayjs from 'dayjs'
import {
  getPendingMatches,
  getSentMatches,
  getAcceptedMatches,
  acceptMatch,
  rejectMatch,
  cancelMatch
} from '@/api/matches'

const router = useRouter()
const activeTab = ref('pending')
const loading = reactive({
  pending: false,
  sent: false,
  accepted: false
})

const pendingMatches = ref([])
const sentMatches = ref([])
const acceptedMatches = ref([])

// Methods
const fetchPendingMatches = async () => {
  try {
    loading.pending = true
    const res = await getPendingMatches()
    pendingMatches.value = res.data.matches
  } catch (err) {
    console.error('載入待處理申請失敗:', err)
    ElMessage.error('載入待處理申請失敗')
  } finally {
    loading.pending = false
  }
}

const fetchSentMatches = async () => {
  try {
    loading.sent = true
    const res = await getSentMatches()
    sentMatches.value = res.data.matches
  } catch (err) {
    console.error('載入已發送申請失敗:', err)
    ElMessage.error('載入已發送申請失敗')
  } finally {
    loading.sent = false
  }
}

const fetchAcceptedMatches = async () => {
  try {
    loading.accepted = true
    const res = await getAcceptedMatches()
    acceptedMatches.value = res.data.matches
  } catch (err) {
    console.error('載入已媒合列表失敗:', err)
    ElMessage.error('載入已媒合列表失敗')
  } finally {
    loading.accepted = false
  }
}

const handleTabChange = (tabName) => {
  if (tabName === 'pending' && pendingMatches.value.length === 0) {
    fetchPendingMatches()
  } else if (tabName === 'sent' && sentMatches.value.length === 0) {
    fetchSentMatches()
  } else if (tabName === 'accepted' && acceptedMatches.value.length === 0) {
    fetchAcceptedMatches()
  }
}

const handleAccept = async (match) => {
  try {
    await ElMessageBox.confirm(
      確定要接受來自  的媒合申請嗎？,
      '確認接受',
      {
        confirmButtonText: '接受',
        cancelButtonText: '取消',
        type: 'success'
      }
    )
    
    await acceptMatch(match.match_id)
    ElMessage.success('已接受媒合申請')
    fetchPendingMatches()
    // 重新載入已媒合列表
    acceptedMatches.value = []
  } catch (err) {
    if (err !== 'cancel') {
      console.error('接受申請失敗:', err)
      ElMessage.error(err.response?.data?.error || '接受申請失敗')
    }
  }
}

const handleReject = async (match) => {
  try {
    const { value: reason } = await ElMessageBox.prompt(
      確定要拒絕來自  的申請嗎？,
      '拒絕申請',
      {
        confirmButtonText: '拒絕',
        cancelButtonText: '取消',
        inputPlaceholder: '可選填拒絕原因',
        inputType: 'textarea',
        inputValidator: (value) => {
          if (value && value.length > 500) {
            return '拒絕原因最多 500 字'
          }
          return true
        }
      }
    )
    
    await rejectMatch(match.match_id, reason)
    ElMessage.success('已拒絕該申請')
    fetchPendingMatches()
  } catch (err) {
    if (err !== 'cancel') {
      console.error('拒絕申請失敗:', err)
      ElMessage.error(err.response?.data?.error || '拒絕申請失敗')
    }
  }
}

const handleCancel = async (match) => {
  try {
    await ElMessageBox.confirm(
      確定要取消發送給  的申請嗎？,
      '確認取消',
      {
        confirmButtonText: '取消申請',
        cancelButtonText: '返回',
        type: 'warning'
      }
    )
    
    await cancelMatch(match.match_id)
    ElMessage.success('已取消媒合申請')
    fetchSentMatches()
  } catch (err) {
    if (err !== 'cancel') {
      console.error('取消申請失敗:', err)
      ElMessage.error(err.response?.data?.error || '取消申請失敗')
    }
  }
}

const handleSendMessage = (match) => {
  // 跳轉到聊天室（如已實作）
  router.push(/chat/)
}

const formatDate = (dateStr) => {
  return dayjs(dateStr).format('YYYY-MM-DD HH:mm')
}

const getStatusText = (status) => {
  const statusMap = {
    'pending': '等待回應',
    'accepted': '已接受',
    'rejected': '已拒絕',
    'cancelled': '已取消'
  }
  return statusMap[status] || status
}

const getStatusTagType = (status) => {
  const typeMap = {
    'pending': 'warning',
    'accepted': 'success',
    'rejected': 'danger',
    'cancelled': 'info'
  }
  return typeMap[status] || 'info'
}

// Lifecycle
onMounted(() => {
  fetchPendingMatches()
})
</script>

<style lang="scss" scoped>
.matches-page {
  min-height: 100vh;
  background: var(--el-bg-color-page);
  padding: var(--spacing-xl);
}

.matches-container {
  max-width: 1000px;
  margin: 0 auto;
  
  h1 {
    font-size: var(--font-size-h1);
    font-weight: var(--font-weight-bold);
    color: var(--el-text-color-primary);
    margin-bottom: var(--spacing-xl);
  }
}

.matches-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.match-card {
  padding: var(--spacing-lg);
  background: var(--el-bg-color);
  border-radius: var(--border-radius-md);
  box-shadow: var(--el-box-shadow-light);
  
  .match-header {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    
    .match-info {
      flex: 1;
      
      h3 {
        font-size: var(--font-size-h4);
        font-weight: var(--font-weight-medium);
        color: var(--el-text-color-primary);
        margin: 0 0 var(--spacing-xs) 0;
      }
      
      .match-meta {
        display: flex;
        gap: var(--spacing-md);
        font-size: var(--font-size-small);
        color: var(--el-text-color-secondary);
        
        span {
          display: flex;
          align-items: center;
          gap: var(--spacing-xs);
        }
      }
    }
  }
  
  .match-message {
    padding: var(--spacing-md);
    background: var(--el-bg-color-page);
    border-radius: var(--border-radius-sm);
    margin-bottom: var(--spacing-md);
    
    p {
      margin: 0;
      font-size: var(--font-size-base);
      color: var(--el-text-color-regular);
      line-height: 1.6;
    }
  }
  
  .match-activity {
    margin-bottom: var(--spacing-md);
  }
  
  .match-actions {
    display: flex;
    gap: var(--spacing-sm);
    justify-content: flex-end;
  }
}

@media (max-width: 768px) {
  .matches-page {
    padding: var(--spacing-md);
  }
  
  .match-card {
    .match-header {
      flex-direction: column;
      align-items: center;
      text-align: center;
      
      .match-info .match-meta {
        flex-direction: column;
        gap: var(--spacing-xs);
      }
    }
    
    .match-actions {
      flex-direction: column;
      
      .el-button {
        width: 100%;
      }
    }
  }
}
</style>
`

### File Locations

Based on [Source: architecture/unified-project-structure.md]:

**Frontend**:
- 媒合管理頁面: rontend/src/views/Matches.vue (新建)
- Matches API 服務: rontend/src/api/matches.js (新建或擴展)
- 個人資料頁面: rontend/src/views/Profile.vue 或 ProfileDetail.vue (擴展 - 添加媒合按鈕)
- 路由配置: rontend/src/router/index.js (擴展 - 添加 /matches 路由)
- 前端測試: rontend/tests/unit/views/Matches.spec.js (新建)

**Backend**:
- 媒合端點: ackend/blueprints/matches.py (驗證並可能擴展)
- Match Model: ackend/models/match.py (已存在)
- User Model: ackend/models/user.py (已存在)
- Activity Model: ackend/models/activity.py (已存在)
- 後端測試: ackend/tests/test_matches.py (擴展)


### Testing Requirements

Based on [Source: architecture/testing-strategy.md]:

**Unit Testing (Vitest)**:
- **Location**: rontend/tests/unit/views/Matches.spec.js
- **Framework**: Vitest + @vue/test-utils + Element Plus
- **Coverage Target**: 80%+
- **Test Cases**:
  1. 頁面正確渲染（三個分頁顯示）
  2. 分頁切換功能正常
  3. 待處理列表顯示正確資料
  4. 已發送列表顯示正確資料
  5. 已媒合列表顯示正確資料
  6. 接受按鈕點擊顯示確認對話框
  7. 拒絕按鈕點擊顯示輸入對話框
  8. 取消按鈕點擊顯示確認對話框
  9. 空狀態正確顯示
  10. 載入狀態（Skeleton）正確顯示
  11. API 調用（Mock getPendingMatches, getSentMatches, getAcceptedMatches）
  12. 日期格式化正確
  13. 狀態標籤顏色正確

**Backend Testing (pytest)**:
- **Location**: ackend/tests/test_matches.py
- **Framework**: pytest + pytest-flask
- **Test Cases**:
  - **發送媒合申請測試**:
    1. 成功發送媒合申請
    2. 重複發送給同一使用者（應失敗）
    3. 對自己發送申請（應失敗）
    4. responder_id 不存在（應返回 404）
    5. 申請訊息過長（應返回 400）
    6. 未認證請求（應返回 401）
  - **獲取待處理申請測試**:
    1. 成功獲取待處理申請列表
    2. 只返回當前使用者收到的申請（user_b）
    3. 只返回 pending 狀態的申請
    4. 按 match_date 降序排序
    5. 包含申請者資料和活動資訊
  - **獲取已發送申請測試**:
    1. 成功獲取已發送申請列表
    2. 只返回當前使用者發送的申請（user_a）
    3. 包含所有狀態的申請
    4. 按 match_date 降序排序
  - **獲取已媒合列表測試**:
    1. 成功獲取已媒合列表
    2. 只返回 accepted 狀態
    3. 返回雙方都參與的媒合
  - **接受媒合申請測試**:
    1. 成功接受申請
    2. 狀態更新為 accepted
    3. confirmed_date 已設定
    4. 只有 user_b 可以接受（權限檢查）
    5. 只能接受 pending 狀態的申請
  - **拒絕媒合申請測試**:
    1. 成功拒絕申請
    2. 狀態更新為 rejected
    3. rejection_reason 已儲存
    4. 只有 user_b 可以拒絕
  - **取消媒合申請測試**:
    1. 成功取消申請
    2. 狀態更新為 cancelled
    3. 只有 user_a 可以取消
    4. 只能取消 pending 狀態的申請

**Running Tests**:
`ash
# Frontend
npm run test:unit

# Backend
pytest backend/tests/test_matches.py -v

# 帶覆蓋率報告
pytest backend/tests/test_matches.py --cov=backend/blueprints/matches --cov-report=html
`

### Technical Constraints

[Source: architecture/tech-stack.md + PRD NFR]

1. **Framework Versions**:
   - Vue.js 3.3.8+
   - Element Plus 2.4.2+
   - Pinia 2.1.7+
   - Day.js 1.11.10+ (日期格式化)
   - Flask 2.3.0+
   - SQLAlchemy 2.0.0+

2. **Performance Requirements** [NFR1]:
   - API 回應時間 < 500ms
   - 使用 lazy loading 延遲載入分頁資料（切換時才載入）
   - 使用 Skeleton 提供即時視覺反饋

3. **UI/UX Requirements**:
   - 響應式設計：桌面  平板  手機
   - 載入狀態使用 Element Plus Skeleton
   - 空狀態使用 Element Plus Empty
   - 確認對話框使用 Element Plus MessageBox
   - 訊息提示使用 Element Plus Message

4. **Browser Support** [NFR3]:
   - Chrome 90+, Firefox 88+, Safari 14+, Edge 90+

5. **Authentication**:
   - 所有 API 需 JWT 認證
   - 路由需使用 
equiresAuth meta
   - 權限檢查：只能管理與自己相關的媒合申請

6. **Security**:
   - 防止 CSRF 攻擊（使用 JWT）
   - 防止 SQL Injection（使用 SQLAlchemy ORM）
   - 輸入驗證：訊息長度、responder_id 有效性
   - 權限檢查：user_a 只能取消，user_b 只能接受/拒絕

### Project Structure Notes

[Source: architecture/unified-project-structure.md]

**新增目錄/檔案**:
-  rontend/src/views/Matches.vue - 媒合管理頁面（新建）
-  rontend/src/api/matches.js - 媒合 API 服務（新建或擴展）
-  rontend/tests/unit/views/Matches.spec.js - 單元測試（新建）

**修改檔案**:
-  rontend/src/views/Profile.vue 或 ProfileDetail.vue - 添加媒合按鈕
-  rontend/src/router/index.js - 添加 /matches 路由
-  ackend/blueprints/matches.py - 可能需補充 accept/reject/cancel 端點
-  ackend/tests/test_matches.py - 擴展測試覆蓋

**無結構衝突**：所有新增檔案符合現有專案結構。

### Additional Notes

**API 整合重點**:
- 後端 Match Model 已完整實作，包含所有必要欄位和方法
- 可能需要補充 accept/reject/cancel 端點（Task 2-3 驗證）
- 使用 lazy loading 策略：只在切換分頁時載入該分頁資料
- 操作成功後需重新載入相關分頁資料

**UI/UX 最佳實踐**:
1. **確認對話框**:
   - 接受：顯示對方名稱，使用 success 類型
   - 拒絕：提供可選的原因輸入框，textarea 類型
   - 取消：顯示對方名稱，使用 warning 類型

2. **空狀態**:
   - 提供明確的訊息說明當前狀態
   - 待處理：「還沒有待處理的申請」
   - 已發送：「還沒有發送過申請」
   - 已媒合：「還沒有媒合成功的旅伴」

3. **載入狀態**:
   - 使用 Skeleton 組件模擬實際內容佈局
   - 每個分頁獨立的 loading 狀態
   - 避免阻塞整個頁面

4. **錯誤處理**:
   - 捕獲 API 錯誤並顯示友善訊息
   - 區分不同類型的錯誤（權限、狀態不正確、網路錯誤）
   - 使用 ElMessage 顯示錯誤提示

**媒合狀態流轉**:
`
pending (發送申請)
   
    accepted (user_b 接受)  開啟聊天室
    rejected (user_b 拒絕)
    cancelled (user_a 取消)
`

**個人資料頁面整合注意事項**:
1. **按鈕顯示邏輯**:
   - 需查詢當前使用者與該使用者的媒合狀態
   - 可能需要新增 API: GET /api/matches/status?user_id={userId}
   - 根據狀態顯示不同按鈕文字和狀態

2. **發送申請流程**:
   - 點擊按鈕  彈出對話框
   - 對話框包含：訊息輸入框（可選，最多 500 字）
   - 確認後調用 POST /api/matches
   - 成功後更新按鈕狀態

**未來可能的增強**:
1. **即時通知**:
   - 使用 Socket.IO 實時通知新的媒合申請
   - 在導航欄顯示待處理申請數量（紅點提示）

2. **媒合推薦**:
   - 根據興趣、活動偏好推薦潛在旅伴
   - 在儀表板顯示「推薦旅伴」區塊

3. **媒合統計**:
   - 顯示媒合成功率
   - 顯示最活躍的媒合時間段

4. **進階篩選**:
   - 按活動類型篩選媒合
   - 按時間範圍篩選
   - 搜尋特定使用者

**參考資源**:
- Element Plus Tabs: https://element-plus.org/en-US/component/tabs.html
- Element Plus MessageBox: https://element-plus.org/en-US/component/message-box.html
- Element Plus Message: https://element-plus.org/en-US/component/message.html
- Element Plus Skeleton: https://element-plus.org/en-US/component/skeleton.html
- Element Plus Empty: https://element-plus.org/en-US/component/empty.html
- Day.js: https://day.js.org/

## Testing

### Frontend Testing
`ash
# 執行單元測試
npm run test:unit

# 執行帶覆蓋率的測試
npm run test:coverage

# UI 測試模式
npm run test:ui
`

### Backend Testing
`ash
# 執行媒合 API 測試
pytest backend/tests/test_matches.py -v

# 執行特定測試
pytest backend/tests/test_matches.py::test_send_match_request -v

# 帶覆蓋率報告
pytest backend/tests/test_matches.py --cov=backend/blueprints/matches --cov-report=html
`

### Manual Testing Checklist

- [ ] 完整媒合申請發送流程
- [ ] 待處理申請審核（接受/拒絕）
- [ ] 已發送申請查看與取消
- [ ] 已媒合列表查看與操作
- [ ] 個人資料頁面媒合按鈕顯示邏輯
- [ ] 空狀態顯示（三個分頁）
- [ ] 載入狀態（Skeleton）
- [ ] 確認對話框功能
- [ ] 錯誤處理與訊息提示
- [ ] 防重複發送驗證
- [ ] 權限檢查（只能管理自己的申請）
- [ ] 響應式設計（桌面/平板/手機）
- [ ] API 回應時間 < 500ms
- [ ] 分頁切換流暢度

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-25 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*此區塊由開發代理在實作時填寫*

### Agent Model Used

(待開發代理填寫)

### Debug Log References

(待開發代理填寫)

### Completion Notes List

(待開發代理填寫)

### File List

(待開發代理填寫)

## QA Results

*此區塊由 QA 代理審查後更新審查結果*

