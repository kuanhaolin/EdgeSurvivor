# Story 3.2: 瀏覽活動列表

## Status

Draft

## Story

**As a** 用戶,
**I want** 瀏覽所有活動的列表,
**so that** 我可以發現感興趣的活動並選擇參加。

## Acceptance Criteria

### 活動列表頁面設計

1. 提供活動列表頁面入口：
   - 在導航欄顯示「探索活動」或「活動」連結
   - 點擊後跳轉到 `/activities` 路由

2. 活動列表頁面應包含以下元素：
   - 頁面標題：「探索活動」
   - 活動卡片網格展示
   - 分頁控制器（如果活動數量超過每頁限制）
   - 空狀態提示（當沒有活動時）

### 活動卡片設計

3. 每個活動卡片應顯示以下資訊：
   - 封面圖片（如有，否則顯示預設圖片）
   - 活動標題
   - 活動類型標籤（使用對應顏色）
   - 活動狀態標籤（recruiting/ongoing/completed/cancelled）
   - 活動日期（格式：YYYY-MM-DD）
   - 活動地點
   - 當前參與人數 / 最大人數（例如：「3 / 10 人」）
   - 創建者頭像和名稱
   - 活動描述預覽（截斷至 100 字，顯示「...」）

4. 活動卡片應具備互動效果：
   - Hover 時卡片上浮並顯示陰影
   - 點擊卡片跳轉到活動詳情頁（`/activities/{activity_id}`）
   - 卡片應具備 cursor: pointer 樣式

### 響應式設計

5. 活動卡片網格應根據螢幕寬度調整：
   - 桌面（> 1024px）：每行 3-4 個卡片
   - 平板（768px - 1024px）：每行 2 個卡片
   - 手機（< 768px）：每行 1 個卡片

6. 卡片內容應在小螢幕上保持可讀性

### 活動列表載入

7. 頁面載入時自動獲取活動列表

8. 顯示載入狀態：
   - 初次載入：顯示骨架屏或載入動畫
   - 分頁載入：顯示載入指示器

9. 載入失敗時：
   - 顯示錯誤訊息：「無法載入活動列表，請稍後再試」
   - 提供「重新載入」按鈕

### 空狀態處理

10. 當沒有活動時，顯示空狀態：
    - 圖示或插圖
    - 提示文字：「目前沒有活動，成為第一個建立活動的人！」
    - 「建立活動」按鈕（跳轉到 `/activities/create`）

### 分頁功能

11. 每頁顯示 12 個活動（可配置）

12. 使用 Element Plus 的 `el-pagination` 組件

13. 分頁器應顯示：
    - 當前頁碼
    - 總頁數
    - 上一頁/下一頁按鈕
    - 快速跳頁功能

14. 切換頁碼時：
    - 發送 API 請求獲取對應頁的活動
    - 捲動到頁面頂部
    - 更新 URL 查詢參數（`?page=2`）

### 後端 API

15. API 端點：`GET /api/activities`

16. 支援查詢參數：
    - `page`：頁碼（預設 1）
    - `per_page`：每頁數量（預設 12，最大 50）
    - `type`：活動類型篩選（可選，值：`created`、`joined`、`all`）

17. 成功回應（200 OK）：
    ```json
    {
      "activities": [
        {
          "activity_id": 1,
          "title": "陽明山登山之旅",
          "category": "adventure",
          "status": "recruiting",
          "start_date": "2025-11-10",
          "end_date": "2025-11-10",
          "location": "陽明山國家公園",
          "description": "一起去陽明山...",
          "max_participants": 10,
          "current_participants": 3,
          "cost": 500.00,
          "cover_image": "/uploads/activities/cover1.jpg",
          "creator": {
            "user_id": 1,
            "name": "John Doe",
            "profile_picture": "/uploads/avatars/user1.jpg"
          },
          "created_at": "2025-11-05T10:00:00Z"
        }
      ],
      "pagination": {
        "page": 1,
        "per_page": 12,
        "total": 45,
        "pages": 4
      }
    }
    ```

18. 如果沒有活動，返回空陣列：
    ```json
    {
      "activities": [],
      "pagination": {
        "page": 1,
        "per_page": 12,
        "total": 0,
        "pages": 0
      }
    }
    ```

### 後端驗證

19. API 應驗證 JWT 認證（使用者必須登入）

20. 驗證分頁參數：
    - `page` >= 1
    - `per_page` 在 1-50 之間

21. 活動列表應包含創建者資訊（使用 `to_dict(include_creator_info=True)`）

22. 活動列表應計算並回傳當前參與人數

### 效能要求

23. API 回應時間需低於 500ms（包含 50 個活動）

24. 前端應使用圖片懶載入（lazy loading）優化效能

25. 使用 Vue 的 `v-for` 時提供 `:key` 綁定以優化渲染

### 使用者體驗

26. 活動卡片應有視覺層次（標題、圖片、資訊）

27. 活動狀態和類型標籤應使用不同顏色區分

28. 日期顯示應友善（例如：「今天」、「明天」、「11/10」）

29. 人數顯示應有視覺提示（接近滿員時使用警告色）

30. 整體設計應簡潔、易於瀏覽

## Tasks / Subtasks

> **Brownfield 專案說明**：後端 API 端點 `GET /api/activities` 已存在，支援基本的活動列表查詢。需要確認分頁功能和創建者資訊是否完整支援。前端需要建立活動列表頁面和活動卡片組件。

### Phase 1: 後端檢查與調整

- [ ] **Task 1: 檢查活動列表 API** (AC: 15-22)
  - [ ] 檢查 `backend/blueprints/activities.py` 中的 `GET /activities` 端點
  - [ ] 確認支援分頁參數（`page`、`per_page`）
  - [ ] 確認回傳格式包含 `pagination` 物件
  - [ ] 確認 `to_dict(include_creator_info=True)` 包含創建者資訊
  - [ ] 確認 `current_participants` 計算正確
  - [ ] 如有缺少，新增分頁邏輯
  - [ ] 測試 API 端點
  - [ ] 記錄 API 規格

### Phase 2: 前端組件開發

- [ ] **Task 2: 建立 ActivityCard 組件** (AC: 3, 4, 26-29)
  - [ ] 在 `frontend/src/components/activity/` 建立 `ActivityCard.vue`
  - [ ] 使用 Vue 3 Composition API 和 `<script setup>` 語法
  - [ ] 實作卡片佈局（封面圖、標題、標籤、日期、地點、人數、創建者、描述）
  - [ ] 實作活動類型標籤（使用 Element Plus 的 `el-tag`）
  - [ ] 實作活動狀態標籤（使用不同顏色）
  - [ ] 實作描述截斷邏輯（最多 100 字）
  - [ ] 實作 Hover 效果（上浮、陰影）
  - [ ] 實作點擊跳轉邏輯（emit 'view-detail' 事件）
  - [ ] 使用 Day.js 格式化日期顯示
  - [ ] 實作人數顯示邏輯（接近滿員時警告色）
  - [ ] 測試組件渲染
  - [ ] 記錄組件規格

- [ ] **Task 3: 建立 Activities 列表頁面** (AC: 1, 2, 5, 10)
  - [ ] 在 `frontend/src/views/` 建立 `Activities.vue`
  - [ ] 使用 Vue 3 Composition API 和 `<script setup>` 語法
  - [ ] 設計頁面佈局（標題、網格容器、分頁器）
  - [ ] 實作響應式網格佈局（使用 `el-row` 和 `el-col`）
  - [ ] 導入並使用 `ActivityCard` 組件
  - [ ] 實作空狀態UI（圖示、提示文字、建立活動按鈕）
  - [ ] 測試頁面渲染

- [ ] **Task 4: 實作活動列表載入邏輯** (AC: 7, 8, 9)
  - [ ] 建立響應式數據：`activities`、`loading`、`error`、`pagination`
  - [ ] 實作 `fetchActivities` 函數
  - [ ] 在 `onMounted` 生命週期鉤子中呼叫 `fetchActivities`
  - [ ] 實作載入狀態顯示（使用 `el-skeleton` 或自定義骨架屏）
  - [ ] 實作錯誤處理和錯誤訊息顯示
  - [ ] 實作「重新載入」按鈕
  - [ ] 測試載入流程

- [ ] **Task 5: 實作分頁功能** (AC: 11-14)
  - [ ] 整合 Element Plus 的 `el-pagination` 組件
  - [ ] 綁定分頁器屬性（`current-page`、`page-size`、`total`）
  - [ ] 實作頁碼變更處理函數 `handlePageChange`
  - [ ] 切換頁碼時獲取新數據
  - [ ] 切換頁碼時捲動到頁面頂部
  - [ ] 更新 URL 查詢參數（使用 Vue Router）
  - [ ] 實作從 URL 讀取頁碼（頁面初始化時）
  - [ ] 測試分頁功能

### Phase 3: 前端 API 服務層

- [ ] **Task 6: 更新 activities API 服務** (AC: 15)
  - [ ] 檢查 `frontend/src/api/activities.js` 中的 `getActivities` 函數
  - [ ] 確認函數支援分頁參數：`getActivities(params = {})`
  - [ ] 確認請求方法為 `GET /api/activities`
  - [ ] 確認查詢參數正確傳遞（`page`、`per_page`、`type`）
  - [ ] 測試 API 函數

### Phase 4: 路由配置

- [ ] **Task 7: 添加活動列表路由** (AC: 1)
  - [ ] 在 `frontend/src/router/index.js` 添加路由定義
  - [ ] 路徑：`/activities`
  - [ ] 組件：`Activities.vue`
  - [ ] 設定路由守衛：需要登入才能訪問
  - [ ] 設定頁面標題 meta 資訊
  - [ ] 測試路由跳轉

- [ ] **Task 8: 添加導航欄連結** (AC: 1)
  - [ ] 在導航欄（NavBar.vue）添加「探索活動」連結
  - [ ] 連結指向 `/activities`
  - [ ] 測試連結跳轉

### Phase 5: 樣式與優化

- [ ] **Task 9: 實作響應式設計** (AC: 5, 6)
  - [ ] 實作桌面網格佈局（3-4 欄）
  - [ ] 實作平板網格佈局（2 欄）
  - [ ] 實作手機網格佈局（1 欄）
  - [ ] 使用 Element Plus 的響應式工具或 CSS Media Queries
  - [ ] 測試不同螢幕尺寸下的顯示

- [ ] **Task 10: 實作圖片懶載入** (AC: 24)
  - [ ] 在 `ActivityCard` 組件中使用 `loading="lazy"` 屬性
  - [ ] 或整合第三方懶載入指令（如 `v-lazy`）
  - [ ] 測試圖片載入效能

### Phase 6: 測試

- [ ] **Task 11: 前端單元測試** (AC: 所有)
  - [ ] 測試 `ActivityCard.vue` 組件渲染
  - [ ] 測試活動資訊顯示正確
  - [ ] 測試描述截斷邏輯
  - [ ] 測試點擊事件
  - [ ] 測試 `Activities.vue` 頁面渲染
  - [ ] 測試活動列表載入（Mock API）
  - [ ] 測試分頁邏輯
  - [ ] 測試空狀態顯示
  - [ ] 執行測試：`npm run test:unit`
  - [ ] 確認覆蓋率 > 80%

- [ ] **Task 12: 後端測試** (AC: 19-22)
  - [ ] 測試活動列表 API（成功案例）
  - [ ] 測試分頁參數驗證
  - [ ] 測試 JWT 認證
  - [ ] 測試空列表回應
  - [ ] 測試創建者資訊包含
  - [ ] 執行測試：`pytest backend/tests/test_activities.py -v`

### Phase 7: 整合測試與驗收

- [ ] **Task 13: 端到端功能驗證** (所有 AC)
  - [ ] 手動測試瀏覽活動列表完整流程
  - [ ] 測試活動卡片顯示正確
  - [ ] 測試點擊卡片跳轉到詳情頁
  - [ ] 測試分頁功能
  - [ ] 測試空狀態顯示
  - [ ] 測試載入和錯誤狀態
  - [ ] 測試響應式設計（不同螢幕尺寸）
  - [ ] 驗證所有 AC 滿足

## Dev Notes

### Previous Story Insights

**來自 Story 1.1 - 3.1 的經驗**：
- Vue 3 Composition API 是標準開發模式 [Source: architecture/4-組件標準-component-standards.md]
- Element Plus 組件庫已整合，使用 `el-tag`、`el-card`、`el-pagination`、`el-skeleton` 等組件 [Source: architecture/2-前端技術棧-frontend-tech-stack.md]
- Pinia Store 可用於管理活動狀態（如需要）[Source: architecture/5-狀態管理-state-management.md]
- JWT 認證機制完善，使用 `@jwt_required()` 裝飾器 [Source: architecture/6-api-整合-api-integration.md]
- Axios 攔截器已配置，自動添加 JWT Token [Source: architecture/6-api-整合-api-integration.md]
- Day.js 用於日期時間格式化 [Source: architecture/2-前端技術棧-frontend-tech-stack.md]
- 響應式設計使用 Element Plus 的 `el-row` 和 `el-col` [Source: architecture/3-專案結構-project-structure.md]
- ActivityCard 組件模板已在架構文件中提供 [Source: architecture/4-組件標準-component-standards.md]

### Data Models

**Activity Model - 列表顯示欄位**

[Source: backend/models/activity.py]

```python
def to_dict(self, include_creator_info=False):
    """轉換為字典格式"""
    data = {
        'activity_id': self.activity_id,
        'title': self.title,
        'category': self.category,
        'status': self.status,
        'start_date': self.start_date.isoformat() if self.start_date else None,
        'end_date': self.end_date.isoformat() if self.end_date else None,
        'location': self.location,
        'description': self.description,
        'max_participants': self.max_participants,
        'current_participants': self.get_participant_count(),
        'cost': float(self.cost) if self.cost else 0.0,
        'cover_image': self.cover_image,
        'created_at': self.created_at.isoformat() if self.created_at else None
    }
    
    if include_creator_info and self.creator:
        data['creator'] = {
            'user_id': self.creator.user_id,
            'name': self.creator.name,
            'profile_picture': self.creator.profile_picture
        }
    
    return data
```

### API Specifications

#### 獲取活動列表

**Endpoint**: `GET /api/activities`

**Authentication**: Required (JWT Token)

**Query Parameters**:
- `page`: 頁碼（預設 1）
- `per_page`: 每頁數量（預設 12，最大 50）
- `type`: 活動類型（可選，值：`created`、`joined`、`all`）

**Response (Success - 200)**:
```json
{
  "activities": [
    {
      "activity_id": 1,
      "title": "陽明山登山之旅",
      "category": "adventure",
      "status": "recruiting",
      "start_date": "2025-11-10",
      "end_date": "2025-11-10",
      "location": "陽明山國家公園",
      "description": "一起去陽明山呼吸新鮮空氣，享受大自然的美好...",
      "max_participants": 10,
      "current_participants": 3,
      "cost": 500.00,
      "cover_image": "/uploads/activities/cover1.jpg",
      "creator": {
        "user_id": 1,
        "name": "John Doe",
        "profile_picture": "/uploads/avatars/user1.jpg"
      },
      "created_at": "2025-11-05T10:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "per_page": 12,
    "total": 45,
    "pages": 4
  }
}
```

**Response (Empty - 200)**:
```json
{
  "activities": [],
  "pagination": {
    "page": 1,
    "per_page": 12,
    "total": 0,
    "pages": 0
  }
}
```

**Response (Error - 401)**:
```json
{
  "error": "未授權，請先登入"
}
```

### File Locations

**Backend** (已存在，需檢查):
- API: `backend/blueprints/activities.py` (檢查 GET /activities 端點，確認分頁功能)
- Model: `backend/models/activity.py` (已存在)
- 測試: `backend/tests/test_activities.py` (新增測試)

**Frontend - New Files**:
- 活動列表頁面: `frontend/src/views/Activities.vue` (新建)
- 活動卡片組件: `frontend/src/components/activity/ActivityCard.vue` (新建)

**Frontend - Updated Files**:
- API 函數: `frontend/src/api/activities.js` (檢查 getActivities 函數)
- 路由: `frontend/src/router/index.js` (添加 /activities 路由)
- 導航欄: `frontend/src/components/layout/NavBar.vue` (添加連結)
- 測試: `frontend/tests/unit/views/Activities.spec.js` (新建)
- 測試: `frontend/tests/unit/components/activity/ActivityCard.spec.js` (新建)

### Component Structure

**ActivityCard 組件** [Source: architecture/4-組件標準-component-standards.md]:

架構文件已提供完整的 ActivityCard 組件範例，包含：
- Props 定義（activity, truncateLength）
- Computed 屬性（formattedDate, participantsText, statusTagType）
- Methods（handleViewDetail）
- 完整的樣式定義

開發者可以直接參考並使用該範例。

### Testing Requirements

**Unit Testing (Vitest)** [Source: architecture/11-測試策略-testing-requirements.md]:
- 測試 `ActivityCard.vue` 組件渲染
- 測試活動資訊顯示（標題、日期、地點、人數）
- 測試描述截斷邏輯
- 測試點擊事件（emit 'view-detail'）
- 測試狀態標籤顏色映射
- 測試 `Activities.vue` 頁面渲染
- 測試活動列表載入（Mock API）
- 測試分頁邏輯
- 測試空狀態顯示
- 覆蓋率目標：> 80%

**Backend Testing (pytest)**:
- 測試活動列表 API 成功案例
- 測試分頁參數驗證
- 測試 JWT 認證
- 測試空列表回應
- 測試創建者資訊正確包含

**測試執行命令**:
```bash
# 前端單元測試
npm run test:unit

# 前端測試覆蓋率
npm run test:coverage

# 後端測試
pytest backend/tests/test_activities.py -v -k get_activities

# E2E 測試（選填）
npm run test:e2e
```

### Technical Constraints

1. **分頁參數驗證**（page >= 1, per_page 在 1-50 之間）
2. **圖片懶載入**（優化初始載入效能）
3. **JWT Token 必須有效**（確保只有登入使用者可以瀏覽）
4. **響應式設計**（支援桌面、平板、手機）
5. **使用 `:key` 綁定**（Vue 的 v-for 優化渲染）

### UI/UX 考量

**活動類型標籤顏色映射**:
```javascript
const categoryColors = {
  'adventure': 'success',    // 綠色
  'culture': 'primary',      // 藍色
  'leisure': 'info',         // 灰色
  'food': 'warning',         // 橙色
  'sports': 'danger',        // 紅色
  'other': ''                // 預設
}
```

**活動狀態標籤顏色映射**:
```javascript
const statusColors = {
  'recruiting': 'success',   // 綠色
  'ongoing': 'primary',      // 藍色
  'completed': 'info',       // 灰色
  'cancelled': 'danger'      // 紅色
}
```

**日期格式化建議**:
```javascript
import dayjs from 'dayjs'
import relativeTime from 'dayjs/plugin/relativeTime'
import 'dayjs/locale/zh-tw'

dayjs.extend(relativeTime)
dayjs.locale('zh-tw')

const formattedDate = computed(() => {
  const date = dayjs(props.activity.start_date)
  const today = dayjs().startOf('day')
  const tomorrow = today.add(1, 'day')
  
  if (date.isSame(today, 'day')) return '今天'
  if (date.isSame(tomorrow, 'day')) return '明天'
  return date.format('MM/DD')
})
```

**人數顯示邏輯**:
```javascript
const participantsClass = computed(() => {
  const ratio = props.activity.current_participants / props.activity.max_participants
  if (ratio >= 0.9) return 'participants--full'
  if (ratio >= 0.7) return 'participants--near-full'
  return ''
})
```

**響應式網格佈局**:
```vue
<el-row :gutter="20">
  <el-col
    v-for="activity in activities"
    :key="activity.activity_id"
    :xs="24"
    :sm="12"
    :md="8"
    :lg="6"
  >
    <ActivityCard :activity="activity" @view-detail="handleViewDetail" />
  </el-col>
</el-row>
```

## Testing

### Frontend Testing
```bash
npm run test:unit
npm run test:coverage
```

### Backend Testing
```bash
pytest backend/tests/test_activities.py -v -k get_activities
```

### Manual Testing Checklist

- [ ] 訪問 `/activities` 頁面正常顯示
- [ ] 活動卡片正確渲染所有資訊
- [ ] 活動卡片 Hover 效果正常
- [ ] 點擊卡片跳轉到活動詳情頁
- [ ] 活動類型和狀態標籤顏色正確
- [ ] 日期格式化正確（今天、明天、日期）
- [ ] 人數顯示正確，接近滿員時有警告色
- [ ] 描述截斷至 100 字並顯示「...」
- [ ] 分頁器正常運作
- [ ] 切換頁碼時載入新數據
- [ ] 切換頁碼時捲動到頂部
- [ ] URL 查詢參數正確更新
- [ ] 空狀態正確顯示（無活動時）
- [ ] 載入狀態正確顯示（骨架屏或動畫）
- [ ] 錯誤狀態正確顯示（含重新載入按鈕）
- [ ] 響應式設計在不同螢幕正常（桌面3-4欄、平板2欄、手機1欄）
- [ ] 圖片懶載入正常運作
- [ ] 創建者頭像和名稱正確顯示

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*此區塊由開發代理在實作時填寫*

### Agent Model Used

(待開發代理填寫)

### Debug Log References

(待開發代理填寫)

### Completion Notes List

(待開發代理填寫)

### File List

(待開發代理填寫)

## QA Results

*此區塊由 QA 代理審查後更新審查結果*
