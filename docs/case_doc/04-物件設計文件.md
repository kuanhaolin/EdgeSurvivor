# EdgeSurvivor 物件設計文件 (ODD)

**Object Design Document**

**版本：** 1.0  
**日期：** 2025-11-03  
**狀態：** Active  
**作者：** Object Design Team

---

## 文件修訂歷史

| 版本 | 日期 | 修訂內容 | 作者 |
|------|------|----------|------|
| 1.0 | 2025-11-03 | 初始版本，基於 MVP 完成狀態 | Design Team |

---

## 目錄

1. [簡介](#1-簡介)
2. [類別圖 (Class Diagram)](#2-類別圖-class-diagram)
3. [後端物件設計](#3-後端物件設計)
4. [前端組件設計](#4-前端組件設計)
5. [序列圖 (Sequence Diagram)](#5-序列圖-sequence-diagram)
6. [狀態圖 (State Diagram)](#6-狀態圖-state-diagram)
7. [設計模式](#7-設計模式)
8. [附錄](#8-附錄)

---

## 1. 簡介

### 1.1 文件目的

本文件定義 **EdgeSurvivor** 的物件導向設計，包含類別圖、序列圖、狀態圖等 UML 圖表，以及後端模型與前端組件的詳細設計。

**目標讀者：**
- 後端開發工程師
- 前端開發工程師
- 系統架構師
- 新進團隊成員

### 1.2 設計原則

1. **單一職責原則 (SRP)**：每個類別只負責一項功能
2. **開放封閉原則 (OCP)**：對擴展開放，對修改封閉
3. **依賴反轉原則 (DIP)**：依賴於抽象而非實作
4. **高內聚低耦合**：模組間的依賴最小化

---

## 2. 類別圖 (Class Diagram)

### 2.1 核心領域模型類別圖

```
┌─────────────────────────────────────────────────────────────────┐
│                      Core Domain Models                           │
└─────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────┐
│                            User                                   │
├──────────────────────────────────────────────────────────────────┤
│ - user_id: int                                                    │
│ - name: str                                                       │
│ - email: str (unique)                                             │
│ - password_hash: str                                              │
│ - profile_picture: str                                            │
│ - bio: str                                                        │
│ - gender: str                                                     │
│ - age: int                                                        │
│ - interests: str (JSON)                                           │
│ - social_privacy: str                                             │
│ - instagram_url: str                                              │
│ - facebook_url: str                                               │
│ - line_id: str                                                    │
│ - twitter_url: str                                                │
│ - two_factor_enabled: bool                                        │
│ - two_factor_secret: str                                          │
│ - rating_count: int                                               │
│ - join_date: datetime                                             │
│ - is_verified: bool                                               │
│ - is_active: bool                                                 │
│ - last_seen: datetime                                             │
├──────────────────────────────────────────────────────────────────┤
│ + set_password(password: str): void                               │
│ + check_password(password: str): bool                             │
│ + to_dict(include_private: bool, is_friend: bool): dict          │
│ + update_last_seen(): void                                        │
└──────────┬───────────────────────────────────────────────────────┘
           │
           │ 1
           │ creates
           │
           │ *
┌──────────▼───────────────────────────────────────────────────────┐
│                          Activity                                 │
├──────────────────────────────────────────────────────────────────┤
│ - activity_id: int                                                │
│ - title: str                                                      │
│ - start_date: date                                                │
│ - end_date: date                                                  │
│ - location: str                                                   │
│ - description: str                                                │
│ - category: str                                                   │
│ - max_participants: int                                           │
│ - cost: decimal                                                   │
│ - status: str (active/completed/cancelled)                        │
│ - creator_id: int (FK)                                            │
│ - cover_image: str                                                │
│ - images: str (JSON)                                              │
│ - meeting_point: str                                              │
│ - duration_hours: int                                             │
│ - difficulty_level: str                                           │
│ - gender_preference: str                                          │
│ - age_min: int                                                    │
│ - age_max: int                                                    │
│ - notes: str                                                      │
│ - created_at: datetime                                            │
│ - updated_at: datetime                                            │
├──────────────────────────────────────────────────────────────────┤
│ + to_dict(include_creator_info: bool): dict                      │
│ + get_participant_count(): int                                    │
│ + get_participants(): list[ActivityParticipant]                  │
│ + get_pending_participants(): list[ActivityParticipant]          │
│ + is_user_participant(user_id: int): bool                        │
│ + is_full(): bool                                                 │
│ + can_user_join(user: User): tuple[bool, str]                    │
└──────────┬───────────────────────────────────────────────────────┘
           │
           │ 1
           │ has
           │
           │ *
┌──────────▼───────────────────────────────────────────────────────┐
│                    ActivityParticipant                            │
├──────────────────────────────────────────────────────────────────┤
│ - participant_id: int                                             │
│ - activity_id: int (FK)                                           │
│ - user_id: int (FK)                                               │
│ - status: str (pending/approved/joined/rejected/left/removed)     │
│ - role: str (creator/participant)                                 │
│ - joined_at: datetime                                             │
│ - approved_at: datetime                                           │
│ - left_at: datetime                                               │
│ - message: str                                                    │
│ - rejection_reason: str                                           │
├──────────────────────────────────────────────────────────────────┤
│ + to_dict(): dict                                                 │
│ + approve(): void                                                 │
│ + reject(reason: str): void                                       │
│ + leave(): void                                                   │
└───────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────┐
│                    ActivityDiscussion                             │
├───────────────────────────────────────────────────────────────────┤
│ - discussion_id: int                                              │
│ - activity_id: int (FK)                                           │
│ - user_id: int (FK)                                               │
│ - message: str                                                    │
│ - message_type: str (text/image/announcement)                     │
│ - created_at: datetime                                            │
│ - updated_at: datetime                                            │
│ - is_deleted: bool                                                │
├───────────────────────────────────────────────────────────────────┤
│ + to_dict(include_user_info: bool): dict                         │
└───────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────┐
│                           Match                                   │
├───────────────────────────────────────────────────────────────────┤
│ - match_id: int                                                   │
│ - activity_id: int (FK, nullable)                                 │
│ - user_a: int (FK)  // 申請者                                     │
│ - user_b: int (FK)  // 被申請者                                   │
│ - status: str (pending/confirmed/rejected/cancelled)              │
│ - match_date: datetime                                            │
│ - confirmed_date: datetime                                        │
│ - cancel_date: datetime                                           │
│ - message: str                                                    │
│ - rejection_reason: str                                           │
├───────────────────────────────────────────────────────────────────┤
│ + to_dict(include_users_info: bool): dict                        │
│ + confirm(): void                                                 │
│ + reject(reason: str): void                                       │
│ + cancel(): void                                                  │
│ + get_other_user(current_user_id: int): int                      │
│ + is_participant(user_id: int): bool                             │
└───────────┬───────────────────────────────────────────────────────┘
            │
            │ 1
            │ has
            │
            │ *
┌───────────▼───────────────────────────────────────────────────────┐
│                        ChatMessage                                │
├───────────────────────────────────────────────────────────────────┤
│ - message_id: int                                                 │
│ - match_id: int (FK, nullable)                                    │
│ - sender_id: int (FK)                                             │
│ - receiver_id: int (FK)                                           │
│ - content: str                                                    │
│ - timestamp: datetime                                             │
│ - message_type: str (text/image/file)                             │
│ - status: str (sent/delivered/read)                               │
│ - is_read: bool                                                   │
│ - file_url: str                                                   │
│ - file_name: str                                                  │
│ - file_size: int                                                  │
├───────────────────────────────────────────────────────────────────┤
│ + to_dict(include_sender_info: bool): dict                       │
│ + mark_as_read(): void                                            │
└───────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────┐
│                          Expense                                  │
├───────────────────────────────────────────────────────────────────┤
│ - expense_id: int                                                 │
│ - activity_id: int (FK)                                           │
│ - payer_id: int (FK)                                              │
│ - amount: decimal                                                 │
│ - description: str                                                │
│ - expense_date: date                                              │
│ - category: str (transport/accommodation/food/ticket/other)       │
│ - is_split: bool                                                  │
│ - split_method: str (equal/custom)                                │
│ - participants: str (JSON)                                        │
│ - created_at: datetime                                            │
├───────────────────────────────────────────────────────────────────┤
│ + to_dict(include_details: bool): dict                           │
│ + calculate_split_amount(participant_count: int): float          │
└───────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────┐
│                      ActivityReview                               │
├───────────────────────────────────────────────────────────────────┤
│ - review_id: int                                                  │
│ - activity_id: int (FK)                                           │
│ - reviewer_id: int (FK)  // 評價者                                │
│ - reviewee_id: int (FK)  // 被評價者                              │
│ - comment: str                                                    │
│ - created_at: datetime                                            │
│ - updated_at: datetime                                            │
├───────────────────────────────────────────────────────────────────┤
│ + to_dict(include_user_info: bool): dict                         │
└───────────────────────────────────────────────────────────────────┘
```

---

## 3. 後端物件設計

### 3.1 User 類別

**路徑：** `backend/models/user.py`

#### 3.1.1 屬性

| 屬性名稱 | 型別 | 說明 |
|---------|------|------|
| user_id | int | 主鍵，自動遞增 |
| name | str | 使用者姓名 |
| email | str | Email（唯一） |
| password_hash | str | 密碼雜湊值 |
| profile_picture | str | 頭像 URL |
| bio | str | 個人簡介 |
| gender | str | 性別 |
| age | int | 年齡 |
| interests | str | 興趣（JSON 字串） |
| social_privacy | str | 社群隱私設定 |
| instagram_url | str | Instagram 連結 |
| facebook_url | str | Facebook 連結 |
| line_id | str | Line ID |
| twitter_url | str | Twitter 連結 |
| two_factor_enabled | bool | 是否啟用 2FA |
| two_factor_secret | str | 2FA 密鑰 |
| rating_count | int | 評價數量 |
| join_date | datetime | 註冊日期 |
| is_verified | bool | Email 是否驗證 |
| is_active | bool | 帳號是否啟用 |
| last_seen | datetime | 最後上線時間 |

#### 3.1.2 關聯

```python
# 一對多關聯
created_activities = db.relationship('Activity', backref='creator', lazy='dynamic')
matches_as_user_a = db.relationship('Match', backref='user_a_ref', lazy='dynamic')
matches_as_user_b = db.relationship('Match', backref='user_b_ref', lazy='dynamic')
sent_messages = db.relationship('ChatMessage', backref='sender', lazy='dynamic')
activity_participations = db.relationship('ActivityParticipant', backref='user', lazy='dynamic')
```

#### 3.1.3 方法

```python
def set_password(password: str) -> None:
    """設定密碼雜湊"""
    self.password_hash = generate_password_hash(password)

def check_password(password: str) -> bool:
    """檢查密碼是否正確"""
    return check_password_hash(self.password_hash, password)

def to_dict(include_private=False, is_friend=False) -> dict:
    """轉換為字典格式
    
    Args:
        include_private: 是否包含私密資訊（自己）
        is_friend: 是否為好友（影響社群帳號顯示）
    
    Returns:
        使用者資料字典
    """
    # 基本資料
    data = {
        'user_id': self.user_id,
        'name': self.name,
        'profile_picture': self.profile_picture,
        'bio': self.bio,
        'gender': self.gender,
        'age': self.age,
        'interests': json.loads(self.interests) if self.interests else [],
        'rating_count': self.rating_count
    }
    
    # 社群帳號（根據隱私設定）
    show_social = include_private or self.social_privacy == 'public' or (is_friend and self.social_privacy == 'friends_only')
    
    if show_social:
        data['social_links'] = {
            'instagram': self.instagram_url,
            'facebook': self.facebook_url,
            'line': self.line_id,
            'twitter': self.twitter_url
        }
    
    # 私密資訊
    if include_private:
        data.update({
            'email': self.email,
            'social_privacy': self.social_privacy,
            'two_factor_enabled': self.two_factor_enabled
        })
    
    return data

def update_last_seen() -> None:
    """更新最後上線時間"""
    self.last_seen = datetime.utcnow()
    db.session.commit()
```

---

### 3.2 Activity 類別

**路徑：** `backend/models/activity.py`

#### 3.2.1 核心方法

```python
def get_participant_count() -> int:
    """取得當前參與人數（已批准 + 創建者）"""
    return ActivityParticipant.query.filter_by(
        activity_id=self.activity_id
    ).filter(
        ActivityParticipant.status.in_(['joined', 'approved'])
    ).count()

def is_full() -> bool:
    """檢查活動是否已滿"""
    return self.get_participant_count() >= self.max_participants

def can_user_join(user: User) -> tuple[bool, str]:
    """檢查使用者是否可加入活動
    
    Returns:
        (可以加入, 訊息)
    """
    # 檢查 1: 不能加入自己的活動
    if self.creator_id == user.user_id:
        return False, "不能加入自己創建的活動"
    
    # 檢查 2: 活動是否已滿
    if self.is_full():
        return False, "活動人數已滿"
    
    # 檢查 3: 活動狀態
    if self.status != 'active':
        return False, "活動已結束或取消"
    
    # 檢查 4: 性別限制
    if self.gender_preference and self.gender_preference != 'any':
        if user.gender != self.gender_preference:
            return False, f"此活動僅限 {self.gender_preference}"
    
    # 檢查 5: 年齡限制
    if self.age_min and user.age and user.age < self.age_min:
        return False, f"年齡需滿 {self.age_min} 歲"
    
    if self.age_max and user.age and user.age > self.age_max:
        return False, f"年齡不能超過 {self.age_max} 歲"
    
    return True, "可以加入"
```

---

### 3.3 ActivityParticipant 類別

**路徑：** `backend/models/activity_participant.py`

#### 3.3.1 狀態管理方法

```python
def approve() -> None:
    """批准參與申請"""
    self.status = 'approved'
    self.approved_at = datetime.utcnow()
    db.session.commit()

def reject(reason: str = None) -> None:
    """拒絕參與申請
    
    Args:
        reason: 拒絕原因（選填）
    """
    self.status = 'rejected'
    self.rejection_reason = reason
    db.session.commit()

def leave() -> None:
    """離開活動"""
    self.status = 'left'
    self.left_at = datetime.utcnow()
    db.session.commit()
```

---

### 3.4 Match 類別

**路徑：** `backend/models/match.py`

#### 3.4.1 媒合管理方法

```python
def confirm() -> None:
    """確認媒合（雙方同意）"""
    self.status = 'confirmed'
    self.confirmed_date = datetime.utcnow()
    db.session.commit()

def reject(reason: str = None) -> None:
    """拒絕媒合
    
    Args:
        reason: 拒絕原因（選填）
    """
    self.status = 'rejected'
    self.rejection_reason = reason
    db.session.commit()

def cancel() -> None:
    """取消媒合（申請者撤銷）"""
    self.status = 'cancelled'
    self.cancel_date = datetime.utcnow()
    db.session.commit()

def get_other_user(current_user_id: int) -> int:
    """取得對方使用者 ID
    
    Args:
        current_user_id: 當前使用者 ID
    
    Returns:
        對方使用者 ID
    """
    return self.user_b if current_user_id == self.user_a else self.user_a

def is_participant(user_id: int) -> bool:
    """檢查使用者是否參與此媒合
    
    Args:
        user_id: 使用者 ID
    
    Returns:
        是否參與
    """
    return user_id in [self.user_a, self.user_b]
```

---

### 3.5 Expense 類別

**路徑：** `backend/models/expense.py`

#### 3.5.1 費用計算方法

```python
def calculate_split_amount(participant_count: int) -> float:
    """計算每人應分攤金額
    
    Args:
        participant_count: 參與人數
    
    Returns:
        每人應分攤金額
    """
    if not self.is_split or participant_count == 0:
        return 0
    return float(self.amount) / participant_count
```

---

## 4. 前端組件設計

### 4.1 組件樹狀結構

```
App.vue (根組件)
│
├── Layout Components (佈局組件)
│   ├── Navbar.vue                 # 導航列
│   ├── Sidebar.vue                # 側邊欄
│   └── Footer.vue                 # 頁尾
│
├── Page Components (頁面組件)
│   ├── LoginView.vue              # 登入頁
│   ├── RegisterView.vue           # 註冊頁
│   ├── DashboardView.vue          # 個人儀表板
│   ├── ActivitiesView.vue         # 活動列表
│   ├── ActivityDetailView.vue     # 活動詳情
│   ├── CreateActivityView.vue     # 建立活動
│   ├── MatchesView.vue            # 媒合列表
│   ├── ChatView.vue               # 聊天室
│   └── ProfileView.vue            # 個人資料
│
└── Reusable Components (可重用組件)
    ├── ActivityCard.vue           # 活動卡片
    ├── ChatWindow.vue             # 聊天視窗
    ├── ExpenseManager.vue         # 費用管理器
    ├── ImageUploader.vue          # 圖片上傳器
    ├── UserAvatar.vue             # 使用者頭像
    ├── ParticipantList.vue        # 參與者列表
    ├── DiscussionThread.vue       # 討論串
    └── ReviewForm.vue             # 評價表單
```

### 4.2 ActivityCard 組件

**路徑：** `frontend/src/components/ActivityCard.vue`

#### 4.2.1 Props

```typescript
interface Props {
  activity: {
    activity_id: number;
    title: string;
    start_date: string;
    location: string;
    category: string;
    cover_image: string;
    current_participants: number;
    max_participants: number;
    creator: {
      name: string;
      profile_picture: string;
    }
  }
}
```

#### 4.2.2 Emits

```typescript
const emit = defineEmits<{
  click: [activity_id: number];
  bookmark: [activity_id: number];
}>()
```

#### 4.2.3 組件結構

```vue
<template>
  <el-card class="activity-card" @click="handleClick">
    <img :src="activity.cover_image" class="cover" />
    <div class="content">
      <h3>{{ activity.title }}</h3>
      <p class="location">
        <el-icon><Location /></el-icon>
        {{ activity.location }}
      </p>
      <p class="date">{{ formatDate(activity.start_date) }}</p>
      <el-tag>{{ activity.category }}</el-tag>
      <div class="footer">
        <div class="participants">
          {{ activity.current_participants }} / {{ activity.max_participants }} 人
        </div>
        <user-avatar :user="activity.creator" size="small" />
      </div>
    </div>
  </el-card>
</template>
```

---

### 4.3 ChatWindow 組件

**路徑：** `frontend/src/components/ChatWindow.vue`

#### 4.3.1 Props

```typescript
interface Props {
  matchId: number;
  otherUser: {
    user_id: number;
    name: string;
    profile_picture: string;
  }
}
```

#### 4.3.2 Data

```typescript
interface ChatState {
  messages: Array<{
    message_id: number;
    sender_id: number;
    content: string;
    timestamp: string;
    is_read: boolean;
  }>;
  inputMessage: string;
  loading: boolean;
  socket: any;
}
```

#### 4.3.3 Methods

```typescript
// 載入聊天訊息
const loadMessages = async () => {
  try {
    const response = await axios.get(`/api/chat/matches/${matchId}/messages`)
    messages.value = response.data
    scrollToBottom()
  } catch (error) {
    console.error('載入訊息失敗', error)
  }
}

// 發送訊息
const sendMessage = () => {
  if (!inputMessage.value.trim()) return
  
  socket.emit('send_message', {
    match_id: matchId,
    content: inputMessage.value,
    receiver_id: otherUser.user_id
  })
  
  inputMessage.value = ''
}

// Socket.IO 事件監聽
socket.on('new_message', (data) => {
  messages.value.push(data)
  scrollToBottom()
})
```

---

### 4.4 ExpenseManager 組件

**路徑：** `frontend/src/components/ExpenseManager.vue`

#### 4.4.1 Props

```typescript
interface Props {
  activityId: number;
  participants: Array<{
    user_id: number;
    name: string;
  }>;
}
```

#### 4.4.2 Data

```typescript
interface ExpenseState {
  expenses: Array<{
    expense_id: number;
    amount: number;
    description: string;
    category: string;
    payer: { name: string };
  }>;
  settlement: Array<{
    from: string;
    to: string;
    amount: number;
  }>;
  showAddForm: boolean;
  newExpense: {
    amount: number;
    description: string;
    category: string;
    payer_id: number;
  };
}
```

#### 4.4.3 Methods

```typescript
// 新增費用
const addExpense = async () => {
  try {
    await axios.post(`/api/activities/${activityId}/expenses`, newExpense.value)
    await loadExpenses()
    showAddForm.value = false
  } catch (error) {
    console.error('新增費用失敗', error)
  }
}

// 計算結算方案
const calculateSettlement = async () => {
  try {
    const response = await axios.get(`/api/activities/${activityId}/expenses/settlement`)
    settlement.value = response.data
  } catch (error) {
    console.error('計算結算失敗', error)
  }
}
```

---

## 5. 序列圖 (Sequence Diagram)

### 5.1 使用者註冊流程

```
使用者          前端          後端API        資料庫       Email服務
  │              │              │              │              │
  │  填寫表單     │              │              │              │
  ├─────────────>│              │              │              │
  │              │  POST /api/auth/register    │              │
  │              ├─────────────>│              │              │
  │              │              │ 驗證資料      │              │
  │              │              │              │              │
  │              │              │ INSERT User  │              │
  │              │              ├─────────────>│              │
  │              │              │<─────────────┤              │
  │              │              │   user_id    │              │
  │              │              │              │ 發送驗證信   │
  │              │              ├──────────────┼─────────────>│
  │              │<─────────────┤              │              │
  │              │   註冊成功   │              │              │
  │<─────────────┤              │              │              │
  │  跳轉登入頁  │              │              │              │
  │              │              │              │              │
  │  收到Email   │              │              │              │
  │<──────────────────────────────────────────────────────────┤
  │              │              │              │              │
  │  點擊驗證連結│              │              │              │
  ├─────────────>│              │              │              │
  │              │  GET /api/auth/verify-email │              │
  │              ├─────────────>│              │              │
  │              │              │ UPDATE User  │              │
  │              │              │ is_verified=true            │
  │              │              ├─────────────>│              │
  │              │<─────────────┤              │              │
  │              │   驗證成功   │              │              │
  │<─────────────┤              │              │              │
```

---

### 5.2 建立活動並申請加入流程

```
創建者         申請者         前端          後端API        資料庫
  │              │              │              │              │
  │ 建立活動     │              │              │              │
  ├─────────────>│              │              │              │
  │              │              │  POST /api/activities       │
  │              │              ├─────────────>│              │
  │              │              │              │ INSERT Activity
  │              │              │              ├─────────────>│
  │              │              │              │ INSERT ActivityParticipant
  │              │              │              │ (creator, joined)
  │              │              │              ├─────────────>│
  │              │              │<─────────────┤              │
  │<─────────────┼──────────────┤  活動已建立  │              │
  │              │              │              │              │
  │              │ 瀏覽活動     │              │              │
  │              ├─────────────>│              │              │
  │              │              │  GET /api/activities        │
  │              │              ├─────────────>│              │
  │              │              │<─────────────┤              │
  │              │<─────────────┤  活動列表    │              │
  │              │              │              │              │
  │              │ 申請加入     │              │              │
  │              ├─────────────>│              │              │
  │              │              │  POST /api/activities/{id}/join
  │              │              ├─────────────>│              │
  │              │              │              │ INSERT ActivityParticipant
  │              │              │              │ (pending)    │
  │              │              │              ├─────────────>│
  │              │              │<─────────────┤              │
  │              │<─────────────┤  申請成功    │              │
  │              │              │              │              │
  │ 查看申請     │              │              │              │
  ├─────────────>│              │              │              │
  │              │              │  GET /api/activities/{id}/participants
  │              │              ├─────────────>│              │
  │              │              │<─────────────┤              │
  │<─────────────┼──────────────┤  待審核列表  │              │
  │              │              │              │              │
  │ 批准申請     │              │              │              │
  ├─────────────>│              │              │              │
  │              │              │  POST /api/activities/participants/{id}/approve
  │              │              ├─────────────>│              │
  │              │              │              │ UPDATE ActivityParticipant
  │              │              │              │ status=approved
  │              │              │              ├─────────────>│
  │              │              │<─────────────┤              │
  │<─────────────┼──────────────┤  批准成功    │              │
  │              │              │              │              │
  │              │ （收到通知） │              │              │
  │              │<──────────────────────────────────────────│
```

---

### 5.3 媒合與開啟聊天室流程

```
使用者A        使用者B        前端          後端API     Socket.IO    資料庫
  │              │              │              │              │              │
  │ 發送媒合申請 │              │              │              │              │
  ├─────────────>│              │              │              │              │
  │              │              │  POST /api/matches          │              │
  │              │              ├─────────────>│              │              │
  │              │              │              │ INSERT Match │              │
  │              │              │              │ (pending)    │              │
  │              │              │              ├──────────────┼─────────────>│
  │              │              │<─────────────┤              │              │
  │<─────────────┼──────────────┤  申請已送出  │              │              │
  │              │              │              │              │              │
  │              │ （收到通知） │              │              │              │
  │              │<──────────────────────────────────────────│              │
  │              │              │              │              │              │
  │              │ 查看媒合申請 │              │              │              │
  │              ├─────────────>│              │              │              │
  │              │              │  GET /api/matches           │              │
  │              │              ├─────────────>│              │              │
  │              │              │<─────────────┤              │              │
  │              │<─────────────┤  媒合列表    │              │              │
  │              │              │              │              │              │
  │              │ 接受媒合     │              │              │              │
  │              ├─────────────>│              │              │              │
  │              │              │  PUT /api/matches/{id}      │              │
  │              │              │  {status: 'confirmed'}      │              │
  │              │              ├─────────────>│              │              │
  │              │              │              │ UPDATE Match │              │
  │              │              │              │ status=confirmed
  │              │              │              ├──────────────┼─────────────>│
  │              │              │<─────────────┤              │              │
  │              │<─────────────┤  媒合成功    │              │              │
  │              │              │              │              │              │
  │ 開啟聊天室   │              │              │              │              │
  ├─────────────>│              │              │              │              │
  │              │              │              │              │ connect      │
  │              │              ├──────────────┼─────────────>│              │
  │              │              │              │              │ join_room    │
  │              │              ├──────────────┼─────────────>│              │
  │              │              │              │              │              │
  │ 發送訊息     │              │              │              │              │
  ├─────────────>│              │              │              │              │
  │              │              │              │              │ send_message │
  │              │              ├──────────────┼─────────────>│              │
  │              │              │              │              │ INSERT ChatMessage
  │              │              │              │              ├─────────────>│
  │              │              │              │              │              │
  │              │              │              │              │ emit new_message
  │              │<──────────────────────────────────────────┤              │
  │              │  收到訊息    │              │              │              │
```

---

### 5.4 費用分攤與結算流程

```
參與者A        參與者B        前端          後端API        資料庫
  │              │              │              │              │
  │ 新增費用     │              │              │              │
  ├─────────────>│              │              │              │
  │              │              │  POST /api/activities/{id}/expenses
  │              │              ├─────────────>│              │
  │              │              │              │ INSERT Expense
  │              │              │              ├─────────────>│
  │              │              │<─────────────┤              │
  │<─────────────┼──────────────┤  費用已新增  │              │
  │              │              │              │              │
  │              │ 新增費用     │              │              │
  │              ├─────────────>│              │              │
  │              │              │  POST /api/activities/{id}/expenses
  │              │              ├─────────────>│              │
  │              │              │              │ INSERT Expense
  │              │              │              ├─────────────>│
  │              │              │<─────────────┤              │
  │              │<─────────────┤  費用已新增  │              │
  │              │              │              │              │
  │ 查看結算     │              │              │              │
  ├─────────────>│              │              │              │
  │              │              │  GET /api/activities/{id}/expenses/settlement
  │              │              ├─────────────>│              │
  │              │              │              │ SELECT expenses
  │              │              │              ├─────────────>│
  │              │              │              │<─────────────┤
  │              │              │              │ 計算結算方案  │
  │              │              │              │ (最少轉帳次數)
  │              │              │<─────────────┤              │
  │<─────────────┼──────────────┤  結算報告    │              │
  │  A → B: 300  │              │              │              │
  │              │              │              │              │
```

---

## 6. 狀態圖 (State Diagram)

### 6.1 活動狀態轉換圖

```
                  ┌──────────────────┐
                  │                  │
          ┌───────┤     active       │
          │       │   (活動中)        │
          │       │                  │
          │       └────┬─────────────┘
          │            │
          │            │ 創建者開始活動
          │            │
          │            ▼
          │       ┌──────────────────┐
          │       │                  │
          │       │    ongoing       │
          │       │  (進行中)         │
          │       │                  │
          │       └────┬─────────────┘
          │            │
          │            │ 創建者結束活動
          │            │
          │            ▼
          │       ┌──────────────────┐
          │       │                  │
          │       │   completed      │
          │       │   (已完成)        │
          │       │                  │
          │       └──────────────────┘
          │
          │ 創建者取消活動
          │
          ▼
    ┌──────────────────┐
    │                  │
    │    cancelled     │
    │    (已取消)       │
    │                  │
    └──────────────────┘
```

---

### 6.2 參與者狀態轉換圖

```
                  ┌──────────────────┐
                  │                  │
          ┌───────┤     pending      │
          │       │    (待審核)       │
          │       │                  │
          │       └────┬─────────────┘
          │            │
          │            │ 創建者批准
          │            │
          │            ▼
          │       ┌──────────────────┐        ┌──────────────────┐
          │       │                  │  離開  │                  │
          │       │    approved      ├───────>│      left        │
          │       │    (已批准)       │        │    (已離開)       │
          │       │                  │        │                  │
          │       └────┬─────────────┘        └──────────────────┘
          │            │
          │            │ 創建者移除
          │            │
          │            ▼
          │       ┌──────────────────┐
          │       │                  │
          │       │    removed       │
          │       │    (被移除)       │
          │       │                  │
          │       └──────────────────┘
          │
          │ 創建者拒絕
          │
          ▼
    ┌──────────────────┐
    │                  │
    │    rejected      │
    │    (已拒絕)       │
    │                  │
    └──────────────────┘

註：創建者的狀態為 'joined'（已加入），不經過審核流程
```

---

### 6.3 媒合狀態轉換圖

```
                  ┌──────────────────┐
                  │                  │
          ┌───────┤     pending      │
          │       │    (待確認)       │
          │       │                  │
          │       └────┬─────────────┘
          │            │
          │            │ 對方接受
          │            │
          │            ▼
          │       ┌──────────────────┐        ┌──────────────────┐
          │       │                  │  任一方 │                  │
          │       │   confirmed      │  取消  │   cancelled      │
          │       │    (已確認)       ├───────>│    (已取消)       │
          │       │                  │        │                  │
          │       └──────────────────┘        └──────────────────┘
          │
          │ 對方拒絕
          │
          ▼
    ┌──────────────────┐
    │                  │
    │    rejected      │
    │    (已拒絕)       │
    │                  │
    └──────────────────┘
```

---

## 7. 設計模式

### 7.1 使用的設計模式

#### 7.1.1 MVC 模式

**應用：** 整體架構  
**說明：**
- **Model (模型)**：SQLAlchemy ORM Models
- **View (視圖)**：Vue 3 Components
- **Controller (控制器)**：Flask Blueprints

---

#### 7.1.2 Factory Pattern (工廠模式)

**應用：** Flask Application Factory  
**檔案：** `backend/app.py`

```python
def create_app(config_name='default'):
    """Application Factory"""
    app = Flask(__name__)
    app.config.from_object(config[config_name])
    
    # 初始化擴展
    db.init_app(app)
    jwt.init_app(app)
    socketio.init_app(app)
    
    # 註冊 Blueprints
    from blueprints import auth_bp, users_bp, activities_bp
    app.register_blueprint(auth_bp, url_prefix='/api/auth')
    app.register_blueprint(users_bp, url_prefix='/api/users')
    app.register_blueprint(activities_bp, url_prefix='/api/activities')
    
    return app
```

---

#### 7.1.3 Repository Pattern (倉儲模式)

**應用：** 資料存取層  
**說明：** SQLAlchemy ORM 封裝了資料庫操作

```python
# 範例：查詢活動
activity = Activity.query.filter_by(activity_id=id).first()

# 範例：建立使用者
new_user = User(name=name, email=email)
db.session.add(new_user)
db.session.commit()
```

---

#### 7.1.4 Observer Pattern (觀察者模式)

**應用：** Socket.IO 即時通訊  
**說明：** 客戶端監聽伺服器事件

```javascript
// 客戶端監聽訊息事件
socket.on('new_message', (data) => {
  messages.value.push(data)
})

// 伺服器發送訊息事件
socketio.emit('new_message', message_data, room=match_id)
```

---

#### 7.1.5 Singleton Pattern (單例模式)

**應用：** 資料庫連線、Socket.IO 實例  
**說明：** 全域共用單一實例

```python
# SQLAlchemy 實例
from flask_sqlalchemy import SQLAlchemy
db = SQLAlchemy()

# Socket.IO 實例
from flask_socketio import SocketIO
socketio = SocketIO()
```

---

## 8. 附錄

### 8.1 命名規範

#### 8.1.1 後端命名規範（Python）

- **檔案名稱：** snake_case（例如：`activity_participant.py`）
- **類別名稱：** PascalCase（例如：`ActivityParticipant`）
- **函式名稱：** snake_case（例如：`get_participant_count()`）
- **變數名稱：** snake_case（例如：`user_id`）
- **常數名稱：** UPPER_SNAKE_CASE（例如：`MAX_PARTICIPANTS`）

#### 8.1.2 前端命名規範（Vue/JavaScript）

- **檔案名稱：** PascalCase（例如：`ActivityCard.vue`）
- **組件名稱：** PascalCase（例如：`ActivityCard`）
- **函式名稱：** camelCase（例如：`loadMessages()`）
- **變數名稱：** camelCase（例如：`activityId`）
- **常數名稱：** UPPER_SNAKE_CASE（例如：`API_BASE_URL`）

---

### 8.2 程式碼審查清單

#### 8.2.1 後端審查清單

- [ ] 遵循 PEP 8 規範
- [ ] 類別有 docstring 說明
- [ ] 方法有型別提示（Type Hints）
- [ ] 使用 ORM 參數化查詢（避免 SQL 注入）
- [ ] 錯誤處理完善（try-except）
- [ ] 敏感資訊不寫死在程式碼（使用環境變數）
- [ ] 資料庫操作後呼叫 `db.session.commit()`
- [ ] API 回應統一格式（成功/錯誤）

#### 8.2.2 前端審查清單

- [ ] 遵循 ESLint 規範
- [ ] 組件有註解說明
- [ ] Props 有型別定義
- [ ] 錯誤處理完善（try-catch）
- [ ] 使用者操作有 Loading 提示
- [ ] 敏感資訊不存在前端（例如 API Key）
- [ ] 表單有驗證機制
- [ ] 響應式設計（支援手機、平板）

---

### 8.3 UML 工具

**建議使用工具：**
- **PlantUML** - 文字轉 UML 圖
- **Draw.io** - 線上繪圖工具
- **Lucidchart** - 專業 UML 工具

---

### 8.4 參考文獻

1. **Design Patterns: Elements of Reusable Object-Oriented Software** - Gang of Four
2. **Clean Code** - Robert C. Martin
3. **Domain-Driven Design** - Eric Evans
4. **Flask Web Development** - Miguel Grinberg
5. **Vue.js 3 Design Patterns and Best Practices** - Packt Publishing

---

**文件核准：**

| 角色 | 姓名 | 簽名 | 日期 |
|------|------|------|------|
| 系統架構師 | - | - | - |
| 技術主管 | - | - | - |
| 資深開發工程師 | - | - | - |

---

**文件結束**
