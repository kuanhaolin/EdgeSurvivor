# EdgeSurvivor 軟體設計文件 (SDD)

**Software Design Document - Architecture Design**

**版本：** 1.0  
**日期：** 2025-11-03  
**狀態：** Active  
**作者：** System Architect Team

---

## 文件修訂歷史

| 版本 | 日期 | 修訂內容 | 作者 |
|------|------|----------|------|
| 1.0 | 2025-11-03 | 初始版本，基於 MVP 完成狀態 | Architect Team |

---

## 目錄

1. [簡介](#1-簡介)
2. [系統架構](#2-系統架構)
3. [技術棧](#3-技術棧)
4. [資料庫設計](#4-資料庫設計)
5. [API 設計](#5-api-設計)
6. [安全性設計](#6-安全性設計)
7. [部署架構](#7-部署架構)
8. [效能優化](#8-效能優化)
9. [附錄](#9-附錄)

---

## 1. 簡介

### 1.1 文件目的

本文件定義 **EdgeSurvivor** 的軟體架構設計，包含系統架構、技術選型、資料庫設計、API 設計、安全性設計及部署架構。本文件旨在：

- 提供開發團隊實作的技術藍圖
- 確保系統設計的一致性與可維護性
- 作為技術審查與優化的依據
- 指導新成員快速理解系統架構

**目標讀者：**
- 系統架構師
- 後端開發工程師
- 前端開發工程師
- DevOps 工程師
- 技術主管

### 1.2 系統概述

**EdgeSurvivor** 是一個專注於「旅伴與活動媒合」的社交平台，採用前後端分離的 Web 應用程式架構。

**核心技術棧：**
- **前端：** Vue 3 + Vite + Element Plus
- **後端：** Python Flask + SQLAlchemy
- **資料庫：** MariaDB 10.11
- **即時通訊：** Socket.IO
- **部署：** Docker + Docker Compose

### 1.3 設計原則

1. **關注點分離 (Separation of Concerns)**
   - 前後端完全分離
   - 模組化設計（Blueprint）
   - 分層架構（Model-View-Controller）

2. **可維護性 (Maintainability)**
   - 一致的命名規範
   - 完整的程式碼註解
   - 遵循 PEP 8 / ESLint 規範

3. **可擴展性 (Scalability)**
   - Docker 容器化
   - RESTful API 設計
   - 資料庫索引優化

4. **安全性 (Security)**
   - JWT Token 認證
   - 密碼加密（scrypt）
   - SQL 注入防護（ORM）
   - CORS 設定

5. **效能優化 (Performance)**
   - API 回應時間 < 500ms
   - 資料庫查詢優化
   - 前端懶載入

---

## 2. 系統架構

### 2.1 整體架構圖

```
┌─────────────────────────────────────────────────────────────────┐
│                      Client Layer (客戶端層)                      │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Web Browser (Chrome, Firefox, Safari)       │   │
│  │                                                          │   │
│  │  ┌──────────────────────────────────────────────────┐   │   │
│  │  │         Vue 3 Single Page Application            │   │   │
│  │  │  - Element Plus UI Components                    │   │   │
│  │  │  - Pinia State Management                        │   │   │
│  │  │  - Vue Router (SPA Routing)                      │   │   │
│  │  │  - Axios (HTTP Client)                           │   │   │
│  │  │  - Socket.IO Client (WebSocket)                  │   │   │
│  │  └──────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ HTTPS / WSS
                         │ (REST API + WebSocket)
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Application Layer (應用層)                     │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  Nginx (Reverse Proxy)                   │   │
│  │  - SSL/TLS Termination                                   │   │
│  │  - Static File Serving                                   │   │
│  │  - Load Balancing (Future)                               │   │
│  └────────────────────┬─────────────────────────────────────┘   │
│                       │                                           │
│  ┌────────────────────▼─────────────────────────────────────┐   │
│  │              Flask Application Server                    │   │
│  │                                                          │   │
│  │  ┌──────────────────────────────────────────────────┐   │   │
│  │  │           Flask RESTful API (Blueprints)          │   │   │
│  │  │                                                   │   │   │
│  │  │  ├─ auth_bp       (使用者認證)                    │   │   │
│  │  │  ├─ users_bp      (使用者管理)                    │   │   │
│  │  │  ├─ activities_bp (活動管理)                     │   │   │
│  │  │  ├─ matches_bp    (媒合系統)                     │   │   │
│  │  │  ├─ chat_bp       (聊天室)                       │   │   │
│  │  │  ├─ expenses_bp   (費用分攤)                     │   │   │
│  │  │  ├─ reviews_bp    (評價系統)                     │   │   │
│  │  │  └─ upload_bp     (檔案上傳)                     │   │   │
│  │  └──────────────────────────────────────────────────┘   │   │
│  │                                                          │   │
│  │  ┌──────────────────────────────────────────────────┐   │   │
│  │  │         Flask-SocketIO (WebSocket Server)        │   │   │
│  │  │  - Chat Room Management                          │   │   │
│  │  │  - Real-time Messaging                           │   │   │
│  │  └──────────────────────────────────────────────────┘   │   │
│  │                                                          │   │
│  │  ┌──────────────────────────────────────────────────┐   │   │
│  │  │            Middleware Layer                       │   │   │
│  │  │  - JWT Authentication                             │   │   │
│  │  │  - CORS Handler                                   │   │   │
│  │  │  - Error Handler                                  │   │   │
│  │  │  - Request Logger                                 │   │   │
│  │  └──────────────────────────────────────────────────┘   │   │
│  └──────────────────────┬───────────────────────────────────┘   │
└─────────────────────────┼───────────────────────────────────────┘
                          │
                          │ SQL / ORM
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Data Layer (資料層)                          │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  SQLAlchemy ORM Layer                    │   │
│  │  - Model Definitions                                     │   │
│  │  - Query Optimization                                    │   │
│  │  - Relationship Management                               │   │
│  └────────────────────┬─────────────────────────────────────┘   │
│                       │                                           │
│  ┌────────────────────▼─────────────────────────────────────┐   │
│  │              MariaDB 10.11 Database                      │   │
│  │                                                          │   │
│  │  ├─ users                 (使用者資料)                   │   │
│  │  ├─ activities            (活動資料)                    │   │
│  │  ├─ activity_participants (活動參與者)                  │   │
│  │  ├─ activity_discussions  (活動討論串)                  │   │
│  │  ├─ matches               (媒合記錄)                    │   │
│  │  ├─ chat_messages         (聊天訊息)                    │   │
│  │  ├─ expenses              (費用記錄)                    │   │
│  │  └─ activity_reviews      (活動評價)                    │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    Storage Layer (儲存層)                        │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              File System (Local Storage)                  │  │
│  │  - /uploads/avatars/      (使用者頭像)                    │  │
│  │  - /uploads/covers/       (活動封面)                      │  │
│  │  - /uploads/albums/       (活動相簿)                      │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 架構模式

**採用 MVC (Model-View-Controller) 架構模式**

#### 2.2.1 Model (模型層)
- **責任：** 資料存取與業務邏輯
- **實作：** SQLAlchemy ORM Models
- **位置：** `backend/models/`

**主要模型：**
```python
User                    # 使用者模型
Activity                # 活動模型
ActivityParticipant     # 活動參與者模型
ActivityDiscussion      # 活動討論串模型
Match                   # 媒合模型
ChatMessage             # 聊天訊息模型
Expense                 # 費用模型
ActivityReview          # 活動評價模型
```

#### 2.2.2 Controller (控制層)
- **責任：** 處理 HTTP 請求、呼叫 Model、返回 JSON 回應
- **實作：** Flask Blueprints
- **位置：** `backend/blueprints/`

**Blueprint 模組：**
```python
auth_bp         # /api/auth/*       (認證相關)
users_bp        # /api/users/*      (使用者管理)
activities_bp   # /api/activities/* (活動管理)
matches_bp      # /api/matches/*    (媒合系統)
chat_bp         # /api/chat/*       (聊天室)
expenses_bp     # /api/expenses/*   (費用分攤)
reviews_bp      # /api/reviews/*    (評價系統)
upload_bp       # /api/upload/*     (檔案上傳)
```

#### 2.2.3 View (視圖層)
- **責任：** 使用者介面展示
- **實作：** Vue 3 Components
- **位置：** `frontend/src/views/`, `frontend/src/components/`

**主要頁面組件：**
```
LoginView.vue           # 登入頁面
RegisterView.vue        # 註冊頁面
DashboardView.vue       # 個人儀表板
ActivitiesView.vue      # 活動列表
ActivityDetailView.vue  # 活動詳情
CreateActivityView.vue  # 建立活動
MatchesView.vue         # 媒合列表
ChatView.vue            # 聊天室
ProfileView.vue         # 個人資料
```

### 2.3 模組化設計

#### 2.3.1 後端模組結構

```
backend/
├── app.py                      # Flask 應用程式入口
├── config.py                   # 配置檔案
├── socketio_events.py          # Socket.IO 事件處理
├── requirements.txt            # Python 依賴套件
│
├── models/                     # 資料模型層
│   ├── __init__.py            # SQLAlchemy db 實例
│   ├── user.py                # 使用者模型
│   ├── activity.py            # 活動模型
│   ├── activity_participant.py# 參與者模型
│   ├── activity_discussion.py # 討論串模型
│   ├── match.py               # 媒合模型
│   ├── chat_message.py        # 聊天訊息模型
│   ├── expense.py             # 費用模型
│   └── activity_review.py     # 評價模型
│
├── blueprints/                 # API 路由層
│   ├── __init__.py
│   ├── auth.py                # 認證 API
│   ├── users.py               # 使用者 API
│   ├── activities.py          # 活動 API
│   ├── matches.py             # 媒合 API
│   ├── chat.py                # 聊天 API
│   ├── expenses.py            # 費用 API
│   ├── reviews.py             # 評價 API
│   └── upload.py              # 上傳 API
│
└── utils/                      # 工具函式層
    ├── __init__.py
    └── email.py               # Email 發送工具
```

#### 2.3.2 前端模組結構

```
frontend/
├── index.html                  # HTML 入口
├── package.json                # Node.js 依賴
├── vite.config.js              # Vite 配置
│
└── src/
    ├── main.js                 # Vue 應用程式入口
    ├── App.vue                 # 根組件
    │
    ├── views/                  # 頁面級組件
    │   ├── LoginView.vue
    │   ├── DashboardView.vue
    │   ├── ActivitiesView.vue
    │   └── ...
    │
    ├── components/             # 可重用組件
    │   ├── ActivityCard.vue
    │   ├── ChatWindow.vue
    │   ├── ExpenseManager.vue
    │   └── ...
    │
    ├── router/                 # 路由配置
    │   └── index.js
    │
    ├── api/                    # API 服務層
    │   ├── index.js           # Axios 實例
    │   ├── auth.js
    │   ├── activities.js
    │   └── ...
    │
    ├── stores/                 # Pinia 狀態管理
    │   └── (未來實作)
    │
    └── styles/                 # 樣式檔案
        └── main.css
```

---

## 3. 技術棧

### 3.1 技術棧總覽

| 層級 | 技術 | 版本 | 用途 |
|------|------|------|------|
| **前端框架** | Vue.js | 3.3.8+ | 響應式 UI 框架 |
| **UI 組件庫** | Element Plus | 2.4.2+ | 企業級 UI 組件 |
| **前端建構工具** | Vite | 4.5.3+ | 開發伺服器與打包 |
| **狀態管理** | Pinia | 2.1.7+ | 狀態管理（未來） |
| **路由** | Vue Router | 4.2.5+ | SPA 路由 |
| **HTTP 客戶端** | Axios | 1.6.0+ | HTTP 請求 |
| **即時通訊 (前端)** | Socket.IO Client | 4.7.4+ | WebSocket 客戶端 |
| **後端框架** | Flask | 3.0.0+ | Python Web 框架 |
| **ORM** | SQLAlchemy | 2.0.0+ | 資料庫 ORM |
| **JWT 認證** | Flask-JWT-Extended | 4.6.0+ | JWT Token 管理 |
| **即時通訊 (後端)** | Flask-SocketIO | 5.3.6+ | WebSocket 伺服器 |
| **Email 服務** | Flask-Mail | 0.9.1+ | SMTP Email |
| **資料庫** | MariaDB | 10.11+ | 關聯式資料庫 |
| **資料庫驅動** | PyMySQL | 1.1.0+ | Python MySQL 驅動 |
| **容器化** | Docker | 24.0+ | 容器化部署 |
| **容器編排** | Docker Compose | 2.20+ | 多容器管理 |

### 3.2 開發工具

| 工具 | 用途 |
|------|------|
| **VS Code** | 主要 IDE |
| **Git** | 版本控制 |
| **GitHub** | 代碼託管 |
| **Postman** | API 測試 |
| **Trello / Notion** | 專案管理 |
| **Figma** | UI/UX 設計 |
| **DBeaver / MySQL Workbench** | 資料庫管理 |

### 3.3 第三方服務

| 服務 | 用途 | 方案 |
|------|------|------|
| **Google OAuth2** | 第三方登入 | 免費 |
| **Gmail SMTP** | Email 發送 | 免費 |
| **Let's Encrypt** | SSL 憑證 | 免費 |
| **DigitalOcean / Linode** | VPS 主機 | $15/月 |

---

## 4. 資料庫設計

### 4.1 資料庫 ER 圖

```
┌─────────────────────────────────────────────────────────────────┐
│                          Database Schema                          │
└─────────────────────────────────────────────────────────────────┘

      ┌──────────────────────┐
      │      users           │
      ├──────────────────────┤
      │ PK user_id           │
      │    name              │
      │    email (UNIQUE)    │
      │    password_hash     │
      │    profile_picture   │
      │    bio               │
      │    gender            │
      │    age               │
      │    interests (JSON)  │
      │    social_privacy    │
      │    instagram_url     │
      │    facebook_url      │
      │    line_id           │
      │    twitter_url       │
      │    two_factor_enabled│
      │    rating_count      │
      │    ...               │
      └──────┬───────────────┘
             │
             │ 1
             │
             │ creates
             │
             │ *
      ┌──────▼───────────────┐
      │   activities         │
      ├──────────────────────┤
      │ PK activity_id       │
      │ FK creator_id        │◄───────┐
      │    title             │        │ 
      │    start_date        │        │
      │    end_date          │        │
      │    location          │        │
      │    description       │        │
      │    category          │        │ 1
      │    max_participants  │        │
      │    cost              │        │
      │    status            │        │
      │    cover_image       │        │
      │    meeting_point     │        │
      │    gender_preference │        │
      │    age_min/age_max   │        │
      │    ...               │        │
      └──────┬───────────────┘        │
             │                        │
             │ 1                      │
             │                        │
             │ has                    │
             │                        │
             │ *                      │
      ┌──────▼───────────────────┐   │
      │ activity_participants    │   │
      ├──────────────────────────┤   │
      │ PK participant_id        │   │
      │ FK activity_id           │───┘
      │ FK user_id               │───┐
      │    status (pending/      │   │
      │           approved/...)  │   │
      │    role (creator/        │   │
      │          participant)    │   │
      │    joined_at             │   │
      │    message               │   │
      │    ...                   │   │
      └──────────────────────────┘   │
                                     │
      ┌──────────────────────────┐   │
      │ activity_discussions     │   │
      ├──────────────────────────┤   │
      │ PK discussion_id         │   │
      │ FK activity_id           │   │
      │ FK user_id               │───┤
      │    message               │   │
      │    message_type          │   │
      │    created_at            │   │
      │    ...                   │   │
      └──────────────────────────┘   │
                                     │
      ┌──────────────────────────┐   │
      │     matches              │   │
      ├──────────────────────────┤   │
      │ PK match_id              │   │
      │ FK activity_id (NULL)    │   │
      │ FK user_a                │───┤
      │ FK user_b                │───┤
      │    status (pending/      │   │
      │           confirmed/...) │   │
      │    match_date            │   │
      │    message               │   │
      │    ...                   │   │
      └──────┬───────────────────┘   │
             │                       │
             │ 1                     │
             │                       │
             │ has                   │
             │                       │
             │ *                     │
      ┌──────▼───────────────────┐   │
      │   chat_messages          │   │
      ├──────────────────────────┤   │
      │ PK message_id            │   │
      │ FK match_id              │   │
      │ FK sender_id             │───┤
      │ FK receiver_id           │───┤
      │    content               │   │
      │    timestamp             │   │
      │    message_type          │   │
      │    status (sent/read)    │   │
      │    is_read               │   │
      │    ...                   │   │
      └──────────────────────────┘   │
                                     │
      ┌──────────────────────────┐   │
      │      expenses            │   │
      ├──────────────────────────┤   │
      │ PK expense_id            │   │
      │ FK activity_id           │   │
      │ FK payer_id              │───┘
      │    amount                │
      │    description           │
      │    category              │
      │    expense_date          │
      │    ...                   │
      └──────────────────────────┘

      ┌──────────────────────────┐
      │  activity_reviews        │
      ├──────────────────────────┤
      │ PK review_id             │
      │ FK activity_id           │
      │ FK reviewer_id           │
      │ FK reviewee_id           │
      │    comment               │
      │    created_at            │
      │    ...                   │
      └──────────────────────────┘
```

### 4.2 資料表詳細設計

#### 4.2.1 users (使用者資料表)

| 欄位名稱 | 資料型別 | 長度 | 約束 | 預設值 | 說明 |
|---------|---------|------|------|--------|------|
| user_id | INT | - | PK, AUTO_INCREMENT | - | 使用者 ID |
| name | VARCHAR | 100 | NOT NULL | - | 姓名 |
| email | VARCHAR | 120 | UNIQUE, NOT NULL, INDEX | - | Email |
| password_hash | VARCHAR | 255 | NOT NULL | - | 密碼雜湊值 |
| privacy_setting | VARCHAR | 20 | - | 'public' | 隱私設定 |
| social_privacy | VARCHAR | 20 | - | 'public' | 社群隱私 |
| location | VARCHAR | 100 | - | NULL | 地區 |
| profile_picture | VARCHAR | 255 | - | NULL | 頭像 URL |
| bio | TEXT | - | - | NULL | 個人簡介 |
| gender | VARCHAR | 10 | - | NULL | 性別 |
| age | INT | - | - | NULL | 年齡 |
| interests | TEXT | - | - | NULL | 興趣（JSON） |
| join_date | DATETIME | - | - | CURRENT_TIMESTAMP | 註冊日期 |
| is_verified | BOOLEAN | - | - | FALSE | Email 驗證 |
| is_active | BOOLEAN | - | - | TRUE | 帳號啟用 |
| last_seen | DATETIME | - | - | CURRENT_TIMESTAMP | 最後上線 |
| instagram_url | VARCHAR | 255 | - | NULL | Instagram |
| facebook_url | VARCHAR | 255 | - | NULL | Facebook |
| line_id | VARCHAR | 100 | - | NULL | Line ID |
| twitter_url | VARCHAR | 255 | - | NULL | Twitter |
| two_factor_enabled | BOOLEAN | - | - | FALSE | 2FA 啟用 |
| two_factor_secret | VARCHAR | 32 | - | NULL | 2FA 密鑰 |
| rating_count | INT | - | - | 0 | 評價數量 |

**索引：**
- PRIMARY KEY (`user_id`)
- UNIQUE INDEX (`email`)

---

#### 4.2.2 activities (活動資料表)

| 欄位名稱 | 資料型別 | 長度 | 約束 | 預設值 | 說明 |
|---------|---------|------|------|--------|------|
| activity_id | INT | - | PK, AUTO_INCREMENT | - | 活動 ID |
| title | VARCHAR | 200 | NOT NULL | - | 活動標題 |
| date | DATE | - | NOT NULL | - | 活動日期（舊欄位） |
| start_date | DATE | - | - | NULL | 開始日期 |
| end_date | DATE | - | - | NULL | 結束日期 |
| location | VARCHAR | 200 | NOT NULL | - | 活動地點 |
| description | TEXT | - | - | NULL | 活動描述 |
| category | VARCHAR | 50 | - | NULL | 活動類別 |
| max_participants | INT | - | - | 2 | 人數上限 |
| cost | DECIMAL | (10,2) | - | 0.00 | 預計費用 |
| status | VARCHAR | 20 | - | 'active' | 活動狀態 |
| creator_id | INT | - | FK, NOT NULL | - | 創建者 ID |
| created_at | DATETIME | - | - | CURRENT_TIMESTAMP | 建立時間 |
| updated_at | DATETIME | - | - | CURRENT_TIMESTAMP ON UPDATE | 更新時間 |
| meeting_point | VARCHAR | 255 | - | NULL | 集合地點 |
| duration_hours | INT | - | - | NULL | 活動時長 |
| difficulty_level | VARCHAR | 20 | - | NULL | 難度等級 |
| gender_preference | VARCHAR | 20 | - | NULL | 性別偏好 |
| age_min | INT | - | - | NULL | 最小年齡 |
| age_max | INT | - | - | NULL | 最大年齡 |
| notes | TEXT | - | - | NULL | 特別注意 |
| cover_image | VARCHAR | 500 | - | NULL | 封面圖 URL |
| images | TEXT | - | - | NULL | 相簿（JSON） |

**索引：**
- PRIMARY KEY (`activity_id`)
- FOREIGN KEY (`creator_id`) REFERENCES `users(user_id)`
- INDEX (`status`, `start_date`)

---

#### 4.2.3 activity_participants (活動參與者)

| 欄位名稱 | 資料型別 | 長度 | 約束 | 預設值 | 說明 |
|---------|---------|------|------|--------|------|
| participant_id | INT | - | PK, AUTO_INCREMENT | - | 參與 ID |
| activity_id | INT | - | FK, NOT NULL | - | 活動 ID |
| user_id | INT | - | FK, NOT NULL | - | 使用者 ID |
| status | VARCHAR | 20 | - | 'pending' | 參與狀態 |
| role | VARCHAR | 20 | - | 'participant' | 角色 |
| joined_at | DATETIME | - | - | CURRENT_TIMESTAMP | 加入時間 |
| approved_at | DATETIME | - | - | NULL | 批准時間 |
| left_at | DATETIME | - | - | NULL | 離開時間 |
| message | TEXT | - | - | NULL | 申請訊息 |
| rejection_reason | TEXT | - | - | NULL | 拒絕原因 |

**索引：**
- PRIMARY KEY (`participant_id`)
- FOREIGN KEY (`activity_id`) REFERENCES `activities(activity_id)`
- FOREIGN KEY (`user_id`) REFERENCES `users(user_id)`
- UNIQUE (`activity_id`, `user_id`)

---

#### 4.2.4 matches (媒合記錄)

| 欄位名稱 | 資料型別 | 長度 | 約束 | 預設值 | 說明 |
|---------|---------|------|------|--------|------|
| match_id | INT | - | PK, AUTO_INCREMENT | - | 媒合 ID |
| activity_id | INT | - | FK, NULLABLE | NULL | 活動 ID |
| user_a | INT | - | FK, NOT NULL | - | 申請者 ID |
| user_b | INT | - | FK, NOT NULL | - | 被申請者 ID |
| status | VARCHAR | 20 | - | 'pending' | 媒合狀態 |
| match_date | DATETIME | - | - | CURRENT_TIMESTAMP | 媒合日期 |
| confirmed_date | DATETIME | - | - | NULL | 確認日期 |
| cancel_date | DATETIME | - | - | NULL | 取消日期 |
| message | TEXT | - | - | NULL | 申請訊息 |
| rejection_reason | TEXT | - | - | NULL | 拒絕原因 |

**索引：**
- PRIMARY KEY (`match_id`)
- FOREIGN KEY (`activity_id`) REFERENCES `activities(activity_id)`
- FOREIGN KEY (`user_a`) REFERENCES `users(user_id)`
- FOREIGN KEY (`user_b`) REFERENCES `users(user_id)`

---

#### 4.2.5 chat_messages (聊天訊息)

| 欄位名稱 | 資料型別 | 長度 | 約束 | 預設值 | 說明 |
|---------|---------|------|------|--------|------|
| message_id | INT | - | PK, AUTO_INCREMENT | - | 訊息 ID |
| match_id | INT | - | FK, NULLABLE | NULL | 媒合 ID |
| sender_id | INT | - | FK, NOT NULL | - | 發送者 ID |
| receiver_id | INT | - | FK, NOT NULL | - | 接收者 ID |
| content | TEXT | - | NOT NULL | - | 訊息內容 |
| timestamp | DATETIME | - | - | CURRENT_TIMESTAMP | 時間戳 |
| message_type | VARCHAR | 20 | - | 'text' | 訊息類型 |
| status | VARCHAR | 20 | - | 'sent' | 訊息狀態 |
| is_read | BOOLEAN | - | - | FALSE | 是否已讀 |
| file_url | VARCHAR | 255 | - | NULL | 檔案 URL |
| file_name | VARCHAR | 255 | - | NULL | 檔案名稱 |
| file_size | INT | - | - | NULL | 檔案大小 |

**索引：**
- PRIMARY KEY (`message_id`)
- FOREIGN KEY (`match_id`) REFERENCES `matches(match_id)`
- FOREIGN KEY (`sender_id`) REFERENCES `users(user_id)`
- FOREIGN KEY (`receiver_id`) REFERENCES `users(user_id)`
- INDEX (`match_id`, `timestamp`)

---

#### 4.2.6 expenses (費用記錄)

| 欄位名稱 | 資料型別 | 長度 | 約束 | 預設值 | 說明 |
|---------|---------|------|------|--------|------|
| expense_id | INT | - | PK, AUTO_INCREMENT | - | 費用 ID |
| activity_id | INT | - | FK, NOT NULL | - | 活動 ID |
| payer_id | INT | - | FK, NOT NULL | - | 付款者 ID |
| amount | DECIMAL | (10,2) | NOT NULL | - | 金額 |
| description | TEXT | - | - | NULL | 描述 |
| expense_date | DATE | - | - | CURRENT_DATE | 費用日期 |
| category | VARCHAR | 50 | - | NULL | 類別 |
| is_split | BOOLEAN | - | - | TRUE | 是否分攤 |
| split_method | VARCHAR | 20 | - | 'equal' | 分攤方式 |
| participants | TEXT | - | - | NULL | 參與者（JSON） |
| created_at | DATETIME | - | - | CURRENT_TIMESTAMP | 建立時間 |

**索引：**
- PRIMARY KEY (`expense_id`)
- FOREIGN KEY (`activity_id`) REFERENCES `activities(activity_id)`
- FOREIGN KEY (`payer_id`) REFERENCES `users(user_id)`

---

#### 4.2.7 activity_reviews (活動評價)

| 欄位名稱 | 資料型別 | 長度 | 約束 | 預設值 | 說明 |
|---------|---------|------|------|--------|------|
| review_id | INT | - | PK, AUTO_INCREMENT | - | 評價 ID |
| activity_id | INT | - | FK, NOT NULL | - | 活動 ID |
| reviewer_id | INT | - | FK, NOT NULL | - | 評價者 ID |
| reviewee_id | INT | - | FK, NOT NULL | - | 被評價者 ID |
| comment | TEXT | - | NOT NULL | - | 評語 |
| created_at | DATETIME | - | - | CURRENT_TIMESTAMP | 建立時間 |
| updated_at | DATETIME | - | - | CURRENT_TIMESTAMP ON UPDATE | 更新時間 |

**索引：**
- PRIMARY KEY (`review_id`)
- FOREIGN KEY (`activity_id`) REFERENCES `activities(activity_id)`
- FOREIGN KEY (`reviewer_id`) REFERENCES `users(user_id)`
- FOREIGN KEY (`reviewee_id`) REFERENCES `users(user_id)`

---

### 4.3 資料庫優化策略

#### 4.3.1 索引優化
- **email** 欄位加索引（UNIQUE）- 提升登入查詢速度
- **activity.status + start_date** 組合索引 - 優化活動列表查詢
- **match_id + timestamp** 組合索引 - 優化聊天訊息查詢

#### 4.3.2 查詢優化
- 使用 SQLAlchemy 的 `joinedload()` 預載關聯資料
- 使用 `limit()` 限制查詢筆數
- 避免 `SELECT *`，只選取需要的欄位

#### 4.3.3 資料庫連線池
```python
# config.py
SQLALCHEMY_ENGINE_OPTIONS = {
    'pool_size': 10,
    'pool_recycle': 3600,
    'pool_pre_ping': True
}
```

---

## 5. API 設計

### 5.1 API 設計原則

1. **RESTful 設計**
   - 使用 HTTP 動詞（GET, POST, PUT, DELETE）
   - 資源導向的 URL 設計
   - 使用 HTTP 狀態碼

2. **統一回應格式**
   ```json
   // 成功回應
   {
     "data": { ... },
     "message": "操作成功"
   }
   
   // 錯誤回應
   {
     "error": "錯誤訊息",
     "code": "ERROR_CODE",
     "status": 400
   }
   ```

3. **JWT 認證**
   - Header: `Authorization: Bearer <token>`
   - Access Token 有效期：15 分鐘
   - Refresh Token 有效期：30 天

### 5.2 API 端點清單

#### 5.2.1 認證 API (`/api/auth`)

| 方法 | 端點 | 描述 | 認證 |
|------|------|------|------|
| POST | `/register` | 使用者註冊 | No |
| POST | `/login` | 使用者登入 | No |
| POST | `/logout` | 使用者登出 | Yes |
| POST | `/refresh` | 刷新 Token | Yes |
| GET | `/me` | 取得當前使用者 | Yes |
| POST | `/change-password` | 變更密碼 | Yes |
| POST | `/forgot-password` | 忘記密碼 | No |
| POST | `/reset-password` | 重設密碼 | No |
| POST | `/verify-email` | 驗證 Email | No |
| POST | `/enable-2fa` | 啟用 2FA | Yes |
| POST | `/disable-2fa` | 停用 2FA | Yes |
| POST | `/verify-2fa` | 驗證 2FA Code | Yes |

---

#### 5.2.2 使用者 API (`/api/users`)

| 方法 | 端點 | 描述 | 認證 |
|------|------|------|------|
| GET | `/profile` | 取得個人資料 | Yes |
| PUT | `/profile` | 更新個人資料 | Yes |
| GET | `/stats` | 取得統計資訊 | Yes |
| GET | `/{user_id}` | 取得使用者資訊 | Yes |
| DELETE | `/account` | 刪除帳號 | Yes |

**範例：GET `/api/users/profile`**

回應：
```json
{
  "user_id": 1,
  "name": "張三",
  "email": "test@example.com",
  "profile_picture": "/uploads/avatars/avatar1.jpg",
  "bio": "熱愛旅行",
  "gender": "male",
  "age": 28,
  "interests": ["登山", "攝影", "美食"],
  "rating_count": 5,
  "social_links": {
    "instagram": "https://instagram.com/user",
    "facebook": null,
    "line": "lineID123",
    "twitter": null
  }
}
```

---

#### 5.2.3 活動 API (`/api/activities`)

| 方法 | 端點 | 描述 | 認證 |
|------|------|------|------|
| GET | `/` | 取得活動列表（支援篩選） | Yes |
| POST | `/` | 建立新活動 | Yes |
| GET | `/{activity_id}` | 取得活動詳情 | Yes |
| PUT | `/{activity_id}` | 更新活動 | Yes |
| DELETE | `/{activity_id}` | 刪除活動 | Yes |
| POST | `/{activity_id}/join` | 申請加入活動 | Yes |
| GET | `/{activity_id}/participants` | 取得參與者列表 | Yes |
| POST | `/participants/{participant_id}/approve` | 批准申請 | Yes |
| POST | `/participants/{participant_id}/reject` | 拒絕申請 | Yes |
| DELETE | `/participants/{participant_id}` | 移除參與者 | Yes |

**範例：POST `/api/activities`**

請求：
```json
{
  "title": "陽明山賞花一日遊",
  "start_date": "2024-12-15",
  "end_date": "2024-12-15",
  "location": "陽明山",
  "description": "一起去陽明山賞花",
  "category": "leisure",
  "max_participants": 4,
  "cost": 500,
  "gender_preference": "any",
  "meeting_point": "捷運劍潭站"
}
```

---

#### 5.2.4 媒合 API (`/api/matches`)

| 方法 | 端點 | 描述 | 認證 |
|------|------|------|------|
| GET | `/` | 取得媒合列表 | Yes |
| POST | `/` | 建立媒合申請 | Yes |
| PUT | `/{match_id}` | 更新媒合狀態 | Yes |
| DELETE | `/{match_id}` | 刪除媒合 | Yes |

---

#### 5.2.5 聊天 API (`/api/chat`)

| 方法 | 端點 | 描述 | 認證 |
|------|------|------|------|
| GET | `/matches/{match_id}/messages` | 取得聊天訊息 | Yes |
| POST | `/matches/{match_id}/messages` | 發送訊息 | Yes |
| GET | `/friends` | 取得好友列表 | Yes |
| GET | `/unread-count` | 取得未讀訊息數 | Yes |

---

#### 5.2.6 費用 API (`/api`)

| 方法 | 端點 | 描述 | 認證 |
|------|------|------|------|
| GET | `/activities/{id}/expenses` | 取得費用列表 | Yes |
| POST | `/activities/{id}/expenses` | 新增費用 | Yes |
| DELETE | `/expenses/{expense_id}` | 刪除費用 | Yes |
| GET | `/activities/{id}/expenses/settlement` | 取得結算方案 | Yes |

---

#### 5.2.7 評價 API (`/api`)

| 方法 | 端點 | 描述 | 認證 |
|------|------|------|------|
| POST | `/activities/{id}/reviews` | 新增評價 | Yes |
| GET | `/activities/{id}/reviews` | 取得評價列表 | Yes |
| GET | `/users/{user_id}/reviews` | 取得使用者評價 | Yes |

---

#### 5.2.8 上傳 API (`/api/upload`)

| 方法 | 端點 | 描述 | 認證 |
|------|------|------|------|
| POST | `/image` | 上傳圖片 | Yes |

**請求：**
- Content-Type: `multipart/form-data`
- 參數：
  - `file`: 圖片檔案
  - `upload_type`: `avatar` / `cover` / `album`

**回應：**
```json
{
  "url": "/uploads/covers/uuid-filename.jpg",
  "filename": "uuid-filename.jpg"
}
```

---

### 5.3 Socket.IO 事件設計

#### 5.3.1 客戶端事件

| 事件名稱 | 參數 | 描述 |
|---------|------|------|
| `connect` | - | 連線建立 |
| `disconnect` | - | 連線中斷 |
| `send_message` | `{match_id, content}` | 發送訊息 |
| `join_room` | `{match_id}` | 加入聊天室 |
| `leave_room` | `{match_id}` | 離開聊天室 |

#### 5.3.2 伺服器事件

| 事件名稱 | 參數 | 描述 |
|---------|------|------|
| `new_message` | `{message_data}` | 新訊息通知 |
| `user_online` | `{user_id}` | 使用者上線 |
| `user_offline` | `{user_id}` | 使用者離線 |

---

## 6. 安全性設計

### 6.1 認證與授權

#### 6.1.1 JWT Token 機制

```python
# JWT 配置
JWT_SECRET_KEY = os.environ.get('JWT_SECRET_KEY')
JWT_ACCESS_TOKEN_EXPIRES = timedelta(minutes=15)
JWT_REFRESH_TOKEN_EXPIRES = timedelta(days=30)
```

**Token 結構：**
```json
{
  "sub": "user_id",
  "type": "access",  // or "refresh"
  "exp": 1234567890,
  "iat": 1234567890
}
```

#### 6.1.2 密碼加密

- **演算法：** scrypt（Python 內建 `werkzeug.security`）
- **Salt：** 自動產生隨機 Salt
- **儲存：** `password_hash` 欄位

```python
from werkzeug.security import generate_password_hash, check_password_hash

# 加密
hash = generate_password_hash(password, method='scrypt')

# 驗證
check_password_hash(hash, password)
```

### 6.2 資料驗證

#### 6.2.1 輸入驗證

- Email 格式驗證（正規表達式）
- 密碼強度驗證（最少 8 字元）
- 檔案類型驗證（MIME Type）
- 檔案大小限制（16MB）

#### 6.2.2 SQL 注入防護

- 使用 SQLAlchemy ORM 參數化查詢
- 避免字串拼接 SQL

```python
# ✅ 正確
User.query.filter_by(email=email).first()

# ❌ 錯誤
db.session.execute(f"SELECT * FROM users WHERE email = '{email}'")
```

### 6.3 CORS 設定

```python
from flask_cors import CORS

CORS(app, resources={
    r"/api/*": {
        "origins": ["http://localhost:5173"],  # Vite dev server
        "methods": ["GET", "POST", "PUT", "DELETE"],
        "allow_headers": ["Content-Type", "Authorization"]
    }
})
```

### 6.4 安全標頭

```python
@app.after_request
def set_security_headers(response):
    response.headers['X-Content-Type-Options'] = 'nosniff'
    response.headers['X-Frame-Options'] = 'DENY'
    response.headers['X-XSS-Protection'] = '1; mode=block'
    return response
```

---

## 7. 部署架構

### 7.1 Docker 容器化

#### 7.1.1 容器架構

```
┌─────────────────────────────────────────────┐
│           Docker Compose 服務群                │
├─────────────────────────────────────────────┤
│                                               │
│  ┌──────────────┐  ┌──────────────┐         │
│  │  frontend    │  │   backend    │         │
│  │  (Nginx)     │  │   (Flask)    │         │
│  │  Port: 80    │  │   Port: 5000 │         │
│  └──────┬───────┘  └──────┬───────┘         │
│         │                 │                  │
│         │                 │                  │
│         │          ┌──────▼───────┐         │
│         │          │      db      │         │
│         │          │  (MariaDB)   │         │
│         │          │  Port: 3306  │         │
│         │          └──────────────┘         │
│         │                                    │
│  ┌──────▼───────────────────────┐          │
│  │       Docker Volumes          │          │
│  │  - db_data (資料庫持久化)      │          │
│  │  - uploads (上傳檔案)          │          │
│  └──────────────────────────────┘          │
└─────────────────────────────────────────────┘
```

#### 7.1.2 docker-compose.yml

```yaml
version: '3.8'

services:
  db:
    image: mariadb:10.11
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"

  backend:
    build: ./backend
    environment:
      DATABASE_URL: mysql+pymysql://${DB_USER}:${DB_PASSWORD}@db:3306/${DB_NAME}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      FLASK_ENV: production
    volumes:
      - ./backend:/app
      - uploads:/app/uploads
    ports:
      - "5000:5000"
    depends_on:
      - db

  frontend:
    image: nginx:alpine
    volumes:
      - ./frontend/dist:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  db_data:
  uploads:
```

### 7.2 環境配置

#### 7.2.1 開發環境

```
前端：Vite Dev Server (http://localhost:5173)
後端：Flask Dev Server (http://localhost:5000)
資料庫：Docker MariaDB (localhost:3306)
```

#### 7.2.2 生產環境

```
前端：Nginx (靜態檔案)
後端：Gunicorn + Flask
資料庫：MariaDB (Docker)
SSL：Let's Encrypt
```

---

## 8. 效能優化

### 8.1 後端優化

- 資料庫連線池（Pool Size: 10）
- 使用 `joinedload()` 預載關聯資料
- API 回應使用 `jsonify()` 序列化
- 日誌記錄使用 `logging` 模組

### 8.2 前端優化

- 路由懶載入（Lazy Loading）
- 圖片壓縮與懶載入
- Vite 打包優化（Tree Shaking）
- 使用 CDN 載入靜態資源（未來）

### 8.3 快取策略（Phase 2）

- Redis 快取熱門活動
- 瀏覽器快取靜態資源
- API Response 快取（短期）

---

## 9. 附錄

### 9.1 資料庫遷移

使用 Alembic 進行資料庫 Schema 遷移：

```bash
# 初始化 Alembic
flask db init

# 建立遷移檔案
flask db migrate -m "Initial migration"

# 執行遷移
flask db upgrade
```

### 9.2 開發環境設定

```bash
# 1. 啟動 Docker
docker-compose up -d

# 2. 初始化資料庫
python backend/init_docker_db.py

# 3. 啟動前端開發伺服器
cd frontend
npm run dev
```

### 9.3 參考文獻

- [Flask 官方文件](https://flask.palletsprojects.com/)
- [Vue 3 官方文件](https://vuejs.org/)
- [SQLAlchemy 官方文件](https://docs.sqlalchemy.org/)
- [Socket.IO 官方文件](https://socket.io/)

---

**文件核准：**

| 角色 | 姓名 | 簽名 | 日期 |
|------|------|------|------|
| 系統架構師 | - | - | - |
| 技術主管 | - | - | - |
| 專案經理 | - | - | - |

---

**文件結束**
