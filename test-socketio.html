<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO é€£ç·šæ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }
        .log-entry.success { color: #28a745; }
        .log-entry.error { color: #dc3545; }
        .log-entry.info { color: #007bff; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        input {
            padding: 8px;
            width: 200px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”Œ Socket.IO é€£ç·šæ¸¬è©¦</h1>
        
        <div id="status" class="status disconnected">
            âŒ æœªé€£ç·š
        </div>

        <div>
            <h3>èªè­‰è¨­å®š</h3>
            <input type="text" id="username" placeholder="ç”¨æˆ¶åï¼ˆå¦‚ aliceï¼‰" value="alice">
            <input type="password" id="password" placeholder="å¯†ç¢¼ï¼ˆå¦‚ password123ï¼‰" value="password123">
            <button onclick="login()">ç™»å…¥ä¸¦é€£ç·š</button>
        </div>

        <div>
            <h3>æ§åˆ¶</h3>
            <button onclick="testConnect()">æ¸¬è©¦é€£ç·š</button>
            <button onclick="testDisconnect()" class="danger">æ–·é–‹é€£ç·š</button>
            <button onclick="getOnlineUsers()">ç²å–åœ¨ç·šç”¨æˆ¶</button>
            <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
        </div>

        <div>
            <h3>èŠå¤©æ¸¬è©¦</h3>
            <input type="number" id="matchId" placeholder="Match ID" value="1">
            <input type="text" id="message" placeholder="è¨Šæ¯å…§å®¹" value="æ¸¬è©¦è¨Šæ¯">
            <button onclick="joinChat()">åŠ å…¥èŠå¤©å®¤</button>
            <button onclick="sendMessage()">ç™¼é€è¨Šæ¯</button>
            <button onclick="leaveChat()">é›¢é–‹èŠå¤©å®¤</button>
        </div>

        <div>
            <h3>æ—¥èªŒ</h3>
            <div id="log" class="log">
                <div class="log-entry info">ç­‰å¾…æ“ä½œ...</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        let socket = null;
        let token = null;
        let currentUserId = null;

        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function updateStatus(connected) {
            const status = document.getElementById('status');
            if (connected) {
                status.className = 'status connected';
                status.textContent = 'âœ… å·²é€£ç·š';
            } else {
                status.className = 'status disconnected';
                status.textContent = 'âŒ æœªé€£ç·š';
            }
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            addLog(`æ­£åœ¨ç™»å…¥ç”¨æˆ¶: ${username}...`, 'info');

            try {
                const response = await fetch('http://localhost:8080/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.access_token;
                    currentUserId = data.user.user_id;
                    addLog(`âœ… ç™»å…¥æˆåŠŸï¼ç”¨æˆ¶ ID: ${currentUserId}`, 'success');
                    addLog(`Token: ${token.substring(0, 20)}...`, 'info');
                    
                    // è‡ªå‹•é€£ç·š Socket.IO
                    testConnect();
                } else {
                    addLog(`âŒ ç™»å…¥å¤±æ•—: ${data.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            } catch (error) {
                addLog(`âŒ ç™»å…¥éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        function testConnect() {
            if (!token) {
                addLog('âŒ è«‹å…ˆç™»å…¥ç²å– Token', 'error');
                return;
            }

            if (socket && socket.connected) {
                addLog('âš ï¸ Socket.IO å·²ç¶“é€£ç·š', 'info');
                return;
            }

            addLog('æ­£åœ¨é€£ç·šåˆ° Socket.IO...', 'info');
            addLog(`URL: http://localhost:8080`, 'info');

            socket = io('http://localhost:8080', {
                auth: {
                    token: token
                },
                path: '/socket.io',
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: 5
            });

            socket.on('connect', () => {
                addLog(`âœ… Socket.IO é€£ç·šæˆåŠŸï¼Socket ID: ${socket.id}`, 'success');
                updateStatus(true);
            });

            socket.on('connect_error', (error) => {
                addLog(`âŒ é€£ç·šéŒ¯èª¤: ${error.message}`, 'error');
                updateStatus(false);
            });

            socket.on('disconnect', (reason) => {
                addLog(`âš ï¸ å·²æ–·ç·š: ${reason}`, 'info');
                updateStatus(false);
            });

            socket.on('reconnect', (attemptNumber) => {
                addLog(`âœ… é‡æ–°é€£ç·šæˆåŠŸï¼ˆå˜—è©¦ ${attemptNumber} æ¬¡ï¼‰`, 'success');
                updateStatus(true);
            });

            socket.on('user_online', (data) => {
                addLog(`ğŸ‘¤ ç”¨æˆ¶ä¸Šç·š: ${data.user_id}`, 'info');
            });

            socket.on('user_offline', (data) => {
                addLog(`ğŸ‘¤ ç”¨æˆ¶é›¢ç·š: ${data.user_id}`, 'info');
            });

            socket.on('new_message', (message) => {
                addLog(`ğŸ’¬ æ”¶åˆ°æ–°è¨Šæ¯: [${message.sender_name}] ${message.content}`, 'success');
            });

            socket.on('user_typing', (data) => {
                addLog(`âŒ¨ï¸ ç”¨æˆ¶ ${data.user_id} ${data.is_typing ? 'æ­£åœ¨è¼¸å…¥...' : 'åœæ­¢è¼¸å…¥'}`, 'info');
            });
        }

        function testDisconnect() {
            if (socket) {
                socket.disconnect();
                addLog('ğŸ”Œ å·²æ‰‹å‹•æ–·é–‹é€£ç·š', 'info');
                updateStatus(false);
            } else {
                addLog('âš ï¸ Socket æœªåˆå§‹åŒ–', 'info');
            }
        }

        function joinChat() {
            if (!socket || !socket.connected) {
                addLog('âŒ Socket.IO æœªé€£ç·š', 'error');
                return;
            }

            const matchId = parseInt(document.getElementById('matchId').value);
            
            addLog(`åŠ å…¥èŠå¤©å®¤: chat_${matchId}...`, 'info');

            socket.emit('join_chat', {
                match_id: matchId,
                user_id: currentUserId
            }, (response) => {
                if (response?.error) {
                    addLog(`âŒ åŠ å…¥èŠå¤©å®¤å¤±æ•—: ${response.error}`, 'error');
                } else {
                    addLog(`âœ… æˆåŠŸåŠ å…¥èŠå¤©å®¤: ${response.room}`, 'success');
                }
            });
        }

        function leaveChat() {
            if (!socket || !socket.connected) {
                addLog('âŒ Socket.IO æœªé€£ç·š', 'error');
                return;
            }

            const matchId = parseInt(document.getElementById('matchId').value);
            
            socket.emit('leave_chat', {
                match_id: matchId,
                user_id: currentUserId
            });

            addLog(`é›¢é–‹èŠå¤©å®¤: chat_${matchId}`, 'info');
        }

        function sendMessage() {
            if (!socket || !socket.connected) {
                addLog('âŒ Socket.IO æœªé€£ç·š', 'error');
                return;
            }

            const matchId = parseInt(document.getElementById('matchId').value);
            const content = document.getElementById('message').value;

            addLog(`ç™¼é€è¨Šæ¯åˆ° chat_${matchId}: ${content}`, 'info');

            socket.emit('send_message', {
                match_id: matchId,
                sender_id: currentUserId,
                content: content,
                message_type: 'text'
            }, (response) => {
                if (response?.error) {
                    addLog(`âŒ ç™¼é€å¤±æ•—: ${response.error}`, 'error');
                } else {
                    addLog(`âœ… è¨Šæ¯ç™¼é€æˆåŠŸï¼Message ID: ${response.message.message_id}`, 'success');
                }
            });
        }

        function getOnlineUsers() {
            if (!socket || !socket.connected) {
                addLog('âŒ Socket.IO æœªé€£ç·š', 'error');
                return;
            }

            socket.emit('get_online_users', {}, (response) => {
                if (response?.error) {
                    addLog(`âŒ ç²å–å¤±æ•—: ${response.error}`, 'error');
                } else {
                    const users = response.online_users || [];
                    addLog(`ğŸ‘¥ åœ¨ç·šç”¨æˆ¶: ${users.length} äºº`, 'success');
                    addLog(`   ç”¨æˆ¶åˆ—è¡¨: ${users.join(', ') || 'ç„¡'}`, 'info');
                }
            });
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '<div class="log-entry info">æ—¥èªŒå·²æ¸…é™¤</div>';
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦æœ‰å„²å­˜çš„ token
        window.onload = () => {
            addLog('ğŸ“ æ¸¬è©¦é é¢å·²è¼‰å…¥', 'info');
            addLog('ğŸ’¡ æç¤ºï¼šè«‹å…ˆä½¿ç”¨æ¸¬è©¦å¸³è™Ÿï¼ˆalice/password123ï¼‰ç™»å…¥', 'info');
        };
    </script>
</body>
</html>
